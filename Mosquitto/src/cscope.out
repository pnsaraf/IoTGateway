cscope 15 $HOME/Downloads/mosquitto-1.4.3/src -q 0000001915 0000351992
	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/bridge.c

17 
	~<as£π.h
>

18 
	~<î∫o.h
>

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 #i‚de‡
WIN32


23 
	~<√tdb.h
>

24 
	~<sys/sockë.h
>

26 
	~<wösock2.h
>

27 
	~<ws2t˝ù.h
>

30 
	~<c⁄fig.h
>

32 
	~<mosquôto.h
>

33 
	~<mosquôto_brokî.h
>

34 
	~<mosquôto_öã∫Æ.h
>

35 
	~<√t_mosq.h
>

36 
	~<mem‹y_mosq.h
>

37 
	~<£nd_mosq.h
>

38 
	~<time_mosq.h
>

39 
	~<és_mosq.h
>

40 
	~<utû_mosq.h
>

41 
	~<wûl_mosq.h
>

43 #ifde‡
WITH_BRIDGE


45 
	$mqâ3_bridge_√w
(
mosquôto_db
 *
db
, 
_mqâ3_bridge
 *
bridge
)

47 
mosquôto
 *
√w_c⁄ãxt
 = 
NULL
;

48 
mosquôto
 **
bridges
;

49 
ho°«me
[256];

50 
Àn
;

51 *
id
, *
loˇl_id
;

53 
	`as£π
(
db
);

54 
	`as£π
(
bridge
);

56 if(!
bridge
->
ªmŸe_˛õ¡id
){

57 if(!
	`gëho°«me
(
ho°«me
, 256)){

58 
Àn
 = 
	`°æí
(
ho°«me
Ë+ såÀn(
bridge
->
«me
) + 2;

59 
id
 = 
	`_mosquôto_mÆloc
(
Àn
);

60 if(!
id
){

61  
MOSQ_ERR_NOMEM
;

63 
	`¢¥ötf
(
id
, 
Àn
, "%s.%s", 
ho°«me
, 
bridge
->
«me
);

67 
bridge
->
ªmŸe_˛õ¡id
 = 
id
;

69 if(
bridge
->
loˇl_˛õ¡id
){

70 
loˇl_id
 = 
	`_mosquôto_°rdup
(
bridge
->
loˇl_˛õ¡id
);

71 if(!
loˇl_id
){

72  
MOSQ_ERR_NOMEM
;

75 
Àn
 = 
	`°æí
(
bridge
->
ªmŸe_˛õ¡id
) + strlen("local.") + 2;

76 
loˇl_id
 = 
	`_mosquôto_mÆloc
(
Àn
);

77 if(!
loˇl_id
){

78  
MOSQ_ERR_NOMEM
;

80 
	`¢¥ötf
(
loˇl_id
, 
Àn
, "loˇl.%s", 
bridge
->
ªmŸe_˛õ¡id
);

81 
bridge
->
loˇl_˛õ¡id
 = 
	`_mosquôto_°rdup
(
loˇl_id
);

82 if(!
bridge
->
loˇl_˛õ¡id
){

83 
	`_mosquôto_‰ì
(
loˇl_id
);

84  
MOSQ_ERR_NOMEM
;

88 
	`HASH_FIND
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
loˇl_id
, 
	`°æí
÷oˇl_id), 
√w_c⁄ãxt
);

89 if(
√w_c⁄ãxt
){

91 
	`_mosquôto_‰ì
(
loˇl_id
);

94 
√w_c⁄ãxt
 = 
	`mqâ3_c⁄ãxt_öô
(
db
, -1);

95 if(!
√w_c⁄ãxt
){

96 
	`_mosquôto_‰ì
(
loˇl_id
);

97  
MOSQ_ERR_NOMEM
;

99 
√w_c⁄ãxt
->
id
 = 
loˇl_id
;

100 
	`HASH_ADD_KEYPTR
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
√w_c⁄ãxt
->
id
, 
	`°æí
(new_context->id),Çew_context);

102 
√w_c⁄ãxt
->
bridge
 = bridge;

103 
√w_c⁄ãxt
->
is_bridge
 = 
åue
;

105 
√w_c⁄ãxt
->
u£∫ame
 =Çew_c⁄ãxt->
bridge
->
ªmŸe_u£∫ame
;

106 
√w_c⁄ãxt
->
∑ssw‹d
 =Çew_c⁄ãxt->
bridge
->
ªmŸe_∑ssw‹d
;

108 #ifde‡
WITH_TLS


109 
√w_c⁄ãxt
->
és_ˇfûe
 =Çew_c⁄ãxt->
bridge
->tls_cafile;

110 
√w_c⁄ãxt
->
és_ˇ∑th
 =Çew_c⁄ãxt->
bridge
->tls_capath;

111 
√w_c⁄ãxt
->
és_˚πfûe
 =Çew_c⁄ãxt->
bridge
->tls_certfile;

112 
√w_c⁄ãxt
->
és_keyfûe
 =Çew_c⁄ãxt->
bridge
->tls_keyfile;

113 
√w_c⁄ãxt
->
és_˚π_ªqs
 = 
SSL_VERIFY_PEER
;

114 
√w_c⁄ãxt
->
és_vîsi⁄
 =Çew_c⁄ãxt->
bridge
->tls_version;

115 
√w_c⁄ãxt
->
és_ö£cuª
 =Çew_c⁄ãxt->
bridge
->tls_insecure;

116 #ifde‡
REAL_WITH_TLS_PSK


117 
√w_c⁄ãxt
->
és_psk_idítôy
 =Çew_c⁄ãxt->
bridge
->tls_psk_identity;

118 
√w_c⁄ãxt
->
és_psk
 =Çew_c⁄ãxt->
bridge
->tls_psk;

122 
bridge
->
åy_¥iv©e_ac˚±ed
 = 
åue
;

123 
√w_c⁄ãxt
->
¥Ÿocﬁ
 = 
bridge
->
¥Ÿocﬁ_vîsi⁄
;

125 
bridges
 = 
	`_mosquôto_ªÆloc
(
db
->bridges, (db->
bridge_cou¡
+1)*(
mosquôto
 *));

126 if(
bridges
){

127 
db
->
bridges
 = bridges;

128 
db
->
bridge_cou¡
++;

129 
db
->
bridges
[db->
bridge_cou¡
-1] = 
√w_c⁄ãxt
;

131  
MOSQ_ERR_NOMEM
;

134  
	`mqâ3_bridge_c⁄√˘
(
db
, 
√w_c⁄ãxt
);

135 
	}
}

137 
	$mqâ3_bridge_c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

139 
rc
;

140 
i
;

141 *
nŸifiˇti⁄_t›ic
;

142 
nŸifiˇti⁄_t›ic_Àn
;

143 
uöt8_t
 
nŸifiˇti⁄_∑ylﬂd
;

145 if(!
c⁄ãxt
 || !c⁄ãxt->
bridge
Ë 
MOSQ_ERR_INVAL
;

147 
c⁄ãxt
->
°©e
 = 
mosq_cs_√w
;

148 
c⁄ãxt
->
sock
 = 
INVALID_SOCKET
;

149 
c⁄ãxt
->
œ°_msg_ö
 = 
	`mosquôto_time
();

150 
c⁄ãxt
->
œ°_msg_out
 = 
	`mosquôto_time
();

151 
c⁄ãxt
->
kì∑live
 = c⁄ãxt->
bridge
->keepalive;

152 
c⁄ãxt
->
˛ón_£ssi⁄
 = c⁄ãxt->
bridge
->clean_session;

153 
c⁄ãxt
->
ö_∑ckë
.
∑ylﬂd
 = 
NULL
;

154 
c⁄ãxt
->
pög_t
 = 0;

155 
c⁄ãxt
->
bridge
->
œzy_ªc⁄√˘
 = 
Ál£
;

156 
	`mqâ3_bridge_∑ckë_˛ónup
(
c⁄ãxt
);

157 
	`mqâ3_db_mesßge_ªc⁄√˘_ª£t
(
db
, 
c⁄ãxt
);

159 if(
c⁄ãxt
->
˛ón_£ssi⁄
){

160 
	`mqâ3_db_mesßges_dñëe
(
db
, 
c⁄ãxt
);

167 
	`mqâ3_subs_˛ón_£ssi⁄
(
db
, 
c⁄ãxt
);

169 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

170 if(
c⁄ãxt
->
bridge
->
t›ics
[
i
].
dúe˘i⁄
 =
bd_out
 || c⁄ãxt->bridge->t›ics[i].dúe˘i⁄ =
bd_bŸh
){

171 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Bridgê%†doögÜoˇ»SUBSCRIBE o¿t›i¯%s", 
c⁄ãxt
->
id
, c⁄ãxt->
bridge
->
t›ics
[
i
].
loˇl_t›ic
);

172 if(
	`mqâ3_sub_add
(
db
, 
c⁄ãxt
, c⁄ãxt->
bridge
->
t›ics
[
i
].
loˇl_t›ic
, c⁄ãxt->bridge->t›ics[i].
qos
, &db->
subs
))  1;

176 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s
){

177 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄_t›ic
){

178 if(!
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
){

179 
nŸifiˇti⁄_∑ylﬂd
 = '0';

180 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1);

181 
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
 = 
åue
;

183 
nŸifiˇti⁄_∑ylﬂd
 = '0';

184 
rc
 = 
	`_mosquôto_wûl_£t
(
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
);

185 if(
rc
 !
MOSQ_ERR_SUCCESS
){

186  
rc
;

189 
nŸifiˇti⁄_t›ic_Àn
 = 
	`°æí
(
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
)+strlen("$SYS/broker/connection//state");

190 
nŸifiˇti⁄_t›ic
 = 
	`_mosquôto_mÆloc
(()*(
nŸifiˇti⁄_t›ic_Àn
+1));

191 if(!
nŸifiˇti⁄_t›ic
Ë 
MOSQ_ERR_NOMEM
;

193 
	`¢¥ötf
(
nŸifiˇti⁄_t›ic
, 
nŸifiˇti⁄_t›ic_Àn
+1, "$SYS/brokî/c⁄√˘i⁄/%s/°©e", 
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
);

195 if(!
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
){

196 
nŸifiˇti⁄_∑ylﬂd
 = '0';

197 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1);

198 
c⁄ãxt
->
bridge
->
öôül_nŸifiˇti⁄_d⁄e
 = 
åue
;

201 
nŸifiˇti⁄_∑ylﬂd
 = '0';

202 
rc
 = 
	`_mosquôto_wûl_£t
(
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
);

203 
	`_mosquôto_‰ì
(
nŸifiˇti⁄_t›ic
);

204 if(
rc
 !
MOSQ_ERR_SUCCESS
){

205  
rc
;

210 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "C⁄√˘ög bridgê%†(%s:%d)", 
c⁄ãxt
->
bridge
->
«me
, c⁄ãxt->bridge->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
, c⁄ãxt->bridge->addªs£s[c⁄ãxt->bridge->cur_addªss].
p‹t
);

211 
rc
 = 
	`_mosquôto_sockë_c⁄√˘
(
c⁄ãxt
, c⁄ãxt->
bridge
->
addªs£s
[c⁄ãxt->bridge->
cur_addªss
].
addªss
, c⁄ãxt->bridge->addªs£s[c⁄ãxt->bridge->cur_addªss].
p‹t
, 
NULL
, 
Ál£
);

212 if(
rc
 > 0 ){

213 if(
rc
 =
MOSQ_ERR_TLS
){

214  
rc
;

215 }if(
rc
 =
MOSQ_ERR_ERRNO
){

216 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

217 }if(
rc
 =
MOSQ_ERR_EAI
){

218 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

221  
rc
;

224 
	`HASH_ADD
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
sock
, (
c⁄ãxt
->sock), context);

226 if(
rc
 =
MOSQ_ERR_CONN_PENDING
){

227 
c⁄ãxt
->
°©e
 = 
mosq_cs_c⁄√˘_≥ndög
;

229 
rc
 = 
	`_mosquôto_£nd_c⁄√˘
(
c⁄ãxt
, c⁄ãxt->
kì∑live
, c⁄ãxt->
˛ón_£ssi⁄
);

230 if(
rc
 =
MOSQ_ERR_SUCCESS
){

231  
MOSQ_ERR_SUCCESS
;

232 }if(
rc
 =
MOSQ_ERR_ERRNO
 && 
î∫o
 =
ENOTCONN
){

233  
MOSQ_ERR_SUCCESS
;

235 if(
rc
 =
MOSQ_ERR_TLS
){

236  
rc
;

237 }if(
rc
 =
MOSQ_ERR_ERRNO
){

238 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`°ªº‹
(
î∫o
));

239 }if(
rc
 =
MOSQ_ERR_EAI
){

240 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ cª©ög bridge: %s.", 
	`gai_°ªº‹
(
î∫o
));

242 
	`_mosquôto_sockë_˛o£
(
db
, 
c⁄ãxt
);

243  
rc
;

245 
	}
}

247 
	$mqâ3_bridge_∑ckë_˛ónup
(
mosquôto
 *
c⁄ãxt
)

249 
_mosquôto_∑ckë
 *
∑ckë
;

250 if(!
c⁄ãxt
) ;

252 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

253 
	`_mosquôto_∑ckë_˛ónup
(
c⁄ãxt
->
cuºít_out_∑ckë
);

254 
	`_mosquôto_‰ì
(
c⁄ãxt
->
cuºít_out_∑ckë
);

255 
c⁄ãxt
->
cuºít_out_∑ckë
 = 
NULL
;

257 
c⁄ãxt
->
out_∑ckë
){

258 
	`_mosquôto_∑ckë_˛ónup
(
c⁄ãxt
->
out_∑ckë
);

259 
∑ckë
 = 
c⁄ãxt
->
out_∑ckë
;

260 
c⁄ãxt
->
out_∑ckë
 = c⁄ãxt->out_∑ckë->
√xt
;

261 
	`_mosquôto_‰ì
(
∑ckë
);

263 
c⁄ãxt
->
out_∑ckë
 = 
NULL
;

264 
c⁄ãxt
->
out_∑ckë_œ°
 = 
NULL
;

266 
	`_mosquôto_∑ckë_˛ónup
(&(
c⁄ãxt
->
ö_∑ckë
));

267 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/conf.c

17 
	~<c⁄fig.h
>

19 
	~<limôs.h
>

20 
	~<°dio.h
>

21 
	~<°dlib.h
>

22 
	~<°rög.h
>

23 
	~<î∫o.h
>

25 #ifde‡
WIN32


27 
	~<dúít.h
>

30 #i‚de‡
WIN32


31 
	~<√tdb.h
>

32 
	~<sys/sockë.h
>

34 
	~<wösock2.h
>

35 
	~<ws2t˝ù.h
>

38 #i‡!
deföed
(
WIN32
Ë&& !deföed(
__CYGWIN__
)

39 
	~<sys/sy¶og.h
>

42 
	~<mosquôto_brokî.h
>

43 
	~<mem‹y_mosq.h
>

44 
	~"és_mosq.h
"

45 
	~"utû_mosq.h
"

46 
	~"mqâ3_¥Ÿocﬁ.h
"

48 
	sc⁄fig_ªcur£
 {

49 
	mlog_de°
;

50 
	mlog_de°_£t
;

51 
	mlog_ty≥
;

52 
	mlog_ty≥_£t
;

53 
	mmax_öÊight_mesßges
;

54 
	mmax_queued_mesßges
;

57 #i‡
deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

58 
	~<wödows.h
>

59 
SERVICE_STATUS_HANDLE
 
£rvi˚_h™dÀ
;

62 
_c⁄f_∑r£_boﬁ
(**
tokí
, c⁄° *
«me
, 
boﬁ
 *
vÆue
, *
ßvïå
);

63 
_c⁄f_∑r£_öt
(**
tokí
, c⁄° *
«me
, *
vÆue
, *
ßvïå
);

64 
_c⁄f_∑r£_°rög
(**
tokí
, c⁄° *
«me
, **
vÆue
, *
ßvïå
);

65 
_c⁄fig_ªad_fûe
(
mqâ3_c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
, c⁄° *
fûe
, 
c⁄fig_ªcur£
 *
c⁄fig_tmp
, 
Àvñ
, *
löío
);

67 
	$_c⁄f_©ãm±_ªsﬁve
(c⁄° *
ho°
, c⁄° *
ãxt
, 
log
, c⁄° *
msg
)

69 
addröfo
 
gai_höts
;

70 
addröfo
 *
gai_ªs
;

71 
rc
;

73 
	`mem£t
(&
gai_höts
, 0, (
addröfo
));

74 
gai_höts
.
ai_Ámûy
 = 
PF_UNSPEC
;

75 
gai_höts
.
ai_Êags
 = 
AI_ADDRCONFIG
;

76 
gai_höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

77 
gai_ªs
 = 
NULL
;

78 
rc
 = 
	`gëaddröfo
(
ho°
, 
NULL
, &
gai_höts
, &
gai_ªs
);

79 if(
gai_ªs
){

80 
	`‰ìaddröfo
(
gai_ªs
);

82 if(
rc
 != 0){

83 #i‚de‡
WIN32


84 if(
rc
 =
EAI_SYSTEM
){

85 if(
î∫o
 =
ENOENT
){

86 
	`_mosquôto_log_¥ötf
(
NULL
, 
log
, "%s: U«bÀÅÿªsﬁvê%†%s.", 
msg
, 
ãxt
, 
ho°
);

88 
	`_mosquôto_log_¥ötf
(
NULL
, 
log
, "%s: Eº‹Ñesﬁvög %s: %s.", 
msg
, 
ãxt
, 
	`°ªº‹
(
î∫o
));

91 
	`_mosquôto_log_¥ötf
(
NULL
, 
log
, "%s: Eº‹Ñesﬁvög %s: %s.", 
msg
, 
ãxt
, 
	`gai_°ªº‹
(
rc
));

94 if(
rc
 =
WSAHOST_NOT_FOUND
){

95 
	`_mosquôto_log_¥ötf
(
NULL
, 
log
, "%s: Eº‹Ñesﬁvög %s.", 
msg
, 
ãxt
);

98  
MOSQ_ERR_INVAL
;

100  
MOSQ_ERR_SUCCESS
;

101 
	}
}

103 
	$_c⁄fig_öô_ªlﬂd
(
mqâ3_c⁄fig
 *
c⁄fig
)

105 
i
;

107 if(
c⁄fig
->
a˛_fûe
Ë
	`_mosquôto_‰ì
(config->acl_file);

108 
c⁄fig
->
a˛_fûe
 = 
NULL
;

109 
c⁄fig
->
Ælow_™⁄ymous
 = 
åue
;

110 
c⁄fig
->
Ælow_du∂iˇã_mesßges
 = 
Ál£
;

111 
c⁄fig
->
Ælow_zîo_Àngth_˛õ¡id
 = 
åue
;

112 
c⁄fig
->
auto_id_¥efix
 = 
NULL
;

113 
c⁄fig
->
auto_id_¥efix_Àn
 = 0;

114 
c⁄fig
->
autoßve_öãrvÆ
 = 1800;

115 
c⁄fig
->
autoßve_⁄_ch™ges
 = 
Ál£
;

116 if(
c⁄fig
->
˛õ¡id_¥efixes
Ë
	`_mosquôto_‰ì
(config->clientid_prefixes);

117 
c⁄fig
->
c⁄√˘i⁄_mesßges
 = 
åue
;

118 
c⁄fig
->
˛õ¡id_¥efixes
 = 
NULL
;

119 if(
c⁄fig
->
log_Âå
){

120 
	`f˛o£
(
c⁄fig
->
log_Âå
);

121 
c⁄fig
->
log_Âå
 = 
NULL
;

123 if(
c⁄fig
->
log_fûe
){

124 
	`_mosquôto_‰ì
(
c⁄fig
->
log_fûe
);

125 
c⁄fig
->
log_fûe
 = 
NULL
;

127 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

128 if(
£rvi˚_h™dÀ
){

132 
c⁄fig
->
log_de°
 = 
MQTT3_LOG_NONE
;

134 
c⁄fig
->
log_de°
 = 
MQTT3_LOG_STDERR
;

137 
c⁄fig
->
log_Ácûôy
 = 
LOG_DAEMON
;

138 
c⁄fig
->
log_de°
 = 
MQTT3_LOG_STDERR
;

139 if(
c⁄fig
->
vîbo£
){

140 
c⁄fig
->
log_ty≥
 = 
INT_MAX
;

142 
c⁄fig
->
log_ty≥
 = 
MOSQ_LOG_ERR
 | 
MOSQ_LOG_WARNING
 | 
MOSQ_LOG_NOTICE
 | 
MOSQ_LOG_INFO
;

145 
c⁄fig
->
log_time°amp
 = 
åue
;

146 if(
c⁄fig
->
∑ssw‹d_fûe
Ë
	`_mosquôto_‰ì
(config->password_file);

147 
c⁄fig
->
∑ssw‹d_fûe
 = 
NULL
;

148 
c⁄fig
->
≥rsi°í˚
 = 
Ál£
;

149 if(
c⁄fig
->
≥rsi°í˚_loˇti⁄
Ë
	`_mosquôto_‰ì
(config->persistence_location);

150 
c⁄fig
->
≥rsi°í˚_loˇti⁄
 = 
NULL
;

151 if(
c⁄fig
->
≥rsi°í˚_fûe
Ë
	`_mosquôto_‰ì
(config->persistence_file);

152 
c⁄fig
->
≥rsi°í˚_fûe
 = 
NULL
;

153 
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 = 0;

154 if(
c⁄fig
->
psk_fûe
Ë
	`_mosquôto_‰ì
(config->psk_file);

155 
c⁄fig
->
psk_fûe
 = 
NULL
;

156 
c⁄fig
->
queue_qos0_mesßges
 = 
Ál£
;

157 
c⁄fig
->
ªåy_öãrvÆ
 = 20;

158 
c⁄fig
->
sys_öãrvÆ
 = 10;

159 
c⁄fig
->
upgøde_outgoög_qos
 = 
Ál£
;

160 if(
c⁄fig
->
auth_›ti⁄s
){

161 
i
=0; i<
c⁄fig
->
auth_›ti⁄_cou¡
; i++){

162 
	`_mosquôto_‰ì
(
c⁄fig
->
auth_›ti⁄s
[
i
].
key
);

163 
	`_mosquôto_‰ì
(
c⁄fig
->
auth_›ti⁄s
[
i
].
vÆue
);

165 
	`_mosquôto_‰ì
(
c⁄fig
->
auth_›ti⁄s
);

166 
c⁄fig
->
auth_›ti⁄s
 = 
NULL
;

167 
c⁄fig
->
auth_›ti⁄_cou¡
 = 0;

169 
	}
}

171 
	$mqâ3_c⁄fig_öô
(
mqâ3_c⁄fig
 *
c⁄fig
)

173 
	`mem£t
(
c⁄fig
, 0, (
mqâ3_c⁄fig
));

174 
	`_c⁄fig_öô_ªlﬂd
(
c⁄fig
);

175 
c⁄fig
->
c⁄fig_fûe
 = 
NULL
;

176 
c⁄fig
->
d´m⁄
 = 
Ál£
;

177 
c⁄fig
->
deÁu…_li°íî
.
ho°
 = 
NULL
;

178 
c⁄fig
->
deÁu…_li°íî
.
p‹t
 = 0;

179 
c⁄fig
->
deÁu…_li°íî
.
max_c⁄√˘i⁄s
 = -1;

180 
c⁄fig
->
deÁu…_li°íî
.
mou¡_poöt
 = 
NULL
;

181 
c⁄fig
->
deÁu…_li°íî
.
socks
 = 
NULL
;

182 
c⁄fig
->
deÁu…_li°íî
.
sock_cou¡
 = 0;

183 
c⁄fig
->
deÁu…_li°íî
.
˛õ¡_cou¡
 = 0;

184 
c⁄fig
->
deÁu…_li°íî
.
¥Ÿocﬁ
 = 
mp_mqâ
;

185 
c⁄fig
->
deÁu…_li°íî
.
u£_u£∫ame_as_˛õ¡id
 = 
Ál£
;

186 #ifde‡
WITH_TLS


187 
c⁄fig
->
deÁu…_li°íî
.
és_vîsi⁄
 = 
NULL
;

188 
c⁄fig
->
deÁu…_li°íî
.
ˇfûe
 = 
NULL
;

189 
c⁄fig
->
deÁu…_li°íî
.
ˇ∑th
 = 
NULL
;

190 
c⁄fig
->
deÁu…_li°íî
.
˚πfûe
 = 
NULL
;

191 
c⁄fig
->
deÁu…_li°íî
.
keyfûe
 = 
NULL
;

192 
c⁄fig
->
deÁu…_li°íî
.
cùhîs
 = 
NULL
;

193 
c⁄fig
->
deÁu…_li°íî
.
psk_höt
 = 
NULL
;

194 
c⁄fig
->
deÁu…_li°íî
.
ªquúe_˚πifiˇã
 = 
Ál£
;

195 
c⁄fig
->
deÁu…_li°íî
.
¸lfûe
 = 
NULL
;

196 
c⁄fig
->
deÁu…_li°íî
.
u£_idítôy_as_u£∫ame
 = 
Ál£
;

198 
c⁄fig
->
li°íîs
 = 
NULL
;

199 
c⁄fig
->
li°íî_cou¡
 = 0;

200 
c⁄fig
->
pid_fûe
 = 
NULL
;

201 
c⁄fig
->
u£r
 = 
NULL
;

202 #ifde‡
WITH_BRIDGE


203 
c⁄fig
->
bridges
 = 
NULL
;

204 
c⁄fig
->
bridge_cou¡
 = 0;

206 
c⁄fig
->
auth_∂ugö
 = 
NULL
;

207 
c⁄fig
->
vîbo£
 = 
Ál£
;

208 
c⁄fig
->
mesßge_size_limô
 = 0;

209 
	}
}

211 
	$mqâ3_c⁄fig_˛ónup
(
mqâ3_c⁄fig
 *
c⁄fig
)

213 
i
;

214 #ifde‡
WITH_BRIDGE


215 
j
;

218 if(
c⁄fig
->
a˛_fûe
Ë
	`_mosquôto_‰ì
(config->acl_file);

219 if(
c⁄fig
->
auto_id_¥efix
Ë
	`_mosquôto_‰ì
(config->auto_id_prefix);

220 if(
c⁄fig
->
˛õ¡id_¥efixes
Ë
	`_mosquôto_‰ì
(config->clientid_prefixes);

221 if(
c⁄fig
->
c⁄fig_fûe
Ë
	`_mosquôto_‰ì
(config->config_file);

222 if(
c⁄fig
->
∑ssw‹d_fûe
Ë
	`_mosquôto_‰ì
(config->password_file);

223 if(
c⁄fig
->
≥rsi°í˚_loˇti⁄
Ë
	`_mosquôto_‰ì
(config->persistence_location);

224 if(
c⁄fig
->
≥rsi°í˚_fûe
Ë
	`_mosquôto_‰ì
(config->persistence_file);

225 if(
c⁄fig
->
≥rsi°í˚_fûï©h
Ë
	`_mosquôto_‰ì
(config->persistence_filepath);

226 if(
c⁄fig
->
psk_fûe
Ë
	`_mosquôto_‰ì
(config->psk_file);

227 if(
c⁄fig
->
li°íîs
){

228 
i
=0; i<
c⁄fig
->
li°íî_cou¡
; i++){

229 if(
c⁄fig
->
li°íîs
[
i
].
ho°
Ë
	`_mosquôto_‰ì
(config->listeners[i].host);

230 if(
c⁄fig
->
li°íîs
[
i
].
mou¡_poöt
Ë
	`_mosquôto_‰ì
(config->listeners[i].mount_point);

231 if(
c⁄fig
->
li°íîs
[
i
].
socks
Ë
	`_mosquôto_‰ì
(config->listeners[i].socks);

232 #ifde‡
WITH_TLS


233 if(
c⁄fig
->
li°íîs
[
i
].
ˇfûe
Ë
	`_mosquôto_‰ì
(config->listeners[i].cafile);

234 if(
c⁄fig
->
li°íîs
[
i
].
ˇ∑th
Ë
	`_mosquôto_‰ì
(config->listeners[i].capath);

235 if(
c⁄fig
->
li°íîs
[
i
].
˚πfûe
Ë
	`_mosquôto_‰ì
(config->listeners[i].certfile);

236 if(
c⁄fig
->
li°íîs
[
i
].
keyfûe
Ë
	`_mosquôto_‰ì
(config->listeners[i].keyfile);

237 if(
c⁄fig
->
li°íîs
[
i
].
cùhîs
Ë
	`_mosquôto_‰ì
(config->listeners[i].ciphers);

238 if(
c⁄fig
->
li°íîs
[
i
].
psk_höt
Ë
	`_mosquôto_‰ì
(config->listeners[i].psk_hint);

239 if(
c⁄fig
->
li°íîs
[
i
].
¸lfûe
Ë
	`_mosquôto_‰ì
(config->listeners[i].crlfile);

240 if(
c⁄fig
->
li°íîs
[
i
].
és_vîsi⁄
Ë
	`_mosquôto_‰ì
(config->listeners[i].tls_version);

241 if(
c⁄fig
->
li°íîs
[
i
].
s¶_˘x
Ë
	`SSL_CTX_‰ì
(config->listeners[i].ssl_ctx);

243 #ifde‡
WITH_WEBSOCKETS


244 if(
c⁄fig
->
li°íîs
[
i
].
hâp_dú
Ë
	`_mosquôto_‰ì
(config->listeners[i].http_dir);

247 
	`_mosquôto_‰ì
(
c⁄fig
->
li°íîs
);

249 #ifde‡
WITH_BRIDGE


250 if(
c⁄fig
->
bridges
){

251 
i
=0; i<
c⁄fig
->
bridge_cou¡
; i++){

252 if(
c⁄fig
->
bridges
[
i
].
«me
Ë
	`_mosquôto_‰ì
(config->bridges[i].name);

253 if(
c⁄fig
->
bridges
[
i
].
addªs£s
){

254 
j
=0; j<
c⁄fig
->
bridges
[
i
].
addªss_cou¡
; j++){

255 
	`_mosquôto_‰ì
(
c⁄fig
->
bridges
[
i
].
addªs£s
[
j
].
addªss
);

257 
	`_mosquôto_‰ì
(
c⁄fig
->
bridges
[
i
].
addªs£s
);

259 if(
c⁄fig
->
bridges
[
i
].
ªmŸe_˛õ¡id
Ë
	`_mosquôto_‰ì
(config->bridges[i].remote_clientid);

260 if(
c⁄fig
->
bridges
[
i
].
ªmŸe_u£∫ame
Ë
	`_mosquôto_‰ì
(config->bridges[i].remote_username);

261 if(
c⁄fig
->
bridges
[
i
].
ªmŸe_∑ssw‹d
Ë
	`_mosquôto_‰ì
(config->bridges[i].remote_password);

262 if(
c⁄fig
->
bridges
[
i
].
loˇl_˛õ¡id
Ë
	`_mosquôto_‰ì
(config->bridges[i].local_clientid);

263 if(
c⁄fig
->
bridges
[
i
].
loˇl_u£∫ame
Ë
	`_mosquôto_‰ì
(config->bridges[i].local_username);

264 if(
c⁄fig
->
bridges
[
i
].
loˇl_∑ssw‹d
Ë
	`_mosquôto_‰ì
(config->bridges[i].local_password);

265 if(
c⁄fig
->
bridges
[
i
].
t›ics
){

266 
j
=0; j<
c⁄fig
->
bridges
[
i
].
t›ic_cou¡
; j++){

267 if(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
t›ic
Ë
	`_mosquôto_‰ì
(config->bridges[i].topics[j].topic);

268 if(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
loˇl_¥efix
Ë
	`_mosquôto_‰ì
(config->bridges[i].topics[j].local_prefix);

269 if(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
ªmŸe_¥efix
Ë
	`_mosquôto_‰ì
(config->bridges[i].topics[j].remote_prefix);

270 if(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
loˇl_t›ic
Ë
	`_mosquôto_‰ì
(config->bridges[i].topics[j].local_topic);

271 if(
c⁄fig
->
bridges
[
i
].
t›ics
[
j
].
ªmŸe_t›ic
Ë
	`_mosquôto_‰ì
(config->bridges[i].topics[j].remote_topic);

273 
	`_mosquôto_‰ì
(
c⁄fig
->
bridges
[
i
].
t›ics
);

275 if(
c⁄fig
->
bridges
[
i
].
nŸifiˇti⁄_t›ic
Ë
	`_mosquôto_‰ì
(config->bridges[i].notification_topic);

276 #ifde‡
WITH_TLS


277 if(
c⁄fig
->
bridges
[
i
].
és_vîsi⁄
Ë
	`_mosquôto_‰ì
(config->bridges[i].tls_version);

278 if(
c⁄fig
->
bridges
[
i
].
és_ˇfûe
Ë
	`_mosquôto_‰ì
(config->bridges[i].tls_cafile);

279 #ifde‡
REAL_WITH_TLS_PSK


280 if(
c⁄fig
->
bridges
[
i
].
és_psk_idítôy
Ë
	`_mosquôto_‰ì
(config->bridges[i].tls_psk_identity);

281 if(
c⁄fig
->
bridges
[
i
].
és_psk
Ë
	`_mosquôto_‰ì
(config->bridges[i].tls_psk);

285 
	`_mosquôto_‰ì
(
c⁄fig
->
bridges
);

288 if(
c⁄fig
->
auth_∂ugö
Ë
	`_mosquôto_‰ì
(config->auth_plugin);

289 if(
c⁄fig
->
auth_›ti⁄s
){

290 
i
=0; i<
c⁄fig
->
auth_›ti⁄_cou¡
; i++){

291 
	`_mosquôto_‰ì
(
c⁄fig
->
auth_›ti⁄s
[
i
].
key
);

292 
	`_mosquôto_‰ì
(
c⁄fig
->
auth_›ti⁄s
[
i
].
vÆue
);

294 
	`_mosquôto_‰ì
(
c⁄fig
->
auth_›ti⁄s
);

295 
c⁄fig
->
auth_›ti⁄s
 = 
NULL
;

296 
c⁄fig
->
auth_›ti⁄_cou¡
 = 0;

298 if(
c⁄fig
->
log_Âå
){

299 
	`f˛o£
(
c⁄fig
->
log_Âå
);

300 
c⁄fig
->
log_Âå
 = 
NULL
;

302 if(
c⁄fig
->
log_fûe
){

303 
	`_mosquôto_‰ì
(
c⁄fig
->
log_fûe
);

304 
c⁄fig
->
log_fûe
 = 
NULL
;

306 
	}
}

308 
	$¥öt_ußge
()

310 
	`¥ötf
("mosquôtÿvîsi⁄ %†(buûd d©ê%s)\n\n", 
VERSION
, 
TIMESTAMP
);

311 
	`¥ötf
("mosquitto isán MQTT v3.1 broker.\n\n");

312 
	`¥ötf
("Usage: mosquitto [-c config_file] [-d] [-h] [-pÖort]\n\n");

313 
	`¥ötf
(" -c : specifyÅhe broker config file.\n");

314 
	`¥ötf
(" -d :ÖutÅhe broker intoÅhe backgroundáfter starting.\n");

315 
	`¥ötf
(" -h : displayÅhis help.\n");

316 
	`¥ötf
(" -p : startÅhe brokerÜistening onÅhe specifiedÖort.\n");

317 
	`¥ötf
(" NotÑecommended in conjunction withÅhe -c option.\n");

318 
	`¥ötf
(" -v : verbose mode -ÉnableállÜoggingÅypes. This overrides\n");

319 
	`¥ötf
("ányÜogging options given inÅhe config file.\n");

320 
	`¥ötf
("\nSee http://mosquitto.org/ for more information.\n\n");

321 
	}
}

323 
	$mqâ3_c⁄fig_∑r£_¨gs
(
mqâ3_c⁄fig
 *
c⁄fig
, 
¨gc
, *
¨gv
[])

325 
i
;

326 
p‹t_tmp
;

328 
i
=1; i<
¨gc
; i++){

329 if(!
	`°rcmp
(
¨gv
[
i
], "-c") || !strcmp(argv[i], "--config-file")){

330 if(
i
<
¨gc
-1){

331 
c⁄fig
->
c⁄fig_fûe
 = 
	`_mosquôto_°rdup
(
¨gv
[
i
+1]);

332 if(!
c⁄fig
->
c⁄fig_fûe
){

333 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

334  
MOSQ_ERR_NOMEM
;

337 if(
	`mqâ3_c⁄fig_ªad
(
c⁄fig
, 
Ál£
)){

338 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo open configuration file.");

339  
MOSQ_ERR_INVAL
;

342 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: -cárgument given, butÇo config file specified.");

343  
MOSQ_ERR_INVAL
;

345 
i
++;

346 }if(!
	`°rcmp
(
¨gv
[
i
], "-d") || !strcmp(argv[i], "--daemon")){

347 
c⁄fig
->
d´m⁄
 = 
åue
;

348 }if(!
	`°rcmp
(
¨gv
[
i
], "-h") || !strcmp(argv[i], "--help")){

349 
	`¥öt_ußge
();

350  
MOSQ_ERR_INVAL
;

351 }if(!
	`°rcmp
(
¨gv
[
i
], "-p") || !strcmp(argv[i], "--port")){

352 if(
i
<
¨gc
-1){

353 
p‹t_tmp
 = 
	`©oi
(
¨gv
[
i
+1]);

354 if(
p‹t_tmp
<1 ||Öort_tmp>65535){

355 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹à•ecifõd (%d).", 
p‹t_tmp
);

356  
MOSQ_ERR_INVAL
;

358 if(
c⁄fig
->
deÁu…_li°íî
.
p‹t
){

359 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: DefaultÜistenerÖort specified multipleÅimes. OnlyÅheÜatest will be used.");

361 
c⁄fig
->
deÁu…_li°íî
.
p‹t
 = 
p‹t_tmp
;

364 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: -párgument given, butÇoÖort specified.");

365  
MOSQ_ERR_INVAL
;

367 
i
++;

368 }if(!
	`°rcmp
(
¨gv
[
i
], "-v") || !strcmp(argv[i], "--verbose")){

369 
c⁄fig
->
vîbo£
 = 
åue
;

371 
	`Ârötf
(
°dîr
, "Eº‹: Unknow¿›ti⁄ '%s'.\n",
¨gv
[
i
]);

372 
	`¥öt_ußge
();

373  
MOSQ_ERR_INVAL
;

377 if(
c⁄fig
->
li°íî_cou¡
 == 0

378 #ifde‡
WITH_TLS


379 || 
c⁄fig
->
deÁu…_li°íî
.
ˇfûe


380 || 
c⁄fig
->
deÁu…_li°íî
.
ˇ∑th


381 || 
c⁄fig
->
deÁu…_li°íî
.
˚πfûe


382 || 
c⁄fig
->
deÁu…_li°íî
.
keyfûe


383 || 
c⁄fig
->
deÁu…_li°íî
.
cùhîs


384 || 
c⁄fig
->
deÁu…_li°íî
.
psk_höt


385 || 
c⁄fig
->
deÁu…_li°íî
.
ªquúe_˚πifiˇã


386 || 
c⁄fig
->
deÁu…_li°íî
.
¸lfûe


387 || 
c⁄fig
->
deÁu…_li°íî
.
u£_idítôy_as_u£∫ame


389 || 
c⁄fig
->
deÁu…_li°íî
.
u£_u£∫ame_as_˛õ¡id


390 || 
c⁄fig
->
deÁu…_li°íî
.
ho°


391 || 
c⁄fig
->
deÁu…_li°íî
.
p‹t


392 || 
c⁄fig
->
deÁu…_li°íî
.
max_c⁄√˘i⁄s
 != -1

393 || 
c⁄fig
->
deÁu…_li°íî
.
mou¡_poöt


394 || 
c⁄fig
->
deÁu…_li°íî
.
¥Ÿocﬁ
 !
mp_mqâ
){

396 
c⁄fig
->
li°íî_cou¡
++;

397 
c⁄fig
->
li°íîs
 = 
	`_mosquôto_ªÆloc
(c⁄fig->li°íîs, (
_mqâ3_li°íî
)*c⁄fig->
li°íî_cou¡
);

398 if(!
c⁄fig
->
li°íîs
){

399 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

400  
MOSQ_ERR_NOMEM
;

402 
	`mem£t
(&
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1], 0, (
_mqâ3_li°íî
));

403 if(
c⁄fig
->
deÁu…_li°íî
.
p‹t
){

404 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
p‹t
 = c⁄fig->
deÁu…_li°íî
.port;

406 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
p‹t
 = 1883;

408 if(
c⁄fig
->
deÁu…_li°íî
.
ho°
){

409 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ho°
 = c⁄fig->
deÁu…_li°íî
.host;

411 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ho°
 = 
NULL
;

413 if(
c⁄fig
->
deÁu…_li°íî
.
mou¡_poöt
){

414 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
mou¡_poöt
 = c⁄fig->
deÁu…_li°íî
.mount_point;

416 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
mou¡_poöt
 = 
NULL
;

418 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
max_c⁄√˘i⁄s
 = c⁄fig->
deÁu…_li°íî
.max_connections;

419 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
¥Ÿocﬁ
 = c⁄fig->
deÁu…_li°íî
.protocol;

420 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
˛õ¡_cou¡
 = 0;

421 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
socks
 = 
NULL
;

422 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
sock_cou¡
 = 0;

423 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
˛õ¡_cou¡
 = 0;

424 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
u£_u£∫ame_as_˛õ¡id
 = c⁄fig->
deÁu…_li°íî
.use_username_as_clientid;

425 #ifde‡
WITH_TLS


426 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
és_vîsi⁄
 = c⁄fig->
deÁu…_li°íî
.tls_version;

427 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ˇfûe
 = c⁄fig->
deÁu…_li°íî
.cafile;

428 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ˇ∑th
 = c⁄fig->
deÁu…_li°íî
.capath;

429 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
˚πfûe
 = c⁄fig->
deÁu…_li°íî
.certfile;

430 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
keyfûe
 = c⁄fig->
deÁu…_li°íî
.keyfile;

431 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
cùhîs
 = c⁄fig->
deÁu…_li°íî
.ciphers;

432 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
psk_höt
 = c⁄fig->
deÁu…_li°íî
.psk_hint;

433 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
ªquúe_˚πifiˇã
 = c⁄fig->
deÁu…_li°íî
.require_certificate;

434 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
s¶_˘x
 = 
NULL
;

435 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
¸lfûe
 = c⁄fig->
deÁu…_li°íî
.crlfile;

436 
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1].
u£_idítôy_as_u£∫ame
 = c⁄fig->
deÁu…_li°íî
.use_identity_as_username;

441 if(!
c⁄fig
->
u£r
){

442 
c⁄fig
->
u£r
 = "mosquitto";

444 if(
c⁄fig
->
vîbo£
){

445 
c⁄fig
->
log_ty≥
 = 
INT_MAX
;

447  
MOSQ_ERR_SUCCESS
;

448 
	}
}

450 
	$mqâ3_c⁄fig_ªad
(
mqâ3_c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
)

452 
rc
 = 
MOSQ_ERR_SUCCESS
;

453 
c⁄fig_ªcur£
 
¸
;

454 
löío
;

455 
Àn
;

456 #ifde‡
WITH_BRIDGE


457 
i
;

460 
¸
.
log_de°
 = 
MQTT3_LOG_NONE
;

461 
¸
.
log_de°_£t
 = 0;

462 
¸
.
log_ty≥
 = 
MOSQ_LOG_NONE
;

463 
¸
.
log_ty≥_£t
 = 0;

464 
¸
.
max_öÊight_mesßges
 = 20;

465 
¸
.
max_queued_mesßges
 = 100;

467 if(!
c⁄fig
->
c⁄fig_fûe
)  0;

469 if(
ªlﬂd
){

471 
	`_c⁄fig_öô_ªlﬂd
(
c⁄fig
);

473 
rc
 = 
	`_c⁄fig_ªad_fûe
(
c⁄fig
, 
ªlﬂd
, c⁄fig->
c⁄fig_fûe
, &
¸
, 0, &
löío
);

474 if(
rc
){

475 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ foundáà%s:%d.", 
c⁄fig
->
c⁄fig_fûe
, 
löío
);

476  
rc
;

479 #ifde‡
WITH_PERSISTENCE


480 if(
c⁄fig
->
≥rsi°í˚
){

481 if(!
c⁄fig
->
≥rsi°í˚_fûe
){

482 
c⁄fig
->
≥rsi°í˚_fûe
 = 
	`_mosquôto_°rdup
("mosquitto.db");

483 if(!
c⁄fig
->
≥rsi°í˚_fûe
Ë 
MOSQ_ERR_NOMEM
;

485 if(
c⁄fig
->
≥rsi°í˚_fûï©h
){

486 
	`_mosquôto_‰ì
(
c⁄fig
->
≥rsi°í˚_fûï©h
);

488 if(
c⁄fig
->
≥rsi°í˚_loˇti⁄
 && 
	`°æí
(config->persistence_location)){

489 
Àn
 = 
	`°æí
(
c⁄fig
->
≥rsi°í˚_loˇti⁄
Ë+ såÀn(c⁄fig->
≥rsi°í˚_fûe
) + 1;

490 
c⁄fig
->
≥rsi°í˚_fûï©h
 = 
	`_mosquôto_mÆloc
(
Àn
);

491 if(!
c⁄fig
->
≥rsi°í˚_fûï©h
Ë 
MOSQ_ERR_NOMEM
;

492 
	`¢¥ötf
(
c⁄fig
->
≥rsi°í˚_fûï©h
, 
Àn
, "%s%s", c⁄fig->
≥rsi°í˚_loˇti⁄
, c⁄fig->
≥rsi°í˚_fûe
);

494 
c⁄fig
->
≥rsi°í˚_fûï©h
 = 
	`_mosquôto_°rdup
(c⁄fig->
≥rsi°í˚_fûe
);

495 if(!
c⁄fig
->
≥rsi°í˚_fûï©h
Ë 
MOSQ_ERR_NOMEM
;

502 if(!
c⁄fig
->
u£r
){

503 
c⁄fig
->
u£r
 = "mosquitto";

506 
	`mqâ3_db_limôs_£t
(
¸
.
max_öÊight_mesßges
, cr.
max_queued_mesßges
);

508 #ifde‡
WITH_BRIDGE


509 
i
=0; i<
c⁄fig
->
bridge_cou¡
; i++){

510 if(!
c⁄fig
->
bridges
[
i
].
«me
 || !c⁄fig->bridges[i].
addªs£s
 || !c⁄fig->bridges[i].
t›ic_cou¡
){

511 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

512  
MOSQ_ERR_INVAL
;

514 #ifde‡
REAL_WITH_TLS_PSK


515 if(
c⁄fig
->
bridges
[
i
].
és_psk
 && !c⁄fig->bridges[i].
és_psk_idítôy
){

516 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration: missing bridge_identity.\n");

517  
MOSQ_ERR_INVAL
;

519 if(
c⁄fig
->
bridges
[
i
].
és_psk_idítôy
 && !c⁄fig->bridges[i].
és_psk
){

520 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration: missing bridge_psk.\n");

521  
MOSQ_ERR_INVAL
;

527 if(
¸
.
log_de°_£t
){

528 
c⁄fig
->
log_de°
 = 
¸
.log_dest;

530 if(
c⁄fig
->
vîbo£
){

531 
c⁄fig
->
log_ty≥
 = 
INT_MAX
;

532 }if(
¸
.
log_ty≥_£t
){

533 
c⁄fig
->
log_ty≥
 = 
¸
.log_type;

535  
MOSQ_ERR_SUCCESS
;

536 
	}
}

538 
	$_c⁄fig_ªad_fûe_c‹e
(
mqâ3_c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
, c⁄° *
fûe
, 
c⁄fig_ªcur£
 *
¸
, 
Àvñ
, *
löío
, 
FILE
 *
Âå
)

540 
rc
;

541 
buf
[1024];

542 *
tokí
;

543 
tmp_öt
;

544 *
ßvïå
 = 
NULL
;

545 #ifde‡
WITH_BRIDGE


546 
_mqâ3_bridge
 *
cur_bridge
 = 
NULL
;

547 
_mqâ3_bridge_t›ic
 *
cur_t›ic
;

549 
time_t
 
expú©i⁄_mu…
;

550 *
key
;

551 *
c⁄f_fûe
;

552 #ifde‡
WIN32


553 
HANDLE
 
fh
;

554 
dú∑th
[
MAX_PATH
];

555 
WIN32_FIND_DATA
 
föd_d©a
;

557 
DIR
 *
dh
;

558 
dúít
 *
de
;

560 
Àn
;

561 
_mqâ3_li°íî
 *
cur_li°íî
 = &
c⁄fig
->
deÁu…_li°íî
;

562 #ifde‡
WITH_BRIDGE


563 *
addªss
;

564 
i
;

566 
löío_ext
;

568 *
löío
 = 0;

570 
	`fgës
(
buf
, 1024, 
Âå
)){

571 (*
löío
)++;

572 if(
buf
[0] != '#' && buf[0] != 10 && buf[0] != 13){

573 
buf
[
	`°æí
(buf)-1] == 10 || buf[strlen(buf)-1] == 13){

574 
buf
[
	`°æí
(buf)-1] = 0;

576 
tokí
 = 
	`°πok_r
(
buf
, " ", &
ßvïå
);

577 if(
tokí
){

578 if(!
	`°rcmp
(
tokí
, "acl_file")){

579 if(
ªlﬂd
){

580 if(
c⁄fig
->
a˛_fûe
){

581 
	`_mosquôto_‰ì
(
c⁄fig
->
a˛_fûe
);

582 
c⁄fig
->
a˛_fûe
 = 
NULL
;

585 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "a˛_fûe", &
c⁄fig
->
a˛_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

586 }if(!
	`°rcmp
(
tokí
, "address") || !strcmp(token, "addresses")){

587 #ifde‡
WITH_BRIDGE


588 if(
ªlﬂd
) ;

589 if(!
cur_bridge
 || cur_bridge->
addªs£s
){

590 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

591  
MOSQ_ERR_INVAL
;

593 (
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
))){

594 
cur_bridge
->
addªss_cou¡
++;

595 
cur_bridge
->
addªs£s
 = 
	`_mosquôto_ªÆloc
(cur_bridge->addªs£s, (
bridge_addªss
)*cur_bridge->
addªss_cou¡
);

596 if(!
cur_bridge
->
addªs£s
){

597 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

598  
MOSQ_ERR_NOMEM
;

600 
cur_bridge
->
addªs£s
[cur_bridge->
addªss_cou¡
-1].
addªss
 = 
tokí
;

602 
i
=0; i<
cur_bridge
->
addªss_cou¡
; i++){

603 
addªss
 = 
	`°πok_r
(
cur_bridge
->
addªs£s
[
i
].addªss, ":", &
ßvïå
);

604 if(
addªss
){

605 
tokí
 = 
	`°πok_r
(
NULL
, ":", &
ßvïå
);

606 if(
tokí
){

607 
tmp_öt
 = 
	`©oi
(
tokí
);

608 if(
tmp_öt
 < 1 ||Åmp_int > 65535){

609 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹àvÆuê(%d).", 
tmp_öt
);

610  
MOSQ_ERR_INVAL
;

612 
cur_bridge
->
addªs£s
[
i
].
p‹t
 = 
tmp_öt
;

614 
cur_bridge
->
addªs£s
[
i
].
p‹t
 = 1883;

616 
cur_bridge
->
addªs£s
[
i
].
addªss
 = 
	`_mosquôto_°rdup
(address);

617 
	`_c⁄f_©ãm±_ªsﬁve
(
addªss
, "bridgêaddªss", 
MOSQ_LOG_WARNING
, "Warning");

620 if(
cur_bridge
->
addªss_cou¡
 == 0){

621 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Emptyáddress value in configuration.");

622  
MOSQ_ERR_INVAL
;

625 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

627 }if(!
	`°rcmp
(
tokí
, "allow_anonymous")){

628 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "Ælow_™⁄ymous", &
c⁄fig
->
Ælow_™⁄ymous
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

629 }if(!
	`°rcmp
(
tokí
, "allow_duplicate_messages")){

630 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "Ælow_du∂iˇã_mesßges", &
c⁄fig
->
Ælow_du∂iˇã_mesßges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

631 }if(!
	`°rcmp
(
tokí
, "allow_zero_length_clientid")){

632 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "Ælow_zîo_Àngth_˛õ¡id", &
c⁄fig
->
Ælow_zîo_Àngth_˛õ¡id
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

633 }if(!
	`°∫cmp
(
tokí
, "auth_opt_", 9)){

634 if(
	`°æí
(
tokí
) < 12){

636 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalidáuth_opt_ config option.");

637  
MOSQ_ERR_INVAL
;

639 
key
 = 
	`_mosquôto_°rdup
(&
tokí
[9]);

640 if(!
key
){

641 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

642  
MOSQ_ERR_NOMEM
;

643 }if(
	`STREMPTY
(
key
)){

644 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalidáuth_opt_ config option.");

645  
MOSQ_ERR_INVAL
;

647 
tokí
 +9+
	`°æí
(
key
)+1;

648 
tokí
[0] == ' ' ||Åoken[0] == '\t'){

649 
tokí
++;

651 if(
tokí
[0]){

652 
c⁄fig
->
auth_›ti⁄_cou¡
++;

653 
c⁄fig
->
auth_›ti⁄s
 = 
	`_mosquôto_ªÆloc
(c⁄fig->auth_›ti⁄s, c⁄fig->
auth_›ti⁄_cou¡
*(
mosquôto_auth_›t
));

654 if(!
c⁄fig
->
auth_›ti⁄s
){

655 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

656  
MOSQ_ERR_NOMEM
;

658 
c⁄fig
->
auth_›ti⁄s
[c⁄fig->
auth_›ti⁄_cou¡
-1].
key
 = key;

659 
c⁄fig
->
auth_›ti⁄s
[c⁄fig->
auth_›ti⁄_cou¡
-1].
vÆue
 = 
	`_mosquôto_°rdup
(
tokí
);

660 if(!
c⁄fig
->
auth_›ti⁄s
[c⁄fig->
auth_›ti⁄_cou¡
-1].
vÆue
){

661 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

662  
MOSQ_ERR_NOMEM
;

665 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
key
);

666  
MOSQ_ERR_INVAL
;

668 }if(!
	`°rcmp
(
tokí
, "auth_plugin")){

669 if(
ªlﬂd
) ;

670 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "auth_∂ugö", &
c⁄fig
->
auth_∂ugö
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

671 }if(!
	`°rcmp
(
tokí
, "auto_id_prefix")){

672 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "auto_id_¥efix", &
c⁄fig
->
auto_id_¥efix
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

673 if(
c⁄fig
->
auto_id_¥efix
){

674 
c⁄fig
->
auto_id_¥efix_Àn
 = 
	`°æí
(c⁄fig->
auto_id_¥efix
);

676 
c⁄fig
->
auto_id_¥efix_Àn
 = 0;

678 }if(!
	`°rcmp
(
tokí
, "autosave_interval")){

679 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "autoßve_öãrvÆ", &
c⁄fig
->
autoßve_öãrvÆ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

680 if(
c⁄fig
->
autoßve_öãrvÆ
 < 0) config->autosave_interval = 0;

681 }if(!
	`°rcmp
(
tokí
, "autosave_on_changes")){

682 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "autoßve_⁄_ch™ges", &
c⁄fig
->
autoßve_⁄_ch™ges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

683 }if(!
	`°rcmp
(
tokí
, "bind_address")){

684 if(
ªlﬂd
) ;

685 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "deÁu…Üi°íî böd_addªss", &
c⁄fig
->
deÁu…_li°íî
.
ho°
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

686 if(
	`_c⁄f_©ãm±_ªsﬁve
(
c⁄fig
->
deÁu…_li°íî
.
ho°
, "böd_addªss", 
MOSQ_LOG_ERR
, "Error")){

687  
MOSQ_ERR_INVAL
;

689 }if(!
	`°rcmp
(
tokí
, "bridge_attempt_unsubscribe")){

690 #ifde‡
WITH_BRIDGE


691 if(
ªlﬂd
) ;

692 if(!
cur_bridge
){

693 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

694  
MOSQ_ERR_INVAL
;

696 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "bridge_©ãm±_unsubs¸ibe", &
cur_bridge
->
©ãm±_unsubs¸ibe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

698 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

700 }if(!
	`°rcmp
(
tokí
, "bridge_cafile")){

701 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

702 if(
ªlﬂd
) ;

703 if(!
cur_bridge
){

704 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

705  
MOSQ_ERR_INVAL
;

707 #ifde‡
REAL_WITH_TLS_PSK


708 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

709 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

710  
MOSQ_ERR_INVAL
;

713 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

714 if(
tokí
){

715 if(
cur_bridge
->
és_ˇfûe
){

716 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate bridge_cafile value in bridge configuration.");

717  
MOSQ_ERR_INVAL
;

719 
cur_bridge
->
és_ˇfûe
 = 
	`_mosquôto_°rdup
(
tokí
);

720 if(!
cur_bridge
->
és_ˇfûe
){

721 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

722  
MOSQ_ERR_NOMEM
;

725 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_cafile value in configuration.");

726  
MOSQ_ERR_INVAL
;

729 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

731 }if(!
	`°rcmp
(
tokí
, "bridge_capath")){

732 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

733 if(
ªlﬂd
) ;

734 if(!
cur_bridge
){

735 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

736  
MOSQ_ERR_INVAL
;

738 #ifde‡
REAL_WITH_TLS_PSK


739 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

740 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

741  
MOSQ_ERR_INVAL
;

744 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

745 if(
tokí
){

746 if(
cur_bridge
->
és_ˇ∑th
){

747 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate bridge_capath value in bridge configuration.");

748  
MOSQ_ERR_INVAL
;

750 
cur_bridge
->
és_ˇ∑th
 = 
	`_mosquôto_°rdup
(
tokí
);

751 if(!
cur_bridge
->
és_ˇ∑th
){

752 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

753  
MOSQ_ERR_NOMEM
;

756 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_capath value in configuration.");

757  
MOSQ_ERR_INVAL
;

760 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

762 }if(!
	`°rcmp
(
tokí
, "bridge_certfile")){

763 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

764 if(
ªlﬂd
) ;

765 if(!
cur_bridge
){

766 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

767  
MOSQ_ERR_INVAL
;

769 #ifde‡
REAL_WITH_TLS_PSK


770 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

771 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

772  
MOSQ_ERR_INVAL
;

775 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

776 if(
tokí
){

777 if(
cur_bridge
->
és_˚πfûe
){

778 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate bridge_certfile value in bridge configuration.");

779  
MOSQ_ERR_INVAL
;

781 
cur_bridge
->
és_˚πfûe
 = 
	`_mosquôto_°rdup
(
tokí
);

782 if(!
cur_bridge
->
és_˚πfûe
){

783 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

784  
MOSQ_ERR_NOMEM
;

787 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_certfile value in configuration.");

788  
MOSQ_ERR_INVAL
;

791 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

793 }if(!
	`°rcmp
(
tokí
, "bridge_identity")){

794 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
REAL_WITH_TLS_PSK
)

795 if(
ªlﬂd
) ;

796 if(!
cur_bridge
){

797 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

798  
MOSQ_ERR_INVAL
;

800 if(
cur_bridge
->
és_ˇfûe
 || cur_bridge->
és_ˇ∑th
 || cur_bridge->
és_˚πfûe
 || cur_bridge->
és_keyfûe
){

801 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateánd identityÉncryption iná single bridge.");

802  
MOSQ_ERR_INVAL
;

804 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

805 if(
tokí
){

806 if(
cur_bridge
->
és_psk_idítôy
){

807 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate bridge_identity value in bridge configuration.");

808  
MOSQ_ERR_INVAL
;

810 
cur_bridge
->
és_psk_idítôy
 = 
	`_mosquôto_°rdup
(
tokí
);

811 if(!
cur_bridge
->
és_psk_idítôy
){

812 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

813  
MOSQ_ERR_NOMEM
;

816 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_identity value in configuration.");

817  
MOSQ_ERR_INVAL
;

820 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS-PSK supportÇotávailable.");

822 }if(!
	`°rcmp
(
tokí
, "bridge_insecure")){

823 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

824 if(
ªlﬂd
) ;

825 if(!
cur_bridge
){

826 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

827  
MOSQ_ERR_INVAL
;

829 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "bridge_ö£cuª", &
cur_bridge
->
és_ö£cuª
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

830 if(
cur_bridge
->
és_ö£cuª
){

831 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "W¨nög: Bridgê%†usög in£cuª mode.", 
cur_bridge
->
«me
);

834 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS-PSK supportÇotávailable.");

836 }if(!
	`°rcmp
(
tokí
, "bridge_keyfile")){

837 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

838 if(
ªlﬂd
) ;

839 if(!
cur_bridge
){

840 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

841  
MOSQ_ERR_INVAL
;

843 #ifde‡
REAL_WITH_TLS_PSK


844 if(
cur_bridge
->
és_psk_idítôy
 || cur_bridge->
és_psk
){

845 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

846  
MOSQ_ERR_INVAL
;

849 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

850 if(
tokí
){

851 if(
cur_bridge
->
és_keyfûe
){

852 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate bridge_keyfile value in bridge configuration.");

853  
MOSQ_ERR_INVAL
;

855 
cur_bridge
->
és_keyfûe
 = 
	`_mosquôto_°rdup
(
tokí
);

856 if(!
cur_bridge
->
és_keyfûe
){

857 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

858  
MOSQ_ERR_NOMEM
;

861 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_keyfile value in configuration.");

862  
MOSQ_ERR_INVAL
;

865 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

867 }if(!
	`°rcmp
(
tokí
, "bridge_protocol_version")){

868 #ifde‡
WITH_BRIDGE


869 if(
ªlﬂd
) ;

870 if(!
cur_bridge
){

871 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

872  
MOSQ_ERR_INVAL
;

874 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

875 if(
tokí
){

876 if(!
	`°rcmp
(
tokí
, "mqttv31")){

877 
cur_bridge
->
¥Ÿocﬁ_vîsi⁄
 = 
mosq_p_mqâ31
;

878 }if(!
	`°rcmp
(
tokí
, "mqttv311")){

879 
cur_bridge
->
¥Ÿocﬁ_vîsi⁄
 = 
mosq_p_mqâ311
;

881 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridge_¥Ÿocﬁ_vîsi⁄ vÆuê(%s).", 
tokí
);

882  
MOSQ_ERR_INVAL
;

885 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_protocol_version value in configuration.");

886  
MOSQ_ERR_INVAL
;

889 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

891 }if(!
	`°rcmp
(
tokí
, "bridge_psk")){

892 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
REAL_WITH_TLS_PSK
)

893 if(
ªlﬂd
) ;

894 if(!
cur_bridge
){

895 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

896  
MOSQ_ERR_INVAL
;

898 if(
cur_bridge
->
és_ˇfûe
 || cur_bridge->
és_ˇ∑th
 || cur_bridge->
és_˚πfûe
 || cur_bridge->
és_keyfûe
){

899 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná single bridge.");

900  
MOSQ_ERR_INVAL
;

902 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

903 if(
tokí
){

904 if(
cur_bridge
->
és_psk
){

905 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate bridge_psk value in bridge configuration.");

906  
MOSQ_ERR_INVAL
;

908 
cur_bridge
->
és_psk
 = 
	`_mosquôto_°rdup
(
tokí
);

909 if(!
cur_bridge
->
és_psk
){

910 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

911  
MOSQ_ERR_NOMEM
;

914 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_psk value in configuration.");

915  
MOSQ_ERR_INVAL
;

918 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS-PSK supportÇotávailable.");

920 }if(!
	`°rcmp
(
tokí
, "bridge_tls_version")){

921 #i‡
	`deföed
(
WITH_BRIDGE
Ë&& deföed(
WITH_TLS
)

922 if(
ªlﬂd
) ;

923 if(!
cur_bridge
){

924 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

925  
MOSQ_ERR_INVAL
;

927 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

928 if(
tokí
){

929 if(
cur_bridge
->
és_vîsi⁄
){

930 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate bridge_tls_version value in bridge configuration.");

931  
MOSQ_ERR_INVAL
;

933 
cur_bridge
->
és_vîsi⁄
 = 
	`_mosquôto_°rdup
(
tokí
);

934 if(!
cur_bridge
->
és_vîsi⁄
){

935 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

936  
MOSQ_ERR_NOMEM
;

939 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty bridge_tls_version value in configuration.");

940  
MOSQ_ERR_INVAL
;

943 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridgeánd/or TLS supportÇotávailable.");

945 }if(!
	`°rcmp
(
tokí
, "cafile")){

946 #i‡
	`deföed
(
WITH_TLS
)

947 if(
ªlﬂd
) ;

948 if(
cur_li°íî
->
psk_höt
){

949 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná singleÜistener.");

950  
MOSQ_ERR_INVAL
;

952 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "ˇfûe", &
cur_li°íî
->
ˇfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

954 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

956 }if(!
	`°rcmp
(
tokí
, "capath")){

957 #ifde‡
WITH_TLS


958 if(
ªlﬂd
) ;

959 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "ˇ∑th", &
cur_li°íî
->
ˇ∑th
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

961 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

963 }if(!
	`°rcmp
(
tokí
, "certfile")){

964 #ifde‡
WITH_TLS


965 if(
ªlﬂd
) ;

966 if(
cur_li°íî
->
psk_höt
){

967 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Cannot use both certificateándÖskÉncryption iná singleÜistener.");

968  
MOSQ_ERR_INVAL
;

970 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "˚πfûe", &
cur_li°íî
->
˚πfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

972 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

974 }if(!
	`°rcmp
(
tokí
, "ciphers")){

975 #ifde‡
WITH_TLS


976 if(
ªlﬂd
) ;

977 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "cùhîs", &
cur_li°íî
->
cùhîs
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

979 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

981 }if(!
	`°rcmp
(
tokí
, "clientid") || !strcmp(token, "remote_clientid")){

982 #ifde‡
WITH_BRIDGE


983 if(
ªlﬂd
) ;

984 if(!
cur_bridge
){

985 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

986  
MOSQ_ERR_INVAL
;

988 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

989 if(
tokí
){

990 if(
cur_bridge
->
ªmŸe_˛õ¡id
){

991 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate clientid value in bridge configuration.");

992  
MOSQ_ERR_INVAL
;

994 
cur_bridge
->
ªmŸe_˛õ¡id
 = 
	`_mosquôto_°rdup
(
tokí
);

995 if(!
cur_bridge
->
ªmŸe_˛õ¡id
){

996 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

997  
MOSQ_ERR_NOMEM
;

1000 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty clientid value in configuration.");

1001  
MOSQ_ERR_INVAL
;

1004 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1006 }if(!
	`°rcmp
(
tokí
, "cleansession")){

1007 #ifde‡
WITH_BRIDGE


1008 if(
ªlﬂd
) ;

1009 if(!
cur_bridge
){

1010 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1011  
MOSQ_ERR_INVAL
;

1013 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "˛ón£ssi⁄", &
cur_bridge
->
˛ón_£ssi⁄
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1015 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1017 }if(!
	`°rcmp
(
tokí
, "clientid_prefixes")){

1018 if(
ªlﬂd
){

1019 if(
c⁄fig
->
˛õ¡id_¥efixes
){

1020 
	`_mosquôto_‰ì
(
c⁄fig
->
˛õ¡id_¥efixes
);

1021 
c⁄fig
->
˛õ¡id_¥efixes
 = 
NULL
;

1024 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "˛õ¡id_¥efixes", &
c⁄fig
->
˛õ¡id_¥efixes
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1025 }if(!
	`°rcmp
(
tokí
, "connection")){

1026 #ifde‡
WITH_BRIDGE


1027 if(
ªlﬂd
) ;

1028 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1029 if(
tokí
){

1030 
c⁄fig
->
bridge_cou¡
++;

1031 
c⁄fig
->
bridges
 = 
	`_mosquôto_ªÆloc
(c⁄fig->bridges, c⁄fig->
bridge_cou¡
*(
_mqâ3_bridge
));

1032 if(!
c⁄fig
->
bridges
){

1033 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1034  
MOSQ_ERR_NOMEM
;

1036 
cur_bridge
 = &(
c⁄fig
->
bridges
[c⁄fig->
bridge_cou¡
-1]);

1037 
	`mem£t
(
cur_bridge
, 0, (
_mqâ3_bridge
));

1038 
cur_bridge
->
«me
 = 
	`_mosquôto_°rdup
(
tokí
);

1039 if(!
cur_bridge
->
«me
){

1040 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1041  
MOSQ_ERR_NOMEM
;

1043 
cur_bridge
->
kì∑live
 = 60;

1044 
cur_bridge
->
nŸifiˇti⁄s
 = 
åue
;

1045 
cur_bridge
->
°¨t_ty≥
 = 
b°_autom©ic
;

1046 
cur_bridge
->
idÀ_timeout
 = 60;

1047 
cur_bridge
->
ª°¨t_timeout
 = 30;

1048 
cur_bridge
->
thªshﬁd
 = 10;

1049 
cur_bridge
->
åy_¥iv©e
 = 
åue
;

1050 
cur_bridge
->
©ãm±_unsubs¸ibe
 = 
åue
;

1051 
cur_bridge
->
¥Ÿocﬁ_vîsi⁄
 = 
mosq_p_mqâ31
;

1053 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty connection value in configuration.");

1054  
MOSQ_ERR_INVAL
;

1057 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1059 }if(!
	`°rcmp
(
tokí
, "connection_messages")){

1060 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
c⁄√˘i⁄_mesßges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1061 }if(!
	`°rcmp
(
tokí
, "crlfile")){

1062 #ifde‡
WITH_TLS


1063 if(
ªlﬂd
) ;

1064 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "¸lfûe", &
cur_li°íî
->
¸lfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1066 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1068 }if(!
	`°rcmp
(
tokí
, "http_dir")){

1069 #ifde‡
WITH_WEBSOCKETS


1070 if(
ªlﬂd
) ;

1071 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "hâp_dú", &
cur_li°íî
->
hâp_dú
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1073 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Websockets supportÇotávailable.");

1075 }if(!
	`°rcmp
(
tokí
, "idle_timeout")){

1076 #ifde‡
WITH_BRIDGE


1077 if(
ªlﬂd
) ;

1078 if(!
cur_bridge
){

1079 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1080  
MOSQ_ERR_INVAL
;

1082 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "idÀ_timeout", &
cur_bridge
->
idÀ_timeout
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1083 if(
cur_bridge
->
idÀ_timeout
 < 1){

1084 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "idle_timeout intervalÅooÜow, using 1 second.");

1085 
cur_bridge
->
idÀ_timeout
 = 1;

1088 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1090 }if(!
	`°rcmp
(
tokí
, "include_dir")){

1091 if(
Àvñ
 == 0){

1093 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1094 if(!
tokí
){

1095 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty include_dir value in configuration.");

1097 #ifde‡
WIN32


1098 
	`¢¥ötf
(
dú∑th
, 
MAX_PATH
, "%s\\*.c⁄f", 
tokí
);

1099 
fh
 = 
	`FödFú°Fûe
(
dú∑th
, &
föd_d©a
);

1100 if(
fh
 =
INVALID_HANDLE_VALUE
){

1101 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›í in˛ude_dú '%s'.", 
tokí
);

1106 
Àn
 = 
	`°æí
(
tokí
)+1+°æí(
föd_d©a
.
cFûeName
)+1;

1107 
c⁄f_fûe
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

1108 if(!
c⁄f_fûe
){

1109 
	`FödClo£
(
fh
);

1110  
MOSQ_ERR_NOMEM
;

1112 
	`¢¥ötf
(
c⁄f_fûe
, 
Àn
, "%s\\%s", 
tokí
, 
föd_d©a
.
cFûeName
);

1113 
c⁄f_fûe
[
Àn
] = '\0';

1115 
rc
 = 
	`_c⁄fig_ªad_fûe
(
c⁄fig
, 
ªlﬂd
, 
c⁄f_fûe
, 
¸
, 
Àvñ
+1, &
löío_ext
);

1116 if(
rc
){

1117 
	`FödClo£
(
fh
);

1118 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ foundáà%s:%d.", 
c⁄f_fûe
, 
löío_ext
);

1119 
	`_mosquôto_‰ì
(
c⁄f_fûe
);

1120  
rc
;

1122 
	`_mosquôto_‰ì
(
c⁄f_fûe
);

1123 }
	`FödNextFûe
(
fh
, &
föd_d©a
));

1125 
	`FödClo£
(
fh
);

1127 
dh
 = 
	`›ídú
(
tokí
);

1128 if(!
dh
){

1129 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›í in˛ude_dú '%s'.", 
tokí
);

1132 (
de
 = 
	`ªaddú
(
dh
)Ë!
NULL
){

1133 if(
	`°æí
(
de
->
d_«me
) > 5){

1134 if(!
	`°rcmp
(&
de
->
d_«me
[
	`°æí
(de->d_name)-5], ".conf")){

1135 
Àn
 = 
	`°æí
(
tokí
)+1+°æí(
de
->
d_«me
)+1;

1136 
c⁄f_fûe
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

1137 if(!
c⁄f_fûe
){

1138 
	`˛o£dú
(
dh
);

1139  
MOSQ_ERR_NOMEM
;

1141 
	`¢¥ötf
(
c⁄f_fûe
, 
Àn
, "%s/%s", 
tokí
, 
de
->
d_«me
);

1142 
c⁄f_fûe
[
Àn
] = '\0';

1144 
rc
 = 
	`_c⁄fig_ªad_fûe
(
c⁄fig
, 
ªlﬂd
, 
c⁄f_fûe
, 
¸
, 
Àvñ
+1, &
löío_ext
);

1145 if(
rc
){

1146 
	`˛o£dú
(
dh
);

1147 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ foundáà%s:%d.", 
c⁄f_fûe
, 
löío_ext
);

1148 
	`_mosquôto_‰ì
(
c⁄f_fûe
);

1149  
rc
;

1151 
	`_mosquôto_‰ì
(
c⁄f_fûe
);

1155 
	`˛o£dú
(
dh
);

1158 }if(!
	`°rcmp
(
tokí
, "keepalive_interval")){

1159 #ifde‡
WITH_BRIDGE


1160 if(
ªlﬂd
) ;

1161 if(!
cur_bridge
){

1162 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1163  
MOSQ_ERR_INVAL
;

1165 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "kì∑live_öãrvÆ", &
cur_bridge
->
kì∑live
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1166 if(
cur_bridge
->
kì∑live
 < 5){

1167 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "keepalive intervalÅooÜow, using 5 seconds.");

1168 
cur_bridge
->
kì∑live
 = 5;

1171 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1173 }if(!
	`°rcmp
(
tokí
, "keyfile")){

1174 #ifde‡
WITH_TLS


1175 if(
ªlﬂd
) ;

1176 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "keyfûe", &
cur_li°íî
->
keyfûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1178 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1180 }if(!
	`°rcmp
(
tokí
, "listener")){

1181 if(
ªlﬂd
) ;

1182 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1183 if(
tokí
){

1184 
c⁄fig
->
li°íî_cou¡
++;

1185 
c⁄fig
->
li°íîs
 = 
	`_mosquôto_ªÆloc
(c⁄fig->li°íîs, (
_mqâ3_li°íî
)*c⁄fig->
li°íî_cou¡
);

1186 if(!
c⁄fig
->
li°íîs
){

1187 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1188  
MOSQ_ERR_NOMEM
;

1190 
tmp_öt
 = 
	`©oi
(
tokí
);

1191 if(
tmp_öt
 < 1 ||Åmp_int > 65535){

1192 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹àvÆuê(%d).", 
tmp_öt
);

1193  
MOSQ_ERR_INVAL
;

1195 
cur_li°íî
 = &
c⁄fig
->
li°íîs
[c⁄fig->
li°íî_cou¡
-1];

1196 
	`mem£t
(
cur_li°íî
, 0, (
_mqâ3_li°íî
));

1197 
cur_li°íî
->
¥Ÿocﬁ
 = 
mp_mqâ
;

1198 
cur_li°íî
->
p‹t
 = 
tmp_öt
;

1199 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1200 if(
tokí
){

1201 
cur_li°íî
->
ho°
 = 
	`_mosquôto_°rdup
(
tokí
);

1203 
cur_li°íî
->
ho°
 = 
NULL
;

1206 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÜistener value in configuration.");

1207  
MOSQ_ERR_INVAL
;

1209 }if(!
	`°rcmp
(
tokí
, "local_clientid")){

1210 #ifde‡
WITH_BRIDGE


1211 if(
ªlﬂd
) ;

1212 if(!
cur_bridge
){

1213 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1214  
MOSQ_ERR_INVAL
;

1216 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1217 if(
tokí
){

1218 if(
cur_bridge
->
loˇl_˛õ¡id
){

1219 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: DuplicateÜocal_clientid value in bridge configuration.");

1220  
MOSQ_ERR_INVAL
;

1222 
cur_bridge
->
loˇl_˛õ¡id
 = 
	`_mosquôto_°rdup
(
tokí
);

1223 if(!
cur_bridge
->
loˇl_˛õ¡id
){

1224 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1225  
MOSQ_ERR_NOMEM
;

1228 
cur_bridge
->
loˇl_˛õ¡id
 = 
NULL
;

1231 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1233 }if(!
	`°rcmp
(
tokí
, "local_password")){

1234 #ifde‡
WITH_BRIDGE


1235 if(
ªlﬂd
) ;

1236 if(!
cur_bridge
){

1237 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1238  
MOSQ_ERR_INVAL
;

1240 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1241 if(
tokí
){

1242 if(
cur_bridge
->
loˇl_∑ssw‹d
){

1243 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: DuplicateÜocal_password value in bridge configuration.");

1244  
MOSQ_ERR_INVAL
;

1246 
cur_bridge
->
loˇl_∑ssw‹d
 = 
	`_mosquôto_°rdup
(
tokí
);

1247 if(!
cur_bridge
->
loˇl_∑ssw‹d
){

1248 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1249  
MOSQ_ERR_NOMEM
;

1252 
cur_bridge
->
loˇl_∑ssw‹d
 = 
NULL
;

1255 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1257 }if(!
	`°rcmp
(
tokí
, "local_username")){

1258 #ifde‡
WITH_BRIDGE


1259 if(
ªlﬂd
) ;

1260 if(!
cur_bridge
){

1261 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1262  
MOSQ_ERR_INVAL
;

1264 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1265 if(
tokí
){

1266 if(
cur_bridge
->
loˇl_u£∫ame
){

1267 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: DuplicateÜocal_username value in bridge configuration.");

1268  
MOSQ_ERR_INVAL
;

1270 
cur_bridge
->
loˇl_u£∫ame
 = 
	`_mosquôto_°rdup
(
tokí
);

1271 if(!
cur_bridge
->
loˇl_u£∫ame
){

1272 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1273  
MOSQ_ERR_NOMEM
;

1276 
cur_bridge
->
loˇl_u£∫ame
 = 
NULL
;

1279 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1281 }if(!
	`°rcmp
(
tokí
, "log_dest")){

1282 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1283 if(
tokí
){

1284 
¸
->
log_de°_£t
 = 1;

1285 if(!
	`°rcmp
(
tokí
, "none")){

1286 
¸
->
log_de°
 = 
MQTT3_LOG_NONE
;

1287 }if(!
	`°rcmp
(
tokí
, "syslog")){

1288 
¸
->
log_de°
 |
MQTT3_LOG_SYSLOG
;

1289 }if(!
	`°rcmp
(
tokí
, "stdout")){

1290 
¸
->
log_de°
 |
MQTT3_LOG_STDOUT
;

1291 }if(!
	`°rcmp
(
tokí
, "stderr")){

1292 
¸
->
log_de°
 |
MQTT3_LOG_STDERR
;

1293 }if(!
	`°rcmp
(
tokí
, "topic")){

1294 
¸
->
log_de°
 |
MQTT3_LOG_TOPIC
;

1295 }if(!
	`°rcmp
(
tokí
, "file")){

1296 
¸
->
log_de°
 |
MQTT3_LOG_FILE
;

1297 if(
c⁄fig
->
log_Âå
 || c⁄fig->
log_fûe
){

1298 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate \"log_dest file\" value.");

1299  
MOSQ_ERR_INVAL
;

1302 
tokí
 = &tokí[
	`°æí
(token)+1];

1303 
tokí
[0] == ' ' ||Åoken[0] == '\t'){

1304 
tokí
++;

1306 if(
tokí
[0]){

1307 
c⁄fig
->
log_fûe
 = 
	`_mosquôto_°rdup
(
tokí
);

1308 if(!
c⁄fig
->
log_fûe
){

1309 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1310  
MOSQ_ERR_NOMEM
;

1313 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty \"log_dest file\" value in configuration.");

1314  
MOSQ_ERR_INVAL
;

1317 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÜog_de° vÆuê(%s).", 
tokí
);

1318  
MOSQ_ERR_INVAL
;

1320 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

1321 if(
£rvi˚_h™dÀ
){

1322 if(
¸
->
log_de°
 =
MQTT3_LOG_STDOUT
 || cr->log_de° =
MQTT3_LOG_STDERR
){

1323 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: CannotÜogÅo stdout/stderr whenÑunningásá Windows service.");

1324  
MOSQ_ERR_INVAL
;

1329 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÜog_dest value in configuration.");

1330  
MOSQ_ERR_INVAL
;

1332 }if(!
	`°rcmp
(
tokí
, "log_facility")){

1333 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

1334 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning:Üog_facilityÇot supported on Windows.");

1336 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "log_Ácûôy", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1337 
tmp_öt
){

1339 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL0
;

1342 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL1
;

1345 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL2
;

1348 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL3
;

1351 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL4
;

1354 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL5
;

1357 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL6
;

1360 
c⁄fig
->
log_Ácûôy
 = 
LOG_LOCAL7
;

1363 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÜog_Ácûôy vÆuê(%d).", 
tmp_öt
);

1364  
MOSQ_ERR_INVAL
;

1367 }if(!
	`°rcmp
(
tokí
, "log_timestamp")){

1368 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
log_time°amp
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1369 }if(!
	`°rcmp
(
tokí
, "log_type")){

1370 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1371 if(
tokí
){

1372 
¸
->
log_ty≥_£t
 = 1;

1373 if(!
	`°rcmp
(
tokí
, "none")){

1374 
¸
->
log_ty≥
 = 
MOSQ_LOG_NONE
;

1375 }if(!
	`°rcmp
(
tokí
, "information")){

1376 
¸
->
log_ty≥
 |
MOSQ_LOG_INFO
;

1377 }if(!
	`°rcmp
(
tokí
, "notice")){

1378 
¸
->
log_ty≥
 |
MOSQ_LOG_NOTICE
;

1379 }if(!
	`°rcmp
(
tokí
, "warning")){

1380 
¸
->
log_ty≥
 |
MOSQ_LOG_WARNING
;

1381 }if(!
	`°rcmp
(
tokí
, "error")){

1382 
¸
->
log_ty≥
 |
MOSQ_LOG_ERR
;

1383 }if(!
	`°rcmp
(
tokí
, "debug")){

1384 
¸
->
log_ty≥
 |
MOSQ_LOG_DEBUG
;

1385 }if(!
	`°rcmp
(
tokí
, "subscribe")){

1386 
¸
->
log_ty≥
 |
MOSQ_LOG_SUBSCRIBE
;

1387 }if(!
	`°rcmp
(
tokí
, "unsubscribe")){

1388 
¸
->
log_ty≥
 |
MOSQ_LOG_UNSUBSCRIBE
;

1389 #ifde‡
WITH_WEBSOCKETS


1390 }if(!
	`°rcmp
(
tokí
, "websockets")){

1391 
¸
->
log_ty≥
 |
MOSQ_LOG_WEBSOCKETS
;

1393 }if(!
	`°rcmp
(
tokí
, "all")){

1394 
¸
->
log_ty≥
 = 
INT_MAX
;

1396 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÜog_ty≥ vÆuê(%s).", 
tokí
);

1397  
MOSQ_ERR_INVAL
;

1400 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÜog_type value in configuration.");

1402 }if(!
	`°rcmp
(
tokí
, "max_connections")){

1403 if(
ªlﬂd
) ;

1404 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1405 if(
tokí
){

1406 
cur_li°íî
->
max_c⁄√˘i⁄s
 = 
	`©oi
(
tokí
);

1407 if(
cur_li°íî
->
max_c⁄√˘i⁄s
 < 0) cur_listener->max_connections = -1;

1409 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_connections value in configuration.");

1411 }if(!
	`°rcmp
(
tokí
, "max_inflight_messages")){

1412 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1413 if(
tokí
){

1414 
¸
->
max_öÊight_mesßges
 = 
	`©oi
(
tokí
);

1415 if(
¸
->
max_öÊight_mesßges
 < 0) cr->max_inflight_messages = 0;

1417 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_inflight_messages value in configuration.");

1419 }if(!
	`°rcmp
(
tokí
, "max_queued_messages")){

1420 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1421 if(
tokí
){

1422 
¸
->
max_queued_mesßges
 = 
	`©oi
(
tokí
);

1423 if(
¸
->
max_queued_mesßges
 < 0) cr->max_queued_messages = 0;

1425 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty max_queued_messages value in configuration.");

1427 }if(!
	`°rcmp
(
tokí
, "message_size_limit")){

1428 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "mesßge_size_limô", (*)&
c⁄fig
->
mesßge_size_limô
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1429 if(
c⁄fig
->
mesßge_size_limô
 > 
MQTT_MAX_PAYLOAD
){

1430 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid mesßge_size_limô vÆuê(%d).", 
c⁄fig
->
mesßge_size_limô
);

1431  
MOSQ_ERR_INVAL
;

1433 }if(!
	`°rcmp
(
tokí
, "mount_point")){

1434 if(
ªlﬂd
) ;

1435 if(
c⁄fig
->
li°íî_cou¡
 == 0){

1436 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: You must use createáÜistener before usingÅhe mount_point option inÅhe configuration file.");

1437  
MOSQ_ERR_INVAL
;

1439 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "mou¡_poöt", &
cur_li°íî
->
mou¡_poöt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1440 if(
	`mosquôto_pub_t›ic_check
(
cur_li°íî
->
mou¡_poöt
Ë!
MOSQ_ERR_SUCCESS
){

1441 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

1443 
cur_li°íî
->
mou¡_poöt
);

1444  
MOSQ_ERR_INVAL
;

1446 }if(!
	`°rcmp
(
tokí
, "notifications")){

1447 #ifde‡
WITH_BRIDGE


1448 if(
ªlﬂd
) ;

1449 if(!
cur_bridge
){

1450 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1451  
MOSQ_ERR_INVAL
;

1453 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "nŸifiˇti⁄s", &
cur_bridge
->
nŸifiˇti⁄s
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1455 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1457 }if(!
	`°rcmp
(
tokí
, "notification_topic")){

1458 #ifde‡
WITH_BRIDGE


1459 if(
ªlﬂd
) ;

1460 if(!
cur_bridge
){

1461 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1462  
MOSQ_ERR_INVAL
;

1464 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "nŸifiˇti⁄_t›ic", &
cur_bridge
->
nŸifiˇti⁄_t›ic
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1466 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1468 }if(!
	`°rcmp
(
tokí
, "password") || !strcmp(token, "remote_password")){

1469 #ifde‡
WITH_BRIDGE


1470 if(
ªlﬂd
) ;

1471 if(!
cur_bridge
){

1472 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1473  
MOSQ_ERR_INVAL
;

1475 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1476 if(
tokí
){

1477 if(
cur_bridge
->
ªmŸe_∑ssw‹d
){

1478 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: DuplicateÖassword value in bridge configuration.");

1479  
MOSQ_ERR_INVAL
;

1481 
cur_bridge
->
ªmŸe_∑ssw‹d
 = 
	`_mosquôto_°rdup
(
tokí
);

1482 if(!
cur_bridge
->
ªmŸe_∑ssw‹d
){

1483 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1484  
MOSQ_ERR_NOMEM
;

1487 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÖassword value in configuration.");

1488  
MOSQ_ERR_INVAL
;

1491 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1493 }if(!
	`°rcmp
(
tokí
, "password_file")){

1494 if(
ªlﬂd
){

1495 if(
c⁄fig
->
∑ssw‹d_fûe
){

1496 
	`_mosquôto_‰ì
(
c⁄fig
->
∑ssw‹d_fûe
);

1497 
c⁄fig
->
∑ssw‹d_fûe
 = 
NULL
;

1500 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "∑ssw‹d_fûe", &
c⁄fig
->
∑ssw‹d_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1501 }if(!
	`°rcmp
(
tokí
, "persistence") || !strcmp(token, "retained_persistence")){

1502 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
≥rsi°í˚
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1503 }if(!
	`°rcmp
(
tokí
, "persistence_file")){

1504 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "≥rsi°í˚_fûe", &
c⁄fig
->
≥rsi°í˚_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1505 }if(!
	`°rcmp
(
tokí
, "persistence_location")){

1506 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "≥rsi°í˚_loˇti⁄", &
c⁄fig
->
≥rsi°í˚_loˇti⁄
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1507 }if(!
	`°rcmp
(
tokí
, "persistent_client_expiration")){

1508 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1509 if(
tokí
){

1510 
tokí
[
	`°æí
(token)-1]){

1512 
expú©i⁄_mu…
 = 3600;

1515 
expú©i⁄_mu…
 = 86400;

1518 
expú©i⁄_mu…
 = 86400*7;

1521 
expú©i⁄_mu…
 = 86400*30;

1524 
expú©i⁄_mu…
 = 86400*365;

1527 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: InvalidÖersistent_client_expiration duration in configuration.");

1528  
MOSQ_ERR_INVAL
;

1530 
tokí
[
	`°æí
(token)-1] = '\0';

1531 
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 = 
	`©oi
(
tokí
)*
expú©i⁄_mu…
;

1532 if(
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 <= 0){

1533 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: InvalidÖersistent_client_expiration duration in configuration.");

1534  
MOSQ_ERR_INVAL
;

1537 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÖersistent_client_expiration value in configuration.");

1539 }if(!
	`°rcmp
(
tokí
, "pid_file")){

1540 if(
ªlﬂd
) ;

1541 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "pid_fûe", &
c⁄fig
->
pid_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1542 }if(!
	`°rcmp
(
tokí
, "port")){

1543 if(
ªlﬂd
) ;

1544 if(
c⁄fig
->
deÁu…_li°íî
.
p‹t
){

1545 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: DefaultÜistenerÖort specified multipleÅimes. OnlyÅheÜatest will be used.");

1547 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "p‹t", &
tmp_öt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1548 if(
tmp_öt
 < 1 ||Åmp_int > 65535){

1549 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖ‹àvÆuê(%d).", 
tmp_öt
);

1550  
MOSQ_ERR_INVAL
;

1552 
c⁄fig
->
deÁu…_li°íî
.
p‹t
 = 
tmp_öt
;

1553 }if(!
	`°rcmp
(
tokí
, "protocol")){

1554 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1555 if(
tokí
){

1556 if(!
	`°rcmp
(
tokí
, "mqtt")){

1557 
cur_li°íî
->
¥Ÿocﬁ
 = 
mp_mqâ
;

1562 }if(!
	`°rcmp
(
tokí
, "websockets")){

1563 #ifde‡
WITH_WEBSOCKETS


1564 
cur_li°íî
->
¥Ÿocﬁ
 = 
mp_websockës
;

1565 
c⁄fig
->
have_websockës_li°íî
 = 
åue
;

1567 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Websockets supportÇotávailable.");

1568  
MOSQ_ERR_INVAL
;

1571 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖrŸocﬁ vÆuê(%s).", 
tokí
);

1572  
MOSQ_ERR_INVAL
;

1575 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÖrotocol value in configuration.");

1577 }if(!
	`°rcmp
(
tokí
, "psk_file")){

1578 #ifde‡
REAL_WITH_TLS_PSK


1579 if(
ªlﬂd
){

1580 if(
c⁄fig
->
psk_fûe
){

1581 
	`_mosquôto_‰ì
(
c⁄fig
->
psk_fûe
);

1582 
c⁄fig
->
psk_fûe
 = 
NULL
;

1585 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "psk_fûe", &
c⁄fig
->
psk_fûe
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1587 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS/TLS-PSK supportÇotávailable.");

1589 }if(!
	`°rcmp
(
tokí
, "psk_hint")){

1590 #ifde‡
REAL_WITH_TLS_PSK


1591 if(
ªlﬂd
) ;

1592 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "psk_höt", &
cur_li°íî
->
psk_höt
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1594 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS/TLS-PSK supportÇotávailable.");

1596 }if(!
	`°rcmp
(
tokí
, "queue_qos0_messages")){

1597 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
queue_qos0_mesßges
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1598 }if(!
	`°rcmp
(
tokí
, "require_certificate")){

1599 #ifde‡
WITH_TLS


1600 if(
ªlﬂd
) ;

1601 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "ªquúe_˚πifiˇã", &
cur_li°íî
->
ªquúe_˚πifiˇã
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1603 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1605 }if(!
	`°rcmp
(
tokí
, "restart_timeout")){

1606 #ifde‡
WITH_BRIDGE


1607 if(
ªlﬂd
) ;

1608 if(!
cur_bridge
){

1609 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1610  
MOSQ_ERR_INVAL
;

1612 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "ª°¨t_timeout", &
cur_bridge
->
ª°¨t_timeout
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1613 if(
cur_bridge
->
ª°¨t_timeout
 < 1){

1614 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "restart_timeout intervalÅooÜow, using 1 second.");

1615 
cur_bridge
->
ª°¨t_timeout
 = 1;

1618 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1620 }if(!
	`°rcmp
(
tokí
, "retry_interval")){

1621 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "ªåy_öãrvÆ", &
c⁄fig
->
ªåy_öãrvÆ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1622 if(
c⁄fig
->
ªåy_öãrvÆ
 < 1 || config->retry_interval > 3600){

1623 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÑëry_öãrvÆ vÆuê(%d).", 
c⁄fig
->
ªåy_öãrvÆ
);

1624  
MOSQ_ERR_INVAL
;

1626 }if(!
	`°rcmp
(
tokí
, "round_robin")){

1627 #ifde‡
WITH_BRIDGE


1628 if(
ªlﬂd
) ;

1629 if(!
cur_bridge
){

1630 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1631  
MOSQ_ERR_INVAL
;

1633 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "round_robö", &
cur_bridge
->
round_robö
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1635 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1637 }if(!
	`°rcmp
(
tokí
, "start_type")){

1638 #ifde‡
WITH_BRIDGE


1639 if(
ªlﬂd
) ;

1640 if(!
cur_bridge
){

1641 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1642  
MOSQ_ERR_INVAL
;

1644 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1645 if(
tokí
){

1646 if(!
	`°rcmp
(
tokí
, "automatic")){

1647 
cur_bridge
->
°¨t_ty≥
 = 
b°_autom©ic
;

1648 }if(!
	`°rcmp
(
tokí
, "lazy")){

1649 
cur_bridge
->
°¨t_ty≥
 = 
b°_œzy
;

1650 }if(!
	`°rcmp
(
tokí
, "manual")){

1651 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Manual start_typeÇot supported.");

1652  
MOSQ_ERR_INVAL
;

1653 }if(!
	`°rcmp
(
tokí
, "once")){

1654 
cur_bridge
->
°¨t_ty≥
 = 
b°_⁄˚
;

1656 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid sèπ_ty≥ vÆuêö c⁄figuøti⁄ (%s).", 
tokí
);

1657  
MOSQ_ERR_INVAL
;

1660 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty start_type value in configuration.");

1661  
MOSQ_ERR_INVAL
;

1664 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1666 }if(!
	`°rcmp
(
tokí
, "store_clean_interval")){

1667 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: store_clean_interval isÇoÜongerÇeeded.");

1668 }if(!
	`°rcmp
(
tokí
, "sys_interval")){

1669 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "sys_öãrvÆ", &
c⁄fig
->
sys_öãrvÆ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1670 if(
c⁄fig
->
sys_öãrvÆ
 < 0 || config->sys_interval > 65535){

1671 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid sys_öãrvÆ vÆuê(%d).", 
c⁄fig
->
sys_öãrvÆ
);

1672  
MOSQ_ERR_INVAL
;

1674 }if(!
	`°rcmp
(
tokí
, "threshold")){

1675 #ifde‡
WITH_BRIDGE


1676 if(
ªlﬂd
) ;

1677 if(!
cur_bridge
){

1678 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1679  
MOSQ_ERR_INVAL
;

1681 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "thªshﬁd", &
cur_bridge
->
thªshﬁd
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1682 if(
cur_bridge
->
thªshﬁd
 < 1){

1683 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "thresholdÅooÜow, using 1 message.");

1684 
cur_bridge
->
thªshﬁd
 = 1;

1687 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1689 }if(!
	`°rcmp
(
tokí
, "tls_version")){

1690 #i‡
	`deföed
(
WITH_TLS
)

1691 if(
ªlﬂd
) ;

1692 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "és_vîsi⁄", &
cur_li°íî
->
és_vîsi⁄
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1694 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1696 }if(!
	`°rcmp
(
tokí
, "topic")){

1697 #ifde‡
WITH_BRIDGE


1698 if(
ªlﬂd
) ;

1699 if(!
cur_bridge
){

1700 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1701  
MOSQ_ERR_INVAL
;

1703 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1704 if(
tokí
){

1705 
cur_bridge
->
t›ic_cou¡
++;

1706 
cur_bridge
->
t›ics
 = 
	`_mosquôto_ªÆloc
(cur_bridge->topics,

1707 (
_mqâ3_bridge_t›ic
)*
cur_bridge
->
t›ic_cou¡
);

1708 if(!
cur_bridge
->
t›ics
){

1709 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1710  
MOSQ_ERR_NOMEM
;

1712 
cur_t›ic
 = &
cur_bridge
->
t›ics
[cur_bridge->
t›ic_cou¡
-1];

1713 if(!
	`°rcmp
(
tokí
, "\"\"")){

1714 
cur_t›ic
->
t›ic
 = 
NULL
;

1716 
cur_t›ic
->
t›ic
 = 
	`_mosquôto_°rdup
(
tokí
);

1717 if(!
cur_t›ic
->
t›ic
){

1718 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1719  
MOSQ_ERR_NOMEM
;

1722 
cur_t›ic
->
dúe˘i⁄
 = 
bd_out
;

1723 
cur_t›ic
->
qos
 = 0;

1724 
cur_t›ic
->
loˇl_¥efix
 = 
NULL
;

1725 
cur_t›ic
->
ªmŸe_¥efix
 = 
NULL
;

1727 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÅopic value in configuration.");

1728  
MOSQ_ERR_INVAL
;

1730 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1731 if(
tokí
){

1732 if(!
	`°rˇ£cmp
(
tokí
, "out")){

1733 
cur_t›ic
->
dúe˘i⁄
 = 
bd_out
;

1734 }if(!
	`°rˇ£cmp
(
tokí
, "in")){

1735 
cur_t›ic
->
dúe˘i⁄
 = 
bd_ö
;

1736 }if(!
	`°rˇ£cmp
(
tokí
, "both")){

1737 
cur_t›ic
->
dúe˘i⁄
 = 
bd_bŸh
;

1739 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêt›i¯dúe˘i⁄ '%s'.", 
tokí
);

1740  
MOSQ_ERR_INVAL
;

1742 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1743 if(
tokí
){

1744 
cur_t›ic
->
qos
 = 
	`©oi
(
tokí
);

1745 if(
cur_t›ic
->
qos
 < 0 || cur_topic->qos > 2){

1746 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêQoSÜevñ '%s'.", 
tokí
);

1747  
MOSQ_ERR_INVAL
;

1750 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1751 if(
tokí
){

1752 
cur_bridge
->
t›ic_ªm≠pög
 = 
åue
;

1753 if(!
	`°rcmp
(
tokí
, "\"\"")){

1754 
cur_t›ic
->
loˇl_¥efix
 = 
NULL
;

1756 if(
	`mosquôto_pub_t›ic_check
(
tokí
Ë!
MOSQ_ERR_SUCCESS
){

1757 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêt›i¯loˇ»¥efix '%s'.", 
tokí
);

1758  
MOSQ_ERR_INVAL
;

1760 
cur_t›ic
->
loˇl_¥efix
 = 
	`_mosquôto_°rdup
(
tokí
);

1761 if(!
cur_t›ic
->
loˇl_¥efix
){

1762 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1763  
MOSQ_ERR_NOMEM
;

1767 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1768 if(
tokí
){

1769 if(!
	`°rcmp
(
tokí
, "\"\"")){

1770 
cur_t›ic
->
ªmŸe_¥efix
 = 
NULL
;

1772 if(
	`mosquôto_pub_t›ic_check
(
tokí
Ë!
MOSQ_ERR_SUCCESS
){

1773 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid bridgêt›i¯ªmŸê¥efix '%s'.", 
tokí
);

1774  
MOSQ_ERR_INVAL
;

1776 
cur_t›ic
->
ªmŸe_¥efix
 = 
	`_mosquôto_°rdup
(
tokí
);

1777 if(!
cur_t›ic
->
ªmŸe_¥efix
){

1778 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1779  
MOSQ_ERR_NOMEM
;

1786 if(
cur_t›ic
->
t›ic
 =
NULL
 &&

1787 (
cur_t›ic
->
loˇl_¥efix
 =
NULL
 || cur_t›ic->
ªmŸe_¥efix
 == NULL)){

1789 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridgeÑemapping.");

1790  
MOSQ_ERR_INVAL
;

1792 if(
cur_t›ic
->
loˇl_¥efix
){

1793 if(
cur_t›ic
->
t›ic
){

1794 
Àn
 = 
	`°æí
(
cur_t›ic
->
t›ic
Ë+ såÀn(cur_t›ic->
loˇl_¥efix
)+1;

1795 
cur_t›ic
->
loˇl_t›ic
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

1796 if(!
cur_t›ic
->
loˇl_t›ic
){

1797 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1798  
MOSQ_ERR_NOMEM
;

1800 
	`¢¥ötf
(
cur_t›ic
->
loˇl_t›ic
, 
Àn
+1, "%s%s", cur_t›ic->
loˇl_¥efix
, cur_t›ic->
t›ic
);

1801 
cur_t›ic
->
loˇl_t›ic
[
Àn
] = '\0';

1803 
cur_t›ic
->
loˇl_t›ic
 = 
	`_mosquôto_°rdup
(cur_t›ic->
loˇl_¥efix
);

1804 if(!
cur_t›ic
->
loˇl_t›ic
){

1805 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1806  
MOSQ_ERR_NOMEM
;

1810 
cur_t›ic
->
loˇl_t›ic
 = 
	`_mosquôto_°rdup
(cur_t›ic->
t›ic
);

1811 if(!
cur_t›ic
->
loˇl_t›ic
){

1812 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1813  
MOSQ_ERR_NOMEM
;

1817 if(
cur_t›ic
->
ªmŸe_¥efix
){

1818 if(
cur_t›ic
->
t›ic
){

1819 
Àn
 = 
	`°æí
(
cur_t›ic
->
t›ic
Ë+ såÀn(cur_t›ic->
ªmŸe_¥efix
)+1;

1820 
cur_t›ic
->
ªmŸe_t›ic
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

1821 if(!
cur_t›ic
->
ªmŸe_t›ic
){

1822 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1823  
MOSQ_ERR_NOMEM
;

1825 
	`¢¥ötf
(
cur_t›ic
->
ªmŸe_t›ic
, 
Àn
, "%s%s", cur_t›ic->
ªmŸe_¥efix
, cur_t›ic->
t›ic
);

1826 
cur_t›ic
->
ªmŸe_t›ic
[
Àn
] = '\0';

1828 
cur_t›ic
->
ªmŸe_t›ic
 = 
	`_mosquôto_°rdup
(cur_t›ic->
ªmŸe_¥efix
);

1829 if(!
cur_t›ic
->
ªmŸe_t›ic
){

1830 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1831  
MOSQ_ERR_NOMEM
;

1835 
cur_t›ic
->
ªmŸe_t›ic
 = 
	`_mosquôto_°rdup
(cur_t›ic->
t›ic
);

1836 if(!
cur_t›ic
->
ªmŸe_t›ic
){

1837 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1838  
MOSQ_ERR_NOMEM
;

1842 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1844 }if(!
	`°rcmp
(
tokí
, "try_private")){

1845 #ifde‡
WITH_BRIDGE


1846 if(
ªlﬂd
) ;

1847 if(!
cur_bridge
){

1848 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1849  
MOSQ_ERR_INVAL
;

1851 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "åy_¥iv©e", &
cur_bridge
->
åy_¥iv©e
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1853 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1855 }if(!
	`°rcmp
(
tokí
, "upgrade_outgoing_qos")){

1856 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
,Åokí, &
c⁄fig
->
upgøde_outgoög_qos
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1857 }if(!
	`°rcmp
(
tokí
, "use_identity_as_username")){

1858 #ifde‡
WITH_TLS


1859 if(
ªlﬂd
) ;

1860 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "u£_idítôy_as_u£∫ame", &
cur_li°íî
->
u£_idítôy_as_u£∫ame
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1862 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: TLS supportÇotávailable.");

1864 }if(!
	`°rcmp
(
tokí
, "user")){

1865 if(
ªlﬂd
) ;

1866 if(
	`_c⁄f_∑r£_°rög
(&
tokí
, "u£r", &
c⁄fig
->
u£r
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1867 }if(!
	`°rcmp
(
tokí
, "use_username_as_clientid")){

1868 if(
ªlﬂd
) ;

1869 if(
	`_c⁄f_∑r£_boﬁ
(&
tokí
, "u£_u£∫ame_as_˛õ¡id", &
cur_li°íî
->
u£_u£∫ame_as_˛õ¡id
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1870 }if(!
	`°rcmp
(
tokí
, "username") || !strcmp(token, "remote_username")){

1871 #ifde‡
WITH_BRIDGE


1872 if(
ªlﬂd
) ;

1873 if(!
cur_bridge
){

1874 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid bridge configuration.");

1875  
MOSQ_ERR_INVAL
;

1877 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1878 if(
tokí
){

1879 if(
cur_bridge
->
ªmŸe_u£∫ame
){

1880 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Duplicate username value in bridge configuration.");

1881  
MOSQ_ERR_INVAL
;

1883 
cur_bridge
->
ªmŸe_u£∫ame
 = 
	`_mosquôto_°rdup
(
tokí
);

1884 if(!
cur_bridge
->
ªmŸe_u£∫ame
){

1885 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1886  
MOSQ_ERR_NOMEM
;

1889 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Empty username value in configuration.");

1890  
MOSQ_ERR_INVAL
;

1893 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Bridge supportÇotávailable.");

1895 }if(!
	`°rcmp
(
tokí
, "websockets_log_level")){

1896 #ifde‡
WITH_WEBSOCKETS


1897 if(
	`_c⁄f_∑r£_öt
(&
tokí
, "websockës_log_Àvñ", &
c⁄fig
->
websockës_log_Àvñ
, 
ßvïå
)Ë 
MOSQ_ERR_INVAL
;

1899 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Websockets supportÇotávailable.");

1901 }if(!
	`°rcmp
(
tokí
, "trace_level")

1902 || !
	`°rcmp
(
tokí
, "ffdc_output")

1903 || !
	`°rcmp
(
tokí
, "max_log_entries")

1904 || !
	`°rcmp
(
tokí
, "trace_output")){

1905 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "W¨nög: Unsuµ‹ãdÑsmb c⁄figuøti⁄ o±i⁄ \"%s\".", 
tokí
);

1907 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Unknow¿c⁄figuøti⁄ v¨übÀ \"%s\".", 
tokí
);

1908  
MOSQ_ERR_INVAL
;

1913  
MOSQ_ERR_SUCCESS
;

1914 
	}
}

1916 
	$_c⁄fig_ªad_fûe
(
mqâ3_c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
, c⁄° *
fûe
, 
c⁄fig_ªcur£
 *
¸
, 
Àvñ
, *
löío
)

1918 
rc
;

1919 
FILE
 *
Âå
 = 
NULL
;

1921 
Âå
 = 
	`_mosquôto_f›í
(
fûe
, "rt");

1922 if(!
Âå
){

1923 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›í c⁄fig fûê%s\n", 
fûe
);

1927 
rc
 = 
	`_c⁄fig_ªad_fûe_c‹e
(
c⁄fig
, 
ªlﬂd
, 
fûe
, 
¸
, 
Àvñ
, 
löío
, 
Âå
);

1928 
	`f˛o£
(
Âå
);

1930  
rc
;

1931 
	}
}

1933 
	$_c⁄f_∑r£_boﬁ
(**
tokí
, c⁄° *
«me
, 
boﬁ
 *
vÆue
, *
ßvïå
)

1935 *
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1936 if(*
tokí
){

1937 if(!
	`°rcmp
(*
tokí
, "false") || !strcmp(*token, "0")){

1938 *
vÆue
 = 
Ál£
;

1939 }if(!
	`°rcmp
(*
tokí
, "true") || !strcmp(*token, "1")){

1940 *
vÆue
 = 
åue
;

1942 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid %†vÆuê(%s).", 
«me
, *
tokí
);

1945 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
«me
);

1946  
MOSQ_ERR_INVAL
;

1949  
MOSQ_ERR_SUCCESS
;

1950 
	}
}

1952 
	$_c⁄f_∑r£_öt
(**
tokí
, c⁄° *
«me
, *
vÆue
, *
ßvïå
)

1954 *
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

1955 if(*
tokí
){

1956 *
vÆue
 = 
	`©oi
(*
tokí
);

1958 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
«me
);

1959  
MOSQ_ERR_INVAL
;

1962  
MOSQ_ERR_SUCCESS
;

1963 
	}
}

1965 
	$_c⁄f_∑r£_°rög
(**
tokí
, c⁄° *
«me
, **
vÆue
, *
ßvïå
)

1967 *
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

1968 if(*
tokí
){

1969 if(*
vÆue
){

1970 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Du∂iˇã %†vÆuêö c⁄figuøti⁄.", 
«me
);

1971  
MOSQ_ERR_INVAL
;

1974 (*
tokí
)[0] == ' ' || (*token)[0] == '\t'){

1975 (*
tokí
)++;

1977 *
vÆue
 = 
	`_mosquôto_°rdup
(*
tokí
);

1978 if(!*
vÆue
){

1979 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

1980  
MOSQ_ERR_NOMEM
;

1983 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±y %†vÆuêö c⁄figuøti⁄.", 
«me
);

1984  
MOSQ_ERR_INVAL
;

1986  
MOSQ_ERR_SUCCESS
;

1987 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/context.c

17 
	~<as£π.h
>

18 
	~<time.h
>

20 
	~<c⁄fig.h
>

22 
	~<mosquôto_brokî.h
>

23 
	~<mem‹y_mosq.h
>

24 
	~<time_mosq.h
>

26 
	~"uthash.h
"

28 
mosquôto
 *
	$mqâ3_c⁄ãxt_öô
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
)

30 
mosquôto
 *
c⁄ãxt
;

31 
addªss
[1024];

33 
c⁄ãxt
 = 
	`_mosquôto_ˇŒoc
(1, (
mosquôto
));

34 if(!
c⁄ãxt
Ë 
NULL
;

36 
c⁄ãxt
->
°©e
 = 
mosq_cs_√w
;

37 
c⁄ãxt
->
sock
 = sock;

38 
c⁄ãxt
->
œ°_msg_ö
 = 
	`mosquôto_time
();

39 
c⁄ãxt
->
œ°_msg_out
 = 
	`mosquôto_time
();

40 
c⁄ãxt
->
kì∑live
 = 60;

41 
c⁄ãxt
->
˛ón_£ssi⁄
 = 
åue
;

42 
c⁄ãxt
->
disc⁄√˘_t
 = 0;

43 
c⁄ãxt
->
id
 = 
NULL
;

44 
c⁄ãxt
->
œ°_mid
 = 0;

45 
c⁄ãxt
->
wûl
 = 
NULL
;

46 
c⁄ãxt
->
u£∫ame
 = 
NULL
;

47 
c⁄ãxt
->
∑ssw‹d
 = 
NULL
;

48 
c⁄ãxt
->
li°íî
 = 
NULL
;

49 
c⁄ãxt
->
a˛_li°
 = 
NULL
;

53 
c⁄ãxt
->
is_bridge
 = 
Ál£
;

55 
c⁄ãxt
->
ö_∑ckë
.
∑ylﬂd
 = 
NULL
;

56 
	`_mosquôto_∑ckë_˛ónup
(&
c⁄ãxt
->
ö_∑ckë
);

57 
c⁄ãxt
->
out_∑ckë
 = 
NULL
;

58 
c⁄ãxt
->
cuºít_out_∑ckë
 = 
NULL
;

60 
c⁄ãxt
->
addªss
 = 
NULL
;

61 if(()
sock
 >= 0){

62 if(!
	`_mosquôto_sockë_gë_addªss
(
sock
, 
addªss
, 1024)){

63 
c⁄ãxt
->
addªss
 = 
	`_mosquôto_°rdup
(address);

65 if(!
c⁄ãxt
->
addªss
){

67 
	`_mosquôto_‰ì
(
c⁄ãxt
);

68  
NULL
;

71 
c⁄ãxt
->
bridge
 = 
NULL
;

72 
c⁄ãxt
->
msgs
 = 
NULL
;

73 
c⁄ãxt
->
œ°_msg
 = 
NULL
;

74 
c⁄ãxt
->
msg_cou¡
 = 0;

75 
c⁄ãxt
->
msg_cou¡12
 = 0;

76 #ifde‡
WITH_TLS


77 
c⁄ãxt
->
s¶
 = 
NULL
;

80 if(()
c⁄ãxt
->
sock
 >= 0){

81 
	`HASH_ADD
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
sock
, (
c⁄ãxt
->sock), context);

83  
c⁄ãxt
;

84 
	}
}

92 
	$mqâ3_c⁄ãxt_˛ónup
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
boﬁ
 
do_‰ì
)

94 
_mosquôto_∑ckë
 *
∑ckë
;

95 
mosquôto_˛õ¡_msg
 *
msg
, *
√xt
;

96 
i
;

98 if(!
c⁄ãxt
) ;

100 if(
c⁄ãxt
->
u£∫ame
){

101 
	`_mosquôto_‰ì
(
c⁄ãxt
->
u£∫ame
);

102 
c⁄ãxt
->
u£∫ame
 = 
NULL
;

104 if(
c⁄ãxt
->
∑ssw‹d
){

105 
	`_mosquôto_‰ì
(
c⁄ãxt
->
∑ssw‹d
);

106 
c⁄ãxt
->
∑ssw‹d
 = 
NULL
;

108 #ifde‡
WITH_BRIDGE


109 if(
c⁄ãxt
->
bridge
){

110 
i
=0; i<
db
->
bridge_cou¡
; i++){

111 if(
db
->
bridges
[
i
] =
c⁄ãxt
){

112 
db
->
bridges
[
i
] = 
NULL
;

115 if(
c⁄ãxt
->
bridge
->
loˇl_˛õ¡id
){

116 
	`_mosquôto_‰ì
(
c⁄ãxt
->
bridge
->
loˇl_˛õ¡id
);

117 
c⁄ãxt
->
bridge
->
loˇl_˛õ¡id
 = 
NULL
;

119 if(
c⁄ãxt
->
bridge
->
ªmŸe_u£∫ame
){

120 
c⁄ãxt
->
bridge
->
ªmŸe_u£∫ame
 = 
NULL
;

122 if(
c⁄ãxt
->
bridge
->
ªmŸe_∑ssw‹d
){

123 
c⁄ãxt
->
bridge
->
ªmŸe_∑ssw‹d
 = 
NULL
;

125 if(
c⁄ãxt
->
bridge
->
loˇl_u£∫ame
){

126 
c⁄ãxt
->
bridge
->
loˇl_u£∫ame
 = 
NULL
;

128 if(
c⁄ãxt
->
bridge
->
loˇl_∑ssw‹d
){

129 
c⁄ãxt
->
bridge
->
loˇl_∑ssw‹d
 = 
NULL
;

131 if(
c⁄ãxt
->
bridge
->
loˇl_˛õ¡id
){

132 
c⁄ãxt
->
bridge
->
loˇl_˛õ¡id
 = 
NULL
;

136 
	`_mosquôto_sockë_˛o£
(
db
, 
c⁄ãxt
);

137 if((
do_‰ì
 || 
c⁄ãxt
->
˛ón_£ssi⁄
Ë&& 
db
){

138 
	`mqâ3_subs_˛ón_£ssi⁄
(
db
, 
c⁄ãxt
);

139 
	`mqâ3_db_mesßges_dñëe
(
db
, 
c⁄ãxt
);

141 if(
c⁄ãxt
->
addªss
){

142 
	`_mosquôto_‰ì
(
c⁄ãxt
->
addªss
);

143 
c⁄ãxt
->
addªss
 = 
NULL
;

146 if(
c⁄ãxt
->
id
){

147 
	`as£π
(
db
);

150 
	`HASH_DELETE
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
);

151 
	`_mosquôto_‰ì
(
c⁄ãxt
->
id
);

152 
c⁄ãxt
->
id
 = 
NULL
;

154 
	`_mosquôto_∑ckë_˛ónup
(&(
c⁄ãxt
->
ö_∑ckë
));

155 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

156 
	`_mosquôto_∑ckë_˛ónup
(
c⁄ãxt
->
cuºít_out_∑ckë
);

157 
	`_mosquôto_‰ì
(
c⁄ãxt
->
cuºít_out_∑ckë
);

158 
c⁄ãxt
->
cuºít_out_∑ckë
 = 
NULL
;

160 
c⁄ãxt
->
out_∑ckë
){

161 
	`_mosquôto_∑ckë_˛ónup
(
c⁄ãxt
->
out_∑ckë
);

162 
∑ckë
 = 
c⁄ãxt
->
out_∑ckë
;

163 
c⁄ãxt
->
out_∑ckë
 = c⁄ãxt->out_∑ckë->
√xt
;

164 
	`_mosquôto_‰ì
(
∑ckë
);

166 if(
c⁄ãxt
->
wûl
){

167 if(
c⁄ãxt
->
wûl
->
t›ic
Ë
	`_mosquôto_‰ì
(context->will->topic);

168 if(
c⁄ãxt
->
wûl
->
∑ylﬂd
Ë
	`_mosquôto_‰ì
(context->will->payload);

169 
	`_mosquôto_‰ì
(
c⁄ãxt
->
wûl
);

170 
c⁄ãxt
->
wûl
 = 
NULL
;

172 if(
do_‰ì
 || 
c⁄ãxt
->
˛ón_£ssi⁄
){

173 
msg
 = 
c⁄ãxt
->
msgs
;

174 
msg
){

175 
√xt
 = 
msg
->next;

176 
	`mosquôto__db_msg_°‹e_dîef
(
db
, &
msg
->
°‹e
);

177 
	`_mosquôto_‰ì
(
msg
);

178 
msg
 = 
√xt
;

180 
c⁄ãxt
->
msgs
 = 
NULL
;

181 
c⁄ãxt
->
œ°_msg
 = 
NULL
;

183 if(
do_‰ì
){

184 
	`_mosquôto_‰ì
(
c⁄ãxt
);

186 
	}
}

188 
	$mqâ3_c⁄ãxt_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
˘xt
)

190 if(
˘xt
->
°©e
 !
mosq_cs_disc⁄√˘ög
 && ctxt->
wûl
){

191 if(
	`mosquôto_a˛_check
(
db
, 
˘xt
, ctxt->
wûl
->
t›ic
, 
MOSQ_ACL_WRITE
Ë=
MOSQ_ERR_SUCCESS
){

193 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
˘xt
, ctxt->
wûl
->
t›ic
, ctxt->wûl->
qos
, ctxt->wûl->
∑ylﬂdÀn
, ctxt->wûl->
∑ylﬂd
, ctxt->wûl->
ªèö
);

196 if(
˘xt
->
wûl
){

197 if(
˘xt
->
wûl
->
t›ic
Ë
	`_mosquôto_‰ì
(ctxt->will->topic);

198 if(
˘xt
->
wûl
->
∑ylﬂd
Ë
	`_mosquôto_‰ì
(ctxt->will->payload);

199 
	`_mosquôto_‰ì
(
˘xt
->
wûl
);

200 
˘xt
->
wûl
 = 
NULL
;

202 
˘xt
->
disc⁄√˘_t
 = 
	`time
(
NULL
);

203 
	`_mosquôto_sockë_˛o£
(
db
, 
˘xt
);

204 
	}
}

206 
	$mosquôto__add_c⁄ãxt_to_disu£d
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

208 if(
db
->
Œ_f‹_‰ì
){

209 
c⁄ãxt
->
f‹_‰ì_√xt
 = 
db
->
Œ_f‹_‰ì
;

210 
db
->
Œ_f‹_‰ì
 = 
c⁄ãxt
;

212 
db
->
Œ_f‹_‰ì
 = 
c⁄ãxt
;

214 
	}
}

216 
	$mosquôto__‰ì_disu£d_c⁄ãxts
(
mosquôto_db
 *
db
)

218 
mosquôto
 *
c⁄ãxt
, *
√xt
;

219 
	`as£π
(
db
);

221 
c⁄ãxt
 = 
db
->
Œ_f‹_‰ì
;

222 
c⁄ãxt
){

223 
√xt
 = 
c⁄ãxt
->
f‹_‰ì_√xt
;

224 
	`mqâ3_c⁄ãxt_˛ónup
(
db
, 
c⁄ãxt
, 
åue
);

225 
c⁄ãxt
 = 
√xt
;

227 
db
->
Œ_f‹_‰ì
 = 
NULL
;

228 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/database.c

17 
	~<as£π.h
>

18 
	~<°dio.h
>

20 
	~<c⁄fig.h
>

22 
	~<mosquôto_brokî.h
>

23 
	~<mem‹y_mosq.h
>

24 
	~<£nd_mosq.h
>

25 
	~<time_mosq.h
>

27 
	gmax_öÊight
 = 20;

28 
	gmax_queued
 = 100;

29 #ifde‡
WITH_SYS_TREE


30 
g_msgs_dr›≥d
;

33 
	$mqâ3_db_›í
(
mqâ3_c⁄fig
 *
c⁄fig
, 
mosquôto_db
 *
db
)

35 
rc
 = 0;

36 
_mosquôto_subhõr
 *
chûd
;

38 if(!
c⁄fig
 || !
db
Ë 
MOSQ_ERR_INVAL
;

40 
db
->
œ°_db_id
 = 0;

42 
db
->
c⁄ãxts_by_id
 = 
NULL
;

43 
db
->
c⁄ãxts_by_sock
 = 
NULL
;

44 
db
->
c⁄ãxts_f‹_‰ì
 = 
NULL
;

45 #ifde‡
WITH_BRIDGE


46 
db
->
bridges
 = 
NULL
;

47 
db
->
bridge_cou¡
 = 0;

51 
db
->
˛õ¡id_ödex_hash
 = 
NULL
;

53 
db
->
subs
.
√xt
 = 
NULL
;

54 
db
->
subs
.sub†
NULL
;

55 
db
->
subs
.
t›ic
 = "";

57 
chûd
 = 
	`_mosquôto_mÆloc
((
_mosquôto_subhõr
));

58 if(!
chûd
){

59 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

60  
MOSQ_ERR_NOMEM
;

62 
chûd
->
∑ª¡
 = 
NULL
;

63 
chûd
->
√xt
 = 
NULL
;

64 
chûd
->
t›ic
 = 
	`_mosquôto_°rdup
("");

65 if(!
chûd
->
t›ic
){

66 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

67  
MOSQ_ERR_NOMEM
;

69 
chûd
->
subs
 = 
NULL
;

70 
chûd
->
chûdªn
 = 
NULL
;

71 
chûd
->
ªèöed
 = 
NULL
;

72 
db
->
subs
.
chûdªn
 = 
chûd
;

74 
chûd
 = 
	`_mosquôto_mÆloc
((
_mosquôto_subhõr
));

75 if(!
chûd
){

76 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

77  
MOSQ_ERR_NOMEM
;

79 
chûd
->
∑ª¡
 = 
NULL
;

80 
chûd
->
√xt
 = 
NULL
;

81 
chûd
->
t›ic
 = 
	`_mosquôto_°rdup
("$SYS");

82 if(!
chûd
->
t›ic
){

83 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

84  
MOSQ_ERR_NOMEM
;

86 
chûd
->
subs
 = 
NULL
;

87 
chûd
->
chûdªn
 = 
NULL
;

88 
chûd
->
ªèöed
 = 
NULL
;

89 
db
->
subs
.
chûdªn
->
√xt
 = 
chûd
;

91 
db
->
u≈wd
 = 
NULL
;

93 #ifde‡
WITH_PERSISTENCE


94 if(
c⁄fig
->
≥rsi°í˚
 && c⁄fig->
≥rsi°í˚_fûï©h
){

95 if(
	`mqâ3_db_ª°‹e
(
db
))  1;

99  
rc
;

100 
	}
}

102 
	$subhõr_˛ón
(
mosquôto_db
 *
db
, 
_mosquôto_subhõr
 *
subhõr
)

104 
_mosquôto_subhõr
 *
√xt
;

105 
_mosquôto_subÀaf
 *
Àaf
, *
√xéóf
;

107 
subhõr
){

108 
√xt
 = 
subhõr
->next;

109 
Àaf
 = 
subhõr
->
subs
;

110 
Àaf
){

111 
√xéóf
 = 
Àaf
->
√xt
;

112 
	`_mosquôto_‰ì
(
Àaf
);

113 
Àaf
 = 
√xéóf
;

115 if(
subhõr
->
ªèöed
){

116 
	`mosquôto__db_msg_°‹e_dîef
(
db
, &
subhõr
->
ªèöed
);

118 
	`subhõr_˛ón
(
db
, 
subhõr
->
chûdªn
);

119 if(
subhõr
->
t›ic
Ë
	`_mosquôto_‰ì
(subhier->topic);

121 
	`_mosquôto_‰ì
(
subhõr
);

122 
subhõr
 = 
√xt
;

124 
	}
}

126 
	$mqâ3_db_˛o£
(
mosquôto_db
 *
db
)

128 
	`subhõr_˛ón
(
db
, db->
subs
.
chûdªn
);

129 
	`mosquôto__db_msg_°‹e_˛ón
(
db
);

131  
MOSQ_ERR_SUCCESS
;

132 
	}
}

135 
	$mosquôto__db_msg_°‹e_add
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
)

137 
°‹e
->
√xt
 = 
db
->
msg_°‹e
;

138 
°‹e
->
¥ev
 = 
NULL
;

139 if(
db
->
msg_°‹e
){

140 
db
->
msg_°‹e
->
¥ev
 = 
°‹e
;

142 
db
->
msg_°‹e
 = 
°‹e
;

143 
	}
}

146 
	$mosquôto__db_msg_°‹e_ªmove
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
)

148 
i
;

150 if(
°‹e
->
¥ev
){

151 
°‹e
->
¥ev
->
√xt
 = store->next;

152 if(
°‹e
->
√xt
){

153 
°‹e
->
√xt
->
¥ev
 = store->prev;

156 
db
->
msg_°‹e
 = 
°‹e
->
√xt
;

157 if(
°‹e
->
√xt
){

158 
°‹e
->
√xt
->
¥ev
 = 
NULL
;

161 
db
->
msg_°‹e_cou¡
--;

163 if(
°‹e
->
sour˚_id
Ë
	`_mosquôto_‰ì
(store->source_id);

164 if(
°‹e
->
de°_ids
){

165 
i
=0; i<
°‹e
->
de°_id_cou¡
; i++){

166 if(
°‹e
->
de°_ids
[
i
]Ë
	`_mosquôto_‰ì
(store->dest_ids[i]);

168 
	`_mosquôto_‰ì
(
°‹e
->
de°_ids
);

170 if(
°‹e
->
t›ic
Ë
	`_mosquôto_‰ì
(store->topic);

171 if(
°‹e
->
∑ylﬂd
Ë
	`_mosquôto_‰ì
(store->payload);

172 
	`_mosquôto_‰ì
(
°‹e
);

173 
	}
}

176 
	$mosquôto__db_msg_°‹e_˛ón
(
mosquôto_db
 *
db
)

178 
mosquôto_msg_°‹e
 *
°‹e
, *
√xt
;;

180 
°‹e
 = 
db
->
msg_°‹e
;

181 
°‹e
){

182 
√xt
 = 
°‹e
->next;

183 
	`mosquôto__db_msg_°‹e_ªmove
(
db
, 
°‹e
);

184 
°‹e
 = 
√xt
;

186 
	}
}

188 
	$mosquôto__db_msg_°‹e_dîef
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 **
°‹e
)

190 (*
°‹e
)->
ªf_cou¡
--;

191 if((*
°‹e
)->
ªf_cou¡
 == 0){

192 
	`mosquôto__db_msg_°‹e_ªmove
(
db
, *
°‹e
);

193 *
°‹e
 = 
NULL
;

195 
	}
}

198 
	$_mesßge_ªmove
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
mosquôto_˛õ¡_msg
 **
msg
, mosquôto_˛õ¡_msg *
œ°
)

200 
i
;

201 
mosquôto_˛õ¡_msg
 *
èû
;

203 if(!
c⁄ãxt
 || !
msg
 || !(*msg)){

207 if((*
msg
)->
°‹e
){

208 
	`mosquôto__db_msg_°‹e_dîef
(
db
, &(*
msg
)->
°‹e
);

210 if(
œ°
){

211 
œ°
->
√xt
 = (*
msg
)->next;

212 if(!
œ°
->
√xt
){

213 
c⁄ãxt
->
œ°_msg
 = 
œ°
;

216 
c⁄ãxt
->
msgs
 = (*
msg
)->
√xt
;

217 if(!
c⁄ãxt
->
msgs
){

218 
c⁄ãxt
->
œ°_msg
 = 
NULL
;

221 
c⁄ãxt
->
msg_cou¡
--;

222 if((*
msg
)->
qos
 > 0){

223 
c⁄ãxt
->
msg_cou¡12
--;

225 
	`_mosquôto_‰ì
(*
msg
);

226 if(
œ°
){

227 *
msg
 = 
œ°
->
√xt
;

229 *
msg
 = 
c⁄ãxt
->
msgs
;

231 
èû
 = 
c⁄ãxt
->
msgs
;

232 
i
 = 0;

233 
èû
 &&Åaû->
°©e
 =
mosq_ms_queued
 && 
i
<
max_öÊight
){

234 if(
èû
->
dúe˘i⁄
 =
mosq_md_out
){

235 
èû
->
qos
){

237 
èû
->
°©e
 = 
mosq_ms_publish_qos0
;

240 
èû
->
°©e
 = 
mosq_ms_publish_qos1
;

243 
èû
->
°©e
 = 
mosq_ms_publish_qos2
;

247 if(
èû
->
qos
 == 2){

248 
èû
->
°©e
 = 
mosq_ms_£nd_pubªc
;

252 
èû
 =Åaû->
√xt
;

254 
	}
}

256 
	$mqâ3_db_mesßge_dñëe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
)

258 
mosquôto_˛õ¡_msg
 *
èû
, *
œ°
 = 
NULL
;

259 
msg_ödex
 = 0;

260 
boﬁ
 
dñëed
 = 
Ál£
;

262 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

264 
èû
 = 
c⁄ãxt
->
msgs
;

265 
èû
){

266 
msg_ödex
++;

267 if(
èû
->
°©e
 =
mosq_ms_queued
 && 
msg_ödex
 <
max_öÊight
){

268 
èû
->
time°amp
 = 
	`mosquôto_time
();

269 if(
èû
->
dúe˘i⁄
 =
mosq_md_out
){

270 
èû
->
qos
){

272 
èû
->
°©e
 = 
mosq_ms_publish_qos0
;

275 
èû
->
°©e
 = 
mosq_ms_publish_qos1
;

278 
èû
->
°©e
 = 
mosq_ms_publish_qos2
;

282 if(
èû
->
qos
 == 2){

283 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

287 if(
èû
->
mid
 =mid &&Åaû->
dúe˘i⁄
 =
dú
){

288 
msg_ödex
--;

289 
	`_mesßge_ªmove
(
db
, 
c⁄ãxt
, &
èû
, 
œ°
);

290 
dñëed
 = 
åue
;

292 
œ°
 = 
èû
;

293 
èû
 =Åaû->
√xt
;

295 if(
msg_ödex
 > 
max_öÊight
 && 
dñëed
){

296  
MOSQ_ERR_SUCCESS
;

300  
MOSQ_ERR_SUCCESS
;

301 
	}
}

303 
	$mqâ3_db_mesßge_ö£π
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
)

305 
mosquôto_˛õ¡_msg
 *
msg
;

306 
mosquôto_msg_°©e
 
°©e
 = 
mosq_ms_övÆid
;

307 
rc
 = 0;

308 
i
;

309 **
de°_ids
;

311 
	`as£π
(
°‹ed
);

312 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

313 if(!
c⁄ãxt
->
id
Ë 
MOSQ_ERR_SUCCESS
;

322 if(
db
->
c⁄fig
->
Ælow_du∂iˇã_mesßges
 =
Ál£


323 && 
dú
 =
mosq_md_out
 && 
ªèö
 =
Ál£
 && 
°‹ed
->
de°_ids
){

325 
i
=0; i<
°‹ed
->
de°_id_cou¡
; i++){

326 if(!
	`°rcmp
(
°‹ed
->
de°_ids
[
i
], 
c⁄ãxt
->
id
)){

328  
MOSQ_ERR_SUCCESS
;

332 if(
c⁄ãxt
->
sock
 =
INVALID_SOCKET
){

334 if(
qos
 =0 && !
db
->
c⁄fig
->
queue_qos0_mesßges
){

335 if(!
c⁄ãxt
->
bridge
){

338 if(
c⁄ãxt
->
bridge
->
°¨t_ty≥
 !
b°_œzy
){

345 if(
c⁄ãxt
->
sock
 !
INVALID_SOCKET
){

346 if(
qos
 =0 || 
max_öÊight
 =0 || 
c⁄ãxt
->
msg_cou¡12
 < max_inflight){

347 if(
dú
 =
mosq_md_out
){

348 
qos
){

350 
°©e
 = 
mosq_ms_publish_qos0
;

353 
°©e
 = 
mosq_ms_publish_qos1
;

356 
°©e
 = 
mosq_ms_publish_qos2
;

360 if(
qos
 == 2){

361 
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

366 }if(
max_queued
 =0 || 
c⁄ãxt
->
msg_cou¡12
-
max_öÊight
 < max_queued){

367 
°©e
 = 
mosq_ms_queued
;

368 
rc
 = 2;

371 if(
c⁄ãxt
->
is_dr›pög
 =
Ál£
){

372 
c⁄ãxt
->
is_dr›pög
 = 
åue
;

373 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
,

375 
c⁄ãxt
->
id
);

377 #ifde‡
WITH_SYS_TREE


378 
g_msgs_dr›≥d
++;

383 if(
max_queued
 > 0 && 
c⁄ãxt
->
msg_cou¡12
 >= max_queued){

384 #ifde‡
WITH_SYS_TREE


385 
g_msgs_dr›≥d
++;

387 if(
c⁄ãxt
->
is_dr›pög
 =
Ál£
){

388 
c⁄ãxt
->
is_dr›pög
 = 
åue
;

389 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
,

391 
c⁄ãxt
->
id
);

395 
°©e
 = 
mosq_ms_queued
;

398 
	`as£π
(
°©e
 !
mosq_ms_övÆid
);

400 #ifde‡
WITH_PERSISTENCE


401 if(
°©e
 =
mosq_ms_queued
){

402 
db
->
≥rsi°í˚_ch™ges
++;

406 
msg
 = 
	`_mosquôto_mÆloc
((
mosquôto_˛õ¡_msg
));

407 if(!
msg
Ë 
MOSQ_ERR_NOMEM
;

408 
msg
->
√xt
 = 
NULL
;

409 
msg
->
°‹e
 = 
°‹ed
;

410 
msg
->
°‹e
->
ªf_cou¡
++;

411 
msg
->
mid
 = mid;

412 
msg
->
time°amp
 = 
	`mosquôto_time
();

413 
msg
->
dúe˘i⁄
 = 
dú
;

414 
msg
->
°©e
 = state;

415 
msg
->
dup
 = 
Ál£
;

416 
msg
->
qos
 = qos;

417 
msg
->
ªèö
 =Ñetain;

418 if(
c⁄ãxt
->
œ°_msg
){

419 
c⁄ãxt
->
œ°_msg
->
√xt
 = 
msg
;

420 
c⁄ãxt
->
œ°_msg
 = 
msg
;

422 
c⁄ãxt
->
msgs
 = 
msg
;

423 
c⁄ãxt
->
œ°_msg
 = 
msg
;

425 
c⁄ãxt
->
msg_cou¡
++;

426 if(
qos
 > 0){

427 
c⁄ãxt
->
msg_cou¡12
++;

430 if(
db
->
c⁄fig
->
Ælow_du∂iˇã_mesßges
 =
Ál£
 && 
dú
 =
mosq_md_out
 && 
ªèö
 == false){

438 
de°_ids
 = 
	`_mosquôto_ªÆloc
(
°‹ed
->de°_ids, (*)*(°‹ed->
de°_id_cou¡
+1));

439 if(
de°_ids
){

440 
°‹ed
->
de°_ids
 = dest_ids;

441 
°‹ed
->
de°_id_cou¡
++;

442 
°‹ed
->
de°_ids
[°‹ed->
de°_id_cou¡
-1] = 
	`_mosquôto_°rdup
(
c⁄ãxt
->
id
);

443 if(!
°‹ed
->
de°_ids
[°‹ed->
de°_id_cou¡
-1]){

444  
MOSQ_ERR_NOMEM
;

447  
MOSQ_ERR_NOMEM
;

450 #ifde‡
WITH_BRIDGE


451 if(
c⁄ãxt
->
bridge
 && c⁄ãxt->bridge->
°¨t_ty≥
 =
b°_œzy


452 && 
c⁄ãxt
->
sock
 =
INVALID_SOCKET


453 && 
c⁄ãxt
->
msg_cou¡
 >c⁄ãxt->
bridge
->
thªshﬁd
){

455 
c⁄ãxt
->
bridge
->
œzy_ªc⁄√˘
 = 
åue
;

459 #ifde‡
WITH_WEBSOCKETS


460 if(
c⁄ãxt
->
wsi
 && 
rc
 == 0){

461  
	`mqâ3_db_mesßge_wrôe
(
db
, 
c⁄ãxt
);

463  
rc
;

466  
rc
;

468 
	}
}

470 
	$mqâ3_db_mesßge_upd©e
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
mosquôto_msg_°©e
 
°©e
)

472 
mosquôto_˛õ¡_msg
 *
èû
;

474 
èû
 = 
c⁄ãxt
->
msgs
;

475 
èû
){

476 if(
èû
->
mid
 =mid &&Åaû->
dúe˘i⁄
 =
dú
){

477 
èû
->
°©e
 = state;

478 
èû
->
time°amp
 = 
	`mosquôto_time
();

479  
MOSQ_ERR_SUCCESS
;

481 
èû
 =Åaû->
√xt
;

484 
	}
}

486 
	$mqâ3_db_mesßges_dñëe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

488 
mosquôto_˛õ¡_msg
 *
èû
, *
√xt
;

490 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

492 
èû
 = 
c⁄ãxt
->
msgs
;

493 
èû
){

494 
	`mosquôto__db_msg_°‹e_dîef
(
db
, &
èû
->
°‹e
);

495 
√xt
 = 
èû
->next;

496 
	`_mosquôto_‰ì
(
èû
);

497 
èû
 = 
√xt
;

499 
c⁄ãxt
->
msgs
 = 
NULL
;

500 
c⁄ãxt
->
œ°_msg
 = 
NULL
;

501 
c⁄ãxt
->
msg_cou¡
 = 0;

502 
c⁄ãxt
->
msg_cou¡12
 = 0;

504  
MOSQ_ERR_SUCCESS
;

505 
	}
}

507 
	$mqâ3_db_mesßges_ósy_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
ªèö
)

509 
mosquôto_msg_°‹e
 *
°‹ed
;

510 *
sour˚_id
;

512 
	`as£π
(
db
);

514 if(!
t›ic
Ë 
MOSQ_ERR_INVAL
;

516 if(
c⁄ãxt
 && c⁄ãxt->
id
){

517 
sour˚_id
 = 
c⁄ãxt
->
id
;

519 
sour˚_id
 = "";

521 if(
	`mqâ3_db_mesßge_°‹e
(
db
, 
sour˚_id
, 0, 
t›ic
, 
qos
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
ªèö
, &
°‹ed
, 0))  1;

523  
	`mqâ3_db_mesßges_queue
(
db
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, &
°‹ed
);

524 
	}
}

526 
	$mqâ3_db_mesßge_°‹e
(
mosquôto_db
 *
db
, c⁄° *
sour˚
, 
uöt16_t
 
sour˚_mid
, c⁄° *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
, 
dbid_t
 
°‹e_id
)

528 
mosquôto_msg_°‹e
 *
ãmp
;

530 
	`as£π
(
db
);

531 
	`as£π
(
°‹ed
);

533 
ãmp
 = 
	`_mosquôto_mÆloc
((
mosquôto_msg_°‹e
));

534 if(!
ãmp
Ë 
MOSQ_ERR_NOMEM
;

536 
ãmp
->
ªf_cou¡
 = 0;

537 if(
sour˚
){

538 
ãmp
->
sour˚_id
 = 
	`_mosquôto_°rdup
(
sour˚
);

540 
ãmp
->
sour˚_id
 = 
	`_mosquôto_°rdup
("");

542 if(!
ãmp
->
sour˚_id
){

543 
	`_mosquôto_‰ì
(
ãmp
);

544 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

545  
MOSQ_ERR_NOMEM
;

547 
ãmp
->
sour˚_mid
 = source_mid;

548 
ãmp
->
mid
 = 0;

549 
ãmp
->
qos
 = qos;

550 
ãmp
->
ªèö
 =Ñetain;

551 if(
t›ic
){

552 
ãmp
->
t›ic
 = 
	`_mosquôto_°rdup
(topic);

553 if(!
ãmp
->
t›ic
){

554 
	`_mosquôto_‰ì
(
ãmp
->
sour˚_id
);

555 
	`_mosquôto_‰ì
(
ãmp
);

556 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

557  
MOSQ_ERR_NOMEM
;

560 
ãmp
->
t›ic
 = 
NULL
;

562 
ãmp
->
∑ylﬂdÀn
 =Öayloadlen;

563 if(
∑ylﬂdÀn
){

564 
ãmp
->
∑ylﬂd
 = 
	`_mosquôto_mÆloc
(()*
∑ylﬂdÀn
);

565 if(!
ãmp
->
∑ylﬂd
){

566 if(
ãmp
->
sour˚_id
Ë
	`_mosquôto_‰ì
(temp->source_id);

567 if(
ãmp
->
t›ic
Ë
	`_mosquôto_‰ì
(temp->topic);

568 if(
ãmp
->
∑ylﬂd
Ë
	`_mosquôto_‰ì
(temp->payload);

569 
	`_mosquôto_‰ì
(
ãmp
);

570  
MOSQ_ERR_NOMEM
;

572 
	`mem˝y
(
ãmp
->
∑ylﬂd
,Öaylﬂd, ()*
∑ylﬂdÀn
);

574 
ãmp
->
∑ylﬂd
 = 
NULL
;

577 if(!
ãmp
->
sour˚_id
 || (
∑ylﬂdÀn
 && !ãmp->
∑ylﬂd
)){

578 if(
ãmp
->
sour˚_id
Ë
	`_mosquôto_‰ì
(temp->source_id);

579 if(
ãmp
->
t›ic
Ë
	`_mosquôto_‰ì
(temp->topic);

580 if(
ãmp
->
∑ylﬂd
Ë
	`_mosquôto_‰ì
(temp->payload);

581 
	`_mosquôto_‰ì
(
ãmp
);

584 
ãmp
->
de°_ids
 = 
NULL
;

585 
ãmp
->
de°_id_cou¡
 = 0;

586 
db
->
msg_°‹e_cou¡
++;

587 (*
°‹ed
Ë
ãmp
;

589 if(!
°‹e_id
){

590 
ãmp
->
db_id
 = ++
db
->
œ°_db_id
;

592 
ãmp
->
db_id
 = 
°‹e_id
;

595 
	`mosquôto__db_msg_°‹e_add
(
db
, 
ãmp
);

597  
MOSQ_ERR_SUCCESS
;

598 
	}
}

600 
	$mqâ3_db_mesßge_°‹e_föd
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°‹e
 **
°‹ed
)

602 
mosquôto_˛õ¡_msg
 *
èû
;

604 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

606 *
°‹ed
 = 
NULL
;

607 
èû
 = 
c⁄ãxt
->
msgs
;

608 
èû
){

609 if(
èû
->
°‹e
->
sour˚_mid
 =
mid
 &&Åaû->
dúe˘i⁄
 =
mosq_md_ö
){

610 *
°‹ed
 = 
èû
->
°‹e
;

611  
MOSQ_ERR_SUCCESS
;

613 
èû
 =Åaû->
√xt
;

617 
	}
}

621 
	$mqâ3_db_mesßge_ªc⁄√˘_ª£t
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

623 
mosquôto_˛õ¡_msg
 *
msg
;

624 
mosquôto_˛õ¡_msg
 *
¥ev
 = 
NULL
;

625 
cou¡
;

627 
msg
 = 
c⁄ãxt
->
msgs
;

628 
c⁄ãxt
->
msg_cou¡
 = 0;

629 
c⁄ãxt
->
msg_cou¡12
 = 0;

630 
msg
){

631 
c⁄ãxt
->
œ°_msg
 = 
msg
;

633 
c⁄ãxt
->
msg_cou¡
++;

634 if(
msg
->
qos
 > 0){

635 
c⁄ãxt
->
msg_cou¡12
++;

638 if(
msg
->
dúe˘i⁄
 =
mosq_md_out
){

639 if(
msg
->
°©e
 !
mosq_ms_queued
){

640 
msg
->
qos
){

642 
msg
->
°©e
 = 
mosq_ms_publish_qos0
;

645 
msg
->
°©e
 = 
mosq_ms_publish_qos1
;

648 if(
msg
->
°©e
 =
mosq_ms_waô_f‹_pubcomp
){

649 
msg
->
°©e
 = 
mosq_ms_ª£nd_pubªl
;

651 
msg
->
°©e
 = 
mosq_ms_publish_qos2
;

657 if(
msg
->
qos
 != 2){

660 
	`_mesßge_ªmove
(
db
, 
c⁄ãxt
, &
msg
, 
¥ev
);

666 
¥ev
 = 
msg
;

667 if(
msg
Ëmsg = msg->
√xt
;

675 if(
c⁄ãxt
->
msgs
){

676 
cou¡
 = 0;

677 
msg
 = 
c⁄ãxt
->
msgs
;

678 
msg
 && (
max_öÊight
 =0 || 
cou¡
 < max_inflight)){

679 if(
msg
->
°©e
 =
mosq_ms_queued
){

680 
msg
->
qos
){

682 
msg
->
°©e
 = 
mosq_ms_publish_qos0
;

685 
msg
->
°©e
 = 
mosq_ms_publish_qos1
;

688 
msg
->
°©e
 = 
mosq_ms_publish_qos2
;

692 
msg
 = msg->
√xt
;

693 
cou¡
++;

697  
MOSQ_ERR_SUCCESS
;

698 
	}
}

700 
	$mqâ3_db_mesßge_timeout_check
(
mosquôto_db
 *
db
, 
timeout
)

702 
time_t
 
thªshﬁd
;

703 
mosquôto_msg_°©e
 
√w_°©e
;

704 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

705 
mosquôto_˛õ¡_msg
 *
msg
;

707 
thªshﬁd
 = 
	`mosquôto_time
(Ë- 
timeout
;

709 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

710 
msg
 = 
c⁄ãxt
->
msgs
;

711 
msg
){

712 
√w_°©e
 = 
mosq_ms_övÆid
;

713 if(
msg
->
time°amp
 < 
thªshﬁd
 && msg->
°©e
 !
mosq_ms_queued
){

714 
msg
->
°©e
){

715 
mosq_ms_waô_f‹_puback
:

716 
√w_°©e
 = 
mosq_ms_publish_qos1
;

718 
mosq_ms_waô_f‹_pubªc
:

719 
√w_°©e
 = 
mosq_ms_publish_qos2
;

721 
mosq_ms_waô_f‹_pubªl
:

722 
√w_°©e
 = 
mosq_ms_£nd_pubªc
;

724 
mosq_ms_waô_f‹_pubcomp
:

725 
√w_°©e
 = 
mosq_ms_ª£nd_pubªl
;

730 if(
√w_°©e
 !
mosq_ms_övÆid
){

731 
msg
->
time°amp
 = 
	`mosquôto_time
();

732 
msg
->
°©e
 = 
√w_°©e
;

733 
msg
->
dup
 = 
åue
;

736 
msg
 = msg->
√xt
;

740  
MOSQ_ERR_SUCCESS
;

741 
	}
}

743 
	$mqâ3_db_mesßge_ªÀa£
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
)

745 
mosquôto_˛õ¡_msg
 *
èû
, *
œ°
 = 
NULL
;

746 
qos
;

747 
ªèö
;

748 *
t›ic
;

749 *
sour˚_id
;

750 
msg_ödex
 = 0;

751 
boﬁ
 
dñëed
 = 
Ál£
;

753 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

755 
èû
 = 
c⁄ãxt
->
msgs
;

756 
èû
){

757 
msg_ödex
++;

758 if(
èû
->
°©e
 =
mosq_ms_queued
 && 
msg_ödex
 <
max_öÊight
){

759 
èû
->
time°amp
 = 
	`mosquôto_time
();

760 if(
èû
->
dúe˘i⁄
 =
mosq_md_out
){

761 
èû
->
qos
){

763 
èû
->
°©e
 = 
mosq_ms_publish_qos0
;

766 
èû
->
°©e
 = 
mosq_ms_publish_qos1
;

769 
èû
->
°©e
 = 
mosq_ms_publish_qos2
;

773 if(
èû
->
qos
 == 2){

774 
	`_mosquôto_£nd_pubªc
(
c⁄ãxt
, 
èû
->
mid
);

775 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

779 if(
èû
->
mid
 =mid &&Åaû->
dúe˘i⁄
 =
dú
){

780 
qos
 = 
èû
->
°‹e
->qos;

781 
t›ic
 = 
èû
->
°‹e
->topic;

782 
ªèö
 = 
èû
->retain;

783 
sour˚_id
 = 
èû
->
°‹e
->source_id;

789 if(!
t›ic
 || !
	`mqâ3_db_mesßges_queue
(
db
, 
sour˚_id
,Å›ic, 
qos
, 
ªèö
, &
èû
->
°‹e
)){

790 
	`_mesßge_ªmove
(
db
, 
c⁄ãxt
, &
èû
, 
œ°
);

791 
dñëed
 = 
åue
;

796 
œ°
 = 
èû
;

797 
èû
 =Åaû->
√xt
;

799 if(
msg_ödex
 > 
max_öÊight
 && 
dñëed
){

800  
MOSQ_ERR_SUCCESS
;

803 if(
dñëed
){

804  
MOSQ_ERR_SUCCESS
;

808 
	}
}

810 
	$mqâ3_db_mesßge_wrôe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

812 
rc
;

813 
mosquôto_˛õ¡_msg
 *
èû
, *
œ°
 = 
NULL
;

814 
uöt16_t
 
mid
;

815 
ªåõs
;

816 
ªèö
;

817 c⁄° *
t›ic
;

818 
qos
;

819 
uöt32_t
 
∑ylﬂdÀn
;

820 c⁄° *
∑ylﬂd
;

821 
msg_cou¡
 = 0;

823 if(!
c⁄ãxt
 || c⁄ãxt->
sock
 =
INVALID_SOCKET


824 || (
c⁄ãxt
->
°©e
 =
mosq_cs_c⁄√˘ed
 && !c⁄ãxt->
id
)){

825  
MOSQ_ERR_INVAL
;

828 if(
c⁄ãxt
->
°©e
 !
mosq_cs_c⁄√˘ed
){

829  
MOSQ_ERR_SUCCESS
;

832 
èû
 = 
c⁄ãxt
->
msgs
;

833 
èû
){

834 if(
èû
->
dúe˘i⁄
 =
mosq_md_ö
){

835 
msg_cou¡
++;

837 if(
èû
->
°©e
 !
mosq_ms_queued
){

838 
mid
 = 
èû
->mid;

839 
ªåõs
 = 
èû
->
dup
;

840 
ªèö
 = 
èû
->retain;

841 
t›ic
 = 
èû
->
°‹e
->topic;

842 
qos
 = 
èû
->qos;

843 
∑ylﬂdÀn
 = 
èû
->
°‹e
->payloadlen;

844 
∑ylﬂd
 = 
èû
->
°‹e
->payload;

846 
èû
->
°©e
){

847 
mosq_ms_publish_qos0
:

848 
rc
 = 
	`_mosquôto_£nd_publish
(
c⁄ãxt
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
ªåõs
);

849 if(!
rc
){

850 
	`_mesßge_ªmove
(
db
, 
c⁄ãxt
, &
èû
, 
œ°
);

852  
rc
;

856 
mosq_ms_publish_qos1
:

857 
rc
 = 
	`_mosquôto_£nd_publish
(
c⁄ãxt
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
ªåõs
);

858 if(!
rc
){

859 
èû
->
time°amp
 = 
	`mosquôto_time
();

860 
èû
->
dup
 = 1;

861 
èû
->
°©e
 = 
mosq_ms_waô_f‹_puback
;

863  
rc
;

865 
œ°
 = 
èû
;

866 
èû
 =Åaû->
√xt
;

869 
mosq_ms_publish_qos2
:

870 
rc
 = 
	`_mosquôto_£nd_publish
(
c⁄ãxt
, 
mid
, 
t›ic
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
qos
, 
ªèö
, 
ªåõs
);

871 if(!
rc
){

872 
èû
->
time°amp
 = 
	`mosquôto_time
();

873 
èû
->
dup
 = 1;

874 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªc
;

876  
rc
;

878 
œ°
 = 
èû
;

879 
èû
 =Åaû->
√xt
;

882 
mosq_ms_£nd_pubªc
:

883 
rc
 = 
	`_mosquôto_£nd_pubªc
(
c⁄ãxt
, 
mid
);

884 if(!
rc
){

885 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

887  
rc
;

889 
œ°
 = 
èû
;

890 
èû
 =Åaû->
√xt
;

893 
mosq_ms_ª£nd_pubªl
:

894 
rc
 = 
	`_mosquôto_£nd_pubªl
(
c⁄ãxt
, 
mid
);

895 if(!
rc
){

896 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubcomp
;

898  
rc
;

900 
œ°
 = 
èû
;

901 
èû
 =Åaû->
√xt
;

904 
mosq_ms_ª£nd_pubcomp
:

905 
rc
 = 
	`_mosquôto_£nd_pubcomp
(
c⁄ãxt
, 
mid
);

906 if(!
rc
){

907 
èû
->
°©e
 = 
mosq_ms_waô_f‹_pubªl
;

909  
rc
;

911 
œ°
 = 
èû
;

912 
èû
 =Åaû->
√xt
;

916 
œ°
 = 
èû
;

917 
èû
 =Åaû->
√xt
;

922 if(
èû
->
dúe˘i⁄
 =
mosq_md_ö
 && (
max_öÊight
 =0 || 
msg_cou¡
 < max_inflight)){

923 if(
èû
->
qos
 == 2){

924 
èû
->
°©e
 = 
mosq_ms_£nd_pubªc
;

927 
œ°
 = 
èû
;

928 
èû
 =Åaû->
√xt
;

933  
MOSQ_ERR_SUCCESS
;

934 
	}
}

936 
	$mqâ3_db_limôs_£t
(
öÊight
, 
queued
)

938 
max_öÊight
 = 
öÊight
;

939 
max_queued
 = 
queued
;

940 
	}
}

942 
	$mqâ3_db_vacuum
()

945 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/db_dump/db_dump.c

17 
	~<¨∑/öë.h
>

18 
	~<as£π.h
>

19 
	~<î∫o.h
>

20 
	~<f˙é.h
>

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<sys/°©.h
>

25 
	~<time.h
>

27 
	~<mosquôto_brokî.h
>

28 
	~<mem‹y_mosq.h
>

29 
	~<≥rsi°.h
>

31 
uöt32_t
 
	gdb_vîsi⁄
;

32 
	g°©s
 = 0;

34 
	$_db_˛õ¡_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
)

36 
uöt16_t
 
i16ãmp
, 
¶í
, 
œ°_mid
;

37 *
˛õ¡_id
 = 
NULL
;

38 
rc
 = 0;

39 
time_t
 
disc⁄√˘_t
;

41 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

42 
¶í
 = 
	`¡ohs
(
i16ãmp
);

43 if(!
¶í
){

44 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

45 
	`f˛o£
(
db_fd
);

48 
˛õ¡_id
 = 
	`ˇŒoc
(
¶í
+1, ());

49 if(!
˛õ¡_id
){

50 
	`f˛o£
(
db_fd
);

51 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

54 
	`ªad_e
(
db_fd
, 
˛õ¡_id
, 
¶í
);

55 if(!
°©s
Ë
	`¥ötf
("\tClõ¡ ID: %s\n", 
˛õ¡_id
);

57 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

58 
œ°_mid
 = 
	`¡ohs
(
i16ãmp
);

59 if(!
°©s
Ë
	`¥ötf
("\tLa° MID: %d\n", 
œ°_mid
);

61 if(
db_vîsi⁄
 == 2){

62 
disc⁄√˘_t
 = 
	`time
(
NULL
);

64 
	`ªad_e
(
db_fd
, &
disc⁄√˘_t
, (
time_t
));

65 if(!
°©s
Ë
	`¥ötf
("\tDisc⁄√˘Åime: %ld\n", 
disc⁄√˘_t
);

68 
	`‰ì
(
˛õ¡_id
);

70  
rc
;

71 
îr‹
:

72 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

73 if(
db_fd
 >0Ë
	`f˛o£
(db_fd);

74 if(
˛õ¡_id
Ë
	`‰ì
(client_id);

76 
	}
}

78 
	$_db_˛õ¡_msg_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
)

80 
dbid_t
 
i64ãmp
, 
°‹e_id
;

81 
uöt16_t
 
i16ãmp
, 
¶í
, 
mid
;

82 
uöt8_t
 
qos
, 
ªèö
, 
dúe˘i⁄
, 
°©e
, 
dup
;

83 *
˛õ¡_id
 = 
NULL
;

85 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

86 
¶í
 = 
	`¡ohs
(
i16ãmp
);

87 if(!
¶í
){

88 
	`Ârötf
(
°dîr
, "Error: CorruptÖersistent database.");

89 
	`f˛o£
(
db_fd
);

92 
˛õ¡_id
 = 
	`ˇŒoc
(
¶í
+1, ());

93 if(!
˛õ¡_id
){

94 
	`f˛o£
(
db_fd
);

95 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

98 
	`ªad_e
(
db_fd
, 
˛õ¡_id
, 
¶í
);

99 if(!
°©s
Ë
	`¥ötf
("\tClõ¡ ID: %s\n", 
˛õ¡_id
);

101 
	`ªad_e
(
db_fd
, &
i64ãmp
, (
dbid_t
));

102 
°‹e_id
 = 
i64ãmp
;

103 if(!
°©s
Ë
	`¥ötf
("\tSt‹êID: %ld\n", ()
°‹e_id
);

105 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

106 
mid
 = 
	`¡ohs
(
i16ãmp
);

107 if(!
°©s
Ë
	`¥ötf
("\tMID: %d\n", 
mid
);

109 
	`ªad_e
(
db_fd
, &
qos
, (
uöt8_t
));

110 if(!
°©s
Ë
	`¥ötf
("\tQoS: %d\n", 
qos
);

111 
	`ªad_e
(
db_fd
, &
ªèö
, (
uöt8_t
));

112 if(!
°©s
Ë
	`¥ötf
("\tRëaö: %d\n", 
ªèö
);

113 
	`ªad_e
(
db_fd
, &
dúe˘i⁄
, (
uöt8_t
));

114 if(!
°©s
Ë
	`¥ötf
("\tDúe˘i⁄: %d\n", 
dúe˘i⁄
);

115 
	`ªad_e
(
db_fd
, &
°©e
, (
uöt8_t
));

116 if(!
°©s
Ë
	`¥ötf
("\tSèã: %d\n", 
°©e
);

117 
	`ªad_e
(
db_fd
, &
dup
, (
uöt8_t
));

118 if(!
°©s
Ë
	`¥ötf
("\tDup: %d\n", 
dup
);

120 
	`‰ì
(
˛õ¡_id
);

123 
îr‹
:

124 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

125 if(
db_fd
 >0Ë
	`f˛o£
(db_fd);

126 if(
˛õ¡_id
Ë
	`‰ì
(client_id);

128 
	}
}

130 
	$_db_msg_°‹e_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
)

132 
dbid_t
 
i64ãmp
, 
°‹e_id
;

133 
uöt32_t
 
i32ãmp
, 
∑ylﬂdÀn
;

134 
uöt16_t
 
i16ãmp
, 
¶í
, 
sour˚_mid
, 
mid
;

135 
uöt8_t
 
qos
, 
ªèö
, *
∑ylﬂd
 = 
NULL
;

136 *
sour˚_id
 = 
NULL
;

137 *
t›ic
 = 
NULL
;

138 
rc
 = 0;

139 
boﬁ
 
bö¨y
;

140 
i
;

142 
	`ªad_e
(
db_fd
, &
i64ãmp
, (
dbid_t
));

143 
°‹e_id
 = 
i64ãmp
;

144 if(!
°©s
Ë
	`¥ötf
("\tSt‹êID: %ld\n", ()
°‹e_id
);

146 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

147 
¶í
 = 
	`¡ohs
(
i16ãmp
);

148 if(
¶í
){

149 
sour˚_id
 = 
	`ˇŒoc
(
¶í
+1, ());

150 if(!
sour˚_id
){

151 
	`f˛o£
(
db_fd
);

152 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

155 if(
	`‰ód
(
sour˚_id
, 1, 
¶í
, 
db_fd
) != slen){

156 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

157 
	`f˛o£
(
db_fd
);

158 
	`‰ì
(
sour˚_id
);

161 if(!
°©s
Ë
	`¥ötf
("\tSour˚ ID: %s\n", 
sour˚_id
);

162 
	`‰ì
(
sour˚_id
);

164 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

165 
sour˚_mid
 = 
	`¡ohs
(
i16ãmp
);

166 if(!
°©s
Ë
	`¥ötf
("\tSour˚ MID: %d\n", 
sour˚_mid
);

168 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

169 
mid
 = 
	`¡ohs
(
i16ãmp
);

170 if(!
°©s
Ë
	`¥ötf
("\tMID: %d\n", 
mid
);

172 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

173 
¶í
 = 
	`¡ohs
(
i16ãmp
);

174 if(
¶í
){

175 
t›ic
 = 
	`ˇŒoc
(
¶í
+1, ());

176 if(!
t›ic
){

177 
	`f˛o£
(
db_fd
);

178 
	`‰ì
(
sour˚_id
);

179 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

182 if(
	`‰ód
(
t›ic
, 1, 
¶í
, 
db_fd
) != slen){

183 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

184 
	`f˛o£
(
db_fd
);

185 
	`‰ì
(
sour˚_id
);

186 
	`‰ì
(
t›ic
);

189 if(!
°©s
Ë
	`¥ötf
("\tT›ic: %s\n", 
t›ic
);

190 
	`‰ì
(
t›ic
);

192 
	`Ârötf
(
°dîr
, "Error: Invalid msg_store chunk whenÑestoringÖersistent database.");

193 
	`f˛o£
(
db_fd
);

194 
	`‰ì
(
sour˚_id
);

197 
	`ªad_e
(
db_fd
, &
qos
, (
uöt8_t
));

198 if(!
°©s
Ë
	`¥ötf
("\tQoS: %d\n", 
qos
);

199 
	`ªad_e
(
db_fd
, &
ªèö
, (
uöt8_t
));

200 if(!
°©s
Ë
	`¥ötf
("\tRëaö: %d\n", 
ªèö
);

202 
	`ªad_e
(
db_fd
, &
i32ãmp
, (
uöt32_t
));

203 
∑ylﬂdÀn
 = 
	`¡ohl
(
i32ãmp
);

204 if(!
°©s
Ë
	`¥ötf
("\tPaylﬂd Lígth: %d\n", 
∑ylﬂdÀn
);

206 if(
∑ylﬂdÀn
){

207 
∑ylﬂd
 = 
	`mÆloc
(
∑ylﬂdÀn
+1);

208 if(!
∑ylﬂd
){

209 
	`f˛o£
(
db_fd
);

210 
	`‰ì
(
sour˚_id
);

211 
	`‰ì
(
t›ic
);

212 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

215 
	`mem£t
(
∑ylﬂd
, 0, 
∑ylﬂdÀn
+1);

216 if(
	`‰ód
(
∑ylﬂd
, 1, 
∑ylﬂdÀn
, 
db_fd
) !=Öayloadlen){

217 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

218 
	`f˛o£
(
db_fd
);

219 
	`‰ì
(
sour˚_id
);

220 
	`‰ì
(
t›ic
);

221 
	`‰ì
(
∑ylﬂd
);

224 
bö¨y
 = 
Ál£
;

225 
i
=0; i<
∑ylﬂdÀn
; i++){

226 if(
∑ylﬂd
[
i
] =0Ë
bö¨y
 = 
åue
;

228 if(
bö¨y
 =
Ál£
 && 
∑ylﬂdÀn
<256){

229 if(!
°©s
Ë
	`¥ötf
("\tPaylﬂd: %s\n", 
∑ylﬂd
);

231 
	`‰ì
(
∑ylﬂd
);

234  
rc
;

235 
îr‹
:

236 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

237 if(
db_fd
 >0Ë
	`f˛o£
(db_fd);

238 if(
sour˚_id
Ë
	`‰ì
(source_id);

239 if(
t›ic
Ë
	`‰ì
(topic);

241 
	}
}

243 
	$_db_ªèö_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
)

245 
dbid_t
 
i64ãmp
, 
°‹e_id
;

247 if(
	`‰ód
(&
i64ãmp
, (
dbid_t
), 1, 
db_fd
) != 1){

248 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

249 
	`f˛o£
(
db_fd
);

252 
°‹e_id
 = 
i64ãmp
;

253 if(!
°©s
Ë
	`¥ötf
("\tSt‹êID: %ld\n", ()
°‹e_id
);

255 
	}
}

257 
	$_db_sub_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_fd
)

259 
uöt16_t
 
i16ãmp
, 
¶í
;

260 
uöt8_t
 
qos
;

261 *
˛õ¡_id
;

262 *
t›ic
;

263 
rc
 = 0;

265 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

266 
¶í
 = 
	`¡ohs
(
i16ãmp
);

267 
˛õ¡_id
 = 
	`ˇŒoc
(
¶í
+1, ());

268 if(!
˛õ¡_id
){

269 
	`f˛o£
(
db_fd
);

270 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

273 
	`ªad_e
(
db_fd
, 
˛õ¡_id
, 
¶í
);

274 if(!
°©s
Ë
	`¥ötf
("\tClõ¡ ID: %s\n", 
˛õ¡_id
);

275 
	`ªad_e
(
db_fd
, &
i16ãmp
, (
uöt16_t
));

276 
¶í
 = 
	`¡ohs
(
i16ãmp
);

277 
t›ic
 = 
	`ˇŒoc
(
¶í
+1, ());

278 if(!
t›ic
){

279 
	`f˛o£
(
db_fd
);

280 
	`Ârötf
(
°dîr
, "Error: Out of memory.");

281 
	`‰ì
(
˛õ¡_id
);

284 
	`ªad_e
(
db_fd
, 
t›ic
, 
¶í
);

285 if(!
°©s
Ë
	`¥ötf
("\tT›ic: %s\n", 
t›ic
);

286 
	`ªad_e
(
db_fd
, &
qos
, (
uöt8_t
));

287 if(!
°©s
Ë
	`¥ötf
("\tQoS: %d\n", 
qos
);

288 
	`‰ì
(
˛õ¡_id
);

289 
	`‰ì
(
t›ic
);

291  
rc
;

292 
îr‹
:

293 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

294 if(
db_fd
 >0Ë
	`f˛o£
(db_fd);

296 
	}
}

298 
	$maö
(
¨gc
, *
¨gv
[])

300 
FILE
 *
fd
;

301 
hódî
[15];

302 
rc
 = 0;

303 
uöt32_t
 
¸c
;

304 
dbid_t
 
i64ãmp
;

305 
uöt32_t
 
i32ãmp
, 
Àngth
;

306 
uöt16_t
 
i16ãmp
, 
chunk
;

307 
uöt8_t
 
i8ãmp
;

308 
ssize_t
 
æí
;

309 
mosquôto_db
 
db
;

310 *
fûíame
;

311 
cfg_cou¡
 = 0;

312 
msg_°‹e_cou¡
 = 0;

313 
˛õ¡_msg_cou¡
 = 0;

314 
ªèö_cou¡
 = 0;

315 
sub_cou¡
 = 0;

316 
˛õ¡_cou¡
 = 0;

318 if(
¨gc
 == 2){

319 
fûíame
 = 
¨gv
[1];

320 }if(
¨gc
 =3 && !
	`°rcmp
(
¨gv
[1], "--stats")){

321 
°©s
 = 1;

322 
fûíame
 = 
¨gv
[2];

324 
	`Ârötf
(
°dîr
, "Usage: db_dump [--stats] <mosquitto db filename>\n");

327 
	`mem£t
(&
db
, 0, (
mosquôto_db
));

328 
fd
 = 
	`f›í
(
fûíame
, "rb");

329 if(!
fd
)  0;

330 
	`ªad_e
(
fd
, &
hódî
, 15);

331 if(!
	`memcmp
(
hódî
, 
magic
, 15)){

332 if(!
°©s
Ë
	`¥ötf
("Mosquitto DB dump\n");

334 
	`ªad_e
(
fd
, &
¸c
, (
uöt32_t
));

335 if(!
°©s
Ë
	`¥ötf
("CRC: %d\n", 
¸c
);

336 
	`ªad_e
(
fd
, &
i32ãmp
, (
uöt32_t
));

337 
db_vîsi⁄
 = 
	`¡ohl
(
i32ãmp
);

338 if(!
°©s
Ë
	`¥ötf
("DB vîsi⁄: %d\n", 
db_vîsi⁄
);

340 
æí
 = 
	`‰ód
(&
i16ãmp
, (
uöt16_t
), 1, 
fd
),Ñlen == 1){

341 
chunk
 = 
	`¡ohs
(
i16ãmp
);

342 
	`ªad_e
(
fd
, &
i32ãmp
, (
uöt32_t
));

343 
Àngth
 = 
	`¡ohl
(
i32ãmp
);

344 
chunk
){

345 
DB_CHUNK_CFG
:

346 
cfg_cou¡
++;

347 if(!
°©s
Ë
	`¥ötf
("DB_CHUNK_CFG:\n");

348 if(!
°©s
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

349 
	`ªad_e
(
fd
, &
i8ãmp
, (
uöt8_t
));

350 if(!
°©s
Ë
	`¥ötf
("\tShutdown: %d\n", 
i8ãmp
);

351 
	`ªad_e
(
fd
, &
i8ãmp
, (
uöt8_t
));

352 if(!
°©s
Ë
	`¥ötf
("\tDB ID size: %d\n", 
i8ãmp
);

353 if(
i8ãmp
 !(
dbid_t
)){

354 
	`Ârötf
(
°dîr
, "Error: Incompatible database configuration (dbid size is %d bytes,Éxpected %ld)",

355 
i8ãmp
, (
dbid_t
));

356 
	`f˛o£
(
fd
);

359 
	`ªad_e
(
fd
, &
i64ãmp
, (
dbid_t
));

360 if(!
°©s
Ë
	`¥ötf
("\tLa° DB ID: %ld\n", ()
i64ãmp
);

363 
DB_CHUNK_MSG_STORE
:

364 
msg_°‹e_cou¡
++;

365 if(!
°©s
Ë
	`¥ötf
("DB_CHUNK_MSG_STORE:\n");

366 if(!
°©s
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

367 if(
	`_db_msg_°‹e_chunk_ª°‹e
(&
db
, 
fd
))  1;

370 
DB_CHUNK_CLIENT_MSG
:

371 
˛õ¡_msg_cou¡
++;

372 if(!
°©s
Ë
	`¥ötf
("DB_CHUNK_CLIENT_MSG:\n");

373 if(!
°©s
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

374 if(
	`_db_˛õ¡_msg_chunk_ª°‹e
(&
db
, 
fd
))  1;

377 
DB_CHUNK_RETAIN
:

378 
ªèö_cou¡
++;

379 if(!
°©s
Ë
	`¥ötf
("DB_CHUNK_RETAIN:\n");

380 if(!
°©s
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

381 if(
	`_db_ªèö_chunk_ª°‹e
(&
db
, 
fd
))  1;

384 
DB_CHUNK_SUB
:

385 
sub_cou¡
++;

386 if(!
°©s
Ë
	`¥ötf
("DB_CHUNK_SUB:\n");

387 if(!
°©s
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

388 if(
	`_db_sub_chunk_ª°‹e
(&
db
, 
fd
))  1;

391 
DB_CHUNK_CLIENT
:

392 
˛õ¡_cou¡
++;

393 if(!
°©s
Ë
	`¥ötf
("DB_CHUNK_CLIENT:\n");

394 if(!
°©s
Ë
	`¥ötf
("\tLígth: %d\n", 
Àngth
);

395 if(
	`_db_˛õ¡_chunk_ª°‹e
(&
db
, 
fd
))  1;

399 
	`Ârötf
(
°dîr
, "W¨nög: Unsuµ‹ãd chunk \"%d\" i¿≥rsi°íàd©aba£ fûe. Ign‹ög.", 
chunk
);

400 
	`f£ek
(
fd
, 
Àngth
, 
SEEK_CUR
);

404 if(
æí
 < 0Ë
îr‹
;

406 
	`Ârötf
(
°dîr
, "Error: Unrecognised file format.");

407 
rc
 = 1;

410 
	`f˛o£
(
fd
);

412 if(
°©s
){

413 
	`¥ötf
("DB_CHUNK_CFG: %ld\n", 
cfg_cou¡
);

414 
	`¥ötf
("DB_CHUNK_MSG_STORE: %ld\n", 
msg_°‹e_cou¡
);

415 
	`¥ötf
("DB_CHUNK_CLIENT_MSG: %ld\n", 
˛õ¡_msg_cou¡
);

416 
	`¥ötf
("DB_CHUNK_RETAIN: %ld\n", 
ªèö_cou¡
);

417 
	`¥ötf
("DB_CHUNK_SUB: %ld\n", 
sub_cou¡
);

418 
	`¥ötf
("DB_CHUNK_CLIENT: %ld\n", 
˛õ¡_cou¡
);

420  
rc
;

421 
îr‹
:

422 
	`Ârötf
(
°dîr
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

423 if(
fd
 >0Ë
	`f˛o£
(fd);

425 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/logging.c

16 
	~<°d¨g.h
>

17 
	~<°dio.h
>

18 
	~<°rög.h
>

19 #i‚de‡
WIN32


20 
	~<sy¶og.h
>

22 
	~<time.h
>

24 #i‚de‡
CMAKE


25 
	~<c⁄fig.h
>

28 
	~<mosquôto_brokî.h
>

29 
	~<mem‹y_mosq.h
>

30 
	~<utû_mosq.h
>

32 
mosquôto_db
 
öt_db
;

34 #ifde‡
WIN32


35 
HANDLE
 
	gsy¶og_h
;

50 
	glog_de°ö©i⁄s
 = 
MQTT3_LOG_STDERR
;

51 
	glog_¥i‹ôõs
 = 
MOSQ_LOG_ERR
 | 
MOSQ_LOG_WARNING
 | 
MOSQ_LOG_NOTICE
 | 
MOSQ_LOG_INFO
;

53 
	$mqâ3_log_öô
(
mqâ3_c⁄fig
 *
c⁄fig
)

55 
rc
 = 0;

57 
log_¥i‹ôõs
 = 
c⁄fig
->
log_ty≥
;

58 
log_de°ö©i⁄s
 = 
c⁄fig
->
log_de°
;

60 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_SYSLOG
){

61 #i‚de‡
WIN32


62 
	`›ílog
("mosquôto", 
LOG_PID
|
LOG_CONS
, 
c⁄fig
->
log_Ácûôy
);

64 
sy¶og_h
 = 
	`O≥nEvítLog
(
NULL
, "mosquitto");

68 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_FILE
){

69 if(
	`dr›_¥ivûeges
(
c⁄fig
, 
åue
)){

72 
c⁄fig
->
log_Âå
 = 
	`_mosquôto_f›í
(c⁄fig->
log_fûe
, "at");

73 if(!
c⁄fig
->
log_Âå
){

74 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›íÜog fûê%†f‹ wrôög.", 
c⁄fig
->
log_fûe
);

75  
MOSQ_ERR_INVAL
;

77 
	`ª°‹e_¥ivûeges
();

79  
rc
;

80 
	}
}

82 
	$mqâ3_log_˛o£
(
mqâ3_c⁄fig
 *
c⁄fig
)

84 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_SYSLOG
){

85 #i‚de‡
WIN32


86 
	`˛o£log
();

88 
	`Clo£EvítLog
(
sy¶og_h
);

91 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_FILE
){

92 if(
c⁄fig
->
log_Âå
){

93 
	`f˛o£
(
c⁄fig
->
log_Âå
);

94 
c⁄fig
->
log_Âå
 = 
NULL
;

99  
MOSQ_ERR_SUCCESS
;

100 
	}
}

102 
	$_mosquôto_log_v¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, 
va_li°
 
va
)

104 *
s
;

105 *
°
;

106 
Àn
;

107 #ifde‡
WIN32


108 *
•
;

110 c⁄° *
t›ic
;

111 
sy¶og_¥i‹ôy
;

112 
time_t
 
now
 = 
	`time
(
NULL
);

113 
time_t
 
œ°_Êush
 = 0;

115 if((
log_¥i‹ôõs
 & 
¥i‹ôy
Ë&& 
log_de°ö©i⁄s
 !
MQTT3_LOG_NONE
){

116 
¥i‹ôy
){

117 
MOSQ_LOG_SUBSCRIBE
:

118 
t›ic
 = "$SYS/broker/log/M/subscribe";

119 #i‚de‡
WIN32


120 
sy¶og_¥i‹ôy
 = 
LOG_NOTICE
;

122 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

125 
MOSQ_LOG_UNSUBSCRIBE
:

126 
t›ic
 = "$SYS/broker/log/M/unsubscribe";

127 #i‚de‡
WIN32


128 
sy¶og_¥i‹ôy
 = 
LOG_NOTICE
;

130 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

133 
MOSQ_LOG_DEBUG
:

134 
t›ic
 = "$SYS/broker/log/D";

135 #i‚de‡
WIN32


136 
sy¶og_¥i‹ôy
 = 
LOG_DEBUG
;

138 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

141 
MOSQ_LOG_ERR
:

142 
t›ic
 = "$SYS/broker/log/E";

143 #i‚de‡
WIN32


144 
sy¶og_¥i‹ôy
 = 
LOG_ERR
;

146 
sy¶og_¥i‹ôy
 = 
EVENTLOG_ERROR_TYPE
;

149 
MOSQ_LOG_WARNING
:

150 
t›ic
 = "$SYS/broker/log/W";

151 #i‚de‡
WIN32


152 
sy¶og_¥i‹ôy
 = 
LOG_WARNING
;

154 
sy¶og_¥i‹ôy
 = 
EVENTLOG_WARNING_TYPE
;

157 
MOSQ_LOG_NOTICE
:

158 
t›ic
 = "$SYS/broker/log/N";

159 #i‚de‡
WIN32


160 
sy¶og_¥i‹ôy
 = 
LOG_NOTICE
;

162 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

165 
MOSQ_LOG_INFO
:

166 
t›ic
 = "$SYS/broker/log/I";

167 #i‚de‡
WIN32


168 
sy¶og_¥i‹ôy
 = 
LOG_INFO
;

170 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

173 #ifde‡
WITH_WEBSOCKETS


174 
MOSQ_LOG_WEBSOCKETS
:

175 
t›ic
 = "$SYS/broker/log/WS";

176 #i‚de‡
WIN32


177 
sy¶og_¥i‹ôy
 = 
LOG_DEBUG
;

179 
sy¶og_¥i‹ôy
 = 
EVENTLOG_INFORMATION_TYPE
;

184 
t›ic
 = "$SYS/broker/log/E";

185 #i‚de‡
WIN32


186 
sy¶og_¥i‹ôy
 = 
LOG_ERR
;

188 
sy¶og_¥i‹ôy
 = 
EVENTLOG_ERROR_TYPE
;

191 
Àn
 = 
	`°æí
(
fmt
) + 500;

192 
s
 = 
	`_mosquôto_mÆloc
(
Àn
*());

193 if(!
s
Ë 
MOSQ_ERR_NOMEM
;

195 
	`v¢¥ötf
(
s
, 
Àn
, 
fmt
, 
va
);

196 
s
[
Àn
-1] = '\0';

198 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_STDOUT
){

199 if(
öt_db
.
c⁄fig
 && i¡_db.c⁄fig->
log_time°amp
){

200 
	`Ârötf
(
°dout
, "%d: %s\n", ()
now
, 
s
);

202 
	`Ârötf
(
°dout
, "%s\n", 
s
);

204 
	`fÊush
(
°dout
);

206 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_STDERR
){

207 if(
öt_db
.
c⁄fig
 && i¡_db.c⁄fig->
log_time°amp
){

208 
	`Ârötf
(
°dîr
, "%d: %s\n", ()
now
, 
s
);

210 
	`Ârötf
(
°dîr
, "%s\n", 
s
);

212 
	`fÊush
(
°dîr
);

214 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_FILE
 && 
öt_db
.
c⁄fig
->
log_Âå
){

215 if(
öt_db
.
c⁄fig
 && i¡_db.c⁄fig->
log_time°amp
){

216 
	`Ârötf
(
öt_db
.
c⁄fig
->
log_Âå
, "%d: %s\n", ()
now
, 
s
);

218 
	`Ârötf
(
öt_db
.
c⁄fig
->
log_Âå
, "%s\n", 
s
);

220 if(
now
 - 
œ°_Êush
 > 1){

221 
	`fÊush
(
öt_db
.
c⁄fig
->
log_Âå
);

222 
œ°_Êush
 = 
now
;

225 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_SYSLOG
){

226 #i‚de‡
WIN32


227 
	`sy¶og
(
sy¶og_¥i‹ôy
, "%s", 
s
);

229 
•
 = (*)
s
;

230 
	`Rï‹tEvít
(
sy¶og_h
, 
sy¶og_¥i‹ôy
, 0, 0, 
NULL
, 1, 0, &
•
, NULL);

233 if(
log_de°ö©i⁄s
 & 
MQTT3_LOG_TOPIC
 && 
¥i‹ôy
 !
MOSQ_LOG_DEBUG
){

234 if(
öt_db
.
c⁄fig
 && i¡_db.c⁄fig->
log_time°amp
){

235 
Àn
 += 30;

236 
°
 = 
	`_mosquôto_mÆloc
(
Àn
*());

237 if(!
°
){

238 
	`_mosquôto_‰ì
(
s
);

239  
MOSQ_ERR_NOMEM
;

241 
	`¢¥ötf
(
°
, 
Àn
, "%d: %s", ()
now
, 
s
);

242 
	`mqâ3_db_mesßges_ósy_queue
(&
öt_db
, 
NULL
, 
t›ic
, 2, 
	`°æí
(
°
), st, 0);

243 
	`_mosquôto_‰ì
(
°
);

245 
	`mqâ3_db_mesßges_ósy_queue
(&
öt_db
, 
NULL
, 
t›ic
, 2, 
	`°æí
(
s
), s, 0);

248 
	`_mosquôto_‰ì
(
s
);

251  
MOSQ_ERR_SUCCESS
;

252 
	}
}

254 
	$_mosquôto_log_¥ötf
(
mosquôto
 *
mosq
, 
¥i‹ôy
, c⁄° *
fmt
, ...)

256 
va_li°
 
va
;

257 
rc
;

259 
	`va_°¨t
(
va
, 
fmt
);

260 
rc
 = 
	`_mosquôto_log_v¥ötf
(
mosq
, 
¥i‹ôy
, 
fmt
, 
va
);

261 
	`va_íd
(
va
);

263  
rc
;

264 
	}
}

266 
	$mosquôto_log_¥ötf
(
Àvñ
, c⁄° *
fmt
, ...)

268 
va_li°
 
va
;

270 
	`va_°¨t
(
va
, 
fmt
);

271 
	`_mosquôto_log_v¥ötf
(
NULL
, 
Àvñ
, 
fmt
, 
va
);

272 
	`va_íd
(
va
);

273 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/loop.c

17 
	#_GNU_SOURCE


	)

19 
	~<c⁄fig.h
>

21 
	~<as£π.h
>

22 #i‚de‡
WIN32


23 
	~<pﬁl.h
>

25 
	~<¥o˚ss.h
>

26 
	~<wösock2.h
>

27 
	~<ws2t˝ù.h
>

30 
	~<î∫o.h
>

31 
	~<sig«l.h
>

32 
	~<°dio.h
>

33 
	~<°rög.h
>

34 #i‚de‡
WIN32


35 
	~<sys/sockë.h
>

37 
	~<time.h
>

39 #ifde‡
WITH_WEBSOCKETS


40 
	~<libwebsockës.h
>

43 
	~<mosquôto_brokî.h
>

44 
	~<mem‹y_mosq.h
>

45 
	~<£nd_mosq.h
>

46 
	~<time_mosq.h
>

47 
	~<utû_mosq.h
>

49 
boﬁ
 
Êag_ªlﬂd
;

50 #ifde‡
WITH_PERSISTENCE


51 
boﬁ
 
Êag_db_backup
;

53 
boﬁ
 
Êag_åì_¥öt
;

54 
run
;

55 #ifde‡
WITH_SYS_TREE


56 
g_˛õ¡s_expúed
;

59 
lo›_h™dÀ_îr‹s
(
mosquôto_db
 *
db
, 
pﬁlfd
 *
pﬁlfds
);

60 
lo›_h™dÀ_ªads_wrôes
(
mosquôto_db
 *
db
, 
pﬁlfd
 *
pﬁlfds
);

62 #ifde‡
WITH_WEBSOCKETS


63 
	$ãmp__expúe_websockës_˛õ¡s
(
mosquôto_db
 *
db
)

65 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

66 
time_t
 
œ°_check
 = 0;

67 
time_t
 
now
 = 
	`mosquôto_time
();

68 *
id
;

70 if(
now
 - 
œ°_check
 > 60){

71 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

72 if(
c⁄ãxt
->
wsi
 && c⁄ãxt->
sock
 !
INVALID_SOCKET
){

73 if(
c⁄ãxt
->
kì∑live
 && 
now
 - c⁄ãxt->
œ°_msg_ö
 > (
time_t
)(context->keepalive)*3/2){

74 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

75 if(
c⁄ãxt
->
id
){

76 
id
 = 
c⁄ãxt
->id;

78 
id
 = "<unknown>";

80 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†ha†ex˚ededÅimeout, disc⁄√˘ög.", 
id
);

83 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

87 
œ°_check
 = 
	`mosquôto_time
();

89 
	}
}

92 
	$mosquôto_maö_lo›
(
mosquôto_db
 *
db
, 
mosq_sock_t
 *
li°ísock
, 
li°ísock_cou¡
, 
li°íî_max
, *
pfds
)

96 #ifde‡
WITH_SYS_TREE


97 
time_t
 
°¨t_time
 = 
	`mosquôto_time
();

99 #ifde‡
WITH_PERSISTENCE


100 
time_t
 
œ°_backup
 = 
	`mosquôto_time
();

102 
time_t
 
now
 = 0;

103 
time_t
 
now_time
;

104 
time_cou¡
;

105 
fdcou¡
;

106 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

107 #i‚de‡
WIN32


108 
sig£t_t
 
sigblock
, 
‹igsig
;

110 
i
;

111 
pﬁlfd
 *
pﬁlfds
 = 
NULL
;

112 
pﬁlfd_cou¡
 = 0;

113 
pﬁlfd_ödex
;

114 #ifde‡
WITH_BRIDGE


115 
mosq_sock_t
 
bridge_sock
;

116 
rc
;

118 
c⁄ãxt_cou¡
;

119 
time_t
 
expú©i⁄_check_time
 = 0;

120 *
id
;

122 #i‚de‡
WIN32


123 
	`sigem±y£t
(&
sigblock
);

124 
	`sigadd£t
(&
sigblock
, 
SIGINT
);

127 if(
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 > 0){

128 
expú©i⁄_check_time
 = 
	`time
(
NULL
) + 3600;

131 
run
){

132 
	`mosquôto__‰ì_disu£d_c⁄ãxts
(
db
);

133 #ifde‡
WITH_SYS_TREE


134 if(
db
->
c⁄fig
->
sys_öãrvÆ
 > 0){

135 
	`mqâ3_db_sys_upd©e
(
db
, db->
c⁄fig
->
sys_öãrvÆ
, 
°¨t_time
);

139 
c⁄ãxt_cou¡
 = 
	`HASH_CNT
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
);

140 #ifde‡
WITH_BRIDGE


141 
c⁄ãxt_cou¡
 +
db
->
bridge_cou¡
;

144 if(
li°ísock_cou¡
 + 
c⁄ãxt_cou¡
 > 
pﬁlfd_cou¡
 || !
pﬁlfds
){

145 
pﬁlfd_cou¡
 = 
li°ísock_cou¡
 + 
c⁄ãxt_cou¡
;

146 
pﬁlfds
 = 
	`_mosquôto_ªÆloc
’ﬁlfds, (
pﬁlfd
)*
pﬁlfd_cou¡
);

147 if(!
pﬁlfds
){

148 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

149  
MOSQ_ERR_NOMEM
;

154 
	`mem£t
(
pﬁlfds
, -1, (
pﬁlfd
)*
pﬁlfd_cou¡
);

158 
pﬁlfd_ödex
 = 0;

159 
i
=0; i<
li°ísock_cou¡
; i++){

160 
pﬁlfds
[
pﬁlfd_ödex
].
fd
 = 
li°ísock
[
i
];

161 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 = 
POLLIN
;

162 
pﬁlfds
[
pﬁlfd_ödex
].
ªvíts
 = 0;

163 
pﬁlfd_ödex
++;

166 
now_time
 = 
	`time
(
NULL
);

168 
time_cou¡
 = 0;

169 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

170 if(
time_cou¡
 > 0){

171 
time_cou¡
--;

173 
time_cou¡
 = 1000;

174 
now
 = 
	`mosquôto_time
();

176 
c⁄ãxt
->
pﬁlfd_ödex
 = -1;

178 if(
c⁄ãxt
->
sock
 !
INVALID_SOCKET
){

179 #ifde‡
WITH_BRIDGE


180 if(
c⁄ãxt
->
bridge
){

181 
	`_mosquôto_check_kì∑live
(
db
, 
c⁄ãxt
);

182 if(
c⁄ãxt
->
bridge
->
round_robö
 =
Ál£


183 && 
c⁄ãxt
->
bridge
->
cur_addªss
 != 0

184 && 
now
 > 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
){

186 if(
	`_mosquôto_åy_c⁄√˘
(
c⁄ãxt
, c⁄ãxt->
bridge
->
addªs£s
[0].
addªss
, c⁄ãxt->bridge->addªs£s[0].
p‹t
, &
bridge_sock
, 
NULL
, 
Ál£
Ë=
MOSQ_ERR_SUCCESS
){

187 
	`COMPAT_CLOSE
(
bridge_sock
);

188 
	`_mosquôto_sockë_˛o£
(
db
, 
c⁄ãxt
);

189 
c⁄ãxt
->
bridge
->
cur_addªss
 = c⁄ãxt->bridge->
addªss_cou¡
-1;

196 if(!(
c⁄ãxt
->
kì∑live
)

197 || 
c⁄ãxt
->
bridge


198 || 
now
 - 
c⁄ãxt
->
œ°_msg_ö
 < (
time_t
)(c⁄ãxt->
kì∑live
)*3/2){

200 if(
	`mqâ3_db_mesßge_wrôe
(
db
, 
c⁄ãxt
Ë=
MOSQ_ERR_SUCCESS
){

201 
pﬁlfds
[
pﬁlfd_ödex
].
fd
 = 
c⁄ãxt
->
sock
;

202 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 = 
POLLIN
;

203 
pﬁlfds
[
pﬁlfd_ödex
].
ªvíts
 = 0;

204 if(
c⁄ãxt
->
cuºít_out_∑ckë
 || c⁄ãxt->
°©e
 =
mosq_cs_c⁄√˘_≥ndög
){

205 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 |
POLLOUT
;

207 
c⁄ãxt
->
pﬁlfd_ödex
 =Öollfd_index;

208 
pﬁlfd_ödex
++;

210 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

213 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

214 if(
c⁄ãxt
->
id
){

215 
id
 = 
c⁄ãxt
->id;

217 
id
 = "<unknown>";

219 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†ha†ex˚ededÅimeout, disc⁄√˘ög.", 
id
);

222 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

227 #ifde‡
WITH_BRIDGE


228 
time_cou¡
 = 0;

229 
i
=0; i<
db
->
bridge_cou¡
; i++){

230 if(!
db
->
bridges
[
i
]) ;

232 
c⁄ãxt
 = 
db
->
bridges
[
i
];

234 if(
c⁄ãxt
->
sock
 =
INVALID_SOCKET
){

235 if(
time_cou¡
 > 0){

236 
time_cou¡
--;

238 
time_cou¡
 = 1000;

239 
now
 = 
	`mosquôto_time
();

242 if(!
c⁄ãxt
->
bridge
->
ª°¨t_t
){

243 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 
now
+c⁄ãxt->bridge->
ª°¨t_timeout
;

244 
c⁄ãxt
->
bridge
->
cur_addªss
++;

245 if(
c⁄ãxt
->
bridge
->
cur_addªss
 =c⁄ãxt->bridge->
addªss_cou¡
){

246 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

248 if(
c⁄ãxt
->
bridge
->
round_robö
 =
Ál£
 && c⁄ãxt->bridge->
cur_addªss
 != 0){

249 
c⁄ãxt
->
bridge
->
¥im¨y_ªåy
 = 
now
 + 5;

252 if(
c⁄ãxt
->
bridge
->
°¨t_ty≥
 =
b°_œzy
 && c⁄ãxt->bridge->
œzy_ªc⁄√˘
){

253 
rc
 = 
	`mqâ3_bridge_c⁄√˘
(
db
, 
c⁄ãxt
);

254 if(
rc
){

255 
c⁄ãxt
->
bridge
->
cur_addªss
++;

256 if(
c⁄ãxt
->
bridge
->
cur_addªss
 =c⁄ãxt->bridge->
addªss_cou¡
){

257 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

261 if(
c⁄ãxt
->
bridge
->
°¨t_ty≥
 =
b°_autom©ic
 && 
now
 > c⁄ãxt->bridge->
ª°¨t_t
){

262 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 0;

263 
rc
 = 
	`mqâ3_bridge_c⁄√˘
(
db
, 
c⁄ãxt
);

264 if(
rc
 =
MOSQ_ERR_SUCCESS
){

265 
pﬁlfds
[
pﬁlfd_ödex
].
fd
 = 
c⁄ãxt
->
sock
;

266 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 = 
POLLIN
;

267 
pﬁlfds
[
pﬁlfd_ödex
].
ªvíts
 = 0;

268 if(
c⁄ãxt
->
cuºít_out_∑ckë
){

269 
pﬁlfds
[
pﬁlfd_ödex
].
evíts
 |
POLLOUT
;

271 
c⁄ãxt
->
pﬁlfd_ödex
 =Öollfd_index;

272 
pﬁlfd_ödex
++;

275 
c⁄ãxt
->
bridge
->
ª°¨t_t
 = 
now
+c⁄ãxt->bridge->
ª°¨t_timeout
;

277 
c⁄ãxt
->
bridge
->
cur_addªss
++;

278 if(
c⁄ãxt
->
bridge
->
cur_addªss
 =c⁄ãxt->bridge->
addªss_cou¡
){

279 
c⁄ãxt
->
bridge
->
cur_addªss
 = 0;

287 
now_time
 = 
	`time
(
NULL
);

288 if(
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
 > 0 && 
now_time
 > 
expú©i⁄_check_time
){

289 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

290 if(
c⁄ãxt
->
sock
 =
INVALID_SOCKET
 && c⁄ãxt->
˛ón_£ssi⁄
 == 0){

296 if(
now_time
 > 
c⁄ãxt
->
disc⁄√˘_t
+
db
->
c⁄fig
->
≥rsi°ít_˛õ¡_expú©i⁄
){

297 if(
c⁄ãxt
->
id
){

298 
id
 = 
c⁄ãxt
->id;

300 
id
 = "<unknown>";

302 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "ExpúögÖîsi°íà˛õ¡ %†duêtÿtimeout.", 
id
);

303 #ifde‡
WITH_SYS_TREE


304 
g_˛õ¡s_expúed
++;

306 
c⁄ãxt
->
˛ón_£ssi⁄
 = 
åue
;

307 
c⁄ãxt
->
°©e
 = 
mosq_cs_expúög
;

308 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

312 
expú©i⁄_check_time
 = 
	`time
(
NULL
) + 3600;

315 
	`mqâ3_db_mesßge_timeout_check
(
db
, db->
c⁄fig
->
ªåy_öãrvÆ
);

317 #i‚de‡
WIN32


318 
	`sig¥ocmask
(
SIG_SETMASK
, &
sigblock
, &
‹igsig
);

319 
fdcou¡
 = 
	`pﬁl
(
pﬁlfds
, 
pﬁlfd_ödex
, 100);

320 
	`sig¥ocmask
(
SIG_SETMASK
, &
‹igsig
, 
NULL
);

322 
fdcou¡
 = 
	`WSAPﬁl
(
pﬁlfds
, 
pﬁlfd_ödex
, 100);

324 if(
fdcou¡
 == -1){

325 
	`lo›_h™dÀ_îr‹s
(
db
, 
pﬁlfds
);

327 
	`lo›_h™dÀ_ªads_wrôes
(
db
, 
pﬁlfds
);

329 
i
=0; i<
li°ísock_cou¡
; i++){

330 if(
pﬁlfds
[
i
].
ªvíts
 & (
POLLIN
 | 
POLLPRI
)){

332 
	`mqâ3_sockë_ac˚±
(
db
, 
li°ísock
[
i
],
pfds
) != -1){

337 #ifde‡
WITH_PERSISTENCE


338 if(
db
->
c⁄fig
->
≥rsi°í˚
 && db->c⁄fig->
autoßve_öãrvÆ
){

339 if(
db
->
c⁄fig
->
autoßve_⁄_ch™ges
){

340 if(
db
->
≥rsi°í˚_ch™ges
 >db->
c⁄fig
->
autoßve_öãrvÆ
){

341 
	`mqâ3_db_backup
(
db
, 
Ál£
);

342 
db
->
≥rsi°í˚_ch™ges
 = 0;

345 if(
œ°_backup
 + 
db
->
c⁄fig
->
autoßve_öãrvÆ
 < 
	`mosquôto_time
()){

346 
	`mqâ3_db_backup
(
db
, 
Ál£
);

347 
œ°_backup
 = 
	`mosquôto_time
();

353 #ifde‡
WITH_PERSISTENCE


354 if(
Êag_db_backup
){

355 
	`mqâ3_db_backup
(
db
, 
Ál£
);

356 
Êag_db_backup
 = 
Ál£
;

359 if(
Êag_ªlﬂd
){

360 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Reloading config.");

361 
	`mqâ3_c⁄fig_ªad
(
db
->
c⁄fig
, 
åue
);

362 
	`mosquôto_£curôy_˛ónup
(
db
, 
åue
);

363 
	`mosquôto_£curôy_öô
(
db
, 
åue
);

364 
	`mosquôto_£curôy_≠∂y
(
db
);

365 
	`mqâ3_log_˛o£
(
db
->
c⁄fig
);

366 
	`mqâ3_log_öô
(
db
->
c⁄fig
);

367 
Êag_ªlﬂd
 = 
Ál£
;

369 if(
Êag_åì_¥öt
){

370 
	`mqâ3_sub_åì_¥öt
(&
db
->
subs
, 0);

371 
Êag_åì_¥öt
 = 
Ál£
;

373 #ifde‡
WITH_WEBSOCKETS


374 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

379 if(
db
->
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
){

380 
	`libwebsockë_£rvi˚
(
db
->
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
, 0);

383 if(
db
->
c⁄fig
->
have_websockës_li°íî
){

384 
	`ãmp__expúe_websockës_˛õ¡s
(
db
);

389 if(
pﬁlfds
Ë
	`_mosquôto_‰ì
(pollfds);

390  
MOSQ_ERR_SUCCESS
;

391 
	}
}

393 
	$do_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

395 *
id
;

397 if(
c⁄ãxt
->
°©e
 =
mosq_cs_disc⁄√˘ed
){

400 #ifde‡
WITH_WEBSOCKETS


401 if(
c⁄ãxt
->
wsi
){

402 if(
c⁄ãxt
->
°©e
 !
mosq_cs_disc⁄√˘ög
){

403 
c⁄ãxt
->
°©e
 = 
mosq_cs_disc⁄√˘_ws
;

405 if(
c⁄ãxt
->
wsi
){

406 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
c⁄ãxt
->
ws_c⁄ãxt
, c⁄ãxt->
wsi
);

408 
c⁄ãxt
->
sock
 = 
INVALID_SOCKET
;

412 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

413 if(
c⁄ãxt
->
id
){

414 
id
 = 
c⁄ãxt
->id;

416 
id
 = "<unknown>";

418 if(
c⁄ãxt
->
°©e
 !
mosq_cs_disc⁄√˘ög
){

419 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "SockëÉº‹ o¿˛õ¡ %s, disc⁄√˘ög.", 
id
);

421 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ %†disc⁄√˘ed.", 
id
);

424 
	`mqâ3_c⁄ãxt_disc⁄√˘
(
db
, 
c⁄ãxt
);

425 #ifde‡
WITH_BRIDGE


426 if(
c⁄ãxt
->
˛ón_£ssi⁄
 && !c⁄ãxt->
bridge
){

428 if(
c⁄ãxt
->
˛ón_£ssi⁄
){

430 
	`mosquôto__add_c⁄ãxt_to_disu£d
(
db
, 
c⁄ãxt
);

431 if(
c⁄ãxt
->
id
){

432 
	`HASH_DELETE
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
);

433 
	`_mosquôto_‰ì
(
c⁄ãxt
->
id
);

434 
c⁄ãxt
->
id
 = 
NULL
;

437 
c⁄ãxt
->
°©e
 = 
mosq_cs_disc⁄√˘ed
;

439 
	}
}

444 
	$lo›_h™dÀ_îr‹s
(
mosquôto_db
 *
db
, 
pﬁlfd
 *
pﬁlfds
)

446 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

448 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

449 if(
c⁄ãxt
->
pﬁlfd_ödex
 < 0){

453 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & (
POLLERR
 | 
POLLNVAL
)){

454 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

457 
	}
}

459 
	$lo›_h™dÀ_ªads_wrôes
(
mosquôto_db
 *
db
, 
pﬁlfd
 *
pﬁlfds
)

461 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

462 
îr
;

463 
sockÀn_t
 
Àn
;

465 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

466 if(
c⁄ãxt
->
pﬁlfd_ödex
 < 0){

470 
	`as£π
(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
fd
 =c⁄ãxt->
sock
);

471 #ifde‡
WITH_TLS


472 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLOUT
 ||

473 
c⁄ãxt
->
w™t_wrôe
 ||

474 (
c⁄ãxt
->
s¶
 && c⁄ãxt->
°©e
 =
mosq_cs_√w
)){

476 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLOUT
){

478 if(
c⁄ãxt
->
°©e
 =
mosq_cs_c⁄√˘_≥ndög
){

479 
Àn
 = ();

480 if(!
	`gësock›t
(
c⁄ãxt
->
sock
, 
SOL_SOCKET
, 
SO_ERROR
, (*)&
îr
, &
Àn
)){

481 if(
îr
 == 0){

482 
c⁄ãxt
->
°©e
 = 
mosq_cs_√w
;

485 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

489 if(
	`_mosquôto_∑ckë_wrôe
(
c⁄ãxt
)){

490 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

496 
	`HASH_ITER
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
, 
c⁄ãxt
, 
˘xt_tmp
){

497 if(
c⁄ãxt
->
pﬁlfd_ödex
 < 0){

501 #ifde‡
WITH_TLS


502 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLIN
 ||

503 (
c⁄ãxt
->
s¶
 && c⁄ãxt->
°©e
 =
mosq_cs_√w
)){

505 if(
pﬁlfds
[
c⁄ãxt
->
pﬁlfd_ödex
].
ªvíts
 & 
POLLIN
){

508 if(
	`_mosquôto_∑ckë_ªad
(
db
, 
c⁄ãxt
)){

509 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

512 }
	`SSL_DATA_PENDING
(
c⁄ãxt
));

515 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/main.c

10 
	~<mosquôto_brokî.h
>

14 
	$maö
(
¨gc
, c⁄° * 
¨gv
[]) {

18 
	`¥ötf
("Beginnging custom main\n");

19 
	`öôûaizeMqâLib
(
¨gc
,
¨gv
);

21 
	`±hªad_exô
(
NULL
);

22 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/mosquitto.c

17 
	~<c⁄fig.h
>

19 #i‚de‡
WIN32


21 
	#_BSD_SOURCE


	)

22 
	~<uni°d.h
>

23 
	~<gΩ.h
>

26 #i‚de‡
WIN32


27 
	~<pwd.h
>

29 
	~<¥o˚ss.h
>

30 
	~<wösock2.h
>

31 
	~<ws2t˝ù.h
>

34 #i‚de‡
WIN32


35 
	~<sys/time.h
>

38 
	~<î∫o.h
>

39 
	~<sig«l.h
>

40 
	~<°dio.h
>

41 
	~<°rög.h
>

42 #ifde‡
WITH_WRAP


43 
	~<t˝d.h
>

45 #ifde‡
WITH_WEBSOCKETS


46 
	~<libwebsockës.h
>

49 
	~<mosquôto_brokî.h
>

50 
	~<mem‹y_mosq.h
>

51 
	~"utû_mosq.h
"

53 
mosquôto_db
 
	göt_db
;

55 
boﬁ
 
	gÊag_ªlﬂd
 = 
Ál£
;

56 #ifde‡
WITH_PERSISTENCE


57 
boﬁ
 
	gÊag_db_backup
 = 
Ál£
;

59 
boﬁ
 
	gÊag_åì_¥öt
 = 
Ál£
;

60 
	grun
;

61 #ifde‡
WITH_WRAP


62 
	~<sy¶og.h
>

63 
	gÆlow_£vîôy
 = 
LOG_INFO
;

64 
	gdíy_£vîôy
 = 
LOG_INFO
;

67 
h™dÀ_sigöt
(
sig«l
);

68 
h™dÀ_sigu§1
(
sig«l
);

69 
h™dÀ_sigu§2
(
sig«l
);

71 
mosquôto_db
 *
	$_mosquôto_gë_db
()

73  &
öt_db
;

74 
	}
}

84 
	$dr›_¥ivûeges
(
mqâ3_c⁄fig
 *
c⁄fig
, 
boﬁ
 
ãmp‹¨y
)

86 #i‡!
	`deföed
(
__CYGWIN__
Ë&& !deföed(
WIN32
)

87 
∑sswd
 *
pwd
;

88 
îr
[256];

89 
rc
;

91 if(
	`gëeuid
() == 0){

92 if(
c⁄fig
->
u£r
 && 
	`°rcmp
(config->user, "root")){

93 
pwd
 = 
	`gëpw«m
(
c⁄fig
->
u£r
);

94 if(!
pwd
){

95 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆid u£∏'%s'.", 
c⁄fig
->
u£r
);

98 if(
	`öôgroups
(
c⁄fig
->
u£r
, 
pwd
->
pw_gid
) == -1){

99 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

100 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög group†whû° dr›pögÖrivûeges: %s.", 
îr
);

103 if(
ãmp‹¨y
){

104 
rc
 = 
	`£ãgid
(
pwd
->
pw_gid
);

106 
rc
 = 
	`£tgid
(
pwd
->
pw_gid
);

108 if(
rc
 == -1){

109 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

110 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög gid whû° dr›pögÖrivûeges: %s.", 
îr
);

113 if(
ãmp‹¨y
){

114 
rc
 = 
	`£ãuid
(
pwd
->
pw_uid
);

116 
rc
 = 
	`£tuid
(
pwd
->
pw_uid
);

118 if(
rc
 == -1){

119 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

120 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög uid whû° dr›pögÖrivûeges: %s.", 
îr
);

124 if(
	`gëeuid
(Ë=0 || 
	`gëegid
() == 0){

125 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Mosquitto shouldÇot beÑunásÑoot/administrator.");

129  
MOSQ_ERR_SUCCESS
;

130 
	}
}

132 
	$ª°‹e_¥ivûeges
()

134 #i‡!
	`deföed
(
__CYGWIN__
Ë&& !deföed(
WIN32
)

135 
îr
[256];

136 
rc
;

138 if(
	`gëuid
() == 0){

139 
rc
 = 
	`£ãgid
(0);

140 if(
rc
 == -1){

141 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

142 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög gid whû°Ñe°‹ögÖrivûeges: %s.", 
îr
);

145 
rc
 = 
	`£ãuid
(0);

146 if(
rc
 == -1){

147 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

148 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ sëtög uid whû°Ñe°‹ögÖrivûeges: %s.", 
îr
);

153  
MOSQ_ERR_SUCCESS
;

154 
	}
}

156 #ifde‡
SIGHUP


158 
	$h™dÀ_sighup
(
sig«l
)

160 
Êag_ªlﬂd
 = 
åue
;

161 
	}
}

165 
	$h™dÀ_sigöt
(
sig«l
)

167 
run
 = 0;

168 
	}
}

171 
	$h™dÀ_sigu§1
(
sig«l
)

173 #ifde‡
WITH_PERSISTENCE


174 
Êag_db_backup
 = 
åue
;

176 
	}
}

179 
	$h™dÀ_sigu§2
(
sig«l
)

181 
Êag_åì_¥öt
 = 
åue
;

182 
	}
}

184 
	$öôûaizeMqâLib
(*
pùefds
)

186 
mosq_sock_t
 *
li°ísock
 = 
NULL
;

188 
pùeFDS
[0] = 
pùefds
[0];

189 
pùeFDS
[1] = 
pùefds
[1];

192 
li°ísock_cou¡
 = 0;

193 
li°ísock_ödex
 = 0;

194 
mqâ3_c⁄fig
 
c⁄fig
;

195 #ifde‡
WITH_SYS_TREE


196 
buf
[1024];

198 
i
, 
j
;

199 
FILE
 *
pid
;

200 
li°íî_max
;

201 
rc
;

202 #ifde‡
WIN32


203 
SYSTEMTIME
 
°
;

205 
îr
[256];

206 
timevÆ
 
tv
;

208 
mosquôto
 *
˘xt
, *
˘xt_tmp
;

210 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

226 #ifde‡
WIN32


227 
	`GëSy°emTime
(&
°
);

228 
	`§™d
(
°
.
wSec⁄d
 + st.
wMûli£c⁄ds
);

230 
	`gëtimeofday
(&
tv
, 
NULL
);

231 
	`§™d
(
tv
.
tv_£c
 +Åv.
tv_u£c
);

234 
	`mem£t
(&
öt_db
, 0, (
mosquôto_db
));

236 
	`_mosquôto_√t_öô
();

238 
	`mqâ3_c⁄fig_öô
(&
c⁄fig
);

239 
rc
 = 
	`mqâ3_c⁄fig_∑r£_¨gs
(&
c⁄fig
, 
NULL
, NULL);

240 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

241 
öt_db
.
c⁄fig
 = &config;

243 if(
c⁄fig
.
d´m⁄
){

244 #i‚de‡
WIN32


245 
	`f‹k
()){

249 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

250 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ i¿f‹k: %s", 
îr
);

253  
MOSQ_ERR_SUCCESS
;

256 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: Can't start in daemon mode in Windows.");

260 if(
c⁄fig
.
d´m⁄
 && c⁄fig.
pid_fûe
){

261 
pid
 = 
	`_mosquôto_f›í
(
c⁄fig
.
pid_fûe
, "wt");

262 if(
pid
){

263 
	`Ârötf
(
pid
, "%d", 
	`gëpid
());

264 
	`f˛o£
(
pid
);

266 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo writeÖid file.");

271 
rc
 = 
	`mqâ3_db_›í
(&
c⁄fig
, &
öt_db
);

272 if(
rc
 !
MOSQ_ERR_SUCCESS
){

273 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Couldn't open database.");

274  
rc
;

280 
	`mqâ3_log_öô
(&
c⁄fig
);

282 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "mosquôtÿvîsi⁄ %†(buûd d©ê%sË°¨tög", 
VERSION
, 
TIMESTAMP
);

283 if(
c⁄fig
.
c⁄fig_fûe
){

284 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "C⁄figÜﬂded from %s.", 
c⁄fig
.
c⁄fig_fûe
);

286 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Using default config.");

290 
rc
 = 
	`mosquôto_£curôy_moduÀ_öô
(&
öt_db
);

291 if(
rc
) Ñc;

292 
rc
 = 
	`mosquôto_£curôy_öô
(&
öt_db
, 
Ál£
);

293 if(
rc
) Ñc;

295 #ifde‡
WITH_SYS_TREE


296 if(
c⁄fig
.
sys_öãrvÆ
 > 0){

298 
	`¢¥ötf
(
buf
, 1024, "mosquôtÿvîsi⁄ %s", 
VERSION
);

299 
	`mqâ3_db_mesßges_ósy_queue
(&
öt_db
, 
NULL
, "$SYS/brokî/vîsi⁄", 2, 
	`°æí
(
buf
), buf, 1);

300 
	`¢¥ötf
(
buf
, 1024, "%s", 
TIMESTAMP
);

301 
	`mqâ3_db_mesßges_ósy_queue
(&
öt_db
, 
NULL
, "$SYS/brokî/time°amp", 2, 
	`°æí
(
buf
), buf, 1);

305 
li°íî_max
 = -1;

306 
li°ísock_ödex
 = 0;

307 
i
=0; i<
c⁄fig
.
li°íî_cou¡
; i++){

308 if(
c⁄fig
.
li°íîs
[
i
].
¥Ÿocﬁ
 =
mp_mqâ
){

309 if(
	`mqâ3_sockë_li°í
(&
c⁄fig
.
li°íîs
[
i
])){

310 
	`mqâ3_db_˛o£
(&
öt_db
);

311 if(
c⁄fig
.
pid_fûe
){

312 
	`ªmove
(
c⁄fig
.
pid_fûe
);

316 
li°ísock_cou¡
 +
c⁄fig
.
li°íîs
[
i
].
sock_cou¡
;

317 
li°ísock
 = 
	`_mosquôto_ªÆloc
÷i°ísock, (
mosq_sock_t
)*
li°ísock_cou¡
);

318 if(!
li°ísock
){

319 
	`mqâ3_db_˛o£
(&
öt_db
);

320 if(
c⁄fig
.
pid_fûe
){

321 
	`ªmove
(
c⁄fig
.
pid_fûe
);

325 
j
=0; j<
c⁄fig
.
li°íîs
[
i
].
sock_cou¡
; j++){

326 if(
c⁄fig
.
li°íîs
[
i
].
socks
[
j
] =
INVALID_SOCKET
){

327 
	`mqâ3_db_˛o£
(&
öt_db
);

328 if(
c⁄fig
.
pid_fûe
){

329 
	`ªmove
(
c⁄fig
.
pid_fûe
);

333 
li°ísock
[
li°ísock_ödex
] = 
c⁄fig
.
li°íîs
[
i
].
socks
[
j
];

334 if(
li°ísock
[
li°ísock_ödex
] > 
li°íî_max
){

335 
li°íî_max
 = 
li°ísock
[
li°ísock_ödex
];

337 
li°ísock_ödex
++;

339 }if(
c⁄fig
.
li°íîs
[
i
].
¥Ÿocﬁ
 =
mp_websockës
){

340 #ifde‡
WITH_WEBSOCKETS


341 
c⁄fig
.
li°íîs
[
i
].
ws_c⁄ãxt
 = 
	`mosq_websockës_öô
(&c⁄fig.li°íîs[i], c⁄fig.
websockës_log_Àvñ
);

342 if(!
c⁄fig
.
li°íîs
[
i
].
ws_c⁄ãxt
){

343 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ¸óã websockë†li°íî o¿p‹à%d.", 
c⁄fig
.
li°íîs
[
i
].
p‹t
);

350 
rc
 = 
	`dr›_¥ivûeges
(&
c⁄fig
, 
Ál£
);

351 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

353 
	`sig«l
(
SIGINT
, 
h™dÀ_sigöt
);

354 
	`sig«l
(
SIGTERM
, 
h™dÀ_sigöt
);

355 #ifde‡
SIGHUP


356 
	`sig«l
(
SIGHUP
, 
h™dÀ_sighup
);

358 #i‚de‡
WIN32


359 
	`sig«l
(
SIGUSR1
, 
h™dÀ_sigu§1
);

360 
	`sig«l
(
SIGUSR2
, 
h™dÀ_sigu§2
);

361 
	`sig«l
(
SIGPIPE
, 
SIG_IGN
);

364 #ifde‡
WITH_BRIDGE


365 
i
=0; i<
c⁄fig
.
bridge_cou¡
; i++){

366 if(
	`mqâ3_bridge_√w
(&
öt_db
, &(
c⁄fig
.
bridges
[
i
]))){

367 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "Warning: UnableÅo connectÅo bridge %s.",

368 
c⁄fig
.
bridges
[
i
].
«me
);

373 
run
 = 1;

374 
rc
 = 
	`mosquôto_maö_lo›
(&
öt_db
, 
li°ísock
, 
li°ísock_cou¡
, 
li°íî_max
,
pùefds
);

376 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "mosquôtÿvîsi⁄ %†ãrmö©ög", 
VERSION
);

377 
	`mqâ3_log_˛o£
(&
c⁄fig
);

379 #ifde‡
WITH_PERSISTENCE


380 if(
c⁄fig
.
≥rsi°í˚
){

381 
	`mqâ3_db_backup
(&
öt_db
, 
åue
);

385 #ifde‡
WITH_WEBSOCKETS


386 
i
=0; i<
öt_db
.
c⁄fig
->
li°íî_cou¡
; i++){

387 if(
öt_db
.
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
){

388 
	`libwebsockë_c⁄ãxt_de°roy
(
öt_db
.
c⁄fig
->
li°íîs
[
i
].
ws_c⁄ãxt
);

390 if(
öt_db
.
c⁄fig
->
li°íîs
[
i
].
ws_¥Ÿocﬁ
){

391 
	`_mosquôto_‰ì
(
öt_db
.
c⁄fig
->
li°íîs
[
i
].
ws_¥Ÿocﬁ
);

396 
	`HASH_ITER
(
hh_id
, 
öt_db
.
c⁄ãxts_by_id
, 
˘xt
, 
˘xt_tmp
){

397 #ifde‡
WITH_WEBSOCKETS


398 if(!
˘xt
->
wsi
){

399 
	`mqâ3_c⁄ãxt_˛ónup
(&
öt_db
, 
˘xt
, 
åue
);

402 
	`mqâ3_c⁄ãxt_˛ónup
(&
öt_db
, 
˘xt
, 
åue
);

405 
	`HASH_ITER
(
hh_sock
, 
öt_db
.
c⁄ãxts_by_sock
, 
˘xt
, 
˘xt_tmp
){

406 
	`mqâ3_c⁄ãxt_˛ónup
(&
öt_db
, 
˘xt
, 
åue
);

408 #ifde‡
WITH_BRIDGE


409 
i
=0; i<
öt_db
.
bridge_cou¡
; i++){

410 if(
öt_db
.
bridges
[
i
]){

411 
	`mqâ3_c⁄ãxt_˛ónup
(&
öt_db
, i¡_db.
bridges
[
i
], 
åue
);

414 if(
öt_db
.
bridges
){

415 
	`_mosquôto_‰ì
(
öt_db
.
bridges
);

418 
	`mosquôto__‰ì_disu£d_c⁄ãxts
(&
öt_db
);

420 
	`mqâ3_db_˛o£
(&
öt_db
);

422 if(
li°ísock
){

423 
i
=0; i<
li°ísock_cou¡
; i++){

424 if(
li°ísock
[
i
] !
INVALID_SOCKET
){

425 #i‚de‡
WIN32


426 
	`˛o£
(
li°ísock
[
i
]);

428 
	`˛o£sockë
(
li°ísock
[
i
]);

432 
	`_mosquôto_‰ì
(
li°ísock
);

435 
	`mosquôto_£curôy_moduÀ_˛ónup
(&
öt_db
);

437 if(
c⁄fig
.
pid_fûe
){

438 
	`ªmove
(
c⁄fig
.
pid_fûe
);

441 
	`mqâ3_c⁄fig_˛ónup
(
öt_db
.
c⁄fig
);

442 
	`_mosquôto_√t_˛ónup
();

444  
rc
;

445 
	}
}

447 #ifde‡
WIN32


448 
__°dˇŒ
 
	$WöMaö
(
HINSTANCE
 
hIn°™˚
, HINSTANCE 
hPªvIn°™˚
, 
LPSTR
 
ÕCmdLöe
, 
nCmdShow
)

450 **
¨gv
;

451 
¨gc
 = 1;

452 *
tokí
;

453 *
ßvïå
 = 
NULL
;

454 
rc
;

456 
¨gv
 = 
	`_mosquôto_mÆloc
((*)*1);

457 
¨gv
[0] = "mosquitto";

458 
tokí
 = 
	`°πok_r
(
ÕCmdLöe
, " ", &
ßvïå
);

459 
tokí
){

460 
¨gc
++;

461 
¨gv
 = 
	`_mosquôto_ªÆloc
◊rgv, (*)*
¨gc
);

462 if(!
¨gv
){

463 
	`Ârötf
(
°dîr
, "Error: Out of memory.\n");

464  
MOSQ_ERR_NOMEM
;

466 
¨gv
[
¨gc
-1] = 
tokí
;

467 
tokí
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

469 
rc
 = 
	`maö
(
¨gc
, 
¨gv
);

470 
	`_mosquôto_‰ì
(
¨gv
);

471  
rc
;

472 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/mosquitto_passwd.c

18 
	~<î∫o.h
>

19 
	~<›ís¶/evp.h
>

20 
	~<›ís¶/ønd.h
>

21 
	~<›ís¶/buf„r.h
>

22 
	~<sig«l.h
>

23 
	~<°dio.h
>

24 
	~<°dlib.h
>

25 
	~<°rög.h
>

26 #ifde‡
WIN32


27 
	~<¥o˚ss.h
>

28 #i‚de‡
__˝lu•lus


29 
	#boﬁ
 

	)

30 
	#åue
 1

	)

31 
	#Ál£
 0

	)

33 
	#¢¥ötf
 
•rötf_s


	)

34 
	~<io.h
>

36 
	~<°dboﬁ.h
>

37 
	~<uni°d.h
>

38 
	~<ãrmios.h
>

41 
	#MAX_BUFFER_LEN
 1024

	)

42 
	#SALT_LEN
 12

	)

44 
	$ba£64_ícode
(*
ö
, 
ö_Àn
, **
ícoded
)

46 
BIO
 *
bmem
, *
b64
;

47 
BUF_MEM
 *
b±r
;

49 
b64
 = 
	`BIO_√w
(
	`BIO_f_ba£64
());

50 
	`BIO_£t_Êags
(
b64
, 
BIO_FLAGS_BASE64_NO_NL
);

51 
bmem
 = 
	`BIO_√w
(
	`BIO_s_mem
());

52 
b64
 = 
	`BIO_push
(b64, 
bmem
);

53 
	`BIO_wrôe
(
b64
, 
ö
, 
ö_Àn
);

54 if(
	`BIO_Êush
(
b64
) != 1){

55 
	`BIO_‰ì_Æl
(
b64
);

58 
	`BIO_gë_mem_±r
(
b64
, &
b±r
);

59 *
ícoded
 = 
	`mÆloc
(
b±r
->
Àngth
+1);

60 if(!(*
ícoded
)){

61 
	`BIO_‰ì_Æl
(
b64
);

64 
	`mem˝y
(*
ícoded
, 
b±r
->
d©a
, b±r->
Àngth
);

65 (*
ícoded
)[
b±r
->
Àngth
] = '\0';

66 
	`BIO_‰ì_Æl
(
b64
);

69 
	}
}

72 
	$¥öt_ußge
()

74 
	`¥ötf
("mosquitto_passwd isáÅool for managingÖassword files for mosquitto.\n\n");

75 
	`¥ötf
("Usage: mosquitto_passwd [-c | -D]Öasswordfile username\n");

76 
	`¥ötf
(" mosquitto_passwd -bÖasswordfile usernameÖassword\n");

77 
	`¥ötf
(" mosquitto_passwd -UÖasswordfile\n");

78 
	`¥ötf
(" -b :Ñun in batch modeÅoállowÖassingÖasswords onÅhe commandÜine.\n");

79 
	`¥ötf
(" -c : createáÇewÖassword file. This will overwriteÉxisting files.\n");

80 
	`¥ötf
(" -D : deleteÅhe usernameÑatherÅhanádding/updating itsÖassword.\n");

81 
	`¥ötf
(" -U : updateáÖlainÅextÖassword fileÅo use hashedÖasswords.\n");

82 
	`¥ötf
("\nSee http://mosquitto.org/ for more information.\n\n");

83 
	}
}

85 
	$ouçut_√w_∑ssw‹d
(
FILE
 *
Âå
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

87 
rc
;

88 
ß…
[
SALT_LEN
];

89 *
ß…64
 = 
NULL
, *
hash64
 = NULL;

90 
hash
[
EVP_MAX_MD_SIZE
];

91 
hash_Àn
;

92 c⁄° 
EVP_MD
 *
dige°
;

93 
EVP_MD_CTX
 
c⁄ãxt
;

95 
rc
 = 
	`RAND_byãs
(
ß…
, 
SALT_LEN
);

96 if(!
rc
){

97 
	`Ârötf
(
°dîr
, "Error: InsufficientÉntropyávailableÅoÖerformÖassword generation.\n");

101 
rc
 = 
	`ba£64_ícode
(
ß…
, 
SALT_LEN
, &
ß…64
);

102 if(
rc
){

103 if(
ß…64
Ë
	`‰ì
(salt64);

104 
	`Ârötf
(
°dîr
, "Error: UnableÅoÉncode salt.\n");

109 
dige°
 = 
	`EVP_gë_dige°by«me
("sha512");

110 if(!
dige°
){

111 if(
ß…64
Ë
	`‰ì
(salt64);

112 
	`Ârötf
(
°dîr
, "Error: UnableÅo create openssl digest.\n");

116 
	`EVP_MD_CTX_öô
(&
c⁄ãxt
);

117 
	`EVP_Dige°Inô_ex
(&
c⁄ãxt
, 
dige°
, 
NULL
);

118 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
∑ssw‹d
, 
	`°æí
(password));

119 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
ß…
, 
SALT_LEN
);

120 
	`EVP_Dige°FöÆ_ex
(&
c⁄ãxt
, 
hash
, &
hash_Àn
);

121 
	`EVP_MD_CTX_˛ónup
(&
c⁄ãxt
);

123 
rc
 = 
	`ba£64_ícode
(
hash
, 
hash_Àn
, &
hash64
);

124 if(
rc
){

125 if(
ß…64
Ë
	`‰ì
(salt64);

126 if(
hash64
Ë
	`‰ì
(hash64);

127 
	`Ârötf
(
°dîr
, "Error: UnableÅoÉncode hash.\n");

131 
	`Ârötf
(
Âå
, "%s:$6$%s$%s\n", 
u£∫ame
, 
ß…64
, 
hash64
);

132 
	`‰ì
(
ß…64
);

133 
	`‰ì
(
hash64
);

136 
	}
}

138 
	$dñëe_pwu£r
(
FILE
 *
Âå
, FILE *
·mp
, c⁄° *
u£∫ame
)

140 
buf
[
MAX_BUFFER_LEN
];

141 
lbuf
[
MAX_BUFFER_LEN
], *
tokí
;

142 
boﬁ
 
found
 = 
Ál£
;

144 !
	`„of
(
Âå
Ë&& 
	`fgës
(
buf
, 
MAX_BUFFER_LEN
, fptr)){

145 
	`mem˝y
(
lbuf
, 
buf
, 
MAX_BUFFER_LEN
);

146 
tokí
 = 
	`°πok
(
lbuf
, ":");

147 if(
	`°rcmp
(
u£∫ame
, 
tokí
)){

148 
	`Ârötf
(
·mp
, "%s", 
buf
);

150 
found
 = 
åue
;

153 if(!
found
){

154 
	`Ârötf
(
°dîr
, "W¨nög: U£∏%†nŸ found i¿∑ssw‹d fûe.\n", 
u£∫ame
);

157 
	}
}

159 
	$upd©e_fûe
(
FILE
 *
Âå
, FILE *
·mp
)

161 
buf
[
MAX_BUFFER_LEN
];

162 
lbuf
[
MAX_BUFFER_LEN
];

163 *
u£∫ame
, *
∑ssw‹d
;

164 
rc
;

165 
Àn
;

167 !
	`„of
(
Âå
Ë&& 
	`fgës
(
buf
, 
MAX_BUFFER_LEN
, fptr)){

168 
	`mem˝y
(
lbuf
, 
buf
, 
MAX_BUFFER_LEN
);

169 
u£∫ame
 = 
	`°πok
(
lbuf
, ":");

170 
∑ssw‹d
 = 
	`°πok
(
NULL
, ":");

171 if(
∑ssw‹d
){

172 
Àn
 = 
	`°æí
(
∑ssw‹d
);

173 
Àn
 && (
∑ssw‹d
[len-1] == '\n' ||Öassword[len-1] == '\r')){

174 
∑ssw‹d
[
Àn
-1] = '\0';

175 
Àn
 = 
	`°æí
(
∑ssw‹d
);

177 
rc
 = 
	`ouçut_√w_∑ssw‹d
(
·mp
, 
u£∫ame
, 
∑ssw‹d
);

178 if(
rc
) Ñc;

180 
	`Ârötf
(
·mp
, "%s", 
u£∫ame
);

184 
	}
}

186 
	$upd©e_pwu£r
(
FILE
 *
Âå
, FILE *
·mp
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

188 
buf
[
MAX_BUFFER_LEN
];

189 
lbuf
[
MAX_BUFFER_LEN
], *
tokí
;

190 
boﬁ
 
found
 = 
Ál£
;

191 
rc
 = 1;

193 !
	`„of
(
Âå
Ë&& 
	`fgës
(
buf
, 
MAX_BUFFER_LEN
, fptr)){

194 
	`mem˝y
(
lbuf
, 
buf
, 
MAX_BUFFER_LEN
);

195 
tokí
 = 
	`°πok
(
lbuf
, ":");

196 if(
	`°rcmp
(
u£∫ame
, 
tokí
)){

197 
	`Ârötf
(
·mp
, "%s", 
buf
);

199 
rc
 = 
	`ouçut_√w_∑ssw‹d
(
·mp
, 
u£∫ame
, 
∑ssw‹d
);

200 
found
 = 
åue
;

203 if(
found
){

204  
rc
;

206  
	`ouçut_√w_∑ssw‹d
(
·mp
, 
u£∫ame
, 
∑ssw‹d
);

208 
	}
}

210 
	$gës_quõt
(*
s
, 
Àn
)

212 #ifde‡
WIN32


213 
HANDLE
 
h
;

214 
DWORD
 
c⁄_‹ig
, 
c⁄_quõt
;

215 
DWORD
 
ªad_Àn
 = 0;

217 
	`mem£t
(
s
, 0, 
Àn
);

218 
h
 = 
	`GëStdH™dÀ
(
STD_INPUT_HANDLE
);

219 
	`GëC⁄sﬁeMode
(
h
, &
c⁄_‹ig
);

220 
c⁄_quõt
 &~
ENABLE_ECHO_INPUT
;

221 
c⁄_quõt
 |
ENABLE_LINE_INPUT
;

222 
	`SëC⁄sﬁeMode
(
h
, 
c⁄_quõt
);

223 if(!
	`RódC⁄sﬁe
(
h
, 
s
, 
Àn
, &
ªad_Àn
, 
NULL
)){

224 
	`SëC⁄sﬁeMode
(
h
, 
c⁄_‹ig
);

227 
s
[
	`°æí
(s)-1] == 10 || s[strlen(s)-1] == 13){

228 
s
[
	`°æí
(s)-1] = 0;

230 if(
	`°æí
(
s
) == 0){

233 
	`SëC⁄sﬁeMode
(
h
, 
c⁄_‹ig
);

237 
ãrmios
 
ts_quõt
, 
ts_‹ig
;

238 *
rs
;

240 
	`mem£t
(
s
, 0, 
Àn
);

241 
	`tcgë©å
(0, &
ts_‹ig
);

242 
ts_quõt
 = 
ts_‹ig
;

243 
ts_quõt
.
c_lÊag
 &~(
ECHO
 | 
ICANON
);

244 
	`tc£èâr
(0, 
TCSANOW
, &
ts_quõt
);

246 
rs
 = 
	`fgës
(
s
, 
Àn
, 
°dö
);

247 
	`tc£èâr
(0, 
TCSANOW
, &
ts_‹ig
);

249 if(!
rs
){

252 
s
[
	`°æí
(s)-1] == 10 || s[strlen(s)-1] == 13){

253 
s
[
	`°æí
(s)-1] = 0;

255 if(
	`°æí
(
s
) == 0){

261 
	}
}

263 
	$gë_∑ssw‹d
(*
∑ssw‹d
, 
Àn
)

265 
pw1
[
MAX_BUFFER_LEN
], 
pw2
[MAX_BUFFER_LEN];

267 
	`¥ötf
("Password: ");

268 if(
	`gës_quõt
(
pw1
, 
MAX_BUFFER_LEN
)){

269 
	`Ârötf
(
°dîr
, "Error: EmptyÖassword.\n");

272 
	`¥ötf
("\n");

274 
	`¥ötf
("ReenterÖassword: ");

275 if(
	`gës_quõt
(
pw2
, 
MAX_BUFFER_LEN
)){

276 
	`Ârötf
(
°dîr
, "Error: EmptyÖassword.\n");

279 
	`¥ötf
("\n");

281 if(
	`°rcmp
(
pw1
, 
pw2
)){

282 
	`Ârötf
(
°dîr
, "Error: Passwords doÇot match.\n");

286 
	`°∫˝y
(
∑ssw‹d
, 
pw1
, 
Àn
);

288 
	}
}

290 
	$c›y_c⁄ã¡s
(
FILE
 *
§c
, FILE *
de°
)

292 
buf
[
MAX_BUFFER_LEN
];

293 
Àn
;

295 
	`ªwöd
(
§c
);

296 
	`ªwöd
(
de°
);

298 #ifde‡
WIN32


299 
	`_chsize
(
	`fûío
(
de°
), 0);

301 if(
	`·runˇã
(
	`fûío
(
de°
), 0))  1;

304 !
	`„of
(
§c
)){

305 
Àn
 = 
	`‰ód
(
buf
, 1, 
MAX_BUFFER_LEN
, 
§c
);

306 if(
Àn
 > 0){

307 if(
	`fwrôe
(
buf
, 1, 
Àn
, 
de°
) !=Üen){

311  !
	`„of
(
§c
);

315 
	}
}

317 
	$¸óã_backup
(c⁄° *
backup_fûe
, 
FILE
 *
Âå
)

319 
FILE
 *
fbackup
;

321 
fbackup
 = 
	`f›í
(
backup_fûe
, "wt");

322 if(!
fbackup
){

323 
	`Ârötf
(
°dîr
, "Eº‹ cª©ög backu∞∑ssw‹d fûê\"%s\",ÇŸ c⁄töuög.\n", 
backup_fûe
);

326 if(
	`c›y_c⁄ã¡s
(
Âå
, 
fbackup
)){

327 
	`Ârötf
(
°dîr
, "Eº‹ c›yög d©®tÿbacku∞∑ssw‹d fûê\"%s\",ÇŸ c⁄töuög.\n", 
backup_fûe
);

328 
	`f˛o£
(
fbackup
);

331 
	`f˛o£
(
fbackup
);

332 
	`ªwöd
(
Âå
);

334 
	}
}

335 
	$h™dÀ_sigöt
(
sig«l
)

337 #i‚de‡
WIN32


338 
ãrmios
 
ts
;

340 
	`tcgë©å
(0, &
ts
);

341 
ts
.
c_lÊag
 |
ECHO
 | 
ICANON
;

342 
	`tc£èâr
(0, 
TCSANOW
, &
ts
);

344 
	`exô
(0);

345 
	}
}

347 
	$_maö_
(
¨gc
, *
¨gv
[])

349 *
∑ssw‹d_fûe_tmp
 = 
NULL
;

350 
∑ssw‹d_fûe
[1024];

351 *
u£∫ame
 = 
NULL
;

352 *
∑ssw‹d_cmd
 = 
NULL
;

353 
boﬁ
 
b©ch_mode
 = 
Ál£
;

354 
boﬁ
 
¸óã_√w
 = 
Ál£
;

355 
boﬁ
 
dñëe_u£r
 = 
Ál£
;

356 
FILE
 *
Âå
, *
·mp
;

357 
∑ssw‹d
[
MAX_BUFFER_LEN
];

358 
rc
;

359 
boﬁ
 
do_upd©e_fûe
 = 
Ál£
;

360 *
backup_fûe
;

362 
	`sig«l
(
SIGINT
, 
h™dÀ_sigöt
);

363 
	`sig«l
(
SIGTERM
, 
h™dÀ_sigöt
);

365 
	`O≥nSSL_add_Æl_dige°s
();

367 if(
¨gc
 == 5){

368 if(!
	`°rcmp
(
¨gv
[1], "-b")){

369 
b©ch_mode
 = 
åue
;

371 
	`Ârötf
(
°dîr
, "Eº‹: Unknow¿›ti⁄ '%s'\n", 
¨gv
[1]);

373 
∑ssw‹d_fûe_tmp
 = 
¨gv
[2];

374 
u£∫ame
 = 
¨gv
[3];

375 
∑ssw‹d_cmd
 = 
¨gv
[4];

376 }if(
¨gc
 == 4){

377 if(!
	`°rcmp
(
¨gv
[1], "-c")){

378 
¸óã_√w
 = 
åue
;

379 }if(!
	`°rcmp
(
¨gv
[1], "-D")){

380 
dñëe_u£r
 = 
åue
;

382 
	`Ârötf
(
°dîr
, "Eº‹: Unknow¿›ti⁄ '%s'\n", 
¨gv
[1]);

385 
∑ssw‹d_fûe_tmp
 = 
¨gv
[2];

386 
u£∫ame
 = 
¨gv
[3];

387 }if(
¨gc
 == 3){

388 if(!
	`°rcmp
(
¨gv
[1], "-U")){

389 
do_upd©e_fûe
 = 
åue
;

390 
∑ssw‹d_fûe_tmp
 = 
¨gv
[2];

392 
∑ssw‹d_fûe_tmp
 = 
¨gv
[1];

393 
u£∫ame
 = 
¨gv
[2];

396 
	`¥öt_ußge
();

400 
	`¢¥ötf
(
∑ssw‹d_fûe
, 1024, "%s", 
∑ssw‹d_fûe_tmp
);

402 if(
¸óã_√w
){

403 
rc
 = 
	`gë_∑ssw‹d
(
∑ssw‹d
, 1024);

404 if(
rc
) Ñc;

405 
Âå
 = 
	`f›í
(
∑ssw‹d_fûe
, "wt");

406 if(!
Âå
){

407 
	`Ârötf
(
°dîr
, "Eº‹: U«bÀÅÿ›í fûê%†f‹ wrôög. %s.\n", 
∑ssw‹d_fûe
, 
	`°ªº‹
(
î∫o
));

410 
rc
 = 
	`ouçut_√w_∑ssw‹d
(
Âå
, 
u£∫ame
, 
∑ssw‹d
);

411 
	`f˛o£
(
Âå
);

412  
rc
;

414 
Âå
 = 
	`f›í
(
∑ssw‹d_fûe
, "r+t");

415 if(!
Âå
){

416 
	`Ârötf
(
°dîr
, "Eº‹: U«bÀÅÿ›íÖassw‹d fûê%s. %s.\n", 
∑ssw‹d_fûe
, 
	`°ªº‹
(
î∫o
));

420 
backup_fûe
 = 
	`mÆloc
(
	`°æí
(
∑ssw‹d_fûe
)+5);

421 
	`¢¥ötf
(
backup_fûe
, 
	`°æí
(
∑ssw‹d_fûe
)+5, "%s.tmp",Öassword_file);

423 if(
	`¸óã_backup
(
backup_fûe
, 
Âå
)){

424 
	`f˛o£
(
Âå
);

425 
	`‰ì
(
backup_fûe
);

429 
·mp
 = 
	`tmpfûe
();

430 if(!
·mp
){

431 
	`Ârötf
(
°dîr
, "Eº‹: U«bÀÅÿ›íÅemp‹¨y fûe. %s.\n", 
	`°ªº‹
(
î∫o
));

432 
	`f˛o£
(
Âå
);

433 
	`‰ì
(
backup_fûe
);

436 if(
dñëe_u£r
){

437 
rc
 = 
	`dñëe_pwu£r
(
Âå
, 
·mp
, 
u£∫ame
);

438 }if(
do_upd©e_fûe
){

439 
rc
 = 
	`upd©e_fûe
(
Âå
, 
·mp
);

441 if(
b©ch_mode
){

443 
rc
 = 
	`upd©e_pwu£r
(
Âå
, 
·mp
, 
u£∫ame
, 
∑ssw‹d_cmd
);

445 
rc
 = 
	`gë_∑ssw‹d
(
∑ssw‹d
, 1024);

446 if(
rc
){

447 
	`f˛o£
(
Âå
);

448 
	`f˛o£
(
·mp
);

449 
	`u∆ök
(
backup_fûe
);

450 
	`‰ì
(
backup_fûe
);

451  
rc
;

454 
rc
 = 
	`upd©e_pwu£r
(
Âå
, 
·mp
, 
u£∫ame
, 
∑ssw‹d
);

457 if(
rc
){

458 
	`f˛o£
(
Âå
);

459 
	`f˛o£
(
·mp
);

460 
	`u∆ök
(
backup_fûe
);

461 
	`‰ì
(
backup_fûe
);

462  
rc
;

465 if(
	`c›y_c⁄ã¡s
(
·mp
, 
Âå
)){

466 
	`f˛o£
(
Âå
);

467 
	`f˛o£
(
·mp
);

468 
	`Ârötf
(
°dîr
, "Error occurred updatingÖassword file.\n");

469 
	`Ârötf
(
°dîr
, "Passw‹d fûêmay bêc‹ru±, checkÅhêbacku∞fûe: %s.\n", 
backup_fûe
);

470 
	`‰ì
(
backup_fûe
);

473 
	`f˛o£
(
Âå
);

474 
	`f˛o£
(
·mp
);

478 
	`u∆ök
(
backup_fûe
);

479 
	`‰ì
(
backup_fûe
);

483 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/net.c

17 
	~<c⁄fig.h
>

19 #i‚de‡
WIN32


20 
	~<√tdb.h
>

21 
	~<uni°d.h
>

22 
	~<¨∑/öë.h
>

23 
	~<sys/sockë.h
>

25 
	~<wösock2.h
>

26 
	~<ws2t˝ù.h
>

29 
	~<as£π.h
>

30 
	~<î∫o.h
>

31 
	~<f˙é.h
>

32 
	~<°dio.h
>

33 
	~<°rög.h
>

34 #ifde‡
WITH_WRAP


35 
	~<t˝d.h
>

38 #ifde‡
__FªeBSD__


39 
	~<√töë/ö.h
>

40 
	~<sys/sockë.h
>

43 #ifde‡
__QNX__


44 
	~<√töë/ö.h
>

45 
	~<√t/√tbyã.h
>

46 
	~<sys/sockë.h
>

49 
	~<mosquôto_brokî.h
>

50 
	~<mqâ3_¥Ÿocﬁ.h
>

51 
	~<mem‹y_mosq.h
>

52 
	~<√t_mosq.h
>

53 
	~<utû_mosq.h
>

55 #ifde‡
WITH_TLS


56 
	~"és_mosq.h
"

57 
	~<›ís¶/îr.h
>

58 
	gés_ex_ödex_c⁄ãxt
 = -1;

59 
	gés_ex_ödex_li°íî
 = -1;

62 #ifde‡
WITH_SYS_TREE


63 
g_sockë_c⁄√˘i⁄s
;

66 
	$mqâ3_sockë_ac˚±
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
li°ísock
,*
pfds
)

68 
i
;

69 
j
;

70 
mosq_sock_t
 
√w_sock
 = 
INVALID_SOCKET
;

71 
mosquôto
 *
√w_c⁄ãxt
;

72 #ifde‡
WITH_TLS


73 
BIO
 *
bio
;

74 
rc
;

75 
ebuf
[256];

76 
e
;

78 #ifde‡
WITH_WRAP


79 
ªque°_öfo
 
wøp_ªq
;

80 
addªss
[1024];

84 
√w_sock
 = 
	`ac˚±
(
li°ísock
, 
NULL
, 0);

88 if(
√w_sock
 =
INVALID_SOCKET
)  -1;

90 #ifde‡
WITH_SYS_TREE


91 
g_sockë_c⁄√˘i⁄s
++;

94 if(
	`_mosquôto_sockë_n⁄block
(
√w_sock
)){

95  
INVALID_SOCKET
;

98 #ifde‡
WITH_WRAP


100 
	`ªque°_öô
(&
wøp_ªq
, 
RQ_FILE
, 
√w_sock
, 
RQ_DAEMON
, "mosquitto", 0);

101 
	`‰omho°
(&
wøp_ªq
);

102 if(!
	`ho°s_ac˚ss
(&
wøp_ªq
)){

104 if(!
	`_mosquôto_sockë_gë_addªss
(
√w_sock
, 
addªss
, 1024)){

105 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ c⁄√˘i⁄ from %†díõdác˚s†byÅ˝d.", 
addªss
);

107 
	`COMPAT_CLOSE
(
√w_sock
);

111 
√w_c⁄ãxt
 = 
	`mqâ3_c⁄ãxt_öô
(
db
, 
√w_sock
);

112 if(!
√w_c⁄ãxt
){

113 
	`COMPAT_CLOSE
(
√w_sock
);

116 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

117 
j
=0; j<
db
->
c⁄fig
->
li°íîs
[
i
].
sock_cou¡
; j++){

118 if(
db
->
c⁄fig
->
li°íîs
[
i
].
socks
[
j
] =
li°ísock
){

119 
√w_c⁄ãxt
->
li°íî
 = &
db
->
c⁄fig
->
li°íîs
[
i
];

120 
√w_c⁄ãxt
->
li°íî
->
˛õ¡_cou¡
++;

126 if(!
√w_c⁄ãxt
->
li°íî
){

127 
	`mqâ3_c⁄ãxt_˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

132 if(
√w_c⁄ãxt
->
li°íî
->
max_c⁄√˘i⁄s
 > 0 &&Çew_c⁄ãxt->li°íî->
˛õ¡_cou¡
 >Çew_context->listener->max_connections){

133 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "Clõ¡ c⁄√˘i⁄ from %†díõd: max_c⁄√˘i⁄†ex˚eded.", 
√w_c⁄ãxt
->
addªss
);

134 
	`mqâ3_c⁄ãxt_˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

138 #ifde‡
WITH_TLS


140 
i
=0; i<
db
->
c⁄fig
->
li°íî_cou¡
; i++){

141 
j
=0; j<
db
->
c⁄fig
->
li°íîs
[
i
].
sock_cou¡
; j++){

142 if(
db
->
c⁄fig
->
li°íîs
[
i
].
socks
[
j
] =
li°ísock
){

143 if(
db
->
c⁄fig
->
li°íîs
[
i
].
s¶_˘x
){

144 
√w_c⁄ãxt
->
s¶
 = 
	`SSL_√w
(
db
->
c⁄fig
->
li°íîs
[
i
].
s¶_˘x
);

145 if(!
√w_c⁄ãxt
->
s¶
){

146 
	`mqâ3_c⁄ãxt_˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

149 
	`SSL_£t_ex_d©a
(
√w_c⁄ãxt
->
s¶
, 
és_ex_ödex_c⁄ãxt
,Çew_context);

150 
	`SSL_£t_ex_d©a
(
√w_c⁄ãxt
->
s¶
, 
és_ex_ödex_li°íî
, &
db
->
c⁄fig
->
li°íîs
[
i
]);

151 
√w_c⁄ãxt
->
w™t_wrôe
 = 
åue
;

152 
bio
 = 
	`BIO_√w_sockë
(
√w_sock
, 
BIO_NOCLOSE
);

153 
	`SSL_£t_bio
(
√w_c⁄ãxt
->
s¶
, 
bio
, bio);

154 
rc
 = 
	`SSL_ac˚±
(
√w_c⁄ãxt
->
s¶
);

155 if(
rc
 != 1){

156 
rc
 = 
	`SSL_gë_îr‹
(
√w_c⁄ãxt
->
s¶
,Ñc);

157 if(
rc
 =
SSL_ERROR_WANT_READ
){

159 }if(
rc
 =
SSL_ERROR_WANT_WRITE
){

160 
√w_c⁄ãxt
->
w™t_wrôe
 = 
åue
;

162 
e
 = 
	`ERR_gë_îr‹
();

163 
e
){

164 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
,

166 
√w_c⁄ãxt
->
addªss
, 
	`ERR_îr‹_°rög
(
e
, 
ebuf
));

167 
e
 = 
	`ERR_gë_îr‹
();

169 
	`mqâ3_c⁄ãxt_˛ónup
(
db
, 
√w_c⁄ãxt
, 
åue
);

179 
	`wrôe
(
pùeFDS
[1], 
√w_c⁄ãxt
->
addªss
, (new_context->address));

181 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New c⁄√˘i⁄ from %†⁄Ö‹à%d.", 
√w_c⁄ãxt
->
addªss
,Çew_c⁄ãxt->
li°íî
->
p‹t
);

183  
√w_sock
;

184 
	}
}

186 #ifde‡
WITH_TLS


187 
	$˛õ¡_˚πifiˇã_vîify
(
¥evîify_ok
, 
X509_STORE_CTX
 *
˘x
)

190  
¥evîify_ok
;

191 
	}
}

194 #ifde‡
REAL_WITH_TLS_PSK


195 
	$psk_£rvî_ˇŒback
(
SSL
 *
s¶
, c⁄° *
idítôy
, *
psk
, 
max_psk_Àn
)

197 
mosquôto_db
 *
db
;

198 
mosquôto
 *
c⁄ãxt
;

199 
_mqâ3_li°íî
 *
li°íî
;

200 *
psk_key
 = 
NULL
;

201 
Àn
;

202 c⁄° *
psk_höt
;

204 if(!
idítôy
)  0;

206 
db
 = 
	`_mosquôto_gë_db
();

208 
c⁄ãxt
 = 
	`SSL_gë_ex_d©a
(
s¶
, 
és_ex_ödex_c⁄ãxt
);

209 if(!
c⁄ãxt
)  0;

211 
li°íî
 = 
	`SSL_gë_ex_d©a
(
s¶
, 
és_ex_ödex_li°íî
);

212 if(!
li°íî
)  0;

214 
psk_höt
 = 
li°íî
->psk_hint;

218 
psk_key
 = 
	`_mosquôto_ˇŒoc
(1, 
max_psk_Àn
*2 + 1);

219 if(!
psk_key
)  0;

221 if(
	`mosquôto_psk_key_gë
(
db
, 
psk_höt
, 
idítôy
, 
psk_key
, 
max_psk_Àn
*2Ë!
MOSQ_ERR_SUCCESS
){

222 
	`_mosquôto_‰ì
(
psk_key
);

226 
Àn
 = 
	`_mosquôto_hex2bö
(
psk_key
, 
psk
, 
max_psk_Àn
);

227 i‡(
Àn
 < 0){

228 
	`_mosquôto_‰ì
(
psk_key
);

232 if(
li°íî
->
u£_idítôy_as_u£∫ame
){

233 
c⁄ãxt
->
u£∫ame
 = 
	`_mosquôto_°rdup
(
idítôy
);

234 if(!
c⁄ãxt
->
u£∫ame
){

235 
	`_mosquôto_‰ì
(
psk_key
);

240 
	`_mosquôto_‰ì
(
psk_key
);

241  
Àn
;

242 
	}
}

245 #ifde‡
WITH_TLS


246 
	$_mosquôto_és_£rvî_˘x
(
_mqâ3_li°íî
 *
li°íî
)

248 
s¶_›ti⁄s
 = 0;

249 
buf
[256];

250 
rc
;

251 #ifde‡
WITH_EC


252 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x10000000L && OPENSSL_VERSION_NUMBER < 0x10002000L

253 
EC_KEY
 *
ecdh
 = 
NULL
;

257 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x10001000L

258 if(
li°íî
->
és_vîsi⁄
 =
NULL
){

259 
li°íî
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`SSLv23_£rvî_mëhod
());

260 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1.2")){

261 
li°íî
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`TLSv1_2_£rvî_mëhod
());

262 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1.1")){

263 
li°íî
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`TLSv1_1_£rvî_mëhod
());

264 }if(!
	`°rcmp
(
li°íî
->
és_vîsi⁄
, "tlsv1")){

265 
li°íî
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`TLSv1_£rvî_mëhod
());

268 
li°íî
->
s¶_˘x
 = 
	`SSL_CTX_√w
(
	`SSLv23_£rvî_mëhod
());

270 if(!
li°íî
->
s¶_˘x
){

271 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo create TLS context.");

276 
s¶_›ti⁄s
 = 
SSL_OP_NO_SSLv2
 | 
SSL_OP_NO_SSLv3
;

277 #ifde‡
SSL_OP_NO_COMPRESSION


279 
s¶_›ti⁄s
 |
SSL_OP_NO_COMPRESSION
;

281 #ifde‡
SSL_OP_CIPHER_SERVER_PREFERENCE


283 
s¶_›ti⁄s
 |
SSL_OP_CIPHER_SERVER_PREFERENCE
;

285 
	`SSL_CTX_£t_›ti⁄s
(
li°íî
->
s¶_˘x
, 
s¶_›ti⁄s
);

287 #ifde‡
SSL_MODE_RELEASE_BUFFERS


289 
	`SSL_CTX_£t_mode
(
li°íî
->
s¶_˘x
, 
SSL_MODE_RELEASE_BUFFERS
);

292 #ifde‡
WITH_EC


293 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x10002000L

294 
	`SSL_CTX_£t_ecdh_auto
(
li°íî
->
s¶_˘x
, 1);

295 #ñi‡
OPENSSL_VERSION_NUMBER
 >= 0x10000000L && OPENSSL_VERSION_NUMBER < 0x10002000L

296 
ecdh
 = 
	`EC_KEY_√w_by_curve_«me
(
NID_X9_62_¥ime256v1
);

297 if(!
ecdh
){

298 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo create TLS ECDH curve.");

301 
	`SSL_CTX_£t_tmp_ecdh
(
li°íî
->
s¶_˘x
, 
ecdh
);

302 
	`EC_KEY_‰ì
(
ecdh
);

306 
	`¢¥ötf
(
buf
, 256, "mosquôto-%d", 
li°íî
->
p‹t
);

307 
	`SSL_CTX_£t_£ssi⁄_id_c⁄ãxt
(
li°íî
->
s¶_˘x
, (*)
buf
, 
	`°æí
(buf));

309 if(
li°íî
->
cùhîs
){

310 
rc
 = 
	`SSL_CTX_£t_cùhî_li°
(
li°íî
->
s¶_˘x
,Üi°íî->
cùhîs
);

311 if(
rc
 == 0){

312 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ£àTLS cùhîs. Check cùhîÜi° \"%s\".", 
li°íî
->
cùhîs
);

316 
rc
 = 
	`SSL_CTX_£t_cùhî_li°
(
li°íî
->
s¶_˘x
, "DEFAULT:!aNULL:!eNULL:!LOW:!EXPORT:!SSLv2:@STRENGTH");

317 if(
rc
 == 0){

318 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ£àTLS cùhîs. Check cùhîÜi° \"%s\".", 
li°íî
->
cùhîs
);

322  
MOSQ_ERR_SUCCESS
;

323 
	}
}

330 
	$mqâ3_sockë_li°í
(
_mqâ3_li°íî
 *
li°íî
)

332 
mosq_sock_t
 
sock
 = 
INVALID_SOCKET
;

333 
addröfo
 
höts
;

334 
addröfo
 *
aöfo
, *
Ω
;

335 
£rvi˚
[10];

336 #i‚de‡
WIN32


337 
ss_›t
 = 1;

339 
ss_›t
 = 1;

341 #ifde‡
WITH_TLS


342 
rc
;

343 
X509_STORE
 *
°‹e
;

344 
X509_LOOKUP
 *
lookup
;

346 
buf
[256];

348 if(!
li°íî
Ë 
MOSQ_ERR_INVAL
;

350 
	`¢¥ötf
(
£rvi˚
, 10, "%d", 
li°íî
->
p‹t
);

351 
	`mem£t
(&
höts
, 0, (
addröfo
));

352 
höts
.
ai_Ámûy
 = 
PF_UNSPEC
;

353 
höts
.
ai_Êags
 = 
AI_PASSIVE
;

354 
höts
.
ai_sockty≥
 = 
SOCK_STREAM
;

356 if(
	`gëaddröfo
(
li°íî
->
ho°
, 
£rvi˚
, &
höts
, &
aöfo
)Ë 
INVALID_SOCKET
;

358 
li°íî
->
sock_cou¡
 = 0;

359 
li°íî
->
socks
 = 
NULL
;

361 
Ω
 = 
aöfo
;Ñp;Ñ∞Ω->
ai_√xt
){

362 if(
Ω
->
ai_Ámûy
 =
AF_INET
){

363 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "O≥nög ipv4Üi°í sockë o¿p‹à%d.", 
	`¡ohs
(((
sockaddr_ö
 *)
Ω
->
ai_addr
)->
sö_p‹t
));

364 }if(
Ω
->
ai_Ámûy
 =
AF_INET6
){

365 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "O≥nög ipv6Üi°í sockë o¿p‹à%d.", 
	`¡ohs
(((
sockaddr_ö6
 *)
Ω
->
ai_addr
)->
sö6_p‹t
));

370 
sock
 = 
	`sockë
(
Ω
->
ai_Ámûy
,Ñp->
ai_sockty≥
,Ñp->
ai_¥Ÿocﬁ
);

371 if(
sock
 =
INVALID_SOCKET
){

372 
	`°ªº‹_r
(
î∫o
, 
buf
, 256);

373 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "W¨nög: %s", 
buf
);

376 
li°íî
->
sock_cou¡
++;

377 
li°íî
->
socks
 = 
	`_mosquôto_ªÆloc
÷i°íî->socks, (
mosq_sock_t
)*li°íî->
sock_cou¡
);

378 if(!
li°íî
->
socks
){

379 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

380  
MOSQ_ERR_NOMEM
;

382 
li°íî
->
socks
[li°íî->
sock_cou¡
-1] = 
sock
;

384 #i‚de‡
WIN32


385 
ss_›t
 = 1;

386 
	`£tsock›t
(
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
ss_›t
, (ss_opt));

388 
ss_›t
 = 1;

389 
	`£tsock›t
(
sock
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
, &
ss_›t
, (ss_opt));

391 if(
	`_mosquôto_sockë_n⁄block
(
sock
)){

395 if(
	`böd
(
sock
, 
Ω
->
ai_addr
,Ñp->
ai_addæí
) == -1){

396 #ifde‡
WIN32


397 
î∫o
 = 
	`WSAGëLa°Eº‹
();

399 
	`°ªº‹_r
(
î∫o
, 
buf
, 256);

400 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s", 
buf
);

401 
	`COMPAT_CLOSE
(
sock
);

405 if(
	`li°í
(
sock
, 100) == -1){

406 #ifde‡
WIN32


407 
î∫o
 = 
	`WSAGëLa°Eº‹
();

409 
	`°ªº‹_r
(
î∫o
, 
buf
, 256);

410 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s", 
buf
);

411 
	`COMPAT_CLOSE
(
sock
);

415 
	`‰ìaddröfo
(
aöfo
);

418 if(
li°íî
->
sock_cou¡
 > 0){

419 #ifde‡
WITH_TLS


420 if((
li°íî
->
ˇfûe
 ||Üi°íî->
ˇ∑th
Ë&&Üi°íî->
˚πfûe
 &&Üi°íî->
keyfûe
){

421 if(
	`_mosquôto_és_£rvî_˘x
(
li°íî
)){

422 
	`COMPAT_CLOSE
(
sock
);

426 
rc
 = 
	`SSL_CTX_lﬂd_vîify_loˇti⁄s
(
li°íî
->
s¶_˘x
,Üi°íî->
ˇfûe
,Üi°íî->
ˇ∑th
);

427 if(
rc
 == 0){

428 if(
li°íî
->
ˇfûe
 &&Üi°íî->
ˇ∑th
){

429 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs. Check cafûê\"%s\"ánd c≠©h \"%s\".", 
li°íî
->
ˇfûe
,Üi°íî->
ˇ∑th
);

430 }if(
li°íî
->
ˇfûe
){

431 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs. Check cafûê\"%s\".", 
li°íî
->
ˇfûe
);

433 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd CA cîtifiˇãs. Check c≠©h \"%s\".", 
li°íî
->
ˇ∑th
);

435 
	`COMPAT_CLOSE
(
sock
);

439 if(
li°íî
->
ªquúe_˚πifiˇã
){

440 
	`SSL_CTX_£t_vîify
(
li°íî
->
s¶_˘x
, 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
, 
˛õ¡_˚πifiˇã_vîify
);

442 
	`SSL_CTX_£t_vîify
(
li°íî
->
s¶_˘x
, 
SSL_VERIFY_NONE
, 
˛õ¡_˚πifiˇã_vîify
);

444 
rc
 = 
	`SSL_CTX_u£_˚πifiˇã_chaö_fûe
(
li°íî
->
s¶_˘x
,Üi°íî->
˚πfûe
);

445 if(
rc
 != 1){

446 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd sîvî cîtifiˇã \"%s\". Check cîtfûe.", 
li°íî
->
˚πfûe
);

447 
	`COMPAT_CLOSE
(
sock
);

450 
rc
 = 
	`SSL_CTX_u£_Priv©eKey_fûe
(
li°íî
->
s¶_˘x
,Üi°íî->
keyfûe
, 
SSL_FILETYPE_PEM
);

451 if(
rc
 != 1){

452 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd sîvî key fûê\"%s\". Check keyfûe.", 
li°íî
->
keyfûe
);

453 
	`COMPAT_CLOSE
(
sock
);

456 
rc
 = 
	`SSL_CTX_check_¥iv©e_key
(
li°íî
->
s¶_˘x
);

457 if(
rc
 != 1){

458 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Server certificate/keyáre inconsistent.");

459 
	`COMPAT_CLOSE
(
sock
);

463 if(
li°íî
->
¸lfûe
){

464 
°‹e
 = 
	`SSL_CTX_gë_˚π_°‹e
(
li°íî
->
s¶_˘x
);

465 if(!
°‹e
){

466 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo obtain TLS store.");

467 
	`COMPAT_CLOSE
(
sock
);

470 
lookup
 = 
	`X509_STORE_add_lookup
(
°‹e
, 
	`X509_LOOKUP_fûe
());

471 
rc
 = 
	`X509_lﬂd_¸l_fûe
(
lookup
, 
li°íî
->
¸lfûe
, 
X509_FILETYPE_PEM
);

472 if(
rc
 != 1){

473 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿlﬂd cîtifiˇãÑevoˇti⁄ fûê\"%s\". Check cæfûe.", 
li°íî
->
¸lfûe
);

474 
	`COMPAT_CLOSE
(
sock
);

477 
	`X509_STORE_£t_Êags
(
°‹e
, 
X509_V_FLAG_CRL_CHECK
);

480 #ifde‡
REAL_WITH_TLS_PSK


481 }if(
li°íî
->
psk_höt
){

482 if(
és_ex_ödex_c⁄ãxt
 == -1){

483 
és_ex_ödex_c⁄ãxt
 = 
	`SSL_gë_ex_√w_ödex
(0, "˛õ¡ c⁄ãxt", 
NULL
, NULL, NULL);

485 if(
és_ex_ödex_li°íî
 == -1){

486 
és_ex_ödex_li°íî
 = 
	`SSL_gë_ex_√w_ödex
(0, "li°íî", 
NULL
, NULL, NULL);

489 if(
	`_mosquôto_és_£rvî_˘x
(
li°íî
)){

490 
	`COMPAT_CLOSE
(
sock
);

493 
	`SSL_CTX_£t_psk_£rvî_ˇŒback
(
li°íî
->
s¶_˘x
, 
psk_£rvî_ˇŒback
);

494 if(
li°íî
->
psk_höt
){

495 
rc
 = 
	`SSL_CTX_u£_psk_idítôy_höt
(
li°íî
->
s¶_˘x
,Üi°íî->
psk_höt
);

496 if(
rc
 == 0){

497 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅo set TLS PSK hint.");

498 
	`COMPAT_CLOSE
(
sock
);

509 
	}
}

511 
	$_mosquôto_sockë_gë_addªss
(
mosq_sock_t
 
sock
, *
buf
, 
Àn
)

513 
sockaddr_°‹age
 
addr
;

514 
sockÀn_t
 
addæí
;

516 
addæí
 = (
addr
);

517 if(!
	`gë≥î«me
(
sock
, (
sockaddr
 *)&
addr
, &
addæí
)){

518 if(
addr
.
ss_Ámûy
 =
AF_INET
){

519 if(
	`öë_¡›
(
AF_INET
, &((
sockaddr_ö
 *)&
addr
)->
sö_addr
.
s_addr
, 
buf
, 
Àn
)){

522 }if(
addr
.
ss_Ámûy
 =
AF_INET6
){

523 if(
	`öë_¡›
(
AF_INET6
, &((
sockaddr_ö6
 *)&
addr
)->
sö6_addr
.
s6_addr
, 
buf
, 
Àn
)){

529 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/persist.c

17 
	~<c⁄fig.h
>

19 #ifde‡
WITH_PERSISTENCE


21 #i‚de‡
WIN32


22 
	~<¨∑/öë.h
>

24 
	~<as£π.h
>

25 
	~<î∫o.h
>

26 
	~<f˙é.h
>

27 
	~<°dio.h
>

28 
	~<°rög.h
>

29 
	~<sys/°©.h
>

30 
	~<time.h
>

32 
	~<mosquôto_brokî.h
>

33 
	~<mem‹y_mosq.h
>

34 
	~<≥rsi°.h
>

35 
	~<time_mosq.h
>

36 
	~"utû_mosq.h
"

38 
uöt32_t
 
	gdb_vîsi⁄
;

41 
_db_ª°‹e_sub
(
mosquôto_db
 *
db
, c⁄° *
˛õ¡_id
, c⁄° *
sub
, 
qos
);

43 
mosquôto
 *
	$_db_föd_‹_add_c⁄ãxt
(
mosquôto_db
 *
db
, c⁄° *
˛õ¡_id
, 
uöt16_t
 
œ°_mid
)

45 
mosquôto
 *
c⁄ãxt
;

47 
c⁄ãxt
 = 
NULL
;

48 
	`HASH_FIND
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
˛õ¡_id
, 
	`°æí
(˛õ¡_id), 
c⁄ãxt
);

49 if(!
c⁄ãxt
){

50 
c⁄ãxt
 = 
	`mqâ3_c⁄ãxt_öô
(
db
, -1);

51 if(!
c⁄ãxt
Ë 
NULL
;

52 
c⁄ãxt
->
id
 = 
	`_mosquôto_°rdup
(
˛õ¡_id
);

53 if(!
c⁄ãxt
->
id
){

54 
	`_mosquôto_‰ì
(
c⁄ãxt
);

55  
NULL
;

58 
c⁄ãxt
->
˛ón_£ssi⁄
 = 
Ál£
;

60 
	`HASH_ADD_KEYPTR
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
->
id
, 
	`°æí
(context->id), context);

62 if(
œ°_mid
){

63 
c⁄ãxt
->
œ°_mid
 =Üast_mid;

65  
c⁄ãxt
;

66 
	}
}

68 
	$mqâ3_db_˛õ¡_mesßges_wrôe
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
, 
mosquôto
 *
c⁄ãxt
)

70 
uöt32_t
 
Àngth
;

71 
dbid_t
 
i64ãmp
;

72 
uöt16_t
 
i16ãmp
, 
¶í
;

73 
uöt8_t
 
i8ãmp
;

74 
mosquôto_˛õ¡_msg
 *
cmsg
;

76 
	`as£π
(
db
);

77 
	`as£π
(
db_Âå
);

78 
	`as£π
(
c⁄ãxt
);

80 
cmsg
 = 
c⁄ãxt
->
msgs
;

81 
cmsg
){

82 
¶í
 = 
	`°æí
(
c⁄ãxt
->
id
);

84 
Àngth
 = 
	`ht⁄l
((
dbid_t
Ë+ (
uöt16_t
Ë+ (
uöt8_t
) +

85 (
uöt8_t
) + (uint8_t) + (uint8_t) +

86 (
uöt8_t
Ë+ 2+
¶í
);

88 
i16ãmp
 = 
	`ht⁄s
(
DB_CHUNK_CLIENT_MSG
);

89 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

90 
	`wrôe_e
(
db_Âå
, &
Àngth
, (
uöt32_t
));

92 
i16ãmp
 = 
	`ht⁄s
(
¶í
);

93 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

94 
	`wrôe_e
(
db_Âå
, 
c⁄ãxt
->
id
, 
¶í
);

96 
i64ãmp
 = 
cmsg
->
°‹e
->
db_id
;

97 
	`wrôe_e
(
db_Âå
, &
i64ãmp
, (
dbid_t
));

99 
i16ãmp
 = 
	`ht⁄s
(
cmsg
->
mid
);

100 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

102 
i8ãmp
 = (
uöt8_t
 )
cmsg
->
qos
;

103 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

105 
i8ãmp
 = (
uöt8_t
 )
cmsg
->
ªèö
;

106 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

108 
i8ãmp
 = (
uöt8_t
 )
cmsg
->
dúe˘i⁄
;

109 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

111 
i8ãmp
 = (
uöt8_t
 )
cmsg
->
°©e
;

112 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

114 
i8ãmp
 = (
uöt8_t
 )
cmsg
->
dup
;

115 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

117 
cmsg
 = cmsg->
√xt
;

120  
MOSQ_ERR_SUCCESS
;

121 
îr‹
:

122 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

124 
	}
}

127 
	$mqâ3_db_mesßge_°‹e_wrôe
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

129 
uöt32_t
 
Àngth
;

130 
dbid_t
 
i64ãmp
;

131 
uöt32_t
 
i32ãmp
;

132 
uöt16_t
 
i16ãmp
, 
¶í
;

133 
uöt8_t
 
i8ãmp
;

134 
mosquôto_msg_°‹e
 *
°‹ed
;

135 
boﬁ
 
f‹˚_no_ªèö
;

137 
	`as£π
(
db
);

138 
	`as£π
(
db_Âå
);

140 
°‹ed
 = 
db
->
msg_°‹e
;

141 
°‹ed
){

142 if(!
	`°∫cmp
(
°‹ed
->
t›ic
, "$SYS", 4)){

147 
f‹˚_no_ªèö
 = 
åue
;

149 
f‹˚_no_ªèö
 = 
Ál£
;

151 
Àngth
 = 
	`ht⁄l
((
dbid_t
Ë+ 2+
	`°æí
(
°‹ed
->
sour˚_id
) +

152 (
uöt16_t
) + (uint16_t) +

153 2+
	`°æí
(
°‹ed
->
t›ic
Ë+ (
uöt32_t
) +

154 
°‹ed
->
∑ylﬂdÀn
 + (
uöt8_t
) + (uint8_t));

156 
i16ãmp
 = 
	`ht⁄s
(
DB_CHUNK_MSG_STORE
);

157 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

158 
	`wrôe_e
(
db_Âå
, &
Àngth
, (
uöt32_t
));

160 
i64ãmp
 = 
°‹ed
->
db_id
;

161 
	`wrôe_e
(
db_Âå
, &
i64ãmp
, (
dbid_t
));

163 
¶í
 = 
	`°æí
(
°‹ed
->
sour˚_id
);

164 
i16ãmp
 = 
	`ht⁄s
(
¶í
);

165 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

166 if(
¶í
){

167 
	`wrôe_e
(
db_Âå
, 
°‹ed
->
sour˚_id
, 
¶í
);

170 
i16ãmp
 = 
	`ht⁄s
(
°‹ed
->
sour˚_mid
);

171 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

173 
i16ãmp
 = 
	`ht⁄s
(
°‹ed
->
mid
);

174 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

176 
¶í
 = 
	`°æí
(
°‹ed
->
t›ic
);

177 
i16ãmp
 = 
	`ht⁄s
(
¶í
);

178 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

179 
	`wrôe_e
(
db_Âå
, 
°‹ed
->
t›ic
, 
¶í
);

181 
i8ãmp
 = (
uöt8_t
 )
°‹ed
->
qos
;

182 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

184 if(
f‹˚_no_ªèö
 =
Ál£
){

185 
i8ãmp
 = (
uöt8_t
 )
°‹ed
->
ªèö
;

187 
i8ãmp
 = 0;

189 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

191 
i32ãmp
 = 
	`ht⁄l
(
°‹ed
->
∑ylﬂdÀn
);

192 
	`wrôe_e
(
db_Âå
, &
i32ãmp
, (
uöt32_t
));

193 if(
°‹ed
->
∑ylﬂdÀn
){

194 
	`wrôe_e
(
db_Âå
, 
°‹ed
->
∑ylﬂd
, ()°‹ed->
∑ylﬂdÀn
);

196 
°‹ed
 = st‹ed->
√xt
;

199  
MOSQ_ERR_SUCCESS
;

200 
îr‹
:

201 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

203 
	}
}

205 
	$mqâ3_db_˛õ¡_wrôe
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

207 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

208 
uöt16_t
 
i16ãmp
, 
¶í
;

209 
uöt32_t
 
Àngth
;

210 
time_t
 
disc⁄√˘_t
;

212 
	`as£π
(
db
);

213 
	`as£π
(
db_Âå
);

215 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

216 if(
c⁄ãxt
 && c⁄ãxt->
˛ón_£ssi⁄
 =
Ál£
){

217 
Àngth
 = 
	`ht⁄l
(2+
	`°æí
(
c⁄ãxt
->
id
Ë+ (
uöt16_t
Ë+ (
time_t
));

219 
i16ãmp
 = 
	`ht⁄s
(
DB_CHUNK_CLIENT
);

220 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

221 
	`wrôe_e
(
db_Âå
, &
Àngth
, (
uöt32_t
));

223 
¶í
 = 
	`°æí
(
c⁄ãxt
->
id
);

224 
i16ãmp
 = 
	`ht⁄s
(
¶í
);

225 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

226 
	`wrôe_e
(
db_Âå
, 
c⁄ãxt
->
id
, 
¶í
);

227 
i16ãmp
 = 
	`ht⁄s
(
c⁄ãxt
->
œ°_mid
);

228 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

229 if(
c⁄ãxt
->
disc⁄√˘_t
){

230 
disc⁄√˘_t
 = 
c⁄ãxt
->disconnect_t;

232 
disc⁄√˘_t
 = 
	`time
(
NULL
);

234 
	`wrôe_e
(
db_Âå
, &
disc⁄√˘_t
, (
time_t
));

236 if(
	`mqâ3_db_˛õ¡_mesßges_wrôe
(
db
, 
db_Âå
, 
c⁄ãxt
))  1;

240  
MOSQ_ERR_SUCCESS
;

241 
îr‹
:

242 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

244 
	}
}

246 
	$_db_subs_ªèö_wrôe
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
, 
_mosquôto_subhõr
 *
node
, c⁄° *
t›ic
)

248 
_mosquôto_subhõr
 *
subhõr
;

249 
_mosquôto_subÀaf
 *
sub
;

250 *
thi°›ic
;

251 
uöt32_t
 
Àngth
;

252 
uöt16_t
 
i16ãmp
;

253 
dbid_t
 
i64ãmp
;

254 
size_t
 
¶í
;

256 
¶í
 = 
	`°æí
(
t›ic
Ë+ såÀn(
node
->topic) + 2;

257 
thi°›ic
 = 
	`_mosquôto_mÆloc
(()*
¶í
);

258 if(!
thi°›ic
Ë 
MOSQ_ERR_NOMEM
;

259 if(
	`°æí
(
t›ic
)){

260 
	`¢¥ötf
(
thi°›ic
, 
¶í
, "%s/%s", 
t›ic
, 
node
->topic);

262 
	`¢¥ötf
(
thi°›ic
, 
¶í
, "%s", 
node
->
t›ic
);

265 
sub
 = 
node
->
subs
;

266 
sub
){

267 if(
sub
->
c⁄ãxt
->
˛ón_£ssi⁄
 =
Ál£
){

268 
Àngth
 = 
	`ht⁄l
(2+
	`°æí
(
sub
->
c⁄ãxt
->
id
Ë+ 2+°æí(
thi°›ic
Ë+ (
uöt8_t
));

270 
i16ãmp
 = 
	`ht⁄s
(
DB_CHUNK_SUB
);

271 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

272 
	`wrôe_e
(
db_Âå
, &
Àngth
, (
uöt32_t
));

274 
¶í
 = 
	`°æí
(
sub
->
c⁄ãxt
->
id
);

275 
i16ãmp
 = 
	`ht⁄s
(
¶í
);

276 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

277 
	`wrôe_e
(
db_Âå
, 
sub
->
c⁄ãxt
->
id
, 
¶í
);

279 
¶í
 = 
	`°æí
(
thi°›ic
);

280 
i16ãmp
 = 
	`ht⁄s
(
¶í
);

281 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

282 
	`wrôe_e
(
db_Âå
, 
thi°›ic
, 
¶í
);

284 
	`wrôe_e
(
db_Âå
, &
sub
->
qos
, (
uöt8_t
));

286 
sub
 = sub->
√xt
;

288 if(
node
->
ªèöed
){

289 if(
	`°∫cmp
(
node
->
ªèöed
->
t›ic
, "$SYS", 4)){

291 
Àngth
 = 
	`ht⁄l
((
dbid_t
));

293 
i16ãmp
 = 
	`ht⁄s
(
DB_CHUNK_RETAIN
);

294 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

295 
	`wrôe_e
(
db_Âå
, &
Àngth
, (
uöt32_t
));

297 
i64ãmp
 = 
node
->
ªèöed
->
db_id
;

298 
	`wrôe_e
(
db_Âå
, &
i64ãmp
, (
dbid_t
));

302 
subhõr
 = 
node
->
chûdªn
;

303 
subhõr
){

304 
	`_db_subs_ªèö_wrôe
(
db
, 
db_Âå
, 
subhõr
, 
thi°›ic
);

305 
subhõr
 = subhõr->
√xt
;

307 
	`_mosquôto_‰ì
(
thi°›ic
);

308  
MOSQ_ERR_SUCCESS
;

309 
îr‹
:

310 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

312 
	}
}

314 
	$mqâ3_db_subs_ªèö_wrôe
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

316 
_mosquôto_subhõr
 *
subhõr
;

318 
subhõr
 = 
db
->
subs
.
chûdªn
;

319 
subhõr
){

320 
	`_db_subs_ªèö_wrôe
(
db
, 
db_Âå
, 
subhõr
, "");

321 
subhõr
 = subhõr->
√xt
;

324  
MOSQ_ERR_SUCCESS
;

325 
	}
}

327 
	$mqâ3_db_backup
(
mosquôto_db
 *
db
, 
boﬁ
 
shutdown
)

329 
rc
 = 0;

330 
FILE
 *
db_Âå
 = 
NULL
;

331 
uöt32_t
 
db_vîsi⁄_w
 = 
	`ht⁄l
(
MOSQ_DB_VERSION
);

332 
uöt32_t
 
¸c
 = 
	`ht⁄l
(0);

333 
dbid_t
 
i64ãmp
;

334 
uöt32_t
 
i32ãmp
;

335 
uöt16_t
 
i16ãmp
;

336 
uöt8_t
 
i8ãmp
;

337 
îr
[256];

338 *
outfûe
 = 
NULL
;

339 
Àn
;

341 if(!
db
 || !db->
c⁄fig
 || !db->c⁄fig->
≥rsi°í˚_fûï©h
Ë 
MOSQ_ERR_INVAL
;

342 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Savög in-mem‹y d©aba£Åÿ%s.", 
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
);

344 
Àn
 = 
	`°æí
(
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
)+5;

345 
outfûe
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

346 if(!
outfûe
){

347 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Error saving in-memory database, out of memory.");

348  
MOSQ_ERR_NOMEM
;

350 
	`¢¥ötf
(
outfûe
, 
Àn
, "%s.√w", 
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
);

351 
outfûe
[
Àn
] = '\0';

352 
db_Âå
 = 
	`_mosquôto_f›í
(
outfûe
, "wb");

353 if(
db_Âå
 =
NULL
){

354 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Eº‹ savög in-mem‹y d©aba£, u«bÀÅÿ›í %†f‹ wrôög.", 
outfûe
);

355 
îr‹
;

359 
	`wrôe_e
(
db_Âå
, 
magic
, 15);

360 
	`wrôe_e
(
db_Âå
, &
¸c
, (
uöt32_t
));

361 
	`wrôe_e
(
db_Âå
, &
db_vîsi⁄_w
, (
uöt32_t
));

364 
i16ãmp
 = 
	`ht⁄s
(
DB_CHUNK_CFG
);

365 
	`wrôe_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

367 
i32ãmp
 = 
	`ht⁄l
((
dbid_t
Ë+ (
uöt8_t
) + (uint8_t));

368 
	`wrôe_e
(
db_Âå
, &
i32ãmp
, (
uöt32_t
));

370 
i8ãmp
 = 
shutdown
;

371 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

372 
i8ãmp
 = (
dbid_t
);

373 
	`wrôe_e
(
db_Âå
, &
i8ãmp
, (
uöt8_t
));

375 
i64ãmp
 = 
db
->
œ°_db_id
;

376 
	`wrôe_e
(
db_Âå
, &
i64ãmp
, (
dbid_t
));

378 if(
	`mqâ3_db_mesßge_°‹e_wrôe
(
db
, 
db_Âå
)){

379 
îr‹
;

382 
	`mqâ3_db_˛õ¡_wrôe
(
db
, 
db_Âå
);

383 
	`mqâ3_db_subs_ªèö_wrôe
(
db
, 
db_Âå
);

385 
	`f˛o£
(
db_Âå
);

387 #ifde‡
WIN32


388 if(
	`ªmove
(
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
) != 0){

389 if(
î∫o
 !
ENOENT
){

390 
îr‹
;

394 if(
	`ª«me
(
outfûe
, 
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
) != 0){

395 
îr‹
;

397 
	`_mosquôto_‰ì
(
outfûe
);

398 
outfûe
 = 
NULL
;

399  
rc
;

400 
îr‹
:

401 if(
outfûe
Ë
	`_mosquôto_‰ì
(outfile);

402 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

403 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

404 if(
db_Âå
Ë
	`f˛o£
(db_fptr);

406 
	}
}

408 
	$_db_˛õ¡_msg_ª°‹e
(
mosquôto_db
 *
db
, c⁄° *
˛õ¡_id
, 
uöt16_t
 
mid
, 
uöt8_t
 
qos
, uöt8_à
ªèö
, uöt8_à
dúe˘i⁄
, uöt8_à
°©e
, uöt8_à
dup
, 
uöt64_t
 
°‹e_id
)

410 
mosquôto_˛õ¡_msg
 *
cmsg
;

411 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
;

412 
mosquôto
 *
c⁄ãxt
;

414 
cmsg
 = 
	`_mosquôto_mÆloc
((
mosquôto_˛õ¡_msg
));

415 if(!
cmsg
){

416 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

417  
MOSQ_ERR_NOMEM
;

420 
cmsg
->
√xt
 = 
NULL
;

421 
cmsg
->
°‹e
 = 
NULL
;

422 
cmsg
->
mid
 = mid;

423 
cmsg
->
qos
 = qos;

424 
cmsg
->
ªèö
 =Ñetain;

425 
cmsg
->
time°amp
 = 0;

426 
cmsg
->
dúe˘i⁄
 = direction;

427 
cmsg
->
°©e
 = state;

428 
cmsg
->
dup
 = dup;

430 
	`HASH_FIND
(
hh
, 
db
->
msg_°‹e_lﬂd
, &
°‹e_id
, (
dbid_t
), 
lﬂd
);

431 if(!
lﬂd
){

432 
	`_mosquôto_‰ì
(
cmsg
);

433 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "ErrorÑestoringÖersistent database, message store corrupt.");

436 
cmsg
->
°‹e
 = 
lﬂd
->store;

437 
cmsg
->
°‹e
->
ªf_cou¡
++;

439 
c⁄ãxt
 = 
	`_db_föd_‹_add_c⁄ãxt
(
db
, 
˛õ¡_id
, 0);

440 if(!
c⁄ãxt
){

441 
	`_mosquôto_‰ì
(
cmsg
);

442 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "ErrorÑestoringÖersistent database, message store corrupt.");

445 if(
c⁄ãxt
->
msgs
){

446 
c⁄ãxt
->
œ°_msg
->
√xt
 = 
cmsg
;

448 
c⁄ãxt
->
msgs
 = 
cmsg
;

450 
c⁄ãxt
->
œ°_msg
 = 
cmsg
;

452  
MOSQ_ERR_SUCCESS
;

453 
	}
}

455 
	$_db_˛õ¡_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

457 
uöt16_t
 
i16ãmp
, 
¶í
, 
œ°_mid
;

458 *
˛õ¡_id
 = 
NULL
;

459 
rc
 = 0;

460 
mosquôto
 *
c⁄ãxt
;

461 
time_t
 
disc⁄√˘_t
;

463 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

464 
¶í
 = 
	`¡ohs
(
i16ãmp
);

465 if(!
¶í
){

466 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: CorruptÖersistent database.");

467 
	`f˛o£
(
db_Âå
);

470 
˛õ¡_id
 = 
	`_mosquôto_mÆloc
(
¶í
+1);

471 if(!
˛õ¡_id
){

472 
	`f˛o£
(
db_Âå
);

473 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

474  
MOSQ_ERR_NOMEM
;

476 
	`ªad_e
(
db_Âå
, 
˛õ¡_id
, 
¶í
);

477 
˛õ¡_id
[
¶í
] = '\0';

479 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

480 
œ°_mid
 = 
	`¡ohs
(
i16ãmp
);

482 if(
db_vîsi⁄
 == 2){

483 
disc⁄√˘_t
 = 
	`time
(
NULL
);

485 
	`ªad_e
(
db_Âå
, &
disc⁄√˘_t
, (
time_t
));

488 
c⁄ãxt
 = 
	`_db_föd_‹_add_c⁄ãxt
(
db
, 
˛õ¡_id
, 
œ°_mid
);

489 if(
c⁄ãxt
){

490 
c⁄ãxt
->
disc⁄√˘_t
 = disconnect_t;

492 
rc
 = 1;

495 
	`_mosquôto_‰ì
(
˛õ¡_id
);

497  
rc
;

498 
îr‹
:

499 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
	`°ªº‹
(
î∫o
));

500 
	`f˛o£
(
db_Âå
);

501 if(
˛õ¡_id
Ë
	`_mosquôto_‰ì
(client_id);

503 
	}
}

505 
	$_db_˛õ¡_msg_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

507 
dbid_t
 
i64ãmp
, 
°‹e_id
;

508 
uöt16_t
 
i16ãmp
, 
¶í
, 
mid
;

509 
uöt8_t
 
qos
, 
ªèö
, 
dúe˘i⁄
, 
°©e
, 
dup
;

510 *
˛õ¡_id
 = 
NULL
;

511 
rc
;

512 
îr
[256];

514 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

515 
¶í
 = 
	`¡ohs
(
i16ãmp
);

516 if(!
¶í
){

517 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: CorruptÖersistent database.");

518 
	`f˛o£
(
db_Âå
);

521 
˛õ¡_id
 = 
	`_mosquôto_mÆloc
(
¶í
+1);

522 if(!
˛õ¡_id
){

523 
	`f˛o£
(
db_Âå
);

524 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

525  
MOSQ_ERR_NOMEM
;

527 
	`ªad_e
(
db_Âå
, 
˛õ¡_id
, 
¶í
);

528 
˛õ¡_id
[
¶í
] = '\0';

530 
	`ªad_e
(
db_Âå
, &
i64ãmp
, (
dbid_t
));

531 
°‹e_id
 = 
i64ãmp
;

533 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

534 
mid
 = 
	`¡ohs
(
i16ãmp
);

536 
	`ªad_e
(
db_Âå
, &
qos
, (
uöt8_t
));

537 
	`ªad_e
(
db_Âå
, &
ªèö
, (
uöt8_t
));

538 
	`ªad_e
(
db_Âå
, &
dúe˘i⁄
, (
uöt8_t
));

539 
	`ªad_e
(
db_Âå
, &
°©e
, (
uöt8_t
));

540 
	`ªad_e
(
db_Âå
, &
dup
, (
uöt8_t
));

542 
rc
 = 
	`_db_˛õ¡_msg_ª°‹e
(
db
, 
˛õ¡_id
, 
mid
, 
qos
, 
ªèö
, 
dúe˘i⁄
, 
°©e
, 
dup
, 
°‹e_id
);

543 
	`_mosquôto_‰ì
(
˛õ¡_id
);

545  
rc
;

546 
îr‹
:

547 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

548 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

549 
	`f˛o£
(
db_Âå
);

550 if(
˛õ¡_id
Ë
	`_mosquôto_‰ì
(client_id);

552 
	}
}

554 
	$_db_msg_°‹e_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

556 
dbid_t
 
i64ãmp
, 
°‹e_id
;

557 
uöt32_t
 
i32ãmp
, 
∑ylﬂdÀn
;

558 
uöt16_t
 
i16ãmp
, 
¶í
, 
sour˚_mid
;

559 
uöt8_t
 
qos
, 
ªèö
, *
∑ylﬂd
 = 
NULL
;

560 *
sour˚_id
 = 
NULL
;

561 *
t›ic
 = 
NULL
;

562 
rc
 = 0;

563 
mosquôto_msg_°‹e
 *
°‹ed
 = 
NULL
;

564 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
;

565 
îr
[256];

567 
lﬂd
 = 
	`_mosquôto_mÆloc
((
mosquôto_msg_°‹e_lﬂd
));

568 if(!
lﬂd
){

569 
	`f˛o£
(
db_Âå
);

570 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

571  
MOSQ_ERR_NOMEM
;

574 
	`ªad_e
(
db_Âå
, &
i64ãmp
, (
dbid_t
));

575 
°‹e_id
 = 
i64ãmp
;

577 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

578 
¶í
 = 
	`¡ohs
(
i16ãmp
);

579 if(
¶í
){

580 
sour˚_id
 = 
	`_mosquôto_mÆloc
(
¶í
+1);

581 if(!
sour˚_id
){

582 
	`_mosquôto_‰ì
(
lﬂd
);

583 
	`f˛o£
(
db_Âå
);

584 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

585  
MOSQ_ERR_NOMEM
;

587 
	`ªad_e
(
db_Âå
, 
sour˚_id
, 
¶í
);

588 
sour˚_id
[
¶í
] = '\0';

590 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

591 
sour˚_mid
 = 
	`¡ohs
(
i16ãmp
);

594 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

596 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

597 
¶í
 = 
	`¡ohs
(
i16ãmp
);

598 if(
¶í
){

599 
t›ic
 = 
	`_mosquôto_mÆloc
(
¶í
+1);

600 if(!
t›ic
){

601 
	`_mosquôto_‰ì
(
lﬂd
);

602 
	`f˛o£
(
db_Âå
);

603 if(
sour˚_id
Ë
	`_mosquôto_‰ì
(source_id);

604 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

605  
MOSQ_ERR_NOMEM
;

607 
	`ªad_e
(
db_Âå
, 
t›ic
, 
¶í
);

608 
t›ic
[
¶í
] = '\0';

610 
	`_mosquôto_‰ì
(
lﬂd
);

611 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Invalid msg_store chunk whenÑestoringÖersistent database.");

612 
	`f˛o£
(
db_Âå
);

613 if(
sour˚_id
Ë
	`_mosquôto_‰ì
(source_id);

616 
	`ªad_e
(
db_Âå
, &
qos
, (
uöt8_t
));

617 
	`ªad_e
(
db_Âå
, &
ªèö
, (
uöt8_t
));

619 
	`ªad_e
(
db_Âå
, &
i32ãmp
, (
uöt32_t
));

620 
∑ylﬂdÀn
 = 
	`¡ohl
(
i32ãmp
);

622 if(
∑ylﬂdÀn
){

623 
∑ylﬂd
 = 
	`_mosquôto_mÆloc
(
∑ylﬂdÀn
);

624 if(!
∑ylﬂd
){

625 
	`_mosquôto_‰ì
(
lﬂd
);

626 
	`f˛o£
(
db_Âå
);

627 if(
sour˚_id
Ë
	`_mosquôto_‰ì
(source_id);

628 
	`_mosquôto_‰ì
(
t›ic
);

629 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

630  
MOSQ_ERR_NOMEM
;

632 
	`ªad_e
(
db_Âå
, 
∑ylﬂd
, 
∑ylﬂdÀn
);

635 
rc
 = 
	`mqâ3_db_mesßge_°‹e
(
db
, 
sour˚_id
, 
sour˚_mid
, 
t›ic
, 
qos
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
ªèö
, &
°‹ed
, 
°‹e_id
);

637 
lﬂd
->
db_id
 = 
°‹ed
->db_id;

638 
lﬂd
->
°‹e
 = 
°‹ed
;

640 
	`HASH_ADD
(
hh
, 
db
->
msg_°‹e_lﬂd
, 
db_id
, (
dbid_t
), 
lﬂd
);

642 if(
sour˚_id
Ë
	`_mosquôto_‰ì
(source_id);

643 
	`_mosquôto_‰ì
(
t›ic
);

644 
	`_mosquôto_‰ì
(
∑ylﬂd
);

646  
rc
;

647 
îr‹
:

648 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

649 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

650 
	`f˛o£
(
db_Âå
);

651 if(
sour˚_id
Ë
	`_mosquôto_‰ì
(source_id);

652 if(
t›ic
Ë
	`_mosquôto_‰ì
(topic);

653 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

655 
	}
}

657 
	$_db_ªèö_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

659 
dbid_t
 
i64ãmp
, 
°‹e_id
;

660 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
;

661 
îr
[256];

663 if(
	`‰ód
(&
i64ãmp
, (
dbid_t
), 1, 
db_Âå
) != 1){

664 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

665 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

666 
	`f˛o£
(
db_Âå
);

669 
°‹e_id
 = 
i64ãmp
;

670 
	`HASH_FIND
(
hh
, 
db
->
msg_°‹e_lﬂd
, &
°‹e_id
, (
dbid_t
), 
lﬂd
);

671 if(
lﬂd
){

672 
	`mqâ3_db_mesßges_queue
(
db
, 
NULL
, 
lﬂd
->
°‹e
->
t›ic
,Üﬂd->°‹e->
qos
,Üﬂd->°‹e->
ªèö
, &load->store);

674 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Corrupt database whilstÑestoringáÑetained message.");

675  
MOSQ_ERR_INVAL
;

677  
MOSQ_ERR_SUCCESS
;

678 
	}
}

680 
	$_db_sub_chunk_ª°‹e
(
mosquôto_db
 *
db
, 
FILE
 *
db_Âå
)

682 
uöt16_t
 
i16ãmp
, 
¶í
;

683 
uöt8_t
 
qos
;

684 *
˛õ¡_id
;

685 *
t›ic
;

686 
rc
 = 0;

687 
îr
[256];

689 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

690 
¶í
 = 
	`¡ohs
(
i16ãmp
);

691 
˛õ¡_id
 = 
	`_mosquôto_mÆloc
(
¶í
+1);

692 if(!
˛õ¡_id
){

693 
	`f˛o£
(
db_Âå
);

694 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

695  
MOSQ_ERR_NOMEM
;

697 
	`ªad_e
(
db_Âå
, 
˛õ¡_id
, 
¶í
);

698 
˛õ¡_id
[
¶í
] = '\0';

700 
	`ªad_e
(
db_Âå
, &
i16ãmp
, (
uöt16_t
));

701 
¶í
 = 
	`¡ohs
(
i16ãmp
);

702 
t›ic
 = 
	`_mosquôto_mÆloc
(
¶í
+1);

703 if(!
t›ic
){

704 
	`f˛o£
(
db_Âå
);

705 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

706 
	`_mosquôto_‰ì
(
˛õ¡_id
);

707  
MOSQ_ERR_NOMEM
;

709 
	`ªad_e
(
db_Âå
, 
t›ic
, 
¶í
);

710 
t›ic
[
¶í
] = '\0';

712 
	`ªad_e
(
db_Âå
, &
qos
, (
uöt8_t
));

713 if(
	`_db_ª°‹e_sub
(
db
, 
˛õ¡_id
, 
t›ic
, 
qos
)){

714 
rc
 = 1;

716 
	`_mosquôto_‰ì
(
˛õ¡_id
);

717 
	`_mosquôto_‰ì
(
t›ic
);

719  
rc
;

720 
îr‹
:

721 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

722 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

723 
	`f˛o£
(
db_Âå
);

725 
	}
}

727 
	$mqâ3_db_ª°‹e
(
mosquôto_db
 *
db
)

729 
FILE
 *
Âå
;

730 
hódî
[15];

731 
rc
 = 0;

732 
uöt32_t
 
¸c
;

733 
dbid_t
 
i64ãmp
;

734 
uöt32_t
 
i32ãmp
, 
Àngth
;

735 
uöt16_t
 
i16ãmp
, 
chunk
;

736 
uöt8_t
 
i8ãmp
;

737 
ssize_t
 
æí
;

738 
îr
[256];

739 
mosquôto_msg_°‹e_lﬂd
 *
lﬂd
, *
lﬂd_tmp
;

741 
	`as£π
(
db
);

742 
	`as£π
(
db
->
c⁄fig
);

743 
	`as£π
(
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
);

745 
db
->
msg_°‹e_lﬂd
 = 
NULL
;

747 
Âå
 = 
	`_mosquôto_f›í
(
db
->
c⁄fig
->
≥rsi°í˚_fûï©h
, "rb");

748 if(
Âå
 =
NULL
Ë 
MOSQ_ERR_SUCCESS
;

749 
	`ªad_e
(
Âå
, &
hódî
, 15);

750 if(!
	`memcmp
(
hódî
, 
magic
, 15)){

752 
	`ªad_e
(
Âå
, &
¸c
, (
uöt32_t
));

753 
	`ªad_e
(
Âå
, &
i32ãmp
, (
uöt32_t
));

754 
db_vîsi⁄
 = 
	`¡ohl
(
i32ãmp
);

758 if(
db_vîsi⁄
 > 
MOSQ_DB_VERSION
 && db_version != 0){

759 if(
db_vîsi⁄
 == 2){

762 
	`f˛o£
(
Âå
);

763 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Unsuµ‹ãdÖîsi°íàd©aba£ f‹m© vîsi⁄ %d (√ed vîsi⁄ %d).", 
db_vîsi⁄
, 
MOSQ_DB_VERSION
);

768 
æí
 = 
	`‰ód
(&
i16ãmp
, (
uöt16_t
), 1, 
Âå
),Ñlen == 1){

769 
chunk
 = 
	`¡ohs
(
i16ãmp
);

770 
	`ªad_e
(
Âå
, &
i32ãmp
, (
uöt32_t
));

771 
Àngth
 = 
	`¡ohl
(
i32ãmp
);

772 
chunk
){

773 
DB_CHUNK_CFG
:

774 
	`ªad_e
(
Âå
, &
i8ãmp
, (
uöt8_t
));

775 
	`ªad_e
(
Âå
, &
i8ãmp
, (
uöt8_t
));

776 if(
i8ãmp
 !(
dbid_t
)){

777 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Incompatible database configuration (dbid size is %d bytes,Éxpected %lu)",

778 
i8ãmp
, ()(
dbid_t
));

779 
	`f˛o£
(
Âå
);

782 
	`ªad_e
(
Âå
, &
i64ãmp
, (
dbid_t
));

783 
db
->
œ°_db_id
 = 
i64ãmp
;

786 
DB_CHUNK_MSG_STORE
:

787 if(
	`_db_msg_°‹e_chunk_ª°‹e
(
db
, 
Âå
))  1;

790 
DB_CHUNK_CLIENT_MSG
:

791 if(
	`_db_˛õ¡_msg_chunk_ª°‹e
(
db
, 
Âå
))  1;

794 
DB_CHUNK_RETAIN
:

795 if(
	`_db_ªèö_chunk_ª°‹e
(
db
, 
Âå
))  1;

798 
DB_CHUNK_SUB
:

799 if(
	`_db_sub_chunk_ª°‹e
(
db
, 
Âå
))  1;

802 
DB_CHUNK_CLIENT
:

803 if(
	`_db_˛õ¡_chunk_ª°‹e
(
db
, 
Âå
))  1;

807 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WARNING
, "W¨nög: Unsuµ‹ãd chunk \"%d\" i¿≥rsi°íàd©aba£ fûe. Ign‹ög.", 
chunk
);

808 
	`f£ek
(
Âå
, 
Àngth
, 
SEEK_CUR
);

812 if(
æí
 < 0Ë
îr‹
;

814 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: UnableÅoÑestoreÖersistent database. Unrecognised file format.");

815 
rc
 = 1;

818 
	`f˛o£
(
Âå
);

820 
	`HASH_ITER
(
hh
, 
db
->
msg_°‹e_lﬂd
, 
lﬂd
, 
lﬂd_tmp
){

821 
	`HASH_DELETE
(
hh
, 
db
->
msg_°‹e_lﬂd
, 
lﬂd
);

822 
	`_mosquôto_‰ì
(
lﬂd
);

824  
rc
;

825 
îr‹
:

826 
	`°ªº‹_r
(
î∫o
, 
îr
, 256);

827 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: %s.", 
îr
);

828 if(
Âå
Ë
	`f˛o£
(fptr);

830 
	}
}

832 
	$_db_ª°‹e_sub
(
mosquôto_db
 *
db
, c⁄° *
˛õ¡_id
, c⁄° *
sub
, 
qos
)

834 
mosquôto
 *
c⁄ãxt
;

836 
	`as£π
(
db
);

837 
	`as£π
(
˛õ¡_id
);

838 
	`as£π
(
sub
);

840 
c⁄ãxt
 = 
	`_db_föd_‹_add_c⁄ãxt
(
db
, 
˛õ¡_id
, 0);

841 if(!
c⁄ãxt
)  1;

842  
	`mqâ3_sub_add
(
db
, 
c⁄ãxt
, 
sub
, 
qos
, &db->
subs
);

843 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/read_handle.c

17 
	~<as£π.h
>

18 
	~<°dio.h
>

19 
	~<°rög.h
>

21 
	~<c⁄fig.h
>

23 
	~<mosquôto_brokî.h
>

24 
	~<mqâ3_¥Ÿocﬁ.h
>

25 
	~<mem‹y_mosq.h
>

26 
	~<ªad_h™dÀ.h
>

27 
	~<£nd_mosq.h
>

28 
	~<utû_mosq.h
>

30 #ifde‡
WITH_SYS_TREE


31 
uöt64_t
 
g_pub_byãs_ª˚ived
;

34 
	$mqâ3_∑ckë_h™dÀ
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

36 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

38 (
c⁄ãxt
->
ö_∑ckë
.
comm™d
)&0xF0){

39 
PINGREQ
:

40  
	`_mosquôto_h™dÀ_pögªq
(
c⁄ãxt
);

41 
PINGRESP
:

42  
	`_mosquôto_h™dÀ_pögª•
(
c⁄ãxt
);

43 
PUBACK
:

44  
	`_mosquôto_h™dÀ_pubackcomp
(
db
, 
c⁄ãxt
, "PUBACK");

45 
PUBCOMP
:

46  
	`_mosquôto_h™dÀ_pubackcomp
(
db
, 
c⁄ãxt
, "PUBCOMP");

47 
PUBLISH
:

48  
	`mqâ3_h™dÀ_publish
(
db
, 
c⁄ãxt
);

49 
PUBREC
:

50  
	`_mosquôto_h™dÀ_pubªc
(
c⁄ãxt
);

51 
PUBREL
:

52  
	`_mosquôto_h™dÀ_pubªl
(
db
, 
c⁄ãxt
);

53 
CONNECT
:

54  
	`mqâ3_h™dÀ_c⁄√˘
(
db
, 
c⁄ãxt
);

55 
DISCONNECT
:

56  
	`mqâ3_h™dÀ_disc⁄√˘
(
db
, 
c⁄ãxt
);

57 
SUBSCRIBE
:

58  
	`mqâ3_h™dÀ_subs¸ibe
(
db
, 
c⁄ãxt
);

59 
UNSUBSCRIBE
:

60  
	`mqâ3_h™dÀ_unsubs¸ibe
(
db
, 
c⁄ãxt
);

61 #ifde‡
WITH_BRIDGE


62 
CONNACK
:

63  
	`mqâ3_h™dÀ_c⁄«ck
(
db
, 
c⁄ãxt
);

64 
SUBACK
:

65  
	`_mosquôto_h™dÀ_suback
(
c⁄ãxt
);

66 
UNSUBACK
:

67  
	`_mosquôto_h™dÀ_unsuback
(
c⁄ãxt
);

71  
MOSQ_ERR_PROTOCOL
;

73 
	}
}

75 
	$mqâ3_h™dÀ_publish
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

77 *
t›ic
;

78 *
∑ylﬂd
 = 
NULL
;

79 
uöt32_t
 
∑ylﬂdÀn
;

80 
uöt8_t
 
dup
, 
qos
, 
ªèö
;

81 
uöt16_t
 
mid
 = 0;

82 
rc
 = 0;

83 
uöt8_t
 
hódî
 = 
c⁄ãxt
->
ö_∑ckë
.
comm™d
;

84 
ªs
 = 0;

85 
mosquôto_msg_°‹e
 *
°‹ed
 = 
NULL
;

86 
Àn
;

87 *
t›ic_mou¡
;

88 #ifde‡
WITH_BRIDGE


89 *
t›ic_ãmp
;

90 
i
;

91 
_mqâ3_bridge_t›ic
 *
cur_t›ic
;

92 
boﬁ
 
m©ch
;

95 
dup
 = (
hódî
 & 0x08)>>3;

96 
qos
 = (
hódî
 & 0x06)>>1;

97 if(
qos
 == 3){

98 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
,

99 "InvÆid QoS i¿PUBLISH from %s, disc⁄√˘ög.", 
c⁄ãxt
->
id
);

102 
ªèö
 = (
hódî
 & 0x01);

104 if(
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
t›ic
))  1;

105 if(
	`STREMPTY
(
t›ic
)){

107 
	`_mosquôto_‰ì
(
t›ic
);

110 #ifde‡
WITH_BRIDGE


111 if(
c⁄ãxt
->
bridge
 && c⁄ãxt->bridge->
t›ics
 && c⁄ãxt->bridge->
t›ic_ªm≠pög
){

112 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

113 
cur_t›ic
 = &
c⁄ãxt
->
bridge
->
t›ics
[
i
];

114 if((
cur_t›ic
->
dúe˘i⁄
 =
bd_bŸh
 || cur_t›ic->dúe˘i⁄ =
bd_ö
)

115 && (
cur_t›ic
->
ªmŸe_¥efix
 || cur_t›ic->
loˇl_¥efix
)){

119 
rc
 = 
	`mosquôto_t›ic_m©ches_sub
(
cur_t›ic
->
ªmŸe_t›ic
, 
t›ic
, &
m©ch
);

120 if(
rc
){

121 
	`_mosquôto_‰ì
(
t›ic
);

122  
rc
;

124 if(
m©ch
){

125 if(
cur_t›ic
->
ªmŸe_¥efix
){

127 if(!
	`°∫cmp
(
cur_t›ic
->
ªmŸe_¥efix
, 
t›ic
, 
	`°æí
(cur_topic->remote_prefix))){

128 
t›ic_ãmp
 = 
	`_mosquôto_°rdup
(
t›ic
+
	`°æí
(
cur_t›ic
->
ªmŸe_¥efix
));

129 if(!
t›ic_ãmp
){

130 
	`_mosquôto_‰ì
(
t›ic
);

131  
MOSQ_ERR_NOMEM
;

133 
	`_mosquôto_‰ì
(
t›ic
);

134 
t›ic
 = 
t›ic_ãmp
;

138 if(
cur_t›ic
->
loˇl_¥efix
){

140 
Àn
 = 
	`°æí
(
t›ic
Ë+ såÀn(
cur_t›ic
->
loˇl_¥efix
)+1;

141 
t›ic_ãmp
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

142 if(!
t›ic_ãmp
){

143 
	`_mosquôto_‰ì
(
t›ic
);

144  
MOSQ_ERR_NOMEM
;

146 
	`¢¥ötf
(
t›ic_ãmp
, 
Àn
, "%s%s", 
cur_t›ic
->
loˇl_¥efix
, 
t›ic
);

147 
t›ic_ãmp
[
Àn
] = '\0';

149 
	`_mosquôto_‰ì
(
t›ic
);

150 
t›ic
 = 
t›ic_ãmp
;

158 if(
	`mosquôto_pub_t›ic_check
(
t›ic
Ë!
MOSQ_ERR_SUCCESS
){

160 
	`_mosquôto_‰ì
(
t›ic
);

164 if(
qos
 > 0){

165 if(
	`_mosquôto_ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
mid
)){

166 
	`_mosquôto_‰ì
(
t›ic
);

171 
∑ylﬂdÀn
 = 
c⁄ãxt
->
ö_∑ckë
.
ªmaöög_Àngth
 - c⁄ãxt->ö_∑ckë.
pos
;

172 #ifde‡
WITH_SYS_TREE


173 
g_pub_byãs_ª˚ived
 +
∑ylﬂdÀn
;

175 if(
c⁄ãxt
->
li°íî
 && c⁄ãxt->li°íî->
mou¡_poöt
){

176 
Àn
 = 
	`°æí
(
c⁄ãxt
->
li°íî
->
mou¡_poöt
Ë+ såÀn(
t›ic
) + 1;

177 
t›ic_mou¡
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

178 if(!
t›ic_mou¡
){

179 
	`_mosquôto_‰ì
(
t›ic
);

180  
MOSQ_ERR_NOMEM
;

182 
	`¢¥ötf
(
t›ic_mou¡
, 
Àn
, "%s%s", 
c⁄ãxt
->
li°íî
->
mou¡_poöt
, 
t›ic
);

183 
t›ic_mou¡
[
Àn
] = '\0';

185 
	`_mosquôto_‰ì
(
t›ic
);

186 
t›ic
 = 
t›ic_mou¡
;

189 if(
∑ylﬂdÀn
){

190 if(
db
->
c⁄fig
->
mesßge_size_limô
 && 
∑ylﬂdÀn
 > db->config->message_size_limit){

191 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Dr›≥dÅoÿœrgêPUBLISH from %†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
c⁄ãxt
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

192 
¥o˚ss_bad_mesßge
;

194 
∑ylﬂd
 = 
	`_mosquôto_ˇŒoc
(
∑ylﬂdÀn
+1, 1);

195 if(!
∑ylﬂd
){

196 
	`_mosquôto_‰ì
(
t›ic
);

199 if(
	`_mosquôto_ªad_byãs
(&
c⁄ãxt
->
ö_∑ckë
, 
∑ylﬂd
, 
∑ylﬂdÀn
)){

200 
	`_mosquôto_‰ì
(
t›ic
);

201 
	`_mosquôto_‰ì
(
∑ylﬂd
);

207 
rc
 = 
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
t›ic
, 
MOSQ_ACL_WRITE
);

208 if(
rc
 =
MOSQ_ERR_ACL_DENIED
){

209 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Díõd PUBLISH from %†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
c⁄ãxt
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

210 
¥o˚ss_bad_mesßge
;

211 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

212 
	`_mosquôto_‰ì
(
t›ic
);

213 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

214  
rc
;

217 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived PUBLISH from %†(d%d, q%d,Ñ%d, m%d, '%s', ... (%ld byãs))", 
c⁄ãxt
->
id
, 
dup
, 
qos
, 
ªèö
, 
mid
, 
t›ic
, ()
∑ylﬂdÀn
);

218 if(
qos
 > 0){

219 
	`mqâ3_db_mesßge_°‹e_föd
(
c⁄ãxt
, 
mid
, &
°‹ed
);

221 if(!
°‹ed
){

222 
dup
 = 0;

223 if(
	`mqâ3_db_mesßge_°‹e
(
db
, 
c⁄ãxt
->
id
, 
mid
, 
t›ic
, 
qos
, 
∑ylﬂdÀn
, 
∑ylﬂd
, 
ªèö
, &
°‹ed
, 0)){

224 
	`_mosquôto_‰ì
(
t›ic
);

225 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

229 
dup
 = 1;

231 
qos
){

233 if(
	`mqâ3_db_mesßges_queue
(
db
, 
c⁄ãxt
->
id
, 
t›ic
, 
qos
, 
ªèö
, &
°‹ed
)Ë
rc
 = 1;

236 if(
	`mqâ3_db_mesßges_queue
(
db
, 
c⁄ãxt
->
id
, 
t›ic
, 
qos
, 
ªèö
, &
°‹ed
)Ë
rc
 = 1;

237 if(
	`_mosquôto_£nd_puback
(
c⁄ãxt
, 
mid
)Ë
rc
 = 1;

240 if(!
dup
){

241 
ªs
 = 
	`mqâ3_db_mesßge_ö£π
(
db
, 
c⁄ãxt
, 
mid
, 
mosq_md_ö
, 
qos
, 
ªèö
, 
°‹ed
);

243 
ªs
 = 0;

247 if(!
ªs
){

248 if(
	`_mosquôto_£nd_pubªc
(
c⁄ãxt
, 
mid
)Ë
rc
 = 1;

249 }if(
ªs
 == 1){

250 
rc
 = 1;

254 
	`_mosquôto_‰ì
(
t›ic
);

255 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

257  
rc
;

258 
¥o˚ss_bad_mesßge
:

259 
	`_mosquôto_‰ì
(
t›ic
);

260 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

261 
qos
){

263  
MOSQ_ERR_SUCCESS
;

265  
	`_mosquôto_£nd_puback
(
c⁄ãxt
, 
mid
);

267 
	`mqâ3_db_mesßge_°‹e_föd
(
c⁄ãxt
, 
mid
, &
°‹ed
);

268 if(!
°‹ed
){

269 if(
	`mqâ3_db_mesßge_°‹e
(
db
, 
c⁄ãxt
->
id
, 
mid
, 
NULL
, 
qos
, 0, NULL, 
Ál£
, &
°‹ed
, 0)){

272 
ªs
 = 
	`mqâ3_db_mesßge_ö£π
(
db
, 
c⁄ãxt
, 
mid
, 
mosq_md_ö
, 
qos
, 
Ál£
, 
°‹ed
);

274 
ªs
 = 0;

276 if(!
ªs
){

277 
ªs
 = 
	`_mosquôto_£nd_pubªc
(
c⁄ãxt
, 
mid
);

279  
ªs
;

282 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/read_handle_client.c

17 
	~<c⁄fig.h
>

18 
	~<°dio.h
>

19 
	~<°rög.h
>

21 
	~<mosquôto_brokî.h
>

22 
	~<mem‹y_mosq.h
>

23 
	~<mqâ3_¥Ÿocﬁ.h
>

24 
	~<£nd_mosq.h
>

25 
	~<utû_mosq.h
>

27 
	$mqâ3_h™dÀ_c⁄«ck
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

29 
uöt8_t
 
byã
;

30 
uöt8_t
 
rc
;

31 
i
;

32 *
nŸifiˇti⁄_t›ic
;

33 
nŸifiˇti⁄_t›ic_Àn
;

34 
nŸifiˇti⁄_∑ylﬂd
;

36 if(!
c⁄ãxt
){

37  
MOSQ_ERR_INVAL
;

39 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived CONNACK o¿c⁄√˘i⁄ %s.", 
c⁄ãxt
->
id
);

40 if(
	`_mosquôto_ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
byã
))  1;

41 if(
	`_mosquôto_ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
rc
))  1;

42 
rc
){

43 
CONNACK_ACCEPTED
:

44 if(
c⁄ãxt
->
bridge
){

45 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄s
){

46 
nŸifiˇti⁄_∑ylﬂd
 = '1';

47 if(
c⁄ãxt
->
bridge
->
nŸifiˇti⁄_t›ic
){

48 if(
	`_mosquôto_£nd_ªÆ_publish
(
c⁄ãxt
, 
	`_mosquôto_mid_gíî©e
(context),

49 
c⁄ãxt
->
bridge
->
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 0)){

53 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
c⁄ãxt
, c⁄ãxt->
bridge
->
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1);

55 
nŸifiˇti⁄_t›ic_Àn
 = 
	`°æí
(
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
)+strlen("$SYS/broker/connection//state");

56 
nŸifiˇti⁄_t›ic
 = 
	`_mosquôto_mÆloc
(()*(
nŸifiˇti⁄_t›ic_Àn
+1));

57 if(!
nŸifiˇti⁄_t›ic
Ë 
MOSQ_ERR_NOMEM
;

59 
	`¢¥ötf
(
nŸifiˇti⁄_t›ic
, 
nŸifiˇti⁄_t›ic_Àn
+1, "$SYS/brokî/c⁄√˘i⁄/%s/°©e", 
c⁄ãxt
->
bridge
->
ªmŸe_˛õ¡id
);

60 
nŸifiˇti⁄_∑ylﬂd
 = '1';

61 if(
	`_mosquôto_£nd_ªÆ_publish
(
c⁄ãxt
, 
	`_mosquôto_mid_gíî©e
(context),

62 
nŸifiˇti⁄_t›ic
, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1, 
åue
, 0)){

64 
	`_mosquôto_‰ì
(
nŸifiˇti⁄_t›ic
);

67 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
c⁄ãxt
, 
nŸifiˇti⁄_t›ic
, 1, 1, &
nŸifiˇti⁄_∑ylﬂd
, 1);

68 
	`_mosquôto_‰ì
(
nŸifiˇti⁄_t›ic
);

71 
i
=0; i<
c⁄ãxt
->
bridge
->
t›ic_cou¡
; i++){

72 if(
c⁄ãxt
->
bridge
->
t›ics
[
i
].
dúe˘i⁄
 =
bd_ö
 || c⁄ãxt->bridge->t›ics[i].dúe˘i⁄ =
bd_bŸh
){

73 if(
	`_mosquôto_£nd_subs¸ibe
(
c⁄ãxt
, 
NULL
, c⁄ãxt->
bridge
->
t›ics
[
i
].
ªmŸe_t›ic
, c⁄ãxt->bridge->t›ics[i].
qos
)){

77 if(
c⁄ãxt
->
bridge
->
©ãm±_unsubs¸ibe
){

78 if(
	`_mosquôto_£nd_unsubs¸ibe
(
c⁄ãxt
, 
NULL
, c⁄ãxt->
bridge
->
t›ics
[
i
].
ªmŸe_t›ic
)){

88 
c⁄ãxt
->
°©e
 = 
mosq_cs_c⁄√˘ed
;

89  
MOSQ_ERR_SUCCESS
;

90 
CONNACK_REFUSED_PROTOCOL_VERSION
:

91 if(
c⁄ãxt
->
bridge
){

92 
c⁄ãxt
->
bridge
->
åy_¥iv©e_ac˚±ed
 = 
Ál£
;

94 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: unacceptableÖrotocol version");

96 
CONNACK_REFUSED_IDENTIFIER_REJECTED
:

97 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: identifierÑejected");

99 
CONNACK_REFUSED_SERVER_UNAVAILABLE
:

100 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: broker unavailable");

102 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
:

103 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: broker unavailable");

105 
CONNACK_REFUSED_NOT_AUTHORIZED
:

106 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused:Çotáuthorised");

109 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Connection Refused: unknownÑeason");

113 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/read_handle_server.c

17 
	~<°dio.h
>

18 
	~<°rög.h
>

20 
	~<c⁄fig.h
>

22 
	~<mosquôto_brokî.h
>

23 
	~<mqâ3_¥Ÿocﬁ.h
>

24 
	~<mem‹y_mosq.h
>

25 
	~<£nd_mosq.h
>

26 
	~<time_mosq.h
>

27 
	~<és_mosq.h
>

28 
	~<utû_mosq.h
>

30 #ifde‡
WITH_UUID


31 
	~<uuid/uuid.h
>

34 #ifde‡
WITH_WEBSOCKETS


35 
	~<libwebsockës.h
>

38 #ifde‡
WITH_SYS_TREE


39 
g_c⁄√˘i⁄_cou¡
;

42 *
	$˛õ¡_id_gí
(
mosquôto_db
 *
db
)

44 *
˛õ¡_id
;

45 #ifde‡
WITH_UUID


46 
uuid_t
 
uuid
;

48 
i
;

51 #ifde‡
WITH_UUID


52 
˛õ¡_id
 = (*)
	`_mosquôto_ˇŒoc
(37 + 
db
->
c⁄fig
->
auto_id_¥efix_Àn
, ());

53 if(!
˛õ¡_id
){

54  
NULL
;

56 if(
db
->
c⁄fig
->
auto_id_¥efix
){

57 
	`mem˝y
(
˛õ¡_id
, 
db
->
c⁄fig
->
auto_id_¥efix
, db->c⁄fig->
auto_id_¥efix_Àn
);

59 
	`uuid_gíî©e_øndom
(
uuid
);

60 
	`uuid_u≈¨£_lowî
(
uuid
, &
˛õ¡_id
[
db
->
c⁄fig
->
auto_id_¥efix_Àn
]);

62 
˛õ¡_id
 = (*)
	`_mosquôto_ˇŒoc
(65 + 
db
->
c⁄fig
->
auto_id_¥efix_Àn
, ());

63 if(!
˛õ¡_id
){

64  
NULL
;

66 if(
db
->
c⁄fig
->
auto_id_¥efix
){

67 
	`mem˝y
(
˛õ¡_id
, 
db
->
c⁄fig
->
auto_id_¥efix
, db->c⁄fig->
auto_id_¥efix_Àn
);

69 
i
=0; i<64; i++){

70 
˛õ¡_id
[
i
+
db
->
c⁄fig
->
auto_id_¥efix_Àn
] = (
	`ønd
()%73)+48;

72 
˛õ¡_id
[
i
] = '\0';

74  
˛õ¡_id
;

75 
	}
}

77 
	$mqâ3_h™dÀ_c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

79 *
¥Ÿocﬁ_«me
 = 
NULL
;

80 
uöt8_t
 
¥Ÿocﬁ_vîsi⁄
;

81 
uöt8_t
 
c⁄√˘_Êags
;

82 
uöt8_t
 
c⁄√˘_ack
 = 0;

83 *
˛õ¡_id
 = 
NULL
;

84 *
wûl_∑ylﬂd
 = 
NULL
, *
wûl_t›ic
 = NULL;

85 
uöt16_t
 
wûl_∑ylﬂdÀn
;

86 
mosquôto_mesßge
 *
wûl_°ru˘
 = 
NULL
;

87 
uöt8_t
 
wûl
, 
wûl_ªèö
, 
wûl_qos
, 
˛ón_£ssi⁄
;

88 
uöt8_t
 
u£∫ame_Êag
, 
∑ssw‹d_Êag
;

89 *
u£∫ame
 = 
NULL
, *
∑ssw‹d
 = NULL;

90 
rc
;

91 
_mosquôto_a˛_u£r
 *
a˛_èû
;

92 
mosquôto_˛õ¡_msg
 *
msg_èû
, *
msg_¥ev
;

93 
mosquôto
 *
found_c⁄ãxt
;

94 
¶í
;

95 
_mosquôto_subÀaf
 *
Àaf
;

96 
i
;

97 #ifde‡
WITH_TLS


98 
X509
 *
˛õ¡_˚π
 = 
NULL
;

99 
X509_NAME
 *
«me
;

100 
X509_NAME_ENTRY
 *
«me_íåy
;

103 #ifde‡
WITH_SYS_TREE


104 
g_c⁄√˘i⁄_cou¡
++;

108 if(
c⁄ãxt
->
°©e
 !
mosq_cs_√w
){

109 
rc
 = 
MOSQ_ERR_PROTOCOL
;

110 
h™dÀ_c⁄√˘_îr‹
;

113 if(
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
¥Ÿocﬁ_«me
)){

114 
rc
 = 1;

115 
h™dÀ_c⁄√˘_îr‹
;

118 if(!
¥Ÿocﬁ_«me
){

119 
rc
 = 3;

120 
h™dÀ_c⁄√˘_îr‹
;

123 if(
	`_mosquôto_ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
¥Ÿocﬁ_vîsi⁄
)){

124 
rc
 = 1;

125 
h™dÀ_c⁄√˘_îr‹
;

128 if(!
	`°rcmp
(
¥Ÿocﬁ_«me
, 
PROTOCOL_NAME_v31
)){

129 if((
¥Ÿocﬁ_vîsi⁄
&0x7FË!
PROTOCOL_VERSION_v31
){

130 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

131 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "InvalidÖrotocol version %d in CONNECT from %s.",

132 
¥Ÿocﬁ_vîsi⁄
, 
c⁄ãxt
->
addªss
);

134 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_PROTOCOL_VERSION
);

135 
	`_mosquôto_‰ì
(
¥Ÿocﬁ_«me
);

136 
rc
 = 
MOSQ_ERR_PROTOCOL
;

137 
h™dÀ_c⁄√˘_îr‹
;

139 
c⁄ãxt
->
¥Ÿocﬁ
 = 
mosq_p_mqâ31
;

140 }if(!
	`°rcmp
(
¥Ÿocﬁ_«me
, 
PROTOCOL_NAME_v311
)){

141 if((
¥Ÿocﬁ_vîsi⁄
&0x7FË!
PROTOCOL_VERSION_v311
){

142 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

143 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "InvalidÖrotocol version %d in CONNECT from %s.",

144 
¥Ÿocﬁ_vîsi⁄
, 
c⁄ãxt
->
addªss
);

146 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_PROTOCOL_VERSION
);

147 
	`_mosquôto_‰ì
(
¥Ÿocﬁ_«me
);

148 
rc
 = 
MOSQ_ERR_PROTOCOL
;

149 
h™dÀ_c⁄√˘_îr‹
;

151 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x00){

153 
	`_mosquôto_‰ì
(
¥Ÿocﬁ_«me
);

154 
rc
 = 
MOSQ_ERR_PROTOCOL
;

155 
h™dÀ_c⁄√˘_îr‹
;

157 
c⁄ãxt
->
¥Ÿocﬁ
 = 
mosq_p_mqâ311
;

159 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

160 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "InvalidÖrotocol \"%s\" in CONNECT from %s.",

161 
¥Ÿocﬁ_«me
, 
c⁄ãxt
->
addªss
);

163 
	`_mosquôto_‰ì
(
¥Ÿocﬁ_«me
);

164 
rc
 = 
MOSQ_ERR_PROTOCOL
;

165 
h™dÀ_c⁄√˘_îr‹
;

167 
	`_mosquôto_‰ì
(
¥Ÿocﬁ_«me
);

169 if(
	`_mosquôto_ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
c⁄√˘_Êags
)){

170 
rc
 = 1;

171 
h™dÀ_c⁄√˘_îr‹
;

173 
˛ón_£ssi⁄
 = (
c⁄√˘_Êags
 & 0x02) >> 1;

174 
wûl
 = 
c⁄√˘_Êags
 & 0x04;

175 
wûl_qos
 = (
c⁄√˘_Êags
 & 0x18) >> 3;

176 if(
wûl_qos
 == 3){

177 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Invalid Will QoS in CONNECT from %s.",

178 
c⁄ãxt
->
addªss
);

179 
rc
 = 
MOSQ_ERR_PROTOCOL
;

180 
h™dÀ_c⁄√˘_îr‹
;

182 
wûl_ªèö
 = 
c⁄√˘_Êags
 & 0x20;

183 
∑ssw‹d_Êag
 = 
c⁄√˘_Êags
 & 0x40;

184 
u£∫ame_Êag
 = 
c⁄√˘_Êags
 & 0x80;

186 if(
	`_mosquôto_ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &(c⁄ãxt->
kì∑live
))){

187 
rc
 = 1;

188 
h™dÀ_c⁄√˘_îr‹
;

191 if(
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
˛õ¡_id
)){

192 
rc
 = 1;

193 
h™dÀ_c⁄√˘_îr‹
;

196 
¶í
 = 
	`°æí
(
˛õ¡_id
);

197 if(
¶í
 == 0){

198 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

199 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_IDENTIFIER_REJECTED
);

200 
rc
 = 
MOSQ_ERR_PROTOCOL
;

201 
h™dÀ_c⁄√˘_îr‹
;

203 
	`_mosquôto_‰ì
(
˛õ¡_id
);

204 
˛õ¡_id
 = 
NULL
;

206 if(
˛ón_£ssi⁄
 =0 || 
db
->
c⁄fig
->
Ælow_zîo_Àngth_˛õ¡id
 =
Ál£
){

207 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_IDENTIFIER_REJECTED
);

208 
rc
 = 
MOSQ_ERR_PROTOCOL
;

209 
h™dÀ_c⁄√˘_îr‹
;

211 
˛õ¡_id
 = 
	`˛õ¡_id_gí
(
db
);

212 if(!
˛õ¡_id
){

213 
rc
 = 
MOSQ_ERR_NOMEM
;

214 
h™dÀ_c⁄√˘_îr‹
;

221 if(
db
->
c⁄fig
->
˛õ¡id_¥efixes
){

222 if(
	`°∫cmp
(
db
->
c⁄fig
->
˛õ¡id_¥efixes
, 
˛õ¡_id
, 
	`°æí
(db->config->clientid_prefixes))){

223 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
);

224 
rc
 = 1;

225 
h™dÀ_c⁄√˘_îr‹
;

229 if(
wûl
){

230 
wûl_°ru˘
 = 
	`_mosquôto_ˇŒoc
(1, (
mosquôto_mesßge
));

231 if(!
wûl_°ru˘
){

232 
rc
 = 
MOSQ_ERR_NOMEM
;

233 
h™dÀ_c⁄√˘_îr‹
;

235 if(
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
wûl_t›ic
)){

236 
rc
 = 1;

237 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "weÑ here.");

238 
h™dÀ_c⁄√˘_îr‹
;

240 if(
	`STREMPTY
(
wûl_t›ic
)){

241 
rc
 = 1;

242 
h™dÀ_c⁄√˘_îr‹
;

244 if(
	`mosquôto_pub_t›ic_check
(
wûl_t›ic
)){

245 
rc
 = 1;

246 
h™dÀ_c⁄√˘_îr‹
;

249 if(
	`_mosquôto_ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
wûl_∑ylﬂdÀn
)){

250 
rc
 = 1;

251 
h™dÀ_c⁄√˘_îr‹
;

253 if(
wûl_∑ylﬂdÀn
 > 0){

254 
wûl_∑ylﬂd
 = 
	`_mosquôto_mÆloc
(
wûl_∑ylﬂdÀn
);

255 if(!
wûl_∑ylﬂd
){

256 
rc
 = 1;

257 
h™dÀ_c⁄√˘_îr‹
;

260 
rc
 = 
	`_mosquôto_ªad_byãs
(&
c⁄ãxt
->
ö_∑ckë
, 
wûl_∑ylﬂd
, 
wûl_∑ylﬂdÀn
);

261 if(
rc
){

262 
rc
 = 1;

263 
h™dÀ_c⁄√˘_îr‹
;

267 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

268 if(
wûl_qos
 !0 || 
wûl_ªèö
 != 0){

269 
rc
 = 
MOSQ_ERR_PROTOCOL
;

270 
h™dÀ_c⁄√˘_îr‹
;

275 if(
u£∫ame_Êag
){

276 
rc
 = 
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
u£∫ame
);

277 if(
rc
 =
MOSQ_ERR_SUCCESS
){

278 if(
∑ssw‹d_Êag
){

279 
rc
 = 
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
∑ssw‹d
);

280 if(
rc
 =
MOSQ_ERR_NOMEM
){

281 
rc
 = 
MOSQ_ERR_NOMEM
;

282 
h™dÀ_c⁄√˘_îr‹
;

283 }if(
rc
 =
MOSQ_ERR_PROTOCOL
){

284 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

286 
∑ssw‹d_Êag
 = 0;

287 }if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

288 
rc
 = 
MOSQ_ERR_PROTOCOL
;

289 
h™dÀ_c⁄√˘_îr‹
;

293 }if(
rc
 =
MOSQ_ERR_NOMEM
){

294 
rc
 = 
MOSQ_ERR_NOMEM
;

295 
h™dÀ_c⁄√˘_îr‹
;

297 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

299 
u£∫ame_Êag
 = 0;

300 }if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

301 
rc
 = 
MOSQ_ERR_PROTOCOL
;

302 
h™dÀ_c⁄√˘_îr‹
;

306 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

307 if(
∑ssw‹d_Êag
){

309 
rc
 = 
MOSQ_ERR_PROTOCOL
;

310 
h™dÀ_c⁄√˘_îr‹
;

315 #ifde‡
WITH_TLS


316 if(
c⁄ãxt
->
li°íî
 && c⁄ãxt->li°íî->
s¶_˘x
 && c⁄ãxt->li°íî->
u£_idítôy_as_u£∫ame
){

317 if(!
c⁄ãxt
->
s¶
){

318 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
);

319 
rc
 = 1;

320 
h™dÀ_c⁄√˘_îr‹
;

322 #ifde‡
REAL_WITH_TLS_PSK


323 if(
c⁄ãxt
->
li°íî
->
psk_höt
){

325 if(!
c⁄ãxt
->
u£∫ame
){

326 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
);

327 
rc
 = 1;

328 
h™dÀ_c⁄√˘_îr‹
;

332 
˛õ¡_˚π
 = 
	`SSL_gë_≥î_˚πifiˇã
(
c⁄ãxt
->
s¶
);

333 if(!
˛õ¡_˚π
){

334 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
);

335 
rc
 = 1;

336 
h™dÀ_c⁄√˘_îr‹
;

338 
«me
 = 
	`X509_gë_subje˘_«me
(
˛õ¡_˚π
);

339 if(!
«me
){

340 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
);

341 
rc
 = 1;

342 
h™dÀ_c⁄√˘_îr‹
;

345 
i
 = 
	`X509_NAME_gë_ödex_by_NID
(
«me
, 
NID_comm⁄Name
, -1);

346 if(
i
 == -1){

347 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_BAD_USERNAME_PASSWORD
);

348 
rc
 = 1;

349 
h™dÀ_c⁄√˘_îr‹
;

351 
«me_íåy
 = 
	`X509_NAME_gë_íåy
(
«me
, 
i
);

352 
c⁄ãxt
->
u£∫ame
 = 
	`_mosquôto_°rdup
((*)
	`ASN1_STRING_d©a
(
«me_íåy
->
vÆue
));

353 if(!
c⁄ãxt
->
u£∫ame
){

354 
rc
 = 1;

355 
h™dÀ_c⁄√˘_îr‹
;

357 
	`X509_‰ì
(
˛õ¡_˚π
);

358 
˛õ¡_˚π
 = 
NULL
;

359 #ifde‡
REAL_WITH_TLS_PSK


364 if(
u£∫ame_Êag
){

365 
rc
 = 
	`mosquôto_u≈wd_check
(
db
, 
u£∫ame
, 
∑ssw‹d
);

366 
rc
){

367 
MOSQ_ERR_SUCCESS
:

369 
MOSQ_ERR_AUTH
:

370 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
);

371 
	`mqâ3_c⁄ãxt_disc⁄√˘
(
db
, 
c⁄ãxt
);

372 
rc
 = 1;

373 
h™dÀ_c⁄√˘_îr‹
;

376 
	`mqâ3_c⁄ãxt_disc⁄√˘
(
db
, 
c⁄ãxt
);

377 
rc
 = 1;

378 
h™dÀ_c⁄√˘_îr‹
;

381 
c⁄ãxt
->
u£∫ame
 = username;

382 
c⁄ãxt
->
∑ssw‹d
 =Öassword;

383 
u£∫ame
 = 
NULL
;

384 
∑ssw‹d
 = 
NULL
;

387 if(!
u£∫ame_Êag
 && 
db
->
c⁄fig
->
Ælow_™⁄ymous
 =
Ál£
){

388 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
);

389 
rc
 = 1;

390 
h™dÀ_c⁄√˘_îr‹
;

392 #ifde‡
WITH_TLS


396 if(
c⁄ãxt
->
li°íî
 && c⁄ãxt->li°íî->
u£_u£∫ame_as_˛õ¡id
){

397 if(
c⁄ãxt
->
u£∫ame
){

398 
	`_mosquôto_‰ì
(
˛õ¡_id
);

399 
˛õ¡_id
 = 
	`_mosquôto_°rdup
(
c⁄ãxt
->
u£∫ame
);

400 if(!
˛õ¡_id
){

401 
rc
 = 
MOSQ_ERR_NOMEM
;

402 
h™dÀ_c⁄√˘_îr‹
;

405 
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 0, 
CONNACK_REFUSED_NOT_AUTHORIZED
);

406 
rc
 = 1;

407 
h™dÀ_c⁄√˘_îr‹
;

412 
	`HASH_FIND
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
˛õ¡_id
, 
	`°æí
(˛õ¡_id), 
found_c⁄ãxt
);

413 if(
found_c⁄ãxt
){

415 if(
found_c⁄ãxt
->
sock
 =
INVALID_SOCKET
){

421 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

422 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Clõ¡ %†Æªady c⁄√˘ed, closög old c⁄√˘i⁄.", 
˛õ¡_id
);

426 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

427 if(
˛ón_£ssi⁄
 == 0){

428 
c⁄√˘_ack
 |= 0x01;

432 
c⁄ãxt
->
˛ón_£ssi⁄
 = clean_session;

434 if(
c⁄ãxt
->
˛ón_£ssi⁄
 =
Ál£
 && 
found_c⁄ãxt
->clean_session == false){

435 if(
found_c⁄ãxt
->
msgs
){

436 
c⁄ãxt
->
msgs
 = 
found_c⁄ãxt
->msgs;

437 
found_c⁄ãxt
->
msgs
 = 
NULL
;

438 
	`mqâ3_db_mesßge_ªc⁄√˘_ª£t
(
db
, 
c⁄ãxt
);

440 
c⁄ãxt
->
subs
 = 
found_c⁄ãxt
->subs;

441 
found_c⁄ãxt
->
subs
 = 
NULL
;

442 
c⁄ãxt
->
sub_cou¡
 = 
found_c⁄ãxt
->sub_count;

443 
found_c⁄ãxt
->
sub_cou¡
 = 0;

445 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

446 if(
c⁄ãxt
->
subs
[
i
]){

447 
Àaf
 = 
c⁄ãxt
->
subs
[
i
]->subs;

448 
Àaf
){

449 if(
Àaf
->
c⁄ãxt
 =
found_c⁄ãxt
){

450 
Àaf
->
c⁄ãxt
 = context;

452 
Àaf
 =Üóf->
√xt
;

458 
found_c⁄ãxt
->
˛ón_£ssi⁄
 = 
åue
;

459 
found_c⁄ãxt
->
°©e
 = 
mosq_cs_disc⁄√˘ög
;

460 
	`do_disc⁄√˘
(
db
, 
found_c⁄ãxt
);

464 if(
db
->
a˛_li°
){

465 
a˛_èû
 = 
db
->
a˛_li°
;

466 
a˛_èû
){

467 if(
c⁄ãxt
->
u£∫ame
){

468 if(
a˛_èû
->
u£∫ame
 && !
	`°rcmp
(
c⁄ãxt
->username,ácl_tail->username)){

469 
c⁄ãxt
->
a˛_li°
 = 
a˛_èû
;

473 if(
a˛_èû
->
u£∫ame
 =
NULL
){

474 
c⁄ãxt
->
a˛_li°
 = 
a˛_èû
;

478 
a˛_èû
 =á˛_èû->
√xt
;

481 
c⁄ãxt
->
a˛_li°
 = 
NULL
;

484 if(
wûl_°ru˘
){

485 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
,"iáhveÑeached will");

486 
c⁄ãxt
->
wûl
 = 
wûl_°ru˘
;

487 
c⁄ãxt
->
wûl
->
t›ic
 = 
wûl_t›ic
;

488 if(
wûl_∑ylﬂd
){

489 
c⁄ãxt
->
wûl
->
∑ylﬂd
 = 
wûl_∑ylﬂd
;

490 
c⁄ãxt
->
wûl
->
∑ylﬂdÀn
 = 
wûl_∑ylﬂdÀn
;

492 
c⁄ãxt
->
wûl
->
∑ylﬂd
 = 
NULL
;

493 
c⁄ãxt
->
wûl
->
∑ylﬂdÀn
 = 0;

495 
c⁄ãxt
->
wûl
->
qos
 = 
wûl_qos
;

496 
c⁄ãxt
->
wûl
->
ªèö
 = 
wûl_ªèö
;

499 if(
db
->
c⁄fig
->
c⁄√˘i⁄_mesßges
 =
åue
){

500 if(
c⁄ãxt
->
is_bridge
){

501 if(
c⁄ãxt
->
u£∫ame
){

502 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New bridgêc⁄√˘ed from %†a†%†(c%d, k%d, u'%s').", 
c⁄ãxt
->
addªss
, 
˛õ¡_id
, 
˛ón_£ssi⁄
, c⁄ãxt->
kì∑live
, c⁄ãxt->
u£∫ame
);

504 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New bridgêc⁄√˘ed from %†a†%†(c%d, k%d).", 
c⁄ãxt
->
addªss
, 
˛õ¡_id
, 
˛ón_£ssi⁄
, c⁄ãxt->
kì∑live
);

507 if(
c⁄ãxt
->
u£∫ame
){

508 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New clõ¡ c⁄√˘ed from %†a†%†(c%d, k%d, u'%s').", 
c⁄ãxt
->
addªss
, 
˛õ¡_id
, 
˛ón_£ssi⁄
, c⁄ãxt->
kì∑live
, c⁄ãxt->
u£∫ame
);

510 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_NOTICE
, "New clõ¡ c⁄√˘ed from %†a†%†(c%d, k%dËwôhÅ›i¯%s.", 
c⁄ãxt
->
addªss
, 
˛õ¡_id
, 
˛ón_£ssi⁄
, c⁄ãxt->
kì∑live
, 
wûl_t›ic
);

515 
c⁄ãxt
->
id
 = 
˛õ¡_id
;

516 
˛õ¡_id
 = 
NULL
;

517 
c⁄ãxt
->
˛ón_£ssi⁄
 = clean_session;

518 
c⁄ãxt
->
pög_t
 = 0;

519 
c⁄ãxt
->
is_dr›pög
 = 
Ál£
;

520 if((
¥Ÿocﬁ_vîsi⁄
&0x80) == 0x80){

521 
c⁄ãxt
->
is_bridge
 = 
åue
;

526 
msg_èû
 = 
c⁄ãxt
->
msgs
;

527 
msg_¥ev
 = 
NULL
;

528 
msg_èû
){

529 if(
msg_èû
->
dúe˘i⁄
 =
mosq_md_out
){

530 if(
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
msg_èû
->
°‹e
->
t›ic
, 
MOSQ_ACL_READ
Ë!
MOSQ_ERR_SUCCESS
){

531 
	`mosquôto__db_msg_°‹e_dîef
(
db
, &
msg_èû
->
°‹e
);

532 if(
msg_¥ev
){

533 
msg_¥ev
->
√xt
 = 
msg_èû
->next;

534 
	`_mosquôto_‰ì
(
msg_èû
);

535 
msg_èû
 = 
msg_¥ev
->
√xt
;

537 
c⁄ãxt
->
msgs
 = c⁄ãxt->msgs->
√xt
;

538 
	`_mosquôto_‰ì
(
msg_èû
);

539 
msg_èû
 = 
c⁄ãxt
->
msgs
;

542 
msg_¥ev
 = 
msg_èû
;

543 
msg_èû
 = msg_èû->
√xt
;

546 
msg_¥ev
 = 
msg_èû
;

547 
msg_èû
 = msg_èû->
√xt
;

551 
	`HASH_ADD_KEYPTR
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
->
id
, 
	`°æí
(context->id), context);

553 #ifde‡
WITH_PERSISTENCE


554 if(!
˛ón_£ssi⁄
){

555 
db
->
≥rsi°í˚_ch™ges
++;

558 
c⁄ãxt
->
°©e
 = 
mosq_cs_c⁄√˘ed
;

559  
	`_mosquôto_£nd_c⁄«ck
(
c⁄ãxt
, 
c⁄√˘_ack
, 
CONNACK_ACCEPTED
);

561 
h™dÀ_c⁄√˘_îr‹
:

562 if(
˛õ¡_id
Ë
	`_mosquôto_‰ì
(client_id);

563 if(
u£∫ame
Ë
	`_mosquôto_‰ì
(username);

564 if(
∑ssw‹d
Ë
	`_mosquôto_‰ì
(password);

565 if(
wûl_∑ylﬂd
Ë
	`_mosquôto_‰ì
(will_payload);

566 if(
wûl_t›ic
Ë
	`_mosquôto_‰ì
(will_topic);

567 if(
wûl_°ru˘
Ë
	`_mosquôto_‰ì
(will_struct);

568 #ifde‡
WITH_TLS


569 if(
˛õ¡_˚π
Ë
	`X509_‰ì
(client_cert);

572  
rc
;

573 
	}
}

575 
	$mqâ3_h™dÀ_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

577 if(!
c⁄ãxt
){

578  
MOSQ_ERR_INVAL
;

580 if(
c⁄ãxt
->
ö_∑ckë
.
ªmaöög_Àngth
 != 0){

581  
MOSQ_ERR_PROTOCOL
;

583 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived DISCONNECT from %s", 
c⁄ãxt
->
id
);

584 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

585 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x00){

586 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

587  
MOSQ_ERR_PROTOCOL
;

590 
c⁄ãxt
->
°©e
 = 
mosq_cs_disc⁄√˘ög
;

591 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

592  
MOSQ_ERR_SUCCESS
;

593 
	}
}

596 
	$mqâ3_h™dÀ_subs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

598 
rc
 = 0;

599 
rc2
;

600 
uöt16_t
 
mid
;

601 *
sub
;

602 
uöt8_t
 
qos
;

603 
uöt8_t
 *
∑ylﬂd
 = 
NULL
, *
tmp_∑ylﬂd
;

604 
uöt32_t
 
∑ylﬂdÀn
 = 0;

605 
Àn
;

606 *
sub_mou¡
;

608 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

609 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived SUBSCRIBE from %s", 
c⁄ãxt
->
id
);

612 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

613 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x02){

614  
MOSQ_ERR_PROTOCOL
;

617 if(
	`_mosquôto_ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
mid
))  1;

619 
c⁄ãxt
->
ö_∑ckë
.
pos
 < c⁄ãxt->ö_∑ckë.
ªmaöög_Àngth
){

620 
sub
 = 
NULL
;

621 if(
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
sub
)){

622 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

626 if(
sub
){

627 if(!
	`°æí
(
sub
)){

628 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Empty subscription string from %s, disconnecting.",

629 
c⁄ãxt
->
addªss
);

630 
	`_mosquôto_‰ì
(
sub
);

631 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

634 if(
	`mosquôto_sub_t›ic_check
(
sub
)){

635 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Invalid subscription string from %s, disconnecting.",

636 
c⁄ãxt
->
addªss
);

637 
	`_mosquôto_‰ì
(
sub
);

638 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

642 if(
	`_mosquôto_ªad_byã
(&
c⁄ãxt
->
ö_∑ckë
, &
qos
)){

643 
	`_mosquôto_‰ì
(
sub
);

644 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

647 if(
qos
 > 2){

648 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Invalid QoS in subscription command from %s, disconnecting.",

649 
c⁄ãxt
->
addªss
);

650 
	`_mosquôto_‰ì
(
sub
);

651 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

654 if(
c⁄ãxt
->
li°íî
 && c⁄ãxt->li°íî->
mou¡_poöt
){

655 
Àn
 = 
	`°æí
(
c⁄ãxt
->
li°íî
->
mou¡_poöt
Ë+ såÀn(
sub
) + 1;

656 
sub_mou¡
 = 
	`_mosquôto_mÆloc
(
Àn
+1);

657 if(!
sub_mou¡
){

658 
	`_mosquôto_‰ì
(
sub
);

659 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

660  
MOSQ_ERR_NOMEM
;

662 
	`¢¥ötf
(
sub_mou¡
, 
Àn
, "%s%s", 
c⁄ãxt
->
li°íî
->
mou¡_poöt
, 
sub
);

663 
sub_mou¡
[
Àn
] = '\0';

665 
	`_mosquôto_‰ì
(
sub
);

666 
sub
 = 
sub_mou¡
;

669 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "\t%†(QoS %d)", 
sub
, 
qos
);

684 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

685 
rc
 = 
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
sub
, 
MOSQ_ACL_READ
);

686 
rc
){

687 
MOSQ_ERR_SUCCESS
:

689 
MOSQ_ERR_ACL_DENIED
:

690 
qos
 = 0x80;

693 
	`_mosquôto_‰ì
(
sub
);

694  
rc
;

699 if(
qos
 != 0x80){

700 
rc2
 = 
	`mqâ3_sub_add
(
db
, 
c⁄ãxt
, 
sub
, 
qos
, &db->
subs
);

701 if(
rc2
 =
MOSQ_ERR_SUCCESS
){

702 if(
	`mqâ3_ªèö_queue
(
db
, 
c⁄ãxt
, 
sub
, 
qos
)Ë
rc
 = 1;

703 }if(
rc2
 != -1){

704 
rc
 = 
rc2
;

706 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_SUBSCRIBE
, "%†%d %s", 
c⁄ãxt
->
id
, 
qos
, 
sub
);

708 
	`_mosquôto_‰ì
(
sub
);

710 
tmp_∑ylﬂd
 = 
	`_mosquôto_ªÆloc
(
∑ylﬂd
, 
∑ylﬂdÀn
 + 1);

711 if(
tmp_∑ylﬂd
){

712 
∑ylﬂd
 = 
tmp_∑ylﬂd
;

713 
∑ylﬂd
[
∑ylﬂdÀn
] = 
qos
;

714 
∑ylﬂdÀn
++;

716 if(
∑ylﬂd
Ë
	`_mosquôto_‰ì
(payload);

718  
MOSQ_ERR_NOMEM
;

723 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

724 if(
∑ylﬂdÀn
 == 0){

726  
MOSQ_ERR_PROTOCOL
;

729 if(
	`_mosquôto_£nd_suback
(
c⁄ãxt
, 
mid
, 
∑ylﬂdÀn
, 
∑ylﬂd
)Ë
rc
 = 1;

730 
	`_mosquôto_‰ì
(
∑ylﬂd
);

732 #ifde‡
WITH_PERSISTENCE


733 
db
->
≥rsi°í˚_ch™ges
++;

736  
rc
;

737 
	}
}

739 
	$mqâ3_h™dÀ_unsubs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

741 
uöt16_t
 
mid
;

742 *
sub
;

744 if(!
c⁄ãxt
Ë 
MOSQ_ERR_INVAL
;

745 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Re˚ived UNSUBSCRIBE from %s", 
c⁄ãxt
->
id
);

747 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ311
){

748 if((
c⁄ãxt
->
ö_∑ckë
.
comm™d
&0x0F) != 0x02){

749  
MOSQ_ERR_PROTOCOL
;

752 if(
	`_mosquôto_ªad_uöt16
(&
c⁄ãxt
->
ö_∑ckë
, &
mid
))  1;

754 
c⁄ãxt
->
ö_∑ckë
.
pos
 < c⁄ãxt->ö_∑ckë.
ªmaöög_Àngth
){

755 
sub
 = 
NULL
;

756 if(
	`_mosquôto_ªad_°rög
(&
c⁄ãxt
->
ö_∑ckë
, &
sub
)){

760 if(
sub
){

761 if(!
	`°æí
(
sub
)){

762 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Empty unsubscription string from %s, disconnecting.",

763 
c⁄ãxt
->
id
);

764 
	`_mosquôto_‰ì
(
sub
);

767 if(
	`mosquôto_sub_t›ic_check
(
sub
)){

768 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "Invalid unsubscription string from %s, disconnecting.",

769 
c⁄ãxt
->
id
);

770 
	`_mosquôto_‰ì
(
sub
);

774 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "\t%s", 
sub
);

775 
	`mqâ3_sub_ªmove
(
db
, 
c⁄ãxt
, 
sub
, &db->
subs
);

776 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_UNSUBSCRIBE
, "%†%s", 
c⁄ãxt
->
id
, 
sub
);

777 
	`_mosquôto_‰ì
(
sub
);

780 #ifde‡
WITH_PERSISTENCE


781 
db
->
≥rsi°í˚_ch™ges
++;

784  
	`_mosquôto_£nd_comm™d_wôh_mid
(
c⁄ãxt
, 
UNSUBACK
, 
mid
, 
Ál£
);

785 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/security.c

17 
	~<c⁄fig.h
>

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~<mosquôto_brokî.h
>

23 
	~"mosquôto_∂ugö.h
"

24 
	~<mem‹y_mosq.h
>

25 
	~"lib_lﬂd.h
"

27 (*
	tFUNC_auth_∂ugö_vîsi⁄
)();

28 (*
	tFUNC_auth_∂ugö_öô
)(**, 
	tmosquôto_auth_›t
 *, );

29 (*
	tFUNC_auth_∂ugö_˛ónup
)(*, 
	tmosquôto_auth_›t
 *, );

30 (*
	tFUNC_auth_∂ugö_£curôy_öô
)(*, 
	tmosquôto_auth_›t
 *, , 
	tboﬁ
);

31 (*
	tFUNC_auth_∂ugö_£curôy_˛ónup
)(*, 
	tmosquôto_auth_›t
 *, , 
	tboﬁ
);

32 (*
	tFUNC_auth_∂ugö_a˛_check
)(*, const *, const *, const *, );

33 (*
	tFUNC_auth_∂ugö_u≈wd_check
)(*, const *, const *);

34 (*
	tFUNC_auth_∂ugö_psk_key_gë
)(*, const *, const *, *, );

36 
	$LIB_ERROR
()

38 #ifde‡
WIN32


39 *
buf
;

40 
	`F‹m©Mesßge
(
FORMAT_MESSAGE_ALLOCATE_BUFFER
 | 
FORMAT_MESSAGE_FROM_STRING
,

41 
NULL
, 
	`GëLa°Eº‹
(), 
LANG_NEUTRAL
, &
buf
, 0, NULL);

42 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "LﬂdÉº‹: %s", 
buf
);

43 
	`LoˇlFªe
(
buf
);

45 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "LﬂdÉº‹: %s", 
	`dÀº‹
());

47 
	}
}

49 
	$mosquôto_£curôy_moduÀ_öô
(
mosquôto_db
 *
db
)

51 *
lib
;

52 (*
∂ugö_vîsi⁄
)(Ë
NULL
;

53 
vîsi⁄
;

54 
rc
;

55 if(
db
->
c⁄fig
->
auth_∂ugö
){

56 
lib
 = 
	`LIB_LOAD
(
db
->
c⁄fig
->
auth_∂ugö
);

57 if(!
lib
){

58 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

59 "Eº‹: U«bÀÅÿlﬂdáuthÖlugö \"%s\".", 
db
->
c⁄fig
->
auth_∂ugö
);

60 
	`LIB_ERROR
();

64 
db
->
auth_∂ugö
.
lib
 = 
NULL
;

65 if(!(
∂ugö_vîsi⁄
 = (
FUNC_auth_∂ugö_vîsi⁄
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_version"))){

66 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

68 
	`LIB_ERROR
();

69 
	`LIB_CLOSE
(
lib
);

72 
vîsi⁄
 = 
	`∂ugö_vîsi⁄
();

73 if(
vîsi⁄
 !
MOSQ_AUTH_PLUGIN_VERSION
){

74 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

76 
vîsi⁄
, 
MOSQ_AUTH_PLUGIN_VERSION
);

77 
	`LIB_ERROR
();

79 
	`LIB_CLOSE
(
lib
);

82 if(!(
db
->
auth_∂ugö
.
∂ugö_öô
 = (
FUNC_auth_∂ugö_öô
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_init"))){

83 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

85 
	`LIB_ERROR
();

86 
	`LIB_CLOSE
(
lib
);

89 if(!(
db
->
auth_∂ugö
.
∂ugö_˛ónup
 = (
FUNC_auth_∂ugö_˛ónup
)
	`LIB_SYM
(
lib
, "mosquitto_auth_plugin_cleanup"))){

90 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

92 
	`LIB_ERROR
();

93 
	`LIB_CLOSE
(
lib
);

97 if(!(
db
->
auth_∂ugö
.
£curôy_öô
 = (
FUNC_auth_∂ugö_£curôy_öô
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_init"))){

98 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

100 
	`LIB_ERROR
();

101 
	`LIB_CLOSE
(
lib
);

105 if(!(
db
->
auth_∂ugö
.
£curôy_˛ónup
 = (
FUNC_auth_∂ugö_£curôy_˛ónup
)
	`LIB_SYM
(
lib
, "mosquitto_auth_security_cleanup"))){

106 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

108 
	`LIB_ERROR
();

109 
	`LIB_CLOSE
(
lib
);

113 if(!(
db
->
auth_∂ugö
.
a˛_check
 = (
FUNC_auth_∂ugö_a˛_check
)
	`LIB_SYM
(
lib
, "mosquitto_auth_acl_check"))){

114 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

116 
	`LIB_ERROR
();

117 
	`LIB_CLOSE
(
lib
);

121 if(!(
db
->
auth_∂ugö
.
u≈wd_check
 = (
FUNC_auth_∂ugö_u≈wd_check
)
	`LIB_SYM
(
lib
, "mosquitto_auth_unpwd_check"))){

122 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

124 
	`LIB_ERROR
();

125 
	`LIB_CLOSE
(
lib
);

129 if(!(
db
->
auth_∂ugö
.
psk_key_gë
 = (
FUNC_auth_∂ugö_psk_key_gë
)
	`LIB_SYM
(
lib
, "mosquitto_auth_psk_key_get"))){

130 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

132 
	`LIB_ERROR
();

133 
	`LIB_CLOSE
(
lib
);

137 
db
->
auth_∂ugö
.
lib
 =Üib;

138 
db
->
auth_∂ugö
.
u£r_d©a
 = 
NULL
;

139 if(
db
->
auth_∂ugö
.
∂ugö_öô
){

140 
rc
 = 
db
->
auth_∂ugö
.
	`∂ugö_öô
(&db->auth_∂ugö.
u£r_d©a
, db->
c⁄fig
->
auth_›ti⁄s
, db->c⁄fig->
auth_›ti⁄_cou¡
);

141 if(
rc
){

142 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
,

143 "Eº‹: Authítiˇti⁄ÖlugöÑëu∫ed %d whí inôülisög.", 
rc
);

145  
rc
;

148 
db
->
auth_∂ugö
.
lib
 = 
NULL
;

149 
db
->
auth_∂ugö
.
∂ugö_öô
 = 
NULL
;

150 
db
->
auth_∂ugö
.
∂ugö_˛ónup
 = 
NULL
;

151 
db
->
auth_∂ugö
.
£curôy_öô
 = 
NULL
;

152 
db
->
auth_∂ugö
.
£curôy_˛ónup
 = 
NULL
;

153 
db
->
auth_∂ugö
.
a˛_check
 = 
NULL
;

154 
db
->
auth_∂ugö
.
u≈wd_check
 = 
NULL
;

155 
db
->
auth_∂ugö
.
psk_key_gë
 = 
NULL
;

158  
MOSQ_ERR_SUCCESS
;

159 
	}
}

161 
	$mosquôto_£curôy_moduÀ_˛ónup
(
mosquôto_db
 *
db
)

163 
	`mosquôto_£curôy_˛ónup
(
db
, 
Ál£
);

165 if(
db
->
auth_∂ugö
.
∂ugö_˛ónup
){

166 
db
->
auth_∂ugö
.
	`∂ugö_˛ónup
(db->auth_∂ugö.
u£r_d©a
, db->
c⁄fig
->
auth_›ti⁄s
, db->c⁄fig->
auth_›ti⁄_cou¡
);

169 if(
db
->
c⁄fig
->
auth_∂ugö
){

170 if(
db
->
auth_∂ugö
.
lib
){

171 
	`LIB_CLOSE
(
db
->
auth_∂ugö
.
lib
);

174 
db
->
auth_∂ugö
.
lib
 = 
NULL
;

175 
db
->
auth_∂ugö
.
∂ugö_öô
 = 
NULL
;

176 
db
->
auth_∂ugö
.
∂ugö_˛ónup
 = 
NULL
;

177 
db
->
auth_∂ugö
.
£curôy_öô
 = 
NULL
;

178 
db
->
auth_∂ugö
.
£curôy_˛ónup
 = 
NULL
;

179 
db
->
auth_∂ugö
.
a˛_check
 = 
NULL
;

180 
db
->
auth_∂ugö
.
u≈wd_check
 = 
NULL
;

181 
db
->
auth_∂ugö
.
psk_key_gë
 = 
NULL
;

183  
MOSQ_ERR_SUCCESS
;

184 
	}
}

186 
	$mosquôto_£curôy_öô
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

188 if(!
db
->
auth_∂ugö
.
lib
){

189  
	`mosquôto_£curôy_öô_deÁu…
(
db
, 
ªlﬂd
);

191  
db
->
auth_∂ugö
.
	`£curôy_öô
(db->auth_∂ugö.
u£r_d©a
, db->
c⁄fig
->
auth_›ti⁄s
, db->c⁄fig->
auth_›ti⁄_cou¡
, 
ªlﬂd
);

193 
	}
}

201 
	$mosquôto_£curôy_≠∂y
(
mosquôto_db
 *
db
)

203 if(!
db
->
auth_∂ugö
.
lib
){

204  
	`mosquôto_£curôy_≠∂y_deÁu…
(
db
);

206  
MOSQ_ERR_SUCCESS
;

207 
	}
}

209 
	$mosquôto_£curôy_˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

211 if(!
db
->
auth_∂ugö
.
lib
){

212  
	`mosquôto_£curôy_˛ónup_deÁu…
(
db
, 
ªlﬂd
);

214  
db
->
auth_∂ugö
.
	`£curôy_˛ónup
(db->auth_∂ugö.
u£r_d©a
, db->
c⁄fig
->
auth_›ti⁄s
, db->c⁄fig->
auth_›ti⁄_cou¡
, 
ªlﬂd
);

216 
	}
}

218 
	$mosquôto_a˛_check
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
ac˚ss
)

220 *
u£∫ame
;

222 if(!
c⁄ãxt
->
id
){

223  
MOSQ_ERR_ACL_DENIED
;

225 if(!
db
->
auth_∂ugö
.
lib
){

226  
	`mosquôto_a˛_check_deÁu…
(
db
, 
c⁄ãxt
, 
t›ic
, 
ac˚ss
);

228 #ifde‡
WITH_BRIDGE


229 if(
c⁄ãxt
->
bridge
){

230 
u£∫ame
 = 
c⁄ãxt
->
bridge
->
loˇl_u£∫ame
;

234 
u£∫ame
 = 
c⁄ãxt
->username;

236  
db
->
auth_∂ugö
.
	`a˛_check
(db->auth_∂ugö.
u£r_d©a
, 
c⁄ãxt
->
id
, 
u£∫ame
, 
t›ic
, 
ac˚ss
);

238 
	}
}

240 
	$mosquôto_u≈wd_check
(
mosquôto_db
 *
db
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

242 if(!
db
->
auth_∂ugö
.
lib
){

243  
	`mosquôto_u≈wd_check_deÁu…
(
db
, 
u£∫ame
, 
∑ssw‹d
);

245  
db
->
auth_∂ugö
.
	`u≈wd_check
(db->auth_∂ugö.
u£r_d©a
, 
u£∫ame
, 
∑ssw‹d
);

247 
	}
}

249 
	$mosquôto_psk_key_gë
(
mosquôto_db
 *
db
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

251 if(!
db
->
auth_∂ugö
.
lib
){

252  
	`mosquôto_psk_key_gë_deÁu…
(
db
, 
höt
, 
idítôy
, 
key
, 
max_key_Àn
);

254  
db
->
auth_∂ugö
.
	`psk_key_gë
(db->auth_∂ugö.
u£r_d©a
, 
höt
, 
idítôy
, 
key
, 
max_key_Àn
);

256 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/security_default.c

17 
	~<c⁄fig.h
>

19 
	~<°dio.h
>

20 
	~<°rög.h
>

22 
	~<mosquôto_brokî.h
>

23 
	~<mem‹y_mosq.h
>

24 
	~"utû_mosq.h
"

26 
_a˛fûe_∑r£
(
mosquôto_db
 *
db
);

27 
_u≈wd_fûe_∑r£
(
mosquôto_db
 *
db
);

28 
_a˛_˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

29 
_u≈wd_˛ónup
(
_mosquôto_u≈wd
 **
u≈wd
, 
boﬁ
 
ªlﬂd
);

30 
_psk_fûe_∑r£
(
mosquôto_db
 *
db
);

31 #ifde‡
WITH_TLS


32 
_pw_dige°
(c⁄° *
∑ssw‹d
, c⁄° *
ß…
, 
ß…_Àn
, *
hash
, *
hash_Àn
);

33 
_ba£64_decode
(*
ö
, **
decoded
, *
decoded_Àn
);

36 
	$mosquôto_£curôy_öô_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

38 
rc
;

41 if(
db
->
c⁄fig
->
∑ssw‹d_fûe
){

42 
rc
 = 
	`_u≈wd_fûe_∑r£
(
db
);

43 if(
rc
){

44 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögÖassw‹d fûê\"%s\".", 
db
->
c⁄fig
->
∑ssw‹d_fûe
);

45  
rc
;

50 if(
db
->
c⁄fig
->
a˛_fûe
){

51 
rc
 = 
	`_a˛fûe_∑r£
(
db
);

52 if(
rc
){

53 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögá˛ fûê\"%s\".", 
db
->
c⁄fig
->
a˛_fûe
);

54  
rc
;

59 if(
db
->
c⁄fig
->
psk_fûe
){

60 
rc
 = 
	`_psk_fûe_∑r£
(
db
);

61 if(
rc
){

62 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹ o≥nögÖsk fûê\"%s\".", 
db
->
c⁄fig
->
psk_fûe
);

63  
rc
;

67  
MOSQ_ERR_SUCCESS
;

68 
	}
}

70 
	$mosquôto_£curôy_˛ónup_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

72 
rc
;

73 
rc
 = 
	`_a˛_˛ónup
(
db
, 
ªlﬂd
);

74 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

75 
rc
 = 
	`_u≈wd_˛ónup
(&
db
->
u≈wd
, 
ªlﬂd
);

76 if(
rc
 !
MOSQ_ERR_SUCCESS
) Ñc;

77  
	`_u≈wd_˛ónup
(&
db
->
psk_id
, 
ªlﬂd
);

78 
	}
}

81 
	$_add_a˛
(
mosquôto_db
 *
db
, c⁄° *
u£r
, c⁄° *
t›ic
, 
ac˚ss
)

83 
_mosquôto_a˛_u£r
 *
a˛_u£r
=
NULL
, *
u£r_èû
;

84 
_mosquôto_a˛
 *
a˛
, *
a˛_èû
;

85 *
loˇl_t›ic
;

86 
boﬁ
 
√w_u£r
 = 
Ál£
;

88 if(!
db
 || !
t›ic
Ë 
MOSQ_ERR_INVAL
;

90 
loˇl_t›ic
 = 
	`_mosquôto_°rdup
(
t›ic
);

91 if(!
loˇl_t›ic
){

92  
MOSQ_ERR_NOMEM
;

95 if(
db
->
a˛_li°
){

96 
u£r_èû
 = 
db
->
a˛_li°
;

97 
u£r_èû
){

98 if(
u£r
 =
NULL
){

99 if(
u£r_èû
->
u£∫ame
 =
NULL
){

100 
a˛_u£r
 = 
u£r_èû
;

103 }if(
u£r_èû
->
u£∫ame
 && !
	`°rcmp
(u£r_èû->u£∫ame, 
u£r
)){

104 
a˛_u£r
 = 
u£r_èû
;

107 
u£r_èû
 = u£r_èû->
√xt
;

110 if(!
a˛_u£r
){

111 
a˛_u£r
 = 
	`_mosquôto_mÆloc
((
_mosquôto_a˛_u£r
));

112 if(!
a˛_u£r
){

113 
	`_mosquôto_‰ì
(
loˇl_t›ic
);

114  
MOSQ_ERR_NOMEM
;

116 
√w_u£r
 = 
åue
;

117 if(
u£r
){

118 
a˛_u£r
->
u£∫ame
 = 
	`_mosquôto_°rdup
(
u£r
);

119 if(!
a˛_u£r
->
u£∫ame
){

120 
	`_mosquôto_‰ì
(
loˇl_t›ic
);

121 
	`_mosquôto_‰ì
(
a˛_u£r
);

122  
MOSQ_ERR_NOMEM
;

125 
a˛_u£r
->
u£∫ame
 = 
NULL
;

127 
a˛_u£r
->
√xt
 = 
NULL
;

128 
a˛_u£r
->
a˛
 = 
NULL
;

131 
a˛
 = 
	`_mosquôto_mÆloc
((
_mosquôto_a˛
));

132 if(!
a˛
){

133 
	`_mosquôto_‰ì
(
loˇl_t›ic
);

134  
MOSQ_ERR_NOMEM
;

136 
a˛
->
ac˚ss
 =áccess;

137 
a˛
->
t›ic
 = 
loˇl_t›ic
;

138 
a˛
->
√xt
 = 
NULL
;

139 
a˛
->
ccou¡
 = 0;

140 
a˛
->
ucou¡
 = 0;

143 if(
a˛_u£r
->
a˛
){

144 
a˛_èû
 = 
a˛_u£r
->
a˛
;

145 
a˛_èû
->
√xt
){

146 
a˛_èû
 =á˛_èû->
√xt
;

148 
a˛_èû
->
√xt
 = 
a˛
;

150 
a˛_u£r
->
a˛
 =ácl;

153 if(
√w_u£r
){

155 if(
db
->
a˛_li°
){

156 
u£r_èû
 = 
db
->
a˛_li°
;

157 
u£r_èû
->
√xt
){

158 
u£r_èû
 = u£r_èû->
√xt
;

160 
u£r_èû
->
√xt
 = 
a˛_u£r
;

162 
db
->
a˛_li°
 = 
a˛_u£r
;

166  
MOSQ_ERR_SUCCESS
;

167 
	}
}

169 
	$_add_a˛_∑âîn
(
mosquôto_db
 *
db
, c⁄° *
t›ic
, 
ac˚ss
)

171 
_mosquôto_a˛
 *
a˛
, *
a˛_èû
;

172 *
loˇl_t›ic
;

173 *
s
;

175 if(!
db
 || !
t›ic
Ë 
MOSQ_ERR_INVAL
;

177 
loˇl_t›ic
 = 
	`_mosquôto_°rdup
(
t›ic
);

178 if(!
loˇl_t›ic
){

179  
MOSQ_ERR_NOMEM
;

182 
a˛
 = 
	`_mosquôto_mÆloc
((
_mosquôto_a˛
));

183 if(!
a˛
){

184 
	`_mosquôto_‰ì
(
loˇl_t›ic
);

185  
MOSQ_ERR_NOMEM
;

187 
a˛
->
ac˚ss
 =áccess;

188 
a˛
->
t›ic
 = 
loˇl_t›ic
;

189 
a˛
->
√xt
 = 
NULL
;

191 
a˛
->
ccou¡
 = 0;

192 
s
 = 
loˇl_t›ic
;

193 
s
){

194 
s
 = 
	`°r°r
(s, "%c");

195 if(
s
){

196 
a˛
->
ccou¡
++;

197 
s
+=2;

201 
a˛
->
ucou¡
 = 0;

202 
s
 = 
loˇl_t›ic
;

203 
s
){

204 
s
 = 
	`°r°r
(s, "%u");

205 if(
s
){

206 
a˛
->
ucou¡
++;

207 
s
+=2;

211 if(
db
->
a˛_∑âîns
){

212 
a˛_èû
 = 
db
->
a˛_∑âîns
;

213 
a˛_èû
->
√xt
){

214 
a˛_èû
 =á˛_èû->
√xt
;

216 
a˛_èû
->
√xt
 = 
a˛
;

218 
db
->
a˛_∑âîns
 = 
a˛
;

221  
MOSQ_ERR_SUCCESS
;

222 
	}
}

224 
	$mosquôto_a˛_check_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
ac˚ss
)

226 *
loˇl_a˛
;

227 
_mosquôto_a˛
 *
a˛_roŸ
;

228 
boﬁ
 
ªsu…
;

229 
i
;

230 
Àn
, 
éí
, 
˛í
, 
uÀn
;

231 *
s
;

233 if(!
db
 || !
c⁄ãxt
 || !
t›ic
Ë 
MOSQ_ERR_INVAL
;

234 if(!
db
->
a˛_li°
 && !db->
a˛_∑âîns
Ë 
MOSQ_ERR_SUCCESS
;

235 if(
c⁄ãxt
->
bridge
Ë 
MOSQ_ERR_SUCCESS
;

236 if(!
c⁄ãxt
->
a˛_li°
 && !
db
->
a˛_∑âîns
Ë 
MOSQ_ERR_ACL_DENIED
;

238 if(
c⁄ãxt
->
a˛_li°
){

239 
a˛_roŸ
 = 
c⁄ãxt
->
a˛_li°
->
a˛
;

241 
a˛_roŸ
 = 
NULL
;

245 
a˛_roŸ
){

249 if(
t›ic
[0] ='$' && 
a˛_roŸ
->topic[0] != '$'){

250 
a˛_roŸ
 =á˛_roŸ->
√xt
;

253 
	`mosquôto_t›ic_m©ches_sub
(
a˛_roŸ
->
t›ic
,Å›ic, &
ªsu…
);

254 if(
ªsu…
){

255 if(
ac˚ss
 & 
a˛_roŸ
->access){

257  
MOSQ_ERR_SUCCESS
;

260 
a˛_roŸ
 =á˛_roŸ->
√xt
;

263 
a˛_roŸ
 = 
db
->
a˛_∑âîns
;

265 
˛í
 = 
	`°æí
(
c⁄ãxt
->
id
);

266 
a˛_roŸ
){

267 
éí
 = 
	`°æí
(
a˛_roŸ
->
t›ic
);

269 if(
a˛_roŸ
->
ucou¡
 && !
c⁄ãxt
->
u£∫ame
){

270 
a˛_roŸ
 =á˛_roŸ->
√xt
;

274 if(
c⁄ãxt
->
u£∫ame
){

275 
uÀn
 = 
	`°æí
(
c⁄ãxt
->
u£∫ame
);

276 
Àn
 = 
éí
 + 
a˛_roŸ
->
ccou¡
*(
˛í
-2Ë+á˛_roŸ->
ucou¡
*(
uÀn
-2);

278 
uÀn
 = 0;

279 
Àn
 = 
éí
 + 
a˛_roŸ
->
ccou¡
*(
˛í
-2);

281 
loˇl_a˛
 = 
	`mÆloc
(
Àn
+1);

282 if(!
loˇl_a˛
)  1;

283 
s
 = 
loˇl_a˛
;

284 
i
=0; i<
éí
; i++){

285 if(
i
<
éí
-1 && 
a˛_roŸ
->
t›ic
[i] == '%'){

286 if(
a˛_roŸ
->
t›ic
[
i
+1] == 'c'){

287 
i
++;

288 
	`°∫˝y
(
s
, 
c⁄ãxt
->
id
, 
˛í
);

289 
s
+=
˛í
;

291 }if(
c⁄ãxt
->
u£∫ame
 && 
a˛_roŸ
->
t›ic
[
i
+1] == 'u'){

292 
i
++;

293 
	`°∫˝y
(
s
, 
c⁄ãxt
->
u£∫ame
, 
uÀn
);

294 
s
+=
uÀn
;

298 
s
[0] = 
a˛_roŸ
->
t›ic
[
i
];

299 
s
++;

301 
loˇl_a˛
[
Àn
] = '\0';

303 
	`mosquôto_t›ic_m©ches_sub
(
loˇl_a˛
, 
t›ic
, &
ªsu…
);

304 
	`_mosquôto_‰ì
(
loˇl_a˛
);

305 if(
ªsu…
){

306 if(
ac˚ss
 & 
a˛_roŸ
->access){

308  
MOSQ_ERR_SUCCESS
;

312 
a˛_roŸ
 =á˛_roŸ->
√xt
;

315  
MOSQ_ERR_ACL_DENIED
;

316 
	}
}

318 
	$_a˛fûe_∑r£
(
mosquôto_db
 *
db
)

320 
FILE
 *
a˛fûe
;

321 
buf
[1024];

322 *
tokí
;

323 *
u£r
 = 
NULL
;

324 *
t›ic
;

325 *
ac˚ss_s
;

326 
ac˚ss
;

327 
rc
;

328 
¶í
;

329 
t›ic_∑âîn
;

330 *
ßvïå
 = 
NULL
;

332 if(!
db
 || !db->
c⁄fig
Ë 
MOSQ_ERR_INVAL
;

333 if(!
db
->
c⁄fig
->
a˛_fûe
Ë 
MOSQ_ERR_SUCCESS
;

335 
a˛fûe
 = 
	`_mosquôto_f›í
(
db
->
c⁄fig
->
a˛_fûe
, "rt");

336 if(!
a˛fûe
){

337 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›íá˛_fûê\"%s\".", 
db
->
c⁄fig
->
a˛_fûe
);

344 
	`fgës
(
buf
, 1024, 
a˛fûe
)){

345 
¶í
 = 
	`°æí
(
buf
);

346 
¶í
 > 0 && (
buf
[slen-1] == 10 || buf[slen-1] == 13)){

347 
buf
[
¶í
-1] = '\0';

348 
¶í
 = 
	`°æí
(
buf
);

350 if(
buf
[0] == '#'){

353 
tokí
 = 
	`°πok_r
(
buf
, " ", &
ßvïå
);

354 if(
tokí
){

355 if(!
	`°rcmp
(
tokí
, "topic") || !strcmp(token, "pattern")){

356 if(!
	`°rcmp
(
tokí
, "topic")){

357 
t›ic_∑âîn
 = 0;

359 
t›ic_∑âîn
 = 1;

362 
ac˚ss_s
 = 
	`°πok_r
(
NULL
, " ", &
ßvïå
);

363 if(!
ac˚ss_s
){

364 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: EmptyÅopic inácl_file.");

365 if(
u£r
Ë
	`_mosquôto_‰ì
(user);

366 
	`f˛o£
(
a˛fûe
);

367  
MOSQ_ERR_INVAL
;

369 
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

370 if(
tokí
){

371 
t›ic
 = 
tokí
;

373 
t›ic
[0] == ' '){

374 
t›ic
++;

377 
t›ic
 = 
ac˚ss_s
;

378 
ac˚ss_s
 = 
NULL
;

380 if(
ac˚ss_s
){

381 if(!
	`°rcmp
(
ac˚ss_s
, "read")){

382 
ac˚ss
 = 
MOSQ_ACL_READ
;

383 }if(!
	`°rcmp
(
ac˚ss_s
, "write")){

384 
ac˚ss
 = 
MOSQ_ACL_WRITE
;

385 }if(!
	`°rcmp
(
ac˚ss_s
, "readwrite")){

386 
ac˚ss
 = 
MOSQ_ACL_READ
 | 
MOSQ_ACL_WRITE
;

388 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÅ›i¯ac˚s†ty≥ \"%s\" i¿a˛_fûe.", 
ac˚ss_s
);

389 if(
u£r
Ë
	`_mosquôto_‰ì
(user);

390 
	`f˛o£
(
a˛fûe
);

391  
MOSQ_ERR_INVAL
;

394 
ac˚ss
 = 
MOSQ_ACL_READ
 | 
MOSQ_ACL_WRITE
;

396 if(
t›ic_∑âîn
 == 0){

397 
rc
 = 
	`_add_a˛
(
db
, 
u£r
, 
t›ic
, 
ac˚ss
);

399 
rc
 = 
	`_add_a˛_∑âîn
(
db
, 
t›ic
, 
ac˚ss
);

401 if(
rc
){

402 if(
u£r
Ë
	`_mosquôto_‰ì
(user);

403 
	`f˛o£
(
a˛fûe
);

404  
rc
;

406 }if(!
	`°rcmp
(
tokí
, "user")){

407 
tokí
 = 
	`°πok_r
(
NULL
, "", &
ßvïå
);

408 if(
tokí
){

410 
tokí
[0] == ' '){

411 
tokí
++;

413 if(
u£r
Ë
	`_mosquôto_‰ì
(user);

414 
u£r
 = 
	`_mosquôto_°rdup
(
tokí
);

415 if(!
u£r
){

416 
	`f˛o£
(
a˛fûe
);

417  
MOSQ_ERR_NOMEM
;

420 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Missing username inácl_file.");

421 if(
u£r
Ë
	`_mosquôto_‰ì
(user);

422 
	`f˛o£
(
a˛fûe
);

429 if(
u£r
Ë
	`_mosquôto_‰ì
(user);

430 
	`f˛o£
(
a˛fûe
);

432  
MOSQ_ERR_SUCCESS
;

433 
	}
}

435 
	$_‰ì_a˛
(
_mosquôto_a˛
 *
a˛
)

437 if(!
a˛
) ;

439 if(
a˛
->
√xt
){

440 
	`_‰ì_a˛
(
a˛
->
√xt
);

442 if(
a˛
->
t›ic
){

443 
	`_mosquôto_‰ì
(
a˛
->
t›ic
);

445 
	`_mosquôto_‰ì
(
a˛
);

446 
	}
}

448 
	$_a˛_˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
)

450 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

451 
_mosquôto_a˛_u£r
 *
u£r_èû
;

453 if(!
db
Ë 
MOSQ_ERR_INVAL
;

454 if(!
db
->
a˛_li°
Ë 
MOSQ_ERR_SUCCESS
;

462 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

463 
c⁄ãxt
->
a˛_li°
 = 
NULL
;

466 
db
->
a˛_li°
){

467 
u£r_èû
 = 
db
->
a˛_li°
->
√xt
;

469 
	`_‰ì_a˛
(
db
->
a˛_li°
->
a˛
);

470 if(
db
->
a˛_li°
->
u£∫ame
){

471 
	`_mosquôto_‰ì
(
db
->
a˛_li°
->
u£∫ame
);

473 
	`_mosquôto_‰ì
(
db
->
a˛_li°
);

475 
db
->
a˛_li°
 = 
u£r_èû
;

478 if(
db
->
a˛_∑âîns
){

479 
	`_‰ì_a˛
(
db
->
a˛_∑âîns
);

480 
db
->
a˛_∑âîns
 = 
NULL
;

482  
MOSQ_ERR_SUCCESS
;

483 
	}
}

485 
	$_pwfûe_∑r£
(c⁄° *
fûe
, 
_mosquôto_u≈wd
 **
roŸ
)

487 
FILE
 *
pwfûe
;

488 
_mosquôto_u≈wd
 *
u≈wd
;

489 
buf
[256];

490 *
u£∫ame
, *
∑ssw‹d
;

491 
Àn
;

492 *
ßvïå
 = 
NULL
;

494 
pwfûe
 = 
	`_mosquôto_f›í
(
fûe
, "rt");

495 if(!
pwfûe
){

496 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿ›íÖwfûê\"%s\".", 
fûe
);

500 !
	`„of
(
pwfûe
)){

501 if(
	`fgës
(
buf
, 256, 
pwfûe
)){

502 
u£∫ame
 = 
	`°πok_r
(
buf
, ":", &
ßvïå
);

503 if(
u£∫ame
){

504 
u≈wd
 = 
	`_mosquôto_ˇŒoc
(1, (
_mosquôto_u≈wd
));

505 if(!
u≈wd
){

506 
	`f˛o£
(
pwfûe
);

507  
MOSQ_ERR_NOMEM
;

509 
u≈wd
->
u£∫ame
 = 
	`_mosquôto_°rdup
(username);

510 if(!
u≈wd
->
u£∫ame
){

511 
	`_mosquôto_‰ì
(
u≈wd
);

512 
	`f˛o£
(
pwfûe
);

513  
MOSQ_ERR_NOMEM
;

515 
Àn
 = 
	`°æí
(
u≈wd
->
u£∫ame
);

516 
u≈wd
->
u£∫ame
[
Àn
-1] == 10 || unpwd->username[len-1] == 13){

517 
u≈wd
->
u£∫ame
[
Àn
-1] = '\0';

518 
Àn
 = 
	`°æí
(
u≈wd
->
u£∫ame
);

520 
∑ssw‹d
 = 
	`°πok_r
(
NULL
, ":", &
ßvïå
);

521 if(
∑ssw‹d
){

522 
u≈wd
->
∑ssw‹d
 = 
	`_mosquôto_°rdup
(password);

523 if(!
u≈wd
->
∑ssw‹d
){

524 
	`f˛o£
(
pwfûe
);

525 
	`_mosquôto_‰ì
(
u≈wd
->
u£∫ame
);

526 
	`_mosquôto_‰ì
(
u≈wd
);

527  
MOSQ_ERR_NOMEM
;

529 
Àn
 = 
	`°æí
(
u≈wd
->
∑ssw‹d
);

530 
Àn
 && (
u≈wd
->
∑ssw‹d
[len-1] == 10 || unpwd->password[len-1] == 13)){

531 
u≈wd
->
∑ssw‹d
[
Àn
-1] = '\0';

532 
Àn
 = 
	`°æí
(
u≈wd
->
∑ssw‹d
);

535 
	`HASH_ADD_KEYPTR
(
hh
, *
roŸ
, 
u≈wd
->
u£∫ame
, 
	`°æí
(unpwd->username), unpwd);

539 
	`f˛o£
(
pwfûe
);

541  
MOSQ_ERR_SUCCESS
;

542 
	}
}

544 
	$_u≈wd_fûe_∑r£
(
mosquôto_db
 *
db
)

546 
rc
;

547 #ifde‡
WITH_TLS


548 
_mosquôto_u≈wd
 *
u
, *
tmp
;

549 *
tokí
;

550 *
ß…
;

551 
ß…_Àn
;

552 *
∑ssw‹d
;

553 
∑ssw‹d_Àn
;

556 if(!
db
 || !db->
c⁄fig
Ë 
MOSQ_ERR_INVAL
;

558 if(!
db
->
c⁄fig
->
∑ssw‹d_fûe
Ë 
MOSQ_ERR_SUCCESS
;

560 
rc
 = 
	`_pwfûe_∑r£
(
db
->
c⁄fig
->
∑ssw‹d_fûe
, &db->
u≈wd
);

561 #ifde‡
WITH_TLS


562 if(
rc
) Ñc;

564 
	`HASH_ITER
(
hh
, 
db
->
u≈wd
, 
u
, 
tmp
){

566 if(
u
->
∑ssw‹d
){

567 
tokí
 = 
	`°πok
(
u
->
∑ssw‹d
, "$");

568 if(
tokí
 && !
	`°rcmp
(token, "6")){

569 
tokí
 = 
	`°πok
(
NULL
, "$");

570 if(
tokí
){

571 
rc
 = 
	`_ba£64_decode
(
tokí
, &
ß…
, &
ß…_Àn
);

572 if(
rc
){

573 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿdecodê∑ssw‹d sÆàf‹ u£∏%s.", 
u
->
u£∫ame
);

574  
MOSQ_ERR_INVAL
;

576 
u
->
ß…
 = salt;

577 
u
->
ß…_Àn
 = salt_len;

578 
tokí
 = 
	`°πok
(
NULL
, "$");

579 if(
tokí
){

580 
rc
 = 
	`_ba£64_decode
(
tokí
, &
∑ssw‹d
, &
∑ssw‹d_Àn
);

581 if(
rc
){

582 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: U«bÀÅÿdecodê∑ssw‹d f‹ u£∏%s.", 
u
->
u£∫ame
);

583  
MOSQ_ERR_INVAL
;

585 
	`_mosquôto_‰ì
(
u
->
∑ssw‹d
);

586 
u
->
∑ssw‹d
 = (*)password;

587 
u
->
∑ssw‹d_Àn
 =Öassword_len;

589 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖassw‹d hash f‹ u£∏%s.", 
u
->
u£∫ame
);

590  
MOSQ_ERR_INVAL
;

593 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖassw‹d hash f‹ u£∏%s.", 
u
->
u£∫ame
);

594  
MOSQ_ERR_INVAL
;

597 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: InvÆidÖassw‹d hash f‹ u£∏%s.", 
u
->
u£∫ame
);

598  
MOSQ_ERR_INVAL
;

603  
rc
;

604 
	}
}

606 
	$_psk_fûe_∑r£
(
mosquôto_db
 *
db
)

608 
rc
;

609 
_mosquôto_u≈wd
 *
u
, *
tmp
;

611 if(!
db
 || !db->
c⁄fig
Ë 
MOSQ_ERR_INVAL
;

614 if(!
db
->
c⁄fig
->
psk_fûe
Ë 
MOSQ_ERR_SUCCESS
;

616 
rc
 = 
	`_pwfûe_∑r£
(
db
->
c⁄fig
->
psk_fûe
, &db->
psk_id
);

617 if(
rc
) Ñc;

619 
	`HASH_ITER
(
hh
, 
db
->
psk_id
, 
u
, 
tmp
){

621 if(!
u
->
∑ssw‹d
){

622 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹: Em±yÖsk f‹ idítôy \"%s\".", 
u
->
u£∫ame
);

623  
MOSQ_ERR_INVAL
;

625 if(
	`°r•n
(
u
->
∑ssw‹d
, "0123456789abcdefABCDEF"Ë< 
	`°æí
(u->password)){

626 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Eº‹:Ösk f‹ idítôy \"%s\" c⁄èö†n⁄-hexadecimÆ ch¨a˘îs.", 
u
->
u£∫ame
);

627  
MOSQ_ERR_INVAL
;

630  
MOSQ_ERR_SUCCESS
;

631 
	}
}

633 
	$mosquôto_u≈wd_check_deÁu…
(
mosquôto_db
 *
db
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
)

635 
_mosquôto_u≈wd
 *
u
, *
tmp
;

636 #ifde‡
WITH_TLS


637 
hash
[
EVP_MAX_MD_SIZE
];

638 
hash_Àn
;

639 
rc
;

642 if(!
db
Ë 
MOSQ_ERR_INVAL
;

643 if(!
db
->
u≈wd
Ë 
MOSQ_ERR_SUCCESS
;

644 if(!
u£∫ame
Ë 
MOSQ_ERR_INVAL
;

646 
	`HASH_ITER
(
hh
, 
db
->
u≈wd
, 
u
, 
tmp
){

647 if(!
	`°rcmp
(
u
->
u£∫ame
, username)){

648 if(
u
->
∑ssw‹d
){

649 if(
∑ssw‹d
){

650 #ifde‡
WITH_TLS


651 
rc
 = 
	`_pw_dige°
(
∑ssw‹d
, 
u
->
ß…
, u->
ß…_Àn
, 
hash
, &
hash_Àn
);

652 if(
rc
 =
MOSQ_ERR_SUCCESS
){

653 if(
hash_Àn
 =
u
->
∑ssw‹d_Àn
 && !
	`memcmp
(u->
∑ssw‹d
, 
hash
, hash_len)){

654  
MOSQ_ERR_SUCCESS
;

656  
MOSQ_ERR_AUTH
;

659  
rc
;

662 if(!
	`°rcmp
(
u
->
∑ssw‹d
,Öassword)){

663  
MOSQ_ERR_SUCCESS
;

667  
MOSQ_ERR_AUTH
;

670  
MOSQ_ERR_SUCCESS
;

675  
MOSQ_ERR_AUTH
;

676 
	}
}

678 
	$_u≈wd_˛ónup
(
_mosquôto_u≈wd
 **
roŸ
, 
boﬁ
 
ªlﬂd
)

680 
_mosquôto_u≈wd
 *
u
, *
tmp
;

682 if(!
roŸ
Ë 
MOSQ_ERR_INVAL
;

684 
	`HASH_ITER
(
hh
, *
roŸ
, 
u
, 
tmp
){

685 
	`HASH_DEL
(*
roŸ
, 
u
);

686 if(
u
->
∑ssw‹d
Ë
	`_mosquôto_‰ì
(u->password);

687 if(
u
->
u£∫ame
Ë
	`_mosquôto_‰ì
(u->username);

688 #ifde‡
WITH_TLS


689 if(
u
->
ß…
Ë
	`_mosquôto_‰ì
(u->salt);

691 
	`_mosquôto_‰ì
(
u
);

694 *
roŸ
 = 
NULL
;

696  
MOSQ_ERR_SUCCESS
;

697 
	}
}

705 
	$mosquôto_£curôy_≠∂y_deÁu…
(
mosquôto_db
 *
db
)

707 
mosquôto
 *
c⁄ãxt
, *
˘xt_tmp
;

708 
_mosquôto_a˛_u£r
 *
a˛_u£r_èû
;

709 
boﬁ
 
Ælow_™⁄ymous
;

711 if(!
db
Ë 
MOSQ_ERR_INVAL
;

713 
Ælow_™⁄ymous
 = 
db
->
c⁄fig
->allow_anonymous;

715 
	`HASH_ITER
(
hh_id
, 
db
->
c⁄ãxts_by_id
, 
c⁄ãxt
, 
˘xt_tmp
){

717 if(!
Ælow_™⁄ymous
 && !
c⁄ãxt
->
u£∫ame
){

718 
c⁄ãxt
->
°©e
 = 
mosq_cs_disc⁄√˘ög
;

719 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

723 if(
	`mosquôto_u≈wd_check_deÁu…
(
db
, 
c⁄ãxt
->
u£∫ame
, c⁄ãxt->
∑ssw‹d
Ë!
MOSQ_ERR_SUCCESS
){

724 
c⁄ãxt
->
°©e
 = 
mosq_cs_disc⁄√˘ög
;

725 
	`do_disc⁄√˘
(
db
, 
c⁄ãxt
);

729 if(
db
->
a˛_li°
){

730 
a˛_u£r_èû
 = 
db
->
a˛_li°
;

731 
a˛_u£r_èû
){

732 if(
a˛_u£r_èû
->
u£∫ame
){

733 if(
c⁄ãxt
->
u£∫ame
){

734 if(!
	`°rcmp
(
a˛_u£r_èû
->
u£∫ame
, 
c⁄ãxt
->username)){

735 
c⁄ãxt
->
a˛_li°
 = 
a˛_u£r_èû
;

740 if(!
c⁄ãxt
->
u£∫ame
){

741 
c⁄ãxt
->
a˛_li°
 = 
a˛_u£r_èû
;

745 
a˛_u£r_èû
 =á˛_u£r_èû->
√xt
;

749  
MOSQ_ERR_SUCCESS
;

750 
	}
}

752 
	$mosquôto_psk_key_gë_deÁu…
(
mosquôto_db
 *
db
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
)

754 
_mosquôto_u≈wd
 *
u
, *
tmp
;

756 if(!
db
 || !
höt
 || !
idítôy
 || !
key
Ë 
MOSQ_ERR_INVAL
;

757 if(!
db
->
psk_id
Ë 
MOSQ_ERR_AUTH
;

759 
	`HASH_ITER
(
hh
, 
db
->
psk_id
, 
u
, 
tmp
){

760 if(!
	`°rcmp
(
u
->
u£∫ame
, 
idítôy
)){

761 
	`°∫˝y
(
key
, 
u
->
∑ssw‹d
, 
max_key_Àn
);

762  
MOSQ_ERR_SUCCESS
;

766  
MOSQ_ERR_AUTH
;

767 
	}
}

769 #ifde‡
WITH_TLS


770 
	$_pw_dige°
(c⁄° *
∑ssw‹d
, c⁄° *
ß…
, 
ß…_Àn
, *
hash
, *
hash_Àn
)

772 c⁄° 
EVP_MD
 *
dige°
;

773 
EVP_MD_CTX
 
c⁄ãxt
;

775 
dige°
 = 
	`EVP_gë_dige°by«me
("sha512");

776 if(!
dige°
){

781 
	`EVP_MD_CTX_öô
(&
c⁄ãxt
);

782 
	`EVP_Dige°Inô_ex
(&
c⁄ãxt
, 
dige°
, 
NULL
);

783 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
∑ssw‹d
, 
	`°æí
(password));

784 
	`EVP_Dige°Upd©e
(&
c⁄ãxt
, 
ß…
, 
ß…_Àn
);

786 
	`EVP_Dige°FöÆ_ex
(&
c⁄ãxt
, 
hash
, 
hash_Àn
);

787 
	`EVP_MD_CTX_˛ónup
(&
c⁄ãxt
);

789  
MOSQ_ERR_SUCCESS
;

790 
	}
}

792 
	$_ba£64_decode
(*
ö
, **
decoded
, *
decoded_Àn
)

794 
BIO
 *
bmem
, *
b64
;

796 
b64
 = 
	`BIO_√w
(
	`BIO_f_ba£64
());

797 
	`BIO_£t_Êags
(
b64
, 
BIO_FLAGS_BASE64_NO_NL
);

798 
bmem
 = 
	`BIO_√w
(
	`BIO_s_mem
());

799 
b64
 = 
	`BIO_push
(b64, 
bmem
);

800 
	`BIO_wrôe
(
bmem
, 
ö
, 
	`°æí
(in));

802 if(
	`BIO_Êush
(
bmem
) != 1){

803 
	`BIO_‰ì_Æl
(
b64
);

806 *
decoded
 = 
	`ˇŒoc
(
	`°æí
(
ö
), 1);

807 *
decoded_Àn
 = 
	`BIO_ªad
(
b64
, *
decoded
, 
	`°æí
(
ö
));

808 
	`BIO_‰ì_Æl
(
b64
);

811 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/send_server.c

17 
	~<c⁄fig.h
>

19 
	~<mosquôto_brokî.h
>

20 
	~<mqâ3_¥Ÿocﬁ.h
>

21 
	~<mem‹y_mosq.h
>

22 
	~<utû_mosq.h
>

24 
	$_mosquôto_£nd_c⁄«ck
(
mosquôto
 *
c⁄ãxt
, 
ack
, 
ªsu…
)

26 
_mosquôto_∑ckë
 *
∑ckë
 = 
NULL
;

27 
rc
;

29 if(
c⁄ãxt
){

30 if(
c⁄ãxt
->
id
){

31 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög CONNACKÅÿ%†(%d, %d)", 
c⁄ãxt
->
id
, 
ack
, 
ªsu…
);

33 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög CONNACKÅÿ%†(%d, %d)", 
c⁄ãxt
->
addªss
, 
ack
, 
ªsu…
);

37 
∑ckë
 = 
	`_mosquôto_ˇŒoc
(1, (
_mosquôto_∑ckë
));

38 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

40 
∑ckë
->
comm™d
 = 
CONNACK
;

41 
∑ckë
->
ªmaöög_Àngth
 = 2;

42 
rc
 = 
	`_mosquôto_∑ckë_Æloc
(
∑ckë
);

43 if(
rc
){

44 
	`_mosquôto_‰ì
(
∑ckë
);

45  
rc
;

47 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
+0] = 
ack
;

48 
∑ckë
->
∑ylﬂd
[∑ckë->
pos
+1] = 
ªsu…
;

50  
	`_mosquôto_∑ckë_queue
(
c⁄ãxt
, 
∑ckë
);

51 
	}
}

53 
	$_mosquôto_£nd_suback
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
)

55 
_mosquôto_∑ckë
 *
∑ckë
 = 
NULL
;

56 
rc
;

58 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "Sídög SUBACKÅÿ%s", 
c⁄ãxt
->
id
);

60 
∑ckë
 = 
	`_mosquôto_ˇŒoc
(1, (
_mosquôto_∑ckë
));

61 if(!
∑ckë
Ë 
MOSQ_ERR_NOMEM
;

63 
∑ckë
->
comm™d
 = 
SUBACK
;

64 
∑ckë
->
ªmaöög_Àngth
 = 2+
∑ylﬂdÀn
;

65 
rc
 = 
	`_mosquôto_∑ckë_Æloc
(
∑ckë
);

66 if(
rc
){

67 
	`_mosquôto_‰ì
(
∑ckë
);

68  
rc
;

70 
	`_mosquôto_wrôe_uöt16
(
∑ckë
, 
mid
);

71 if(
∑ylﬂdÀn
){

72 
	`_mosquôto_wrôe_byãs
(
∑ckë
, 
∑ylﬂd
, 
∑ylﬂdÀn
);

75  
	`_mosquôto_∑ckë_queue
(
c⁄ãxt
, 
∑ckë
);

76 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/service.c

17 #i‡
deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

19 
	~<wödows.h
>

21 
	~<mem‹y_mosq.h
>

23 
run
;

24 
SERVICE_STATUS_HANDLE
 
	g£rvi˚_h™dÀ
 = 0;

25 
SERVICE_STATUS
 
	g£rvi˚_°©us
;

26 
maö
(
¨gc
, *
¨gv
[]);

29 
__°dˇŒ
 
	$£rvi˚_h™dÀr
(
DWORD
 
fdwC⁄åﬁ
)

31 
fdwC⁄åﬁ
){

32 
SERVICE_CONTROL_CONTINUE
:

35 
SERVICE_CONTROL_PAUSE
:

38 
SERVICE_CONTROL_SHUTDOWN
:

40 
SERVICE_CONTROL_STOP
:

42 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_STOP_PENDING
;

43 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

44 
run
 = 0;

47 
	}
}

50 
__°dˇŒ
 
	$£rvi˚_maö
(
DWORD
 
dwArgc
, 
LPTSTR
 *
ÕszArgv
)

52 **
¨gv
;

53 
¨gc
 = 1;

54 
c⁄f_∑th
[
MAX_PATH
 + 20];

55 
rc
;

57 
£rvi˚_h™dÀ
 = 
	`Regi°îSîvi˚CålH™dÀr
("mosquôto", 
£rvi˚_h™dÀr
);

58 if(
£rvi˚_h™dÀ
){

59 
rc
 = 
	`GëEnvú⁄mítV¨übÀ
("MOSQUITTO_DIR", 
c⁄f_∑th
, 
MAX_PATH
);

60 if(!
rc
 ||Ñ¯=
MAX_PATH
){

61 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_STOPPED
;

62 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

65 
	`°rˇt
(
c⁄f_∑th
, "/mosquitto.conf");

67 
¨gv
 = 
	`_mosquôto_mÆloc
((*)*3);

68 
¨gv
[0] = "mosquitto";

69 
¨gv
[1] = "-c";

70 
¨gv
[2] = 
c⁄f_∑th
;

71 
¨gc
 = 3;

73 
£rvi˚_°©us
.
dwSîvi˚Ty≥
 = 
SERVICE_WIN32_OWN_PROCESS
;

74 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_RUNNING
;

75 
£rvi˚_°©us
.
dwC⁄åﬁsAc˚±ed
 = 
SERVICE_ACCEPT_SHUTDOWN
 | 
SERVICE_ACCEPT_STOP
;

76 
£rvi˚_°©us
.
dwWö32ExôCode
 = 
NO_ERROR
;

77 
£rvi˚_°©us
.
dwCheckPoöt
 = 0;

78 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

80 
	`maö
(
¨gc
, 
¨gv
);

81 
	`_mosquôto_‰ì
(
¨gv
);

83 
£rvi˚_°©us
.
dwCuºítSèã
 = 
SERVICE_STOPPED
;

84 
	`SëSîvi˚Sètus
(
£rvi˚_h™dÀ
, &
£rvi˚_°©us
);

86 
	}
}

88 
	$£rvi˚_ö°Æl
()

90 
SC_HANDLE
 
sc_m™agî
, 
svc_h™dÀ
;

91 
exe_∑th
[
MAX_PATH
 + 5];

92 
SERVICE_DESCRIPTION
 
svc_desc
;

94 
	`GëModuÀFûeName
(
NULL
, 
exe_∑th
, 
MAX_PATH
);

95 
	`°rˇt
(
exe_∑th
, "Ñun");

97 
sc_m™agî
 = 
	`O≥nSCM™agî
(
NULL
, NULL, 
SC_MANAGER_CREATE_SERVICE
);

98 if(
sc_m™agî
){

99 
svc_h™dÀ
 = 
	`Cª©eSîvi˚
(
sc_m™agî
, "mosquitto", "Mosquitto Broker",

100 
SERVICE_START
 | 
SERVICE_STOP
 | 
SERVICE_CHANGE_CONFIG
,

101 
SERVICE_WIN32_OWN_PROCESS
, 
SERVICE_AUTO_START
, 
SERVICE_ERROR_NORMAL
,

102 
exe_∑th
, 
NULL
, NULL, NULL, NULL, NULL);

104 if(
svc_h™dÀ
){

105 
svc_desc
.
ÕDes¸ùti⁄
 = "MQTT v3.1 broker";

106 
	`Ch™geSîvi˚C⁄fig2
(
svc_h™dÀ
, 
SERVICE_CONFIG_DESCRIPTION
, &
svc_desc
);

107 
	`Clo£Sîvi˚H™dÀ
(
svc_h™dÀ
);

109 
	`Clo£Sîvi˚H™dÀ
(
sc_m™agî
);

111 
	}
}

113 
	$£rvi˚_unö°Æl
()

115 
SC_HANDLE
 
sc_m™agî
, 
svc_h™dÀ
;

116 
SERVICE_STATUS
 
°©us
;

118 
sc_m™agî
 = 
	`O≥nSCM™agî
(
NULL
, 
SERVICES_ACTIVE_DATABASE
, 
SC_MANAGER_CONNECT
);

119 if(
sc_m™agî
){

120 
svc_h™dÀ
 = 
	`O≥nSîvi˚
(
sc_m™agî
, "mosquôto", 
SERVICE_QUERY_STATUS
 | 
DELETE
);

121 if(
svc_h™dÀ
){

122 if(
	`QuîySîvi˚Sètus
(
svc_h™dÀ
, &
°©us
)){

123 if(
°©us
.
dwCuºítSèã
 =
SERVICE_STOPPED
){

124 
	`DñëeSîvi˚
(
svc_h™dÀ
);

127 
	`Clo£Sîvi˚H™dÀ
(
svc_h™dÀ
);

129 
	`Clo£Sîvi˚H™dÀ
(
sc_m™agî
);

131 
	}
}

133 
	$£rvi˚_run
()

135 
SERVICE_TABLE_ENTRY
 
°e
[] = {

136 { "mosquôto", 
£rvi˚_maö
 },

137 { 
NULL
, NULL }

140 
	`SèπSîvi˚CålDi•©chî
(
°e
);

141 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/subs.c

48 
	~<c⁄fig.h
>

50 
	~<as£π.h
>

51 
	~<°dio.h
>

52 
	~<°rög.h
>

54 
	~<mosquôto_brokî.h
>

55 
	~<mem‹y_mosq.h
>

56 
	~<utû_mosq.h
>

58 
	s_sub_tokí
 {

59 
_sub_tokí
 *
	m√xt
;

60 *
	mt›ic
;

63 
	$_subs_¥o˚ss
(
mosquôto_db
 *
db
, 
_mosquôto_subhõr
 *
hõr
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
, 
boﬁ
 
£t_ªèö
)

65 
rc
 = 0;

66 
rc2
;

67 
˛õ¡_qos
, 
msg_qos
;

68 
uöt16_t
 
mid
;

69 
_mosquôto_subÀaf
 *
Àaf
;

70 
boﬁ
 
˛õ¡_ªèö
;

72 
Àaf
 = 
hõr
->
subs
;

74 if(
ªèö
 && 
£t_ªèö
){

75 #ifde‡
WITH_PERSISTENCE


76 if(
	`°∫cmp
(
t›ic
, "$SYS", 4)){

79 
db
->
≥rsi°í˚_ch™ges
++;

82 if(
hõr
->
ªèöed
){

83 
	`mosquôto__db_msg_°‹e_dîef
(
db
, &
hõr
->
ªèöed
);

84 #ifde‡
WITH_SYS_TREE


85 
db
->
ªèöed_cou¡
--;

88 if(
°‹ed
->
∑ylﬂdÀn
){

89 
hõr
->
ªèöed
 = 
°‹ed
;

90 
hõr
->
ªèöed
->
ªf_cou¡
++;

91 #ifde‡
WITH_SYS_TREE


92 
db
->
ªèöed_cou¡
++;

95 
hõr
->
ªèöed
 = 
NULL
;

98 
sour˚_id
 && 
Àaf
){

99 if(!
Àaf
->
c⁄ãxt
->
id
 || (Àaf->c⁄ãxt->
is_bridge
 && !
	`°rcmp
÷óf->c⁄ãxt->id, 
sour˚_id
))){

100 
Àaf
 =Üóf->
√xt
;

104 
rc2
 = 
	`mosquôto_a˛_check
(
db
, 
Àaf
->
c⁄ãxt
, 
t›ic
, 
MOSQ_ACL_READ
);

105 if(
rc2
 =
MOSQ_ERR_ACL_DENIED
){

106 
Àaf
 =Üóf->
√xt
;

108 }if(
rc2
 =
MOSQ_ERR_SUCCESS
){

109 
˛õ¡_qos
 = 
Àaf
->
qos
;

111 if(
db
->
c⁄fig
->
upgøde_outgoög_qos
){

112 
msg_qos
 = 
˛õ¡_qos
;

114 if(
qos
 > 
˛õ¡_qos
){

115 
msg_qos
 = 
˛õ¡_qos
;

117 
msg_qos
 = 
qos
;

120 if(
msg_qos
){

121 
mid
 = 
	`_mosquôto_mid_gíî©e
(
Àaf
->
c⁄ãxt
);

123 
mid
 = 0;

125 if(
Àaf
->
c⁄ãxt
->
is_bridge
){

129 
˛õ¡_ªèö
 = 
ªèö
;

133 
˛õ¡_ªèö
 = 
Ál£
;

135 if(
	`mqâ3_db_mesßge_ö£π
(
db
, 
Àaf
->
c⁄ãxt
, 
mid
, 
mosq_md_out
, 
msg_qos
, 
˛õ¡_ªèö
, 
°‹ed
Ë=1Ë
rc
 = 1;

139 
Àaf
 =Üóf->
√xt
;

141  
rc
;

142 
	}
}

144 
_sub_tokí
 *
	$_sub_t›ic_≠≥nd
(
_sub_tokí
 **
èû
, _sub_tokí **
t›ics
, *
t›ic
)

146 
_sub_tokí
 *
√w_t›ic
;

148 if(!
t›ic
){

149  
NULL
;

151 
√w_t›ic
 = 
	`_mosquôto_mÆloc
((
_sub_tokí
));

152 if(!
√w_t›ic
){

153 
	`_mosquôto_‰ì
(
t›ic
);

154  
NULL
;

156 
√w_t›ic
->
√xt
 = 
NULL
;

157 
√w_t›ic
->
t›ic
 =Åopic;

159 if(*
èû
){

160 (*
èû
)->
√xt
 = 
√w_t›ic
;

161 *
èû
 = (*èû)->
√xt
;

163 *
t›ics
 = 
√w_t›ic
;

164 *
èû
 = 
√w_t›ic
;

166  
√w_t›ic
;

167 
	}
}

169 
	$_sub_t›ic_tokíi£
(c⁄° *
subt›ic
, 
_sub_tokí
 **
t›ics
)

171 
_sub_tokí
 *
√w_t›ic
, *
èû
 = 
NULL
;

172 
Àn
;

173 
°¨t
, 
°›
, 
éí
;

174 
i
;

175 *
t›ic
;

177 
	`as£π
(
subt›ic
);

178 
	`as£π
(
t›ics
);

180 if(
subt›ic
[0] != '$'){

181 
√w_t›ic
 = 
	`_sub_t›ic_≠≥nd
(&
èû
, 
t›ics
, 
	`_mosquôto_°rdup
(""));

182 if(!
√w_t›ic
Ë
˛ónup
;

185 
Àn
 = 
	`°æí
(
subt›ic
);

187 if(
subt›ic
[0] == '/'){

188 
√w_t›ic
 = 
	`_sub_t›ic_≠≥nd
(&
èû
, 
t›ics
, 
	`_mosquôto_°rdup
(""));

189 if(!
√w_t›ic
Ë
˛ónup
;

191 
°¨t
 = 1;

193 
°¨t
 = 0;

196 
°›
 = 0;

197 
i
=
°¨t
; i<
Àn
+1; i++){

198 if(
subt›ic
[
i
] == '/' || subtopic[i] == '\0'){

199 
°›
 = 
i
;

201 if(
°¨t
 !
°›
){

202 
éí
 = 
°›
-
°¨t
;

204 
t›ic
 = 
	`_mosquôto_mÆloc
(
éí
+1);

205 if(!
t›ic
Ë
˛ónup
;

206 
	`mem˝y
(
t›ic
, &
subt›ic
[
°¨t
], 
éí
);

207 
t›ic
[
éí
] = '\0';

209 
t›ic
 = 
	`_mosquôto_°rdup
("");

210 if(!
t›ic
Ë
˛ónup
;

212 
√w_t›ic
 = 
	`_sub_t›ic_≠≥nd
(&
èû
, 
t›ics
, 
t›ic
);

213 if(!
√w_t›ic
Ë
˛ónup
;

214 
°¨t
 = 
i
+1;

218  
MOSQ_ERR_SUCCESS
;

220 
˛ónup
:

221 
èû
 = *
t›ics
;

222 *
t›ics
 = 
NULL
;

223 
èû
){

224 if(
èû
->
t›ic
Ë
	`_mosquôto_‰ì
(tail->topic);

225 
√w_t›ic
 = 
èû
->
√xt
;

226 
	`_mosquôto_‰ì
(
èû
);

227 
èû
 = 
√w_t›ic
;

230 
	}
}

232 
	$_sub_t›ic_tokís_‰ì
(
_sub_tokí
 *
tokís
)

234 
_sub_tokí
 *
èû
;

236 
tokís
){

237 
èû
 = 
tokís
->
√xt
;

238 if(
tokís
->
t›ic
){

239 
	`_mosquôto_‰ì
(
tokís
->
t›ic
);

241 
	`_mosquôto_‰ì
(
tokís
);

242 
tokís
 = 
èû
;

244 
	}
}

246 
	$_sub_add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
qos
, 
_mosquôto_subhõr
 *
subhõr
, 
_sub_tokí
 *
tokís
)

249 
_mosquôto_subhõr
 *
bønch
, *
œ°
 = 
NULL
;

250 
_mosquôto_subÀaf
 *
Àaf
, *
œ°_Àaf
;

251 
_mosquôto_subhõr
 **
subs
;

252 
i
;

254 if(!
tokís
){

255 if(
c⁄ãxt
 && c⁄ãxt->
id
){

256 
Àaf
 = 
subhõr
->
subs
;

257 
œ°_Àaf
 = 
NULL
;

258 
Àaf
){

259 if(
Àaf
->
c⁄ãxt
 &&Üóf->c⁄ãxt->
id
 && !
	`°rcmp
(leaf->context->id, context->id)){

263 
Àaf
->
qos
 = qos;

264 if(
c⁄ãxt
->
¥Ÿocﬁ
 =
mosq_p_mqâ31
){

272 
œ°_Àaf
 = 
Àaf
;

273 
Àaf
 =Üóf->
√xt
;

275 
Àaf
 = 
	`_mosquôto_mÆloc
((
_mosquôto_subÀaf
));

276 if(!
Àaf
Ë 
MOSQ_ERR_NOMEM
;

277 
Àaf
->
√xt
 = 
NULL
;

278 
Àaf
->
c⁄ãxt
 = context;

279 
Àaf
->
qos
 = qos;

280 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

281 if(!
c⁄ãxt
->
subs
[
i
]){

282 
c⁄ãxt
->
subs
[
i
] = 
subhõr
;

286 if(
i
 =
c⁄ãxt
->
sub_cou¡
){

287 
subs
 = 
	`_mosquôto_ªÆloc
(
c⁄ãxt
->subs, (
_mosquôto_subhõr
 *)*(c⁄ãxt->
sub_cou¡
 + 1));

288 if(!
subs
){

289 
	`_mosquôto_‰ì
(
Àaf
);

290  
MOSQ_ERR_NOMEM
;

292 
c⁄ãxt
->
subs
 = subs;

293 
c⁄ãxt
->
sub_cou¡
++;

294 
c⁄ãxt
->
subs
[c⁄ãxt->
sub_cou¡
-1] = 
subhõr
;

296 if(
œ°_Àaf
){

297 
œ°_Àaf
->
√xt
 = 
Àaf
;

298 
Àaf
->
¥ev
 = 
œ°_Àaf
;

300 
subhõr
->
subs
 = 
Àaf
;

301 
Àaf
->
¥ev
 = 
NULL
;

303 #ifde‡
WITH_SYS_TREE


304 
db
->
subs¸ùti⁄_cou¡
++;

307  
MOSQ_ERR_SUCCESS
;

310 
bønch
 = 
subhõr
->
chûdªn
;

311 
bønch
){

312 if(!
	`°rcmp
(
bønch
->
t›ic
, 
tokís
->topic)){

313  
	`_sub_add
(
db
, 
c⁄ãxt
, 
qos
, 
bønch
, 
tokís
->
√xt
);

315 
œ°
 = 
bønch
;

316 
bønch
 = bønch->
√xt
;

319 
bønch
 = 
	`_mosquôto_ˇŒoc
(1, (
_mosquôto_subhõr
));

320 if(!
bønch
Ë 
MOSQ_ERR_NOMEM
;

321 
bønch
->
∑ª¡
 = 
subhõr
;

322 
bønch
->
t›ic
 = 
	`_mosquôto_°rdup
(
tokís
->topic);

323 if(!
bønch
->
t›ic
){

324 
	`_mosquôto_‰ì
(
bønch
);

325  
MOSQ_ERR_NOMEM
;

327 if(!
œ°
){

328 
subhõr
->
chûdªn
 = 
bønch
;

330 
œ°
->
√xt
 = 
bønch
;

332  
	`_sub_add
(
db
, 
c⁄ãxt
, 
qos
, 
bønch
, 
tokís
->
√xt
);

333 
	}
}

335 
	$_sub_ªmove
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
_mosquôto_subhõr
 *
subhõr
, 
_sub_tokí
 *
tokís
)

337 
_mosquôto_subhõr
 *
bønch
, *
œ°
 = 
NULL
;

338 
_mosquôto_subÀaf
 *
Àaf
;

339 
i
;

341 if(!
tokís
){

342 
Àaf
 = 
subhõr
->
subs
;

343 
Àaf
){

344 if(
Àaf
->
c⁄ãxt
==context){

345 #ifde‡
WITH_SYS_TREE


346 
db
->
subs¸ùti⁄_cou¡
--;

348 if(
Àaf
->
¥ev
){

349 
Àaf
->
¥ev
->
√xt
 =Üeaf->next;

351 
subhõr
->
subs
 = 
Àaf
->
√xt
;

353 if(
Àaf
->
√xt
){

354 
Àaf
->
√xt
->
¥ev
 =Üeaf->prev;

356 
	`_mosquôto_‰ì
(
Àaf
);

362 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

363 if(
c⁄ãxt
->
subs
[
i
] =
subhõr
){

364 
c⁄ãxt
->
subs
[
i
] = 
NULL
;

368  
MOSQ_ERR_SUCCESS
;

370 
Àaf
 =Üóf->
√xt
;

372  
MOSQ_ERR_SUCCESS
;

375 
bønch
 = 
subhõr
->
chûdªn
;

376 
bønch
){

377 if(!
	`°rcmp
(
bønch
->
t›ic
, 
tokís
->topic)){

378 
	`_sub_ªmove
(
db
, 
c⁄ãxt
, 
bønch
, 
tokís
->
√xt
);

379 if(!
bønch
->
chûdªn
 && !bønch->
subs
 && !bønch->
ªèöed
){

380 if(
œ°
){

381 
œ°
->
√xt
 = 
bønch
->next;

383 
subhõr
->
chûdªn
 = 
bønch
->
√xt
;

385 
	`_mosquôto_‰ì
(
bønch
->
t›ic
);

386 
	`_mosquôto_‰ì
(
bønch
);

388  
MOSQ_ERR_SUCCESS
;

390 
œ°
 = 
bønch
;

391 
bønch
 = bønch->
√xt
;

393  
MOSQ_ERR_SUCCESS
;

394 
	}
}

396 
	$_sub_£¨ch
(
mosquôto_db
 *
db
, 
_mosquôto_subhõr
 *
subhõr
, 
_sub_tokí
 *
tokís
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
, 
boﬁ
 
£t_ªèö
)

399 
_mosquôto_subhõr
 *
bønch
;

400 
boﬁ
 
§
;

402 
bønch
 = 
subhõr
->
chûdªn
;

403 
bønch
){

404 
§
 = 
£t_ªèö
;

406 if(
tokís
 &&Åokís->
t›ic
 && (!
	`°rcmp
(
bønch
->topic,Åokens->topic) || !strcmp(branch->topic, "+"))){

409 if(!
	`°rcmp
(
bønch
->
t›ic
, "+")){

411 
§
 = 
Ál£
;

413 
	`_sub_£¨ch
(
db
, 
bønch
, 
tokís
->
√xt
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
§
);

414 if(!
tokís
->
√xt
){

415 
	`_subs_¥o˚ss
(
db
, 
bønch
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
§
);

417 }if(!
	`°rcmp
(
bønch
->
t›ic
, "#"Ë&& !bønch->
chûdªn
){

422 
	`_subs_¥o˚ss
(
db
, 
bønch
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, 
°‹ed
, 
Ál£
);

424 
bønch
 = bønch->
√xt
;

426 
	}
}

428 
	$mqâ3_sub_add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
qos
, 
_mosquôto_subhõr
 *
roŸ
)

430 
rc
 = 0;

431 
_mosquôto_subhõr
 *
subhõr
, *
chûd
;

432 
_sub_tokí
 *
tokís
 = 
NULL
;

434 
	`as£π
(
roŸ
);

435 
	`as£π
(
sub
);

437 if(
	`_sub_t›ic_tokíi£
(
sub
, &
tokís
))  1;

439 
subhõr
 = 
roŸ
->
chûdªn
;

440 
subhõr
){

441 if(!
	`°rcmp
(
subhõr
->
t›ic
, 
tokís
->topic)){

442 
rc
 = 
	`_sub_add
(
db
, 
c⁄ãxt
, 
qos
, 
subhõr
, 
tokís
);

445 
subhõr
 = subhõr->
√xt
;

447 if(!
subhõr
){

448 
chûd
 = 
	`_mosquôto_mÆloc
((
_mosquôto_subhõr
));

449 if(!
chûd
){

450 
	`_sub_t›ic_tokís_‰ì
(
tokís
);

451 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

452  
MOSQ_ERR_NOMEM
;

454 
chûd
->
∑ª¡
 = 
roŸ
;

455 
chûd
->
t›ic
 = 
	`_mosquôto_°rdup
(
tokís
->topic);

456 if(!
chûd
->
t›ic
){

457 
	`_sub_t›ic_tokís_‰ì
(
tokís
);

458 
	`_mosquôto_‰ì
(
chûd
);

459 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Error: Out of memory.");

460  
MOSQ_ERR_NOMEM
;

462 
chûd
->
subs
 = 
NULL
;

463 
chûd
->
chûdªn
 = 
NULL
;

464 
chûd
->
ªèöed
 = 
NULL
;

465 if(
db
->
subs
.
chûdªn
){

466 
chûd
->
√xt
 = 
db
->
subs
.
chûdªn
;

468 
chûd
->
√xt
 = 
NULL
;

470 
db
->
subs
.
chûdªn
 = 
chûd
;

472 
rc
 = 
	`_sub_add
(
db
, 
c⁄ãxt
, 
qos
, 
chûd
, 
tokís
);

475 
	`_sub_t›ic_tokís_‰ì
(
tokís
);

478 if(
rc
 =-1Ër¯
MOSQ_ERR_SUCCESS
;

479  
rc
;

480 
	}
}

482 
	$mqâ3_sub_ªmove
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
_mosquôto_subhõr
 *
roŸ
)

484 
rc
 = 0;

485 
_mosquôto_subhõr
 *
subhõr
;

486 
_sub_tokí
 *
tokís
 = 
NULL
;

488 
	`as£π
(
roŸ
);

489 
	`as£π
(
sub
);

491 if(
	`_sub_t›ic_tokíi£
(
sub
, &
tokís
))  1;

493 
subhõr
 = 
roŸ
->
chûdªn
;

494 
subhõr
){

495 if(!
	`°rcmp
(
subhõr
->
t›ic
, 
tokís
->topic)){

496 
rc
 = 
	`_sub_ªmove
(
db
, 
c⁄ãxt
, 
subhõr
, 
tokís
);

499 
subhõr
 = subhõr->
√xt
;

502 
	`_sub_t›ic_tokís_‰ì
(
tokís
);

504  
rc
;

505 
	}
}

507 
	$mqâ3_db_mesßges_queue
(
mosquôto_db
 *
db
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
)

509 
rc
 = 0;

510 
_mosquôto_subhõr
 *
subhõr
;

511 
_sub_tokí
 *
tokís
 = 
NULL
;

513 
	`as£π
(
db
);

514 
	`as£π
(
t›ic
);

516 if(
	`_sub_t›ic_tokíi£
(
t›ic
, &
tokís
))  1;

522 (*
°‹ed
)->
ªf_cou¡
++;

524 
subhõr
 = 
db
->
subs
.
chûdªn
;

525 
subhõr
){

526 if(!
	`°rcmp
(
subhõr
->
t›ic
, 
tokís
->topic)){

527 if(
ªèö
){

531 
	`_sub_add
(
db
, 
NULL
, 0, 
subhõr
, 
tokís
);

533 
	`_sub_£¨ch
(
db
, 
subhõr
, 
tokís
, 
sour˚_id
, 
t›ic
, 
qos
, 
ªèö
, *
°‹ed
, 
åue
);

535 
subhõr
 = subhõr->
√xt
;

537 
	`_sub_t›ic_tokís_‰ì
(
tokís
);

540 
	`mosquôto__db_msg_°‹e_dîef
(
db
, 
°‹ed
);

542  
rc
;

543 
	}
}

547 
_mosquôto_subhõr
 *
	$tmp_ªmove_subs
(
_mosquôto_subhõr
 *
sub
)

549 
_mosquôto_subhõr
 *
∑ª¡
;

550 
_mosquôto_subhõr
 *
hõr
;

551 
_mosquôto_subhõr
 *
œ°
 = 
NULL
;

553 if(!
sub
 || !sub->
∑ª¡
){

554  
NULL
;

556 if(
sub
->
chûdªn
 || sub->
subs
 || sub->
√xt
){

557  
NULL
;

560 
∑ª¡
 = 
sub
->parent;

561 
hõr
 = 
sub
->
∑ª¡
->
chûdªn
;

562 
hõr
){

563 if(
hõr
 =
sub
){

564 if(
œ°
){

565 
œ°
->
√xt
 = 
sub
->next;

567 
∑ª¡
->
chûdªn
 = 
NULL
;

569 if(
sub
->
t›ic
Ë
	`_mosquôto_‰ì
(sub->topic);

570 
	`_mosquôto_‰ì
(
sub
);

573 
œ°
 = 
hõr
;

574 
hõr
 = hõr->
√xt
;

576 if(
∑ª¡
->
subs
 =
NULL


577 && 
∑ª¡
->
chûdªn
 =
NULL


578 && 
∑ª¡
->
ªèöed
 =
NULL


579 && 
∑ª¡
->parent){

581  
∑ª¡
;

583  
NULL
;

585 
	}
}

590 
	$mqâ3_subs_˛ón_£ssi⁄
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
)

592 
i
;

593 
_mosquôto_subÀaf
 *
Àaf
;

594 
_mosquôto_subhõr
 *
hõr
;

596 
i
=0; i<
c⁄ãxt
->
sub_cou¡
; i++){

597 if(
c⁄ãxt
->
subs
[
i
] =
NULL
){

600 
Àaf
 = 
c⁄ãxt
->
subs
[
i
]->subs;

601 
Àaf
){

602 if(
Àaf
->
c⁄ãxt
==context){

603 #ifde‡
WITH_SYS_TREE


604 
db
->
subs¸ùti⁄_cou¡
--;

606 if(
Àaf
->
¥ev
){

607 
Àaf
->
¥ev
->
√xt
 =Üeaf->next;

609 
c⁄ãxt
->
subs
[
i
]->sub†
Àaf
->
√xt
;

611 if(
Àaf
->
√xt
){

612 
Àaf
->
√xt
->
¥ev
 =Üeaf->prev;

614 
	`_mosquôto_‰ì
(
Àaf
);

617 
Àaf
 =Üóf->
√xt
;

619 if(
c⁄ãxt
->
subs
[
i
]->sub†=
NULL


620 && 
c⁄ãxt
->
subs
[
i
]->
chûdªn
 =
NULL


621 && 
c⁄ãxt
->
subs
[
i
]->
ªèöed
 =
NULL


622 && 
c⁄ãxt
->
subs
[
i
]->
∑ª¡
){

624 
hõr
 = 
c⁄ãxt
->
subs
[
i
];

625 
c⁄ãxt
->
subs
[
i
] = 
NULL
;

627 
hõr
 = 
	`tmp_ªmove_subs
(hier);

628 }
hõr
);

631 
	`_mosquôto_‰ì
(
c⁄ãxt
->
subs
);

632 
c⁄ãxt
->
subs
 = 
NULL
;

633 
c⁄ãxt
->
sub_cou¡
 = 0;

635  
MOSQ_ERR_SUCCESS
;

636 
	}
}

638 
	$mqâ3_sub_åì_¥öt
(
_mosquôto_subhõr
 *
roŸ
, 
Àvñ
)

640 
i
;

641 
_mosquôto_subhõr
 *
bønch
;

642 
_mosquôto_subÀaf
 *
Àaf
;

644 
i
=0; i<
Àvñ
*2; i++){

645 
	`¥ötf
(" ");

647 
	`¥ötf
("%s", 
roŸ
->
t›ic
);

648 
Àaf
 = 
roŸ
->
subs
;

649 
Àaf
){

650 if(
Àaf
->
c⁄ãxt
){

651 
	`¥ötf
(" (%s, %d)", 
Àaf
->
c⁄ãxt
->
id
,Üóf->
qos
);

653 
	`¥ötf
(" (%s, %d)", "", 
Àaf
->
qos
);

655 
Àaf
 =Üóf->
√xt
;

657 if(
roŸ
->
ªèöed
){

658 
	`¥ötf
(" (r)");

660 
	`¥ötf
("\n");

662 
bønch
 = 
roŸ
->
chûdªn
;

663 
bønch
){

664 
	`mqâ3_sub_åì_¥öt
(
bønch
, 
Àvñ
+1);

665 
bønch
 = bønch->
√xt
;

667 
	}
}

669 
	$_ªèö_¥o˚ss
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
ªèöed
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
sub_qos
)

671 
rc
 = 0;

672 
qos
;

673 
uöt16_t
 
mid
;

675 
rc
 = 
	`mosquôto_a˛_check
(
db
, 
c⁄ãxt
, 
ªèöed
->
t›ic
, 
MOSQ_ACL_READ
);

676 if(
rc
 =
MOSQ_ERR_ACL_DENIED
){

677  
MOSQ_ERR_SUCCESS
;

678 }if(
rc
 !
MOSQ_ERR_SUCCESS
){

679  
rc
;

682 
qos
 = 
ªèöed
->qos;

684 if(
qos
 > 
sub_qos
) qos = sub_qos;

685 if(
qos
 > 0){

686 
mid
 = 
	`_mosquôto_mid_gíî©e
(
c⁄ãxt
);

688 
mid
 = 0;

690  
	`mqâ3_db_mesßge_ö£π
(
db
, 
c⁄ãxt
, 
mid
, 
mosq_md_out
, 
qos
, 
åue
, 
ªèöed
);

691 
	}
}

693 
	$_ªèö_£¨ch
(
mosquôto_db
 *
db
, 
_mosquôto_subhõr
 *
subhõr
, 
_sub_tokí
 *
tokís
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
sub_qos
, 
Àvñ
)

695 
_mosquôto_subhõr
 *
bønch
;

696 
Êag
 = 0;

698 
bønch
 = 
subhõr
->
chûdªn
;

699 
bønch
){

703 if(!
	`°rcmp
(
tokís
->
t›ic
, "#"Ë&& !tokís->
√xt
){

708 
Êag
 = -1;

709 if(
bønch
->
ªèöed
){

710 
	`_ªèö_¥o˚ss
(
db
, 
bønch
->
ªèöed
, 
c⁄ãxt
, 
sub
, 
sub_qos
);

712 if(
bønch
->
chûdªn
){

713 
	`_ªèö_£¨ch
(
db
, 
bønch
, 
tokís
, 
c⁄ãxt
, 
sub
, 
sub_qos
, 
Àvñ
+1);

715 }if(
	`°rcmp
(
bønch
->
t›ic
, "+"Ë&& (!°rcmp(bønch->t›ic, 
tokís
->topic) || !strcmp(tokens->topic, "+"))){

716 if(
tokís
->
√xt
){

717 if(
	`_ªèö_£¨ch
(
db
, 
bønch
, 
tokís
->
√xt
, 
c⁄ãxt
, 
sub
, 
sub_qos
, 
Àvñ
+1) == -1

718 || (!
bønch
->
√xt
 && 
tokís
->√xà&& !
	`°rcmp
—okís->√xt->
t›ic
, "#"Ë&& 
Àvñ
>0)){

720 if(
bønch
->
ªèöed
){

721 
	`_ªèö_¥o˚ss
(
db
, 
bønch
->
ªèöed
, 
c⁄ãxt
, 
sub
, 
sub_qos
);

725 if(
bønch
->
ªèöed
){

726 
	`_ªèö_¥o˚ss
(
db
, 
bønch
->
ªèöed
, 
c⁄ãxt
, 
sub
, 
sub_qos
);

731 
bønch
 = bønch->
√xt
;

733  
Êag
;

734 
	}
}

736 
	$mqâ3_ªèö_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
sub_qos
)

738 
_mosquôto_subhõr
 *
subhõr
;

739 
_sub_tokí
 *
tokís
 = 
NULL
, *
èû
;

741 
	`as£π
(
db
);

742 
	`as£π
(
c⁄ãxt
);

743 
	`as£π
(
sub
);

745 if(
	`_sub_t›ic_tokíi£
(
sub
, &
tokís
))  1;

747 
subhõr
 = 
db
->
subs
.
chûdªn
;

748 
subhõr
){

749 if(!
	`°rcmp
(
subhõr
->
t›ic
, 
tokís
->topic)){

750 
	`_ªèö_£¨ch
(
db
, 
subhõr
, 
tokís
, 
c⁄ãxt
, 
sub
, 
sub_qos
, 0);

753 
subhõr
 = subhõr->
√xt
;

755 
tokís
){

756 
èû
 = 
tokís
->
√xt
;

757 
	`_mosquôto_‰ì
(
tokís
->
t›ic
);

758 
	`_mosquôto_‰ì
(
tokís
);

759 
tokís
 = 
èû
;

762  
MOSQ_ERR_SUCCESS
;

763 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/sys_tree.c

17 #ifde‡
WITH_SYS_TREE


19 
	~<m©h.h
>

20 
	~<°dio.h
>

22 
	~<c⁄fig.h
>

24 
	~<mosquôto_brokî.h
>

25 
	~<mem‹y_mosq.h
>

26 
	~<time_mosq.h
>

28 
	#BUFLEN
 100

	)

30 
uöt64_t
 
	gg_byãs_ª˚ived
 = 0;

31 
uöt64_t
 
	gg_byãs_£¡
 = 0;

32 
uöt64_t
 
	gg_pub_byãs_ª˚ived
 = 0;

33 
uöt64_t
 
	gg_pub_byãs_£¡
 = 0;

34 
	gg_msgs_ª˚ived
 = 0;

35 
	gg_msgs_£¡
 = 0;

36 
	gg_pub_msgs_ª˚ived
 = 0;

37 
	gg_pub_msgs_£¡
 = 0;

38 
	gg_msgs_dr›≥d
 = 0;

39 
	gg_˛õ¡s_expúed
 = 0;

40 
	gg_sockë_c⁄√˘i⁄s
 = 0;

41 
	gg_c⁄√˘i⁄_cou¡
 = 0;

43 
	$_sys_upd©e_˛õ¡s
(
mosquôto_db
 *
db
, *
buf
)

45 
˛õ¡_cou¡
 = -1;

46 
˛õ¡s_expúed
 = -1;

47 
˛õ¡_max
 = -1;

48 
disc⁄√˘ed_cou¡
 = -1;

49 
c⁄√˘ed_cou¡
 = -1;

51 
cou¡_tŸÆ
, 
cou¡_by_sock
;

53 
cou¡_tŸÆ
 = 
	`HASH_CNT
(
hh_id
, 
db
->
c⁄ãxts_by_id
);

54 
cou¡_by_sock
 = 
	`HASH_CNT
(
hh_sock
, 
db
->
c⁄ãxts_by_sock
);

56 if(
˛õ¡_cou¡
 !
cou¡_tŸÆ
){

57 
˛õ¡_cou¡
 = 
cou¡_tŸÆ
;

58 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
˛õ¡_cou¡
);

59 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/tŸÆ", 2, 
	`°æí
(
buf
), buf, 1);

61 if(
˛õ¡_cou¡
 > 
˛õ¡_max
){

62 
˛õ¡_max
 = 
˛õ¡_cou¡
;

63 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
˛õ¡_max
);

64 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/maximum", 2, 
	`°æí
(
buf
), buf, 1);

68 if(
disc⁄√˘ed_cou¡
 !
cou¡_tŸÆ
-
cou¡_by_sock
){

69 
disc⁄√˘ed_cou¡
 = 
cou¡_tŸÆ
-
cou¡_by_sock
;

70 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
disc⁄√˘ed_cou¡
);

71 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/öa˘ive", 2, 
	`°æí
(
buf
), buf, 1);

72 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/disc⁄√˘ed", 2, 
	`°æí
(
buf
), buf, 1);

74 if(
c⁄√˘ed_cou¡
 !
cou¡_by_sock
){

75 
c⁄√˘ed_cou¡
 = 
cou¡_by_sock
;

76 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
c⁄√˘ed_cou¡
);

77 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/a˘ive", 2, 
	`°æí
(
buf
), buf, 1);

78 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/c⁄√˘ed", 2, 
	`°æí
(
buf
), buf, 1);

80 if(
g_˛õ¡s_expúed
 !
˛õ¡s_expúed
){

81 
˛õ¡s_expúed
 = 
g_˛õ¡s_expúed
;

82 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
˛õ¡s_expúed
);

83 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/˛õ¡s/expúed", 2, 
	`°æí
(
buf
), buf, 1);

85 
	}
}

87 #ifde‡
REAL_WITH_MEMORY_TRACKING


88 
	$_sys_upd©e_mem‹y
(
mosquôto_db
 *
db
, *
buf
)

90 
cuºít_hóp
 = -1;

91 
max_hóp
 = -1;

92 
vÆue_ul
;

94 
vÆue_ul
 = 
	`_mosquôto_mem‹y_u£d
();

95 if(
cuºít_hóp
 !
vÆue_ul
){

96 
cuºít_hóp
 = 
vÆue_ul
;

97 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
cuºít_hóp
);

98 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/hóp/cuºít", 2, 
	`°æí
(
buf
), buf, 1);

100 
vÆue_ul
 =
	`_mosquôto_max_mem‹y_u£d
();

101 if(
max_hóp
 !
vÆue_ul
){

102 
max_hóp
 = 
vÆue_ul
;

103 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
max_hóp
);

104 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/hóp/maximum", 2, 
	`°æí
(
buf
), buf, 1);

106 
	}
}

109 
	$ˇlc_lﬂd
(
mosquôto_db
 *
db
, *
buf
, c⁄° *
t›ic
, 
exp⁄ít
, 
öãrvÆ
, *
cuºít
)

111 
√w_vÆue
;

113 
√w_vÆue
 = 
öãrvÆ
 + 
exp⁄ít
*((*
cuºít
) - interval);

114 if(
	`Ábs
(
√w_vÆue
 - (*
cuºít
)) >= 0.01){

115 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%.2f", 
√w_vÆue
);

116 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, 
t›ic
, 2, 
	`°æí
(
buf
), buf, 1);

118 (*
cuºít
Ë
√w_vÆue
;

119 
	}
}

127 
	$mqâ3_db_sys_upd©e
(
mosquôto_db
 *
db
, 
öãrvÆ
, 
time_t
 
°¨t_time
)

129 
time_t
 
œ°_upd©e
 = 0;

130 
time_t
 
now
;

131 
time_t
 
u±ime
;

132 
buf
[
BUFLEN
];

134 
msg_°‹e_cou¡
 = -1;

135 
msgs_ª˚ived
 = -1;

136 
msgs_£¡
 = -1;

137 
publish_dr›≥d
 = -1;

138 
pub_msgs_ª˚ived
 = -1;

139 
pub_msgs_£¡
 = -1;

140 
byãs_ª˚ived
 = -1;

141 
byãs_£¡
 = -1;

142 
pub_byãs_ª˚ived
 = -1;

143 
pub_byãs_£¡
 = -1;

144 
subs¸ùti⁄_cou¡
 = -1;

145 
ªèöed_cou¡
 = -1;

147 
msgs_ª˚ived_lﬂd1
 = 0;

148 
msgs_ª˚ived_lﬂd5
 = 0;

149 
msgs_ª˚ived_lﬂd15
 = 0;

150 
msgs_£¡_lﬂd1
 = 0;

151 
msgs_£¡_lﬂd5
 = 0;

152 
msgs_£¡_lﬂd15
 = 0;

153 
publish_dr›≥d_lﬂd1
 = 0;

154 
publish_dr›≥d_lﬂd5
 = 0;

155 
publish_dr›≥d_lﬂd15
 = 0;

156 
msgs_ª˚ived_öãrvÆ
, 
msgs_£¡_öãrvÆ
, 
publish_dr›≥d_öãrvÆ
;

158 
publish_ª˚ived_lﬂd1
 = 0;

159 
publish_ª˚ived_lﬂd5
 = 0;

160 
publish_ª˚ived_lﬂd15
 = 0;

161 
publish_£¡_lﬂd1
 = 0;

162 
publish_£¡_lﬂd5
 = 0;

163 
publish_£¡_lﬂd15
 = 0;

164 
publish_ª˚ived_öãrvÆ
, 
publish_£¡_öãrvÆ
;

166 
byãs_ª˚ived_lﬂd1
 = 0;

167 
byãs_ª˚ived_lﬂd5
 = 0;

168 
byãs_ª˚ived_lﬂd15
 = 0;

169 
byãs_£¡_lﬂd1
 = 0;

170 
byãs_£¡_lﬂd5
 = 0;

171 
byãs_£¡_lﬂd15
 = 0;

172 
byãs_ª˚ived_öãrvÆ
, 
byãs_£¡_öãrvÆ
;

174 
sockë_lﬂd1
 = 0;

175 
sockë_lﬂd5
 = 0;

176 
sockë_lﬂd15
 = 0;

177 
sockë_öãrvÆ
;

179 
c⁄√˘i⁄_lﬂd1
 = 0;

180 
c⁄√˘i⁄_lﬂd5
 = 0;

181 
c⁄√˘i⁄_lﬂd15
 = 0;

182 
c⁄√˘i⁄_öãrvÆ
;

184 
exp⁄ít
;

185 
i_mu…
;

187 
now
 = 
	`mosquôto_time
();

189 if(
öãrvÆ
 && 
now
 - i¡îvÆ > 
œ°_upd©e
){

190 
u±ime
 = 
now
 - 
°¨t_time
;

191 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d sec⁄ds", ()
u±ime
);

192 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/u±ime", 2, 
	`°æí
(
buf
), buf, 1);

194 
	`_sys_upd©e_˛õ¡s
(
db
, 
buf
);

195 if(
œ°_upd©e
 > 0){

196 
i_mu…
 = 60.0/()(
now
-
œ°_upd©e
);

198 
msgs_ª˚ived_öãrvÆ
 = (
g_msgs_ª˚ived
 - 
msgs_ª˚ived
)*
i_mu…
;

199 
msgs_£¡_öãrvÆ
 = (
g_msgs_£¡
 - 
msgs_£¡
)*
i_mu…
;

200 
publish_dr›≥d_öãrvÆ
 = (
g_msgs_dr›≥d
 - 
publish_dr›≥d
)*
i_mu…
;

202 
publish_ª˚ived_öãrvÆ
 = (
g_pub_msgs_ª˚ived
 - 
pub_msgs_ª˚ived
)*
i_mu…
;

203 
publish_£¡_öãrvÆ
 = (
g_pub_msgs_£¡
 - 
pub_msgs_£¡
)*
i_mu…
;

205 
byãs_ª˚ived_öãrvÆ
 = (
g_byãs_ª˚ived
 - 
byãs_ª˚ived
)*
i_mu…
;

206 
byãs_£¡_öãrvÆ
 = (
g_byãs_£¡
 - 
byãs_£¡
)*
i_mu…
;

208 
sockë_öãrvÆ
 = 
g_sockë_c⁄√˘i⁄s
*
i_mu…
;

209 
g_sockë_c⁄√˘i⁄s
 = 0;

210 
c⁄√˘i⁄_öãrvÆ
 = 
g_c⁄√˘i⁄_cou¡
*
i_mu…
;

211 
g_c⁄√˘i⁄_cou¡
 = 0;

214 
exp⁄ít
 = 
	`exp
(-1.0*(
now
-
œ°_upd©e
)/60.0);

216 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/ª˚ived/1mö", 
exp⁄ít
, 
msgs_ª˚ived_öãrvÆ
, &
msgs_ª˚ived_lﬂd1
);

217 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/£¡/1mö", 
exp⁄ít
, 
msgs_£¡_öãrvÆ
, &
msgs_£¡_lﬂd1
);

218 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/dr›≥d/1mö", 
exp⁄ít
, 
publish_dr›≥d_öãrvÆ
, &
publish_dr›≥d_lﬂd1
);

219 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/ª˚ived/1mö", 
exp⁄ít
, 
publish_ª˚ived_öãrvÆ
, &
publish_ª˚ived_lﬂd1
);

220 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/£¡/1mö", 
exp⁄ít
, 
publish_£¡_öãrvÆ
, &
publish_£¡_lﬂd1
);

221 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/ª˚ived/1mö", 
exp⁄ít
, 
byãs_ª˚ived_öãrvÆ
, &
byãs_ª˚ived_lﬂd1
);

222 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/£¡/1mö", 
exp⁄ít
, 
byãs_£¡_öãrvÆ
, &
byãs_£¡_lﬂd1
);

223 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/sockës/1mö", 
exp⁄ít
, 
sockë_öãrvÆ
, &
sockë_lﬂd1
);

224 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/c⁄√˘i⁄s/1mö", 
exp⁄ít
, 
c⁄√˘i⁄_öãrvÆ
, &
c⁄√˘i⁄_lﬂd1
);

227 
exp⁄ít
 = 
	`exp
(-1.0*(
now
-
œ°_upd©e
)/300.0);

229 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/ª˚ived/5mö", 
exp⁄ít
, 
msgs_ª˚ived_öãrvÆ
, &
msgs_ª˚ived_lﬂd5
);

230 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/£¡/5mö", 
exp⁄ít
, 
msgs_£¡_öãrvÆ
, &
msgs_£¡_lﬂd5
);

231 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/dr›≥d/5mö", 
exp⁄ít
, 
publish_dr›≥d_öãrvÆ
, &
publish_dr›≥d_lﬂd5
);

232 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/ª˚ived/5mö", 
exp⁄ít
, 
publish_ª˚ived_öãrvÆ
, &
publish_ª˚ived_lﬂd5
);

233 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/£¡/5mö", 
exp⁄ít
, 
publish_£¡_öãrvÆ
, &
publish_£¡_lﬂd5
);

234 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/ª˚ived/5mö", 
exp⁄ít
, 
byãs_ª˚ived_öãrvÆ
, &
byãs_ª˚ived_lﬂd5
);

235 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/£¡/5mö", 
exp⁄ít
, 
byãs_£¡_öãrvÆ
, &
byãs_£¡_lﬂd5
);

236 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/sockës/5mö", 
exp⁄ít
, 
sockë_öãrvÆ
, &
sockë_lﬂd5
);

237 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/c⁄√˘i⁄s/5mö", 
exp⁄ít
, 
c⁄√˘i⁄_öãrvÆ
, &
c⁄√˘i⁄_lﬂd5
);

240 
exp⁄ít
 = 
	`exp
(-1.0*(
now
-
œ°_upd©e
)/900.0);

242 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/ª˚ived/15mö", 
exp⁄ít
, 
msgs_ª˚ived_öãrvÆ
, &
msgs_ª˚ived_lﬂd15
);

243 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/mesßges/£¡/15mö", 
exp⁄ít
, 
msgs_£¡_öãrvÆ
, &
msgs_£¡_lﬂd15
);

244 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/dr›≥d/15mö", 
exp⁄ít
, 
publish_dr›≥d_öãrvÆ
, &
publish_dr›≥d_lﬂd15
);

245 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/ª˚ived/15mö", 
exp⁄ít
, 
publish_ª˚ived_öãrvÆ
, &
publish_ª˚ived_lﬂd15
);

246 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/publish/£¡/15mö", 
exp⁄ít
, 
publish_£¡_öãrvÆ
, &
publish_£¡_lﬂd15
);

247 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/ª˚ived/15mö", 
exp⁄ít
, 
byãs_ª˚ived_öãrvÆ
, &
byãs_ª˚ived_lﬂd15
);

248 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/byãs/£¡/15mö", 
exp⁄ít
, 
byãs_£¡_öãrvÆ
, &
byãs_£¡_lﬂd15
);

249 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/sockës/15mö", 
exp⁄ít
, 
sockë_öãrvÆ
, &
sockë_lﬂd15
);

250 
	`ˇlc_lﬂd
(
db
, 
buf
, "$SYS/brokî/lﬂd/c⁄√˘i⁄s/15mö", 
exp⁄ít
, 
c⁄√˘i⁄_öãrvÆ
, &
c⁄√˘i⁄_lﬂd15
);

253 if(
db
->
msg_°‹e_cou¡
 != msg_store_count){

254 
msg_°‹e_cou¡
 = 
db
->msg_store_count;

255 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
msg_°‹e_cou¡
);

256 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/mesßges/°‹ed", 2, 
	`°æí
(
buf
), buf, 1);

259 if(
db
->
subs¸ùti⁄_cou¡
 != subscription_count){

260 
subs¸ùti⁄_cou¡
 = 
db
->subscription_count;

261 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
subs¸ùti⁄_cou¡
);

262 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/subs¸ùti⁄s/cou¡", 2, 
	`°æí
(
buf
), buf, 1);

265 if(
db
->
ªèöed_cou¡
 !=Ñetained_count){

266 
ªèöed_cou¡
 = 
db
->retained_count;

267 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%d", 
ªèöed_cou¡
);

268 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/ªèöed mesßges/cou¡", 2, 
	`°æí
(
buf
), buf, 1);

271 #ifde‡
REAL_WITH_MEMORY_TRACKING


272 
	`_sys_upd©e_mem‹y
(
db
, 
buf
);

275 if(
msgs_ª˚ived
 !
g_msgs_ª˚ived
){

276 
msgs_ª˚ived
 = 
g_msgs_ª˚ived
;

277 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
msgs_ª˚ived
);

278 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/mesßges/ª˚ived", 2, 
	`°æí
(
buf
), buf, 1);

281 if(
msgs_£¡
 !
g_msgs_£¡
){

282 
msgs_£¡
 = 
g_msgs_£¡
;

283 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
msgs_£¡
);

284 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/mesßges/£¡", 2, 
	`°æí
(
buf
), buf, 1);

287 if(
publish_dr›≥d
 !
g_msgs_dr›≥d
){

288 
publish_dr›≥d
 = 
g_msgs_dr›≥d
;

289 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
publish_dr›≥d
);

290 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/mesßges/dr›≥d", 2, 
	`°æí
(
buf
), buf, 1);

293 if(
pub_msgs_ª˚ived
 !
g_pub_msgs_ª˚ived
){

294 
pub_msgs_ª˚ived
 = 
g_pub_msgs_ª˚ived
;

295 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
pub_msgs_ª˚ived
);

296 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/mesßges/ª˚ived", 2, 
	`°æí
(
buf
), buf, 1);

299 if(
pub_msgs_£¡
 !
g_pub_msgs_£¡
){

300 
pub_msgs_£¡
 = 
g_pub_msgs_£¡
;

301 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%lu", 
pub_msgs_£¡
);

302 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/mesßges/£¡", 2, 
	`°æí
(
buf
), buf, 1);

305 if(
byãs_ª˚ived
 !
g_byãs_ª˚ived
){

306 
byãs_ª˚ived
 = 
g_byãs_ª˚ived
;

307 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
byãs_ª˚ived
);

308 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/byãs/ª˚ived", 2, 
	`°æí
(
buf
), buf, 1);

311 if(
byãs_£¡
 !
g_byãs_£¡
){

312 
byãs_£¡
 = 
g_byãs_£¡
;

313 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
byãs_£¡
);

314 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/byãs/£¡", 2, 
	`°æí
(
buf
), buf, 1);

317 if(
pub_byãs_ª˚ived
 !
g_pub_byãs_ª˚ived
){

318 
pub_byãs_ª˚ived
 = 
g_pub_byãs_ª˚ived
;

319 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
pub_byãs_ª˚ived
);

320 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/byãs/ª˚ived", 2, 
	`°æí
(
buf
), buf, 1);

323 if(
pub_byãs_£¡
 !
g_pub_byãs_£¡
){

324 
pub_byãs_£¡
 = 
g_pub_byãs_£¡
;

325 
	`¢¥ötf
(
buf
, 
BUFLEN
, "%Œu", 
pub_byãs_£¡
);

326 
	`mqâ3_db_mesßges_ósy_queue
(
db
, 
NULL
, "$SYS/brokî/publish/byãs/£¡", 2, 
	`°æí
(
buf
), buf, 1);

329 
œ°_upd©e
 = 
	`mosquôto_time
();

331 
	}
}

	@/Users/psaraf/Downloads/mosquitto-1.4.3/src/websockets.c

30 #ifde‡
WITH_WEBSOCKETS


32 
	~<libwebsockës.h
>

33 
	~"mosquôto_öã∫Æ.h
"

34 
	~"mosquôto_brokî.h
"

35 
	~"mqâ3_¥Ÿocﬁ.h
"

36 
	~"mem‹y_mosq.h
"

38 
	~<°dlib.h
>

39 
	~<î∫o.h
>

40 
	~<sys/°©.h
>

42 #ifde‡
WITH_SYS_TREE


43 
uöt64_t
 
g_byãs_ª˚ived
;

44 
uöt64_t
 
g_byãs_£¡
;

45 
g_msgs_ª˚ived
;

46 
g_msgs_£¡
;

47 
g_pub_msgs_ª˚ived
;

48 
g_pub_msgs_£¡
;

50 
mosquôto_db
 
öt_db
;

52 
ˇŒback_mqâ
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

53 
libwebsockë
 *
wsi
,

54 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

55 *
u£r
,

56 *
ö
,

57 
size_t
 
Àn
);

58 
ˇŒback_hâp
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

59 
libwebsockë
 *
wsi
,

60 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

61 *
u£r
,

62 *
ö
,

63 
size_t
 
Àn
);

65 
	emosq_ws_¥Ÿocﬁs
 {

66 
	mPROTOCOL_HTTP
 = 0,

67 
	mPROTOCOL_MQTT
,

68 
	mDEMO_PROTOCOL_COUNT


71 
	slibws_hâp_d©a
 {

72 
FILE
 *
	mÂå
;

75 #i‚de‡
LWS_FEATURE_SERVE_HTTP_FILE_HAS_OTHER_HEADERS_ARG


78 
	#LWS_IS_OLD


	)

79 
	#HTTP_STATUS_FORBIDDEN
 403

	)

80 
	#HTTP_STATUS_NOT_FOUND
 404

	)

81 
	#HTTP_STATUS_METHOD_NOT_ALLOWED
 405

	)

82 
	#HTTP_STATUS_REQ_URI_TOO_LONG
 414

	)

83 
	#HTTP_STATUS_INTERNAL_SERVER_ERROR
 500

	)

84 
	#libwebsockës_ªtu∫_hâp_°©us
(
A
, 
B
, 
C
, 
D
)

	)

87 
libwebsockë_¥Ÿocﬁs
 
	g¥Ÿocﬁs
[] = {

91 
ˇŒback_hâp
,

92  (
libws_hâp_d©a
),

94 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


97 
NULL
,

102 
ˇŒback_mqâ
,

103 (
libws_mqâ_d©a
),

105 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


108 
NULL
,

113 
ˇŒback_mqâ
,

114 (
libws_mqâ_d©a
),

116 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


119 
NULL
,

122 #ifde‡
LWS_FEATURE_PROTOCOLS_HAS_ID_FIELD


123 { 
NULL
, NULL, 0, 0, 0, NULL, 0}

125 { 
NULL
, NULL, 0, 0, NULL, 0}

129 
	$ósy_addªss
(
sock
, 
mosquôto
 *
mosq
)

131 
addªss
[1024];

133 if(!
	`_mosquôto_sockë_gë_addªss
(
sock
, 
addªss
, 1024)){

134 
mosq
->
addªss
 = 
	`_mosquôto_°rdup
(address);

136 
	}
}

138 
	$ˇŒback_mqâ
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

139 
libwebsockë
 *
wsi
,

140 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

141 *
u£r
,

142 *
ö
,

143 
size_t
 
Àn
)

145 
mosquôto_db
 *
db
;

146 
mosquôto
 *
mosq
 = 
NULL
;

147 
_mosquôto_∑ckë
 *
∑ckë
;

148 
cou¡
;

149 
libws_mqâ_d©a
 *
u
 = (libws_mqâ_d©®*)
u£r
;

150 
size_t
 
pos
;

151 
uöt8_t
 *
buf
;

152 
rc
;

153 
uöt8_t
 
byã
;

155 
db
 = &
öt_db
;

157 
ªas⁄
) {

158 
LWS_CALLBACK_ESTABLISHED
:

159 
mosq
 = 
	`mqâ3_c⁄ãxt_öô
(
db
, 
WEBSOCKET_CLIENT
);

160 if(
mosq
){

161 
mosq
->
ws_c⁄ãxt
 = 
c⁄ãxt
;

162 
mosq
->
wsi
 = wsi;

163 
u
->
mosq
 = mosq;

167 
	`ósy_addªss
(
	`libwebsockë_gë_sockë_fd
(
wsi
), 
mosq
);

168 if(!
mosq
->
addªss
){

170 
	`_mosquôto_‰ì
(
mosq
);

171 
u
->
mosq
 = 
NULL
;

176 
LWS_CALLBACK_CLOSED
:

177 if(!
u
){

180 
mosq
 = 
u
->mosq;

181 if(
mosq
){

182 
mosq
->
wsi
 = 
NULL
;

183 
	`do_disc⁄√˘
(
db
, 
mosq
);

187 
LWS_CALLBACK_SERVER_WRITEABLE
:

188 if(!
u
){

191 
mosq
 = 
u
->mosq;

192 if(!
mosq
 || mosq->
°©e
 =
mosq_cs_disc⁄√˘_ws
 || mosq->°©ê=
mosq_cs_disc⁄√˘ög
){

196 if(
mosq
->
out_∑ckë
 && !mosq->
cuºít_out_∑ckë
){

197 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

198 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

199 if(!
mosq
->
out_∑ckë
){

200 
mosq
->
out_∑ckë_œ°
 = 
NULL
;

204 
mosq
->
cuºít_out_∑ckë
 && !
	`lws_£nd_pùe_choked
(mosq->
wsi
)){

205 
∑ckë
 = 
mosq
->
cuºít_out_∑ckë
;

207 if(
∑ckë
->
pos
 =0 &&Öackë->
to_¥o˚ss
 =∑ckë->
∑ckë_Àngth
){

214 
	`memmove
(&
∑ckë
->
∑ylﬂd
[
LWS_SEND_BUFFER_PRE_PADDING
],Öackë->∑ylﬂd,Öackë->
∑ckë_Àngth
);

215 
∑ckë
->
pos
 +
LWS_SEND_BUFFER_PRE_PADDING
;

217 
cou¡
 = 
	`libwebsockë_wrôe
(
wsi
, &
∑ckë
->
∑ylﬂd
[∑ckë->
pos
],Öackë->
to_¥o˚ss
, 
LWS_WRITE_BINARY
);

218 #ifde‡
LWS_IS_OLD


220 
cou¡
 = 
∑ckë
->
to_¥o˚ss
;

222 if(
cou¡
 < 0){

225 
∑ckë
->
to_¥o˚ss
 -
cou¡
;

226 
∑ckë
->
pos
 +
cou¡
;

227 if(
∑ckë
->
to_¥o˚ss
 > 0){

232 
mosq
->
cuºít_out_∑ckë
 = mosq->
out_∑ckë
;

233 if(
mosq
->
out_∑ckë
){

234 
mosq
->
out_∑ckë
 = mosq->out_∑ckë->
√xt
;

235 if(!
mosq
->
out_∑ckë
){

236 
mosq
->
out_∑ckë_œ°
 = 
NULL
;

240 
	`_mosquôto_∑ckë_˛ónup
(
∑ckë
);

241 
	`_mosquôto_‰ì
(
∑ckë
);

243 
mosq
->
œ°_msg_out
 = 
	`mosquôto_time
();

245 if(
mosq
->
cuºít_out_∑ckë
){

246 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
mosq
->
ws_c⁄ãxt
, mosq->
wsi
);

249 if(
mosq
->
cuºít_out_∑ckë
){

250 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
mosq
->
ws_c⁄ãxt
, mosq->
wsi
);

254 
LWS_CALLBACK_RECEIVE
:

255 if(!
u
 || !u->
mosq
){

258 
mosq
 = 
u
->mosq;

259 
pos
 = 0;

260 
buf
 = (
uöt8_t
 *)
ö
;

261 #ifde‡
WITH_SYS_TREE


262 
g_byãs_ª˚ived
 +
Àn
;

264 
pos
 < 
Àn
){

265 if(!
mosq
->
ö_∑ckë
.
comm™d
){

266 
mosq
->
ö_∑ckë
.
comm™d
 = 
buf
[
pos
];

267 
pos
++;

269 if(
mosq
->
°©e
 =
mosq_cs_√w
 && (mosq->
ö_∑ckë
.
comm™d
&0xF0Ë!
CONNECT
){

273 if(
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 <= 0){

275 if(
pos
 =
Àn
){

278 
byã
 = 
buf
[
pos
];

279 
pos
++;

281 
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
--;

285 if(
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 < -4){

289 
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 +(
byã
 & 127Ë* mosq->ö_∑ckë.
ªmaöög_mu…
;

290 
mosq
->
ö_∑ckë
.
ªmaöög_mu…
 *= 128;

291 }(
byã
 & 128) != 0);

292 
mosq
->
ö_∑ckë
.
ªmaöög_cou¡
 *= -1;

294 if(
mosq
->
ö_∑ckë
.
ªmaöög_Àngth
 > 0){

295 
mosq
->
ö_∑ckë
.
∑ylﬂd
 = 
	`_mosquôto_mÆloc
(mosq->ö_∑ckë.
ªmaöög_Àngth
*(
uöt8_t
));

296 if(!
mosq
->
ö_∑ckë
.
∑ylﬂd
){

299 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = mosq->ö_∑ckë.
ªmaöög_Àngth
;

302 if(
mosq
->
ö_∑ckë
.
to_¥o˚ss
>0){

303 if(
Àn
 - 
pos
 >
mosq
->
ö_∑ckë
.
to_¥o˚ss
){

304 
	`mem˝y
(&
mosq
->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
], &
buf
[pos], mosq->ö_∑ckë.
to_¥o˚ss
);

305 
mosq
->
ö_∑ckë
.
pos
 +mosq->ö_∑ckë.
to_¥o˚ss
;

306 
pos
 +
mosq
->
ö_∑ckë
.
to_¥o˚ss
;

307 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 = 0;

309 
	`mem˝y
(&
mosq
->
ö_∑ckë
.
∑ylﬂd
[mosq->ö_∑ckë.
pos
], &
buf
[pos], 
Àn
-pos);

310 
mosq
->
ö_∑ckë
.
pos
 +
Àn
-pos;

311 
mosq
->
ö_∑ckë
.
to_¥o˚ss
 -
Àn
-
pos
;

316 
mosq
->
ö_∑ckë
.
pos
 = 0;

317 #ifde‡
WITH_SYS_TREE


318 
g_msgs_ª˚ived
++;

319 if(((
mosq
->
ö_∑ckë
.
comm™d
)&0xF5Ë=
PUBLISH
){

320 
g_pub_msgs_ª˚ived
++;

323 
rc
 = 
	`mqâ3_∑ckë_h™dÀ
(
db
, 
mosq
);

326 
	`_mosquôto_∑ckë_˛ónup
(&
mosq
->
ö_∑ckë
);

328 
mosq
->
œ°_msg_ö
 = 
	`mosquôto_time
();

330 if(
rc
){

331 
	`do_disc⁄√˘
(
db
, 
mosq
);

342 
	}
}

345 
	$ˇŒback_hâp
(
libwebsockë_c⁄ãxt
 *
c⁄ãxt
,

346 
libwebsockë
 *
wsi
,

347 
libwebsockë_ˇŒback_ªas⁄s
 
ªas⁄
,

348 *
u£r
,

349 *
ö
,

350 
size_t
 
Àn
)

352 
libws_hâp_d©a
 *
u
 = (libws_hâp_d©®*)
u£r
;

353 
libws_mqâ_hack
 *
hack
;

354 *
hâp_dú
;

355 
size_t
 
buÊí
, 
¶í
;

356 #i‚de‡
LWS_IS_OLD


357 
size_t
 
wÀn
;

359 *
fûíame
, *
fûíame_ˇn⁄iˇl
;

360 
buf
[4096];

361 
°©
 
fûe°©
;

365 
ªas⁄
) {

366 
LWS_CALLBACK_HTTP
:

367 if(!
u
){

371 
hack
 = (
libws_mqâ_hack
 *)
	`libwebsockë_c⁄ãxt_u£r
(
c⁄ãxt
);

372 if(!
hack
){

375 
hâp_dú
 = 
hack
->http_dir;

377 if(!
hâp_dú
){

382 #i‚de‡
LWS_IS_OLD


384 if(
	`lws_hdr_tŸÆ_Àngth
(
wsi
, 
WSI_TOKEN_POST_URI
)){

385 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_METHOD_NOT_ALLOWED
, 
NULL
);

390 if(!
	`°rcmp
((*)
ö
, "/")){

391 
¶í
 = 
	`°æí
(
hâp_dú
) + strlen("/index.html") + 2;

393 
¶í
 = 
	`°æí
(
hâp_dú
Ë+ såÀn((*)
ö
) + 2;

395 
fûíame
 = 
	`_mosquôto_mÆloc
(
¶í
);

396 if(!
fûíame
){

397 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

400 if(!
	`°rcmp
((*)
ö
, "/")){

401 
	`¢¥ötf
(
fûíame
, 
¶í
, "%s/ödex.html", 
hâp_dú
);

403 
	`¢¥ötf
(
fûíame
, 
¶í
, "%s%s", 
hâp_dú
, (*)
ö
);

408 #ifde‡
WIN32


409 
fûíame_ˇn⁄iˇl
 = 
	`_fuŒ∑th
(
NULL
, 
fûíame
, 0);

410 if(!
fûíame_ˇn⁄iˇl
){

411 
	`_mosquôto_‰ì
(
fûíame
);

412 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

416 
fûíame_ˇn⁄iˇl
 = 
	`ªÆ∑th
(
fûíame
, 
NULL
);

417 if(!
fûíame_ˇn⁄iˇl
){

418 
	`_mosquôto_‰ì
(
fûíame
);

419 if(
î∫o
 =
EACCES
){

420 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_FORBIDDEN
, 
NULL
);

421 }if(
î∫o
 =
EINVAL
 ||Éºnÿ=
EIO
 ||Éºnÿ=
ELOOP
){

422 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

423 }if(
î∫o
 =
ENAMETOOLONG
){

424 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_REQ_URI_TOO_LONG
, 
NULL
);

425 }if(
î∫o
 =
ENOENT
 ||Éºnÿ=
ENOTDIR
){

426 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_NOT_FOUND
, 
NULL
);

431 if(
	`°∫cmp
(
hâp_dú
, 
fûíame_ˇn⁄iˇl
, 
	`°æí
(http_dir))){

433 
	`‰ì
(
fûíame_ˇn⁄iˇl
);

434 
	`_mosquôto_‰ì
(
fûíame
);

435 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_FORBIDDEN
, 
NULL
);

438 
	`‰ì
(
fûíame_ˇn⁄iˇl
);

440 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_DEBUG
, "hâ∞£rvög fûê\"%s\".", 
fûíame
);

441 
u
->
Âå
 = 
	`f›í
(
fûíame
, "rb");

442 
	`_mosquôto_‰ì
(
fûíame
);

443 if(!
u
->
Âå
){

444 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_NOT_FOUND
, 
NULL
);

447 if(
	`f°©
(
	`fûío
(
u
->
Âå
), &
fûe°©
) < 0){

448 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_INTERNAL_SERVER_ERROR
, 
NULL
);

449 
	`f˛o£
(
u
->
Âå
);

452 #ifde‡
WIN32


453 if((
fûe°©
.
°_mode
 & 
S_IFREG
) != S_IFREG){

455 if(!
	`S_ISREG
(
fûe°©
.
°_mode
)){

457 
	`libwebsockës_ªtu∫_hâp_°©us
(
c⁄ãxt
, 
wsi
, 
HTTP_STATUS_FORBIDDEN
, 
NULL
);

461 
buÊí
 = 
	`¢¥ötf
((*)
buf
, 4096, "HTTP/1.0 200 OK\r\n"

464 ()
fûe°©
.
°_size
);

465 if(
	`libwebsockë_wrôe
(
wsi
, 
buf
, 
buÊí
, 
LWS_WRITE_HTTP
) < 0){

466 
	`f˛o£
(
u
->
Âå
);

469 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
c⁄ãxt
, 
wsi
);

472 #i‚de‡
LWS_IS_OLD


473 
LWS_CALLBACK_HTTP_BODY
:

477 
LWS_CALLBACK_HTTP_BODY_COMPLETION
:

481 
LWS_CALLBACK_FILTER_HTTP_CONNECTION
:

485 
LWS_CALLBACK_HTTP_WRITEABLE
:

487 if(
u
 && u->
Âå
){

489 
buÊí
 = 
	`‰ód
(
buf
, 1, (buf), 
u
->
Âå
);

490 if(
buÊí
 < 1){

491 
	`f˛o£
(
u
->
Âå
);

494 
wÀn
 = 
	`libwebsockë_wrôe
(
wsi
, 
buf
, 
buÊí
, 
LWS_WRITE_HTTP
);

495 if(
wÀn
 < 
buÊí
){

496 if(
	`f£ek
(
u
->
Âå
, 
buÊí
-
wÀn
, 
SEEK_CUR
) < 0){

497 
	`f˛o£
(
u
->
Âå
);

498 
u
->
Âå
 = 
NULL
;

502 if(
buÊí
 < (
buf
)){

503 
	`f˛o£
(
u
->
Âå
);

504 
u
->
Âå
 = 
NULL
;

507 }
u
->
Âå
 && !
	`lws_£nd_pùe_choked
(
wsi
));

508 
	`libwebsockë_ˇŒback_⁄_wrôabÀ
(
c⁄ãxt
, 
wsi
);

519 
	}
}

521 
	$log_wøp
(
Àvñ
, c⁄° *
löe
)

523 *
l
 = (*)
löe
;

524 
l
[
	`°æí
(
löe
)-1] = '\0';

525 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_WEBSOCKETS
, "%s", 
l
);

526 
	}
}

528 
libwebsockë_c⁄ãxt
 *
	$mosq_websockës_öô
(
_mqâ3_li°íî
 *
li°íî
, 
log_Àvñ
)

530 
lws_c⁄ãxt_¸óti⁄_öfo
 
öfo
;

531 
libwebsockë_¥Ÿocﬁs
 *
p
;

532 
¥Ÿocﬁ_cou¡
;

533 
i
;

534 
libws_mqâ_hack
 *
u£r
;

537 
¥Ÿocﬁ_cou¡
=0; 
¥Ÿocﬁs
[¥Ÿocﬁ_cou¡].
«me
;Örotocol_count++);

539 
p
 = 
	`_mosquôto_ˇŒoc
(
¥Ÿocﬁ_cou¡
+1, (
libwebsockë_¥Ÿocﬁs
));

540 if(!
p
){

541 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_ERR
, "Out of memory.");

542  
NULL
;

544 
i
=0; 
¥Ÿocﬁs
[i].
«me
; i++){

545 
p
[
i
].
«me
 = 
¥Ÿocﬁs
[i].name;

546 
p
[
i
].
ˇŒback
 = 
¥Ÿocﬁs
[i].callback;

547 
p
[
i
].
≥r_£ssi⁄_d©a_size
 = 
¥Ÿocﬁs
[i].per_session_data_size;

548 
p
[
i
].
rx_buf„r_size
 = 
¥Ÿocﬁs
[i].rx_buffer_size;

551 
	`mem£t
(&
öfo
, 0, (info));

552 
öfo
.
p‹t
 = 
li°íî
->port;

553 
öfo
.
¥Ÿocﬁs
 = 
p
;

554 
öfo
.
gid
 = -1;

555 
öfo
.
uid
 = -1;

556 #ifde‡
WITH_TLS


557 
öfo
.
s¶_ˇ_fûï©h
 = 
li°íî
->
ˇfûe
;

558 
öfo
.
s¶_˚π_fûï©h
 = 
li°íî
->
˚πfûe
;

559 
öfo
.
s¶_¥iv©e_key_fûï©h
 = 
li°íî
->
keyfûe
;

560 #i‚de‡
LWS_IS_OLD


561 
öfo
.
s¶_cùhî_li°
 = 
li°íî
->
cùhîs
;

563 if(
li°íî
->
ªquúe_˚πifiˇã
){

564 
öfo
.
›ti⁄s
 |
LWS_SERVER_OPTION_REQUIRE_VALID_OPENSSL_CLIENT_CERT
;

567 #i‚de‡
LWS_IS_OLD


568 
öfo
.
›ti⁄s
 |
LWS_SERVER_OPTION_DISABLE_IPV6
;

571 
u£r
 = 
	`_mosquôto_ˇŒoc
(1, (
libws_mqâ_hack
));

572 if(!
u£r
){

573 
	`_mosquôto_‰ì
(
p
);

574  
NULL
;

577 if(
li°íî
->
hâp_dú
){

578 #ifde‡
WIN32


579 
u£r
->
hâp_dú
 = 
	`_fuŒ∑th
(
NULL
, 
li°íî
->http_dir, 0);

581 
u£r
->
hâp_dú
 = 
	`ªÆ∑th
(
li°íî
->hâp_dú, 
NULL
);

583 if(!
u£r
->
hâp_dú
){

584 
	`_mosquôto_‰ì
(
u£r
);

585 
	`_mosquôto_‰ì
(
p
);

586  
NULL
;

590 
öfo
.
u£r
 = user;

591 
li°íî
->
ws_¥Ÿocﬁ
 = 
p
;

593 
	`lws_£t_log_Àvñ
(
log_Àvñ
, 
log_wøp
);

595 
	`_mosquôto_log_¥ötf
(
NULL
, 
MOSQ_LOG_INFO
, "O≥nög websockë†li°í sockë o¿p‹à%d.", 
li°íî
->
p‹t
);

596  
	`libwebsockë_¸óã_c⁄ãxt
(&
öfo
);

597 
	}
}

	@lib_load.h

17 #i‚de‡
LIB_LOAD_H


18 
	#LIB_LOAD_H


	)

20 #ifde‡
WIN32


21 
	~<wödows.h
>

23 
	~<dlf˙.h
>

26 #ifde‡
WIN32


27 
	#LIB_LOAD
(
A
Ë
	`LﬂdLibøry
(A)

	)

28 
	#LIB_CLOSE
(
A
Ë
	`FªeLibøry
(A)

	)

29 
	#LIB_SYM
(
HANDLE
, 
SYM
Ë
	`GëProcAddªss
(HANDLE, SYM)

	)

31 
	#LIB_LOAD
(
A
Ë
	`dl›í
(A, 
RTLD_NOW
|
RTLD_GLOBAL
)

	)

32 
	#LIB_CLOSE
(
A
Ë
	`dl˛o£
(A)

	)

33 
	#LIB_SYM
(
HANDLE
, 
SYM
Ë
	`dlsym
(HANDLE, SYM)

	)

36 
	#LIB_SYM_EASY
(
MEMBER
, 
HANDLE
, 
SYM
Ëif(!(MEMBER = 
	`LIB_SYM
(HANDLE, SYM)Ë 1

	)

	@memory_mosq.h

17 #i‚de‡
_MEMORY_MOSQ_H_


18 
	#_MEMORY_MOSQ_H_


	)

20 
	~<°dio.h
>

21 
	~<sys/ty≥s.h
>

23 #i‡
deföed
(
WITH_MEMORY_TRACKING
Ë&& deföed(
WITH_BROKER
Ë&& !deföed(
WIN32
Ë&& !deföed(
__SYMBIAN32__
Ë&& !deföed(
__ANDROID__
Ë&& !deföed(
__UCLIBC__
Ë&& !deföed(
__O≥nBSD__
)

24 
	#REAL_WITH_MEMORY_TRACKING


	)

27 *
_mosquôto_ˇŒoc
(
size_t
 
nmemb
, size_à
size
);

28 
_mosquôto_‰ì
(*
mem
);

29 *
_mosquôto_mÆloc
(
size_t
 
size
);

30 #ifde‡
REAL_WITH_MEMORY_TRACKING


31 
_mosquôto_mem‹y_u£d
();

32 
_mosquôto_max_mem‹y_u£d
();

34 *
_mosquôto_ªÆloc
(*
±r
, 
size_t
 
size
);

35 *
_mosquôto_°rdup
(c⁄° *
s
);

	@mosquitto_broker.h

17 #i‚de‡
MQTT3_H


18 
	#MQTT3_H


	)

20 
	~<c⁄fig.h
>

21 
	~<°dio.h
>

23 
	~<mosquôto_öã∫Æ.h
>

24 
	~<mosquôto_∂ugö.h
>

25 
	~<mosquôto.h
>

26 
	~"és_mosq.h
"

27 
	~"uthash.h
"

29 #i‚de‡
__GNUC__


30 
	#__©åibuã__
(
©åib
)

	)

34 
	#MQTT3_LOG_NONE
 0x00

	)

35 
	#MQTT3_LOG_SYSLOG
 0x01

	)

36 
	#MQTT3_LOG_FILE
 0x02

	)

37 
	#MQTT3_LOG_STDOUT
 0x04

	)

38 
	#MQTT3_LOG_STDERR
 0x08

	)

39 
	#MQTT3_LOG_TOPIC
 0x10

	)

40 
	#MQTT3_LOG_ALL
 0xFF

	)

42 
	#WEBSOCKET_CLIENT
 -2

	)

44 
	emosquôto_¥Ÿocﬁ
 {

45 
	mmp_mqâ
,

46 
	mmp_mqâ¢
,

47 
	mmp_websockës


50 
uöt64_t
 
	tdbid_t
;

52 
	s_mqâ3_li°íî
 {

53 
	mfd
;

54 *
	mho°
;

55 
uöt16_t
 
	mp‹t
;

56 
	mmax_c⁄√˘i⁄s
;

57 *
	mmou¡_poöt
;

58 
mosq_sock_t
 *
	msocks
;

59 
	msock_cou¡
;

60 
	m˛õ¡_cou¡
;

61 
mosquôto_¥Ÿocﬁ
 
	m¥Ÿocﬁ
;

62 
boﬁ
 
	mu£_u£∫ame_as_˛õ¡id
;

63 #ifde‡
WITH_TLS


64 *
	mˇfûe
;

65 *
	mˇ∑th
;

66 *
	m˚πfûe
;

67 *
	mkeyfûe
;

68 *
	mcùhîs
;

69 *
	mpsk_höt
;

70 
boﬁ
 
	mªquúe_˚πifiˇã
;

71 
SSL_CTX
 *
	ms¶_˘x
;

72 *
	m¸lfûe
;

73 
boﬁ
 
	mu£_idítôy_as_u£∫ame
;

74 *
	més_vîsi⁄
;

76 #ifde‡
WITH_WEBSOCKETS


77 
libwebsockë_c⁄ãxt
 *
	mws_c⁄ãxt
;

78 *
	mhâp_dú
;

79 
libwebsockë_¥Ÿocﬁs
 *
	mws_¥Ÿocﬁ
;

83 
	smqâ3_c⁄fig
 {

84 *
	mc⁄fig_fûe
;

85 *
	ma˛_fûe
;

86 
boﬁ
 
	mÆlow_™⁄ymous
;

87 
boﬁ
 
	mÆlow_du∂iˇã_mesßges
;

88 
boﬁ
 
	mÆlow_zîo_Àngth_˛õ¡id
;

89 *
	mauto_id_¥efix
;

90 
	mauto_id_¥efix_Àn
;

91 
	mautoßve_öãrvÆ
;

92 
boﬁ
 
	mautoßve_⁄_ch™ges
;

93 *
	m˛õ¡id_¥efixes
;

94 
boﬁ
 
	mc⁄√˘i⁄_mesßges
;

95 
boﬁ
 
	md´m⁄
;

96 
_mqâ3_li°íî
 
	mdeÁu…_li°íî
;

97 
_mqâ3_li°íî
 *
	mli°íîs
;

98 
	mli°íî_cou¡
;

99 
	mlog_de°
;

100 
	mlog_Ácûôy
;

101 
	mlog_ty≥
;

102 
boﬁ
 
	mlog_time°amp
;

103 *
	mlog_fûe
;

104 
FILE
 *
	mlog_Âå
;

105 
uöt32_t
 
	mmesßge_size_limô
;

106 *
	m∑ssw‹d_fûe
;

107 
boﬁ
 
	m≥rsi°í˚
;

108 *
	m≥rsi°í˚_loˇti⁄
;

109 *
	m≥rsi°í˚_fûe
;

110 *
	m≥rsi°í˚_fûï©h
;

111 
time_t
 
	m≥rsi°ít_˛õ¡_expú©i⁄
;

112 *
	mpid_fûe
;

113 *
	mpsk_fûe
;

114 
boﬁ
 
	mqueue_qos0_mesßges
;

115 
	mªåy_öãrvÆ
;

116 
	msys_öãrvÆ
;

117 
boﬁ
 
	mupgøde_outgoög_qos
;

118 *
	mu£r
;

119 
boﬁ
 
	mvîbo£
;

120 #ifde‡
WITH_WEBSOCKETS


121 
	mwebsockës_log_Àvñ
;

122 
boﬁ
 
	mhave_websockës_li°íî
;

124 #ifde‡
WITH_BRIDGE


125 
_mqâ3_bridge
 *
	mbridges
;

126 
	mbridge_cou¡
;

128 *
	mauth_∂ugö
;

129 
mosquôto_auth_›t
 *
	mauth_›ti⁄s
;

130 
	mauth_›ti⁄_cou¡
;

133 
	s_mosquôto_subÀaf
 {

134 
_mosquôto_subÀaf
 *
	m¥ev
;

135 
_mosquôto_subÀaf
 *
	m√xt
;

136 
mosquôto
 *
	mc⁄ãxt
;

137 
	mqos
;

140 
	s_mosquôto_subhõr
 {

141 
_mosquôto_subhõr
 *
	m∑ª¡
;

142 
_mosquôto_subhõr
 *
	mchûdªn
;

143 
_mosquôto_subhõr
 *
	m√xt
;

144 
_mosquôto_subÀaf
 *
	msubs
;

145 *
	mt›ic
;

146 
mosquôto_msg_°‹e
 *
	mªèöed
;

149 
	smosquôto_msg_°‹e_lﬂd
{

150 
UT_hash_h™dÀ
 
	mhh
;

151 
dbid_t
 
	mdb_id
;

152 
mosquôto_msg_°‹e
 *
	m°‹e
;

155 
	smosquôto_msg_°‹e
{

156 
mosquôto_msg_°‹e
 *
	m√xt
;

157 
mosquôto_msg_°‹e
 *
	m¥ev
;

158 
dbid_t
 
	mdb_id
;

159 *
	msour˚_id
;

160 **
	mde°_ids
;

161 
	mde°_id_cou¡
;

162 
	mªf_cou¡
;

163 *
	mt›ic
;

164 *
	m∑ylﬂd
;

165 
uöt32_t
 
	m∑ylﬂdÀn
;

166 
uöt16_t
 
	msour˚_mid
;

167 
uöt16_t
 
	mmid
;

168 
uöt8_t
 
	mqos
;

169 
boﬁ
 
	mªèö
;

172 
	smosquôto_˛õ¡_msg
{

173 
mosquôto_˛õ¡_msg
 *
	m√xt
;

174 
mosquôto_msg_°‹e
 *
	m°‹e
;

175 
time_t
 
	mtime°amp
;

176 
uöt16_t
 
	mmid
;

177 
uöt8_t
 
	mqos
;

178 
boﬁ
 
	mªèö
;

179 
mosquôto_msg_dúe˘i⁄
 
	mdúe˘i⁄
;

180 
mosquôto_msg_°©e
 
	m°©e
;

181 
boﬁ
 
	mdup
;

184 
	s_mosquôto_u≈wd
{

185 *
	mu£∫ame
;

186 *
	m∑ssw‹d
;

187 #ifde‡
WITH_TLS


188 
	m∑ssw‹d_Àn
;

189 
	mß…_Àn
;

190 *
	mß…
;

192 
UT_hash_h™dÀ
 
	mhh
;

195 
	s_mosquôto_a˛
{

196 
_mosquôto_a˛
 *
	m√xt
;

197 *
	mt›ic
;

198 
	mac˚ss
;

199 
	mucou¡
;

200 
	mccou¡
;

203 
	s_mosquôto_a˛_u£r
{

204 
_mosquôto_a˛_u£r
 *
	m√xt
;

205 *
	mu£∫ame
;

206 
_mosquôto_a˛
 *
	ma˛
;

209 
	s_mosquôto_auth_∂ugö
{

210 *
	mlib
;

211 *
	mu£r_d©a
;

212 (*
	m∂ugö_vîsi⁄
)();

213 (*
	m∂ugö_öô
)(**
	mu£r_d©a
, 
mosquôto_auth_›t
 *
	mauth_›ts
, 
	mauth_›t_cou¡
);

214 (*
	m∂ugö_˛ónup
)(*
	mu£r_d©a
, 
mosquôto_auth_›t
 *
	mauth_›ts
, 
	mauth_›t_cou¡
);

215 (*
	m£curôy_öô
)(*
	mu£r_d©a
, 
mosquôto_auth_›t
 *
	mauth_›ts
, 
	mauth_›t_cou¡
, 
boﬁ
 
	mªlﬂd
);

216 (*
	m£curôy_˛ónup
)(*
	mu£r_d©a
, 
mosquôto_auth_›t
 *
	mauth_›ts
, 
	mauth_›t_cou¡
, 
boﬁ
 
	mªlﬂd
);

217 (*
	ma˛_check
)(*
	mu£r_d©a
, c⁄° *
	m˛õ¡id
, c⁄° *
	mu£∫ame
, c⁄° *
	mt›ic
, 
	mac˚ss
);

218 (*
	mu≈wd_check
)(*
	mu£r_d©a
, c⁄° *
	mu£∫ame
, c⁄° *
	m∑ssw‹d
);

219 (*
	mpsk_key_gë
)(*
	mu£r_d©a
, c⁄° *
	mhöt
, c⁄° *
	midítôy
, *
	mkey
, 
	mmax_key_Àn
);

222 
	smosquôto_db
{

223 
dbid_t
 
	mœ°_db_id
;

224 
_mosquôto_subhõr
 
	msubs
;

225 
_mosquôto_u≈wd
 *
	mu≈wd
;

226 
_mosquôto_a˛_u£r
 *
	ma˛_li°
;

227 
_mosquôto_a˛
 *
	ma˛_∑âîns
;

228 
_mosquôto_u≈wd
 *
	mpsk_id
;

229 
mosquôto
 *
	mc⁄ãxts_by_id
;

230 
mosquôto
 *
	mc⁄ãxts_by_sock
;

231 
mosquôto
 *
	mc⁄ãxts_f‹_‰ì
;

232 #ifde‡
WITH_BRIDGE


233 
mosquôto
 **
	mbridges
;

235 
_˛õ¡id_ödex_hash
 *
	m˛õ¡id_ödex_hash
;

236 
mosquôto_msg_°‹e
 *
	mmsg_°‹e
;

237 
mosquôto_msg_°‹e_lﬂd
 *
	mmsg_°‹e_lﬂd
;

238 #ifde‡
WITH_BRIDGE


239 
	mbridge_cou¡
;

241 
	mmsg_°‹e_cou¡
;

242 
mqâ3_c⁄fig
 *
	mc⁄fig
;

243 
	m≥rsi°í˚_ch™ges
;

244 
_mosquôto_auth_∂ugö
 
	mauth_∂ugö
;

245 #ifde‡
WITH_SYS_TREE


246 
	msubs¸ùti⁄_cou¡
;

247 
	mªèöed_cou¡
;

249 
mosquôto
 *
	mŒ_f‹_‰ì
;

252 
	emqâ3_bridge_dúe˘i⁄
{

253 
	mbd_out
 = 0,

254 
	mbd_ö
 = 1,

255 
	mbd_bŸh
 = 2

258 
	emosquôto_bridge_°¨t_ty≥
{

259 
	mb°_autom©ic
 = 0,

260 
	mb°_œzy
 = 1,

261 
	mb°_m™uÆ
 = 2,

262 
	mb°_⁄˚
 = 3

265 
	s_mqâ3_bridge_t›ic
{

266 *
	mt›ic
;

267 
	mqos
;

268 
mqâ3_bridge_dúe˘i⁄
 
	mdúe˘i⁄
;

269 *
	mloˇl_¥efix
;

270 *
	mªmŸe_¥efix
;

271 *
	mloˇl_t›ic
;

272 *
	mªmŸe_t›ic
;

275 
	sbridge_addªss
{

276 *
	maddªss
;

277 
	mp‹t
;

280 
	s_mqâ3_bridge
{

281 *
	m«me
;

282 
bridge_addªss
 *
	maddªs£s
;

283 
	mcur_addªss
;

284 
	maddªss_cou¡
;

285 
time_t
 
	m¥im¨y_ªåy
;

286 
boﬁ
 
	mround_robö
;

287 
boﬁ
 
	måy_¥iv©e
;

288 
boﬁ
 
	måy_¥iv©e_ac˚±ed
;

289 
boﬁ
 
	m˛ón_£ssi⁄
;

290 
	mkì∑live
;

291 
_mqâ3_bridge_t›ic
 *
	mt›ics
;

292 
	mt›ic_cou¡
;

293 
boﬁ
 
	mt›ic_ªm≠pög
;

294 
_mosquôto_¥Ÿocﬁ
 
	m¥Ÿocﬁ_vîsi⁄
;

295 
time_t
 
	mª°¨t_t
;

296 *
	mªmŸe_˛õ¡id
;

297 *
	mªmŸe_u£∫ame
;

298 *
	mªmŸe_∑ssw‹d
;

299 *
	mloˇl_˛õ¡id
;

300 *
	mloˇl_u£∫ame
;

301 *
	mloˇl_∑ssw‹d
;

302 
boﬁ
 
	mnŸifiˇti⁄s
;

303 *
	mnŸifiˇti⁄_t›ic
;

304 
mosquôto_bridge_°¨t_ty≥
 
	m°¨t_ty≥
;

305 
	midÀ_timeout
;

306 
	mª°¨t_timeout
;

307 
	mthªshﬁd
;

308 
boﬁ
 
	mœzy_ªc⁄√˘
;

309 
boﬁ
 
	m©ãm±_unsubs¸ibe
;

310 
boﬁ
 
	möôül_nŸifiˇti⁄_d⁄e
;

311 #ifde‡
WITH_TLS


312 *
	més_ˇfûe
;

313 *
	més_ˇ∑th
;

314 *
	més_˚πfûe
;

315 *
	més_keyfûe
;

316 
boﬁ
 
	més_ö£cuª
;

317 *
	més_vîsi⁄
;

318 #ifde‡
REAL_WITH_TLS_PSK


319 *
	més_psk_idítôy
;

320 *
	més_psk
;

325 #ifde‡
WITH_WEBSOCKETS


326 
	slibws_mqâ_hack
 {

327 *
	mhâp_dú
;

330 
	slibws_mqâ_d©a
 {

331 
mosquôto
 *
	mmosq
;

336 
	gpùeFDS
[2];

338 
	~<√t_mosq.h
>

344 
öôûaizeMqâLib
(*);

350 
mosquôto_maö_lo›
(
mosquôto_db
 *
db
, 
mosq_sock_t
 *
li°ísock
, 
li°ísock_cou¡
, 
li°íî_max
,*);

351 
mosquôto_db
 *
_mosquôto_gë_db
();

357 
mqâ3_c⁄fig_öô
(
mqâ3_c⁄fig
 *
c⁄fig
);

359 
mqâ3_c⁄fig_∑r£_¨gs
(
mqâ3_c⁄fig
 *
c⁄fig
, 
¨gc
, *
¨gv
[]);

364 
mqâ3_c⁄fig_ªad
(
mqâ3_c⁄fig
 *
c⁄fig
, 
boﬁ
 
ªlﬂd
);

366 
mqâ3_c⁄fig_˛ónup
(
mqâ3_c⁄fig
 *
c⁄fig
);

368 
dr›_¥ivûeges
(
mqâ3_c⁄fig
 *
c⁄fig
, 
boﬁ
 
ãmp‹¨y
);

369 
ª°‹e_¥ivûeges
();

374 
_mosquôto_£nd_c⁄«ck
(
mosquôto
 *
c⁄ãxt
, 
ack
, 
ªsu…
);

375 
_mosquôto_£nd_suback
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
);

380 
mqâ3_sockë_ac˚±
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
li°ísock
,*);

381 
mqâ3_sockë_li°í
(
_mqâ3_li°íî
 *
li°íî
);

382 
_mosquôto_sockë_gë_addªss
(
mosq_sock_t
 
sock
, *
buf
, 
Àn
);

387 
mqâ3_∑ckë_h™dÀ
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

388 
mqâ3_h™dÀ_c⁄«ck
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

389 
mqâ3_h™dÀ_c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

390 
mqâ3_h™dÀ_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

391 
mqâ3_h™dÀ_publish
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

392 
mqâ3_h™dÀ_subs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

393 
mqâ3_h™dÀ_unsubs¸ibe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

398 
mqâ3_db_›í
(
mqâ3_c⁄fig
 *
c⁄fig
, 
mosquôto_db
 *
db
);

399 
mqâ3_db_˛o£
(
mosquôto_db
 *
db
);

400 #ifde‡
WITH_PERSISTENCE


401 
mqâ3_db_backup
(
mosquôto_db
 *
db
, 
boﬁ
 
shutdown
);

402 
mqâ3_db_ª°‹e
(
mosquôto_db
 *
db
);

404 
mqâ3_db_limôs_£t
(
öÊight
, 
queued
);

406 
mqâ3_db_mesßge_cou¡
(*
cou¡
);

407 
mqâ3_db_mesßge_dñëe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
);

408 
mqâ3_db_mesßge_ö£π
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
qos
, 
boﬁ
 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
);

409 
mqâ3_db_mesßge_ªÀa£
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
);

410 
mqâ3_db_mesßge_upd©e
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_dúe˘i⁄
 
dú
, 
mosquôto_msg_°©e
 
°©e
);

411 
mqâ3_db_mesßge_wrôe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

412 
mqâ3_db_mesßges_dñëe
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

413 
mqâ3_db_mesßges_ósy_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
ªèö
);

414 
mqâ3_db_mesßges_queue
(
mosquôto_db
 *
db
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
);

415 
mqâ3_db_mesßge_°‹e
(
mosquôto_db
 *
db
, c⁄° *
sour˚
, 
uöt16_t
 
sour˚_mid
, c⁄° *
t›ic
, 
qos
, 
uöt32_t
 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
ªèö
, 
mosquôto_msg_°‹e
 **
°‹ed
, 
dbid_t
 
°‹e_id
);

416 
mqâ3_db_mesßge_°‹e_föd
(
mosquôto
 *
c⁄ãxt
, 
uöt16_t
 
mid
, 
mosquôto_msg_°‹e
 **
°‹ed
);

417 
mosquôto__db_msg_°‹e_add
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
);

418 
mosquôto__db_msg_°‹e_ªmove
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 *
°‹e
);

419 
mosquôto__db_msg_°‹e_dîef
(
mosquôto_db
 *
db
, 
mosquôto_msg_°‹e
 **
°‹e
);

420 
mosquôto__db_msg_°‹e_˛ón
(
mosquôto_db
 *
db
);

422 
mqâ3_db_mesßge_timeout_check
(
mosquôto_db
 *
db
, 
timeout
);

423 
mqâ3_db_mesßge_ªc⁄√˘_ª£t
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

424 
mqâ3_ªèö_queue
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
sub_qos
);

425 
mqâ3_db_sys_upd©e
(
mosquôto_db
 *
db
, 
öãrvÆ
, 
time_t
 
°¨t_time
);

426 
mqâ3_db_vacuum
();

431 
mqâ3_sub_add
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
qos
, 
_mosquôto_subhõr
 *
roŸ
);

432 
mqâ3_sub_ªmove
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
sub
, 
_mosquôto_subhõr
 *
roŸ
);

433 
mqâ3_sub_£¨ch
(
mosquôto_db
 *
db
, 
_mosquôto_subhõr
 *
roŸ
, c⁄° *
sour˚_id
, c⁄° *
t›ic
, 
qos
, 
ªèö
, 
mosquôto_msg_°‹e
 *
°‹ed
);

434 
mqâ3_sub_åì_¥öt
(
_mosquôto_subhõr
 *
roŸ
, 
Àvñ
);

435 
mqâ3_subs_˛ón_£ssi⁄
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

440 
mosquôto
 *
mqâ3_c⁄ãxt_öô
(
mosquôto_db
 *
db
, 
mosq_sock_t
 
sock
);

441 
mqâ3_c⁄ãxt_˛ónup
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, 
boﬁ
 
do_‰ì
);

442 
mqâ3_c⁄ãxt_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

443 
mosquôto__add_c⁄ãxt_to_disu£d
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

444 
mosquôto__‰ì_disu£d_c⁄ãxts
(
mosquôto_db
 *
db
);

449 
mqâ3_log_öô
(
mqâ3_c⁄fig
 *
c⁄fig
);

450 
mqâ3_log_˛o£
(
mqâ3_c⁄fig
 *
c⁄fig
);

451 
	$_mosquôto_log_¥ötf
(
mosquôto
 *
mosq
, 
Àvñ
, c⁄° *
fmt
, ...Ë
	`__©åibuã__
((
	`f‹m©
(
¥ötf
, 3, 4)));

456 #ifde‡
WITH_BRIDGE


457 
	`mqâ3_bridge_√w
(
mosquôto_db
 *
db
, 
_mqâ3_bridge
 *
bridge
);

458 
	`mqâ3_bridge_c⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

459 
	`mqâ3_bridge_∑ckë_˛ónup
(
mosquôto
 *
c⁄ãxt
);

465 
	`mosquôto_£curôy_moduÀ_öô
(
mosquôto_db
 *
db
);

466 
	`mosquôto_£curôy_moduÀ_˛ónup
(
mosquôto_db
 *
db
);

468 
	`mosquôto_£curôy_öô
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

469 
	`mosquôto_£curôy_≠∂y
(
mosquôto_db
 *
db
);

470 
	`mosquôto_£curôy_˛ónup
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

471 
	`mosquôto_a˛_check
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
ac˚ss
);

472 
	`mosquôto_u≈wd_check
(
mosquôto_db
 *
db
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

473 
	`mosquôto_psk_key_gë
(
mosquôto_db
 *
db
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
);

475 
	`mosquôto_£curôy_öô_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

476 
	`mosquôto_£curôy_≠∂y_deÁu…
(
mosquôto_db
 *
db
);

477 
	`mosquôto_£curôy_˛ónup_deÁu…
(
mosquôto_db
 *
db
, 
boﬁ
 
ªlﬂd
);

478 
	`mosquôto_a˛_check_deÁu…
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
, c⁄° *
t›ic
, 
ac˚ss
);

479 
	`mosquôto_u≈wd_check_deÁu…
(
mosquôto_db
 *
db
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

480 
	`mosquôto_psk_key_gë_deÁu…
(
mosquôto_db
 *
db
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
);

485 #i‡
	`deföed
(
WIN32
Ë|| deföed(
__CYGWIN__
)

486 
	`£rvi˚_ö°Æl
();

487 
	`£rvi˚_unö°Æl
();

488 
	`£rvi˚_run
();

494 #ifde‡
WITH_WEBSOCKETS


495 
libwebsockë_c⁄ãxt
 *
	`mosq_websockës_öô
(
_mqâ3_li°íî
 *
li°íî
, 
log_Àvñ
);

497 
	`do_disc⁄√˘
(
mosquôto_db
 *
db
, 
mosquôto
 *
c⁄ãxt
);

	@mosquitto_internal.h

17 #i‚de‡
_MOSQUITTO_INTERNAL_H_


18 
	#_MOSQUITTO_INTERNAL_H_


	)

20 
	~<c⁄fig.h
>

22 #ifde‡
WIN32


23 
	~<wösock2.h
>

26 #ifde‡
WITH_TLS


27 
	~<›ís¶/s¶.h
>

29 
	~<time.h
>

31 
	~<°dlib.h
>

33 #i‡
deföed
(
WITH_THREADING
Ë&& !deföed(
WITH_BROKER
)

34 
	~<±hªad.h
>

36 
	~<dummy±hªad.h
>

39 #ifde‡
WITH_SRV


40 
	~<¨es.h
>

43 #ifde‡
WIN32


44 #i‡
_MSC_VER
 < 1600

45 
	tuöt8_t
;

46 
	tuöt16_t
;

47 
	tuöt32_t
;

48 
	tuöt64_t
;

50 
	~<°döt.h
>

53 
	~<°döt.h
>

56 
	~"mosquôto.h
"

57 
	~"time_mosq.h
"

58 #ifde‡
WITH_BROKER


59 
	~"uthash.h
"

60 
	gmosquôto_˛õ¡_msg
;

63 #ifde‡
WIN32


64 
SOCKET
 
	tmosq_sock_t
;

66 
	tmosq_sock_t
;

69 
	emosquôto_msg_dúe˘i⁄
 {

70 
	mmosq_md_ö
 = 0,

71 
	mmosq_md_out
 = 1

74 
	emosquôto_msg_°©e
 {

75 
	mmosq_ms_övÆid
 = 0,

76 
	mmosq_ms_publish_qos0
 = 1,

77 
	mmosq_ms_publish_qos1
 = 2,

78 
	mmosq_ms_waô_f‹_puback
 = 3,

79 
	mmosq_ms_publish_qos2
 = 4,

80 
	mmosq_ms_waô_f‹_pubªc
 = 5,

81 
	mmosq_ms_ª£nd_pubªl
 = 6,

82 
	mmosq_ms_waô_f‹_pubªl
 = 7,

83 
	mmosq_ms_ª£nd_pubcomp
 = 8,

84 
	mmosq_ms_waô_f‹_pubcomp
 = 9,

85 
	mmosq_ms_£nd_pubªc
 = 10,

86 
	mmosq_ms_queued
 = 11

89 
	emosquôto_˛õ¡_°©e
 {

90 
	mmosq_cs_√w
 = 0,

91 
	mmosq_cs_c⁄√˘ed
 = 1,

92 
	mmosq_cs_disc⁄√˘ög
 = 2,

93 
	mmosq_cs_c⁄√˘_async
 = 3,

94 
	mmosq_cs_c⁄√˘_≥ndög
 = 4,

95 
	mmosq_cs_c⁄√˘_§v
 = 5,

96 
	mmosq_cs_disc⁄√˘_ws
 = 6,

97 
	mmosq_cs_disc⁄√˘ed
 = 7,

98 
	mmosq_cs_socks5_√w
 = 8,

99 
	mmosq_cs_socks5_°¨t
 = 9,

100 
	mmosq_cs_socks5_ªque°
 = 10,

101 
	mmosq_cs_socks5_ª∂y
 = 11,

102 
	mmosq_cs_socks5_auth_ok
 = 12,

103 
	mmosq_cs_socks5_u£Ωass_ª∂y
 = 13,

104 
	mmosq_cs_socks5_£nd_u£Ωass
 = 14,

105 
	mmosq_cs_expúög
 = 15,

108 
	e_mosquôto_¥Ÿocﬁ
 {

109 
	mmosq_p_övÆid
 = 0,

110 
	mmosq_p_mqâ31
 = 1,

111 
	mmosq_p_mqâ311
 = 2,

112 
	mmosq_p_mqâs
 = 3

115 
	e_mosquôto_å™•‹t
 {

116 
	mmosq_t_övÆid
 = 0,

117 
	mmosq_t_t˝
 = 1,

118 
	mmosq_t_ws
 = 2,

119 
	mmosq_t_s˘p
 = 3

122 
	s_mosquôto_∑ckë
{

123 
uöt8_t
 *
	m∑ylﬂd
;

124 
_mosquôto_∑ckë
 *
	m√xt
;

125 
uöt32_t
 
	mªmaöög_mu…
;

126 
uöt32_t
 
	mªmaöög_Àngth
;

127 
uöt32_t
 
	m∑ckë_Àngth
;

128 
uöt32_t
 
	mto_¥o˚ss
;

129 
uöt32_t
 
	mpos
;

130 
uöt16_t
 
	mmid
;

131 
uöt8_t
 
	mcomm™d
;

132 
öt8_t
 
	mªmaöög_cou¡
;

135 
	smosquôto_mesßge_Æl
{

136 
mosquôto_mesßge_Æl
 *
	m√xt
;

137 
time_t
 
	mtime°amp
;

139 
mosquôto_msg_°©e
 
	m°©e
;

140 
boﬁ
 
	mdup
;

141 
mosquôto_mesßge
 
	mmsg
;

144 
	smosquôto
 {

145 
mosq_sock_t
 
	msock
;

146 #i‚de‡
WITH_BROKER


147 
mosq_sock_t
 
	msock∑úR
, 
	msock∑úW
;

149 
_mosquôto_¥Ÿocﬁ
 
	m¥Ÿocﬁ
;

150 *
	maddªss
;

151 *
	mid
;

152 *
	mu£∫ame
;

153 *
	m∑ssw‹d
;

154 
uöt16_t
 
	mkì∑live
;

155 
uöt16_t
 
	mœ°_mid
;

156 
mosquôto_˛õ¡_°©e
 
	m°©e
;

157 
time_t
 
	mœ°_msg_ö
;

158 
time_t
 
	mœ°_msg_out
;

159 
time_t
 
	mpög_t
;

160 
_mosquôto_∑ckë
 
	mö_∑ckë
;

161 
_mosquôto_∑ckë
 *
	mcuºít_out_∑ckë
;

162 
_mosquôto_∑ckë
 *
	mout_∑ckë
;

163 
mosquôto_mesßge
 *
	mwûl
;

164 #ifde‡
WITH_TLS


165 
SSL
 *
	ms¶
;

166 
SSL_CTX
 *
	ms¶_˘x
;

167 *
	més_ˇfûe
;

168 *
	més_ˇ∑th
;

169 *
	més_˚πfûe
;

170 *
	més_keyfûe
;

171 (*
	més_pw_ˇŒback
)(*
	mbuf
, 
	msize
, 
	mrwÊag
, *
	mu£rd©a
);

172 *
	més_vîsi⁄
;

173 *
	més_cùhîs
;

174 *
	més_psk
;

175 *
	més_psk_idítôy
;

176 
	més_˚π_ªqs
;

177 
boﬁ
 
	més_ö£cuª
;

179 
boﬁ
 
	mw™t_wrôe
;

180 
boﬁ
 
	mw™t_c⁄√˘
;

181 #i‡
deföed
(
WITH_THREADING
Ë&& !deföed(
WITH_BROKER
)

182 
±hªad_muãx_t
 
	mˇŒback_muãx
;

183 
±hªad_muãx_t
 
	mlog_ˇŒback_muãx
;

184 
±hªad_muãx_t
 
	mmsgtime_muãx
;

185 
±hªad_muãx_t
 
	mout_∑ckë_muãx
;

186 
±hªad_muãx_t
 
	mcuºít_out_∑ckë_muãx
;

187 
±hªad_muãx_t
 
	m°©e_muãx
;

188 
±hªad_muãx_t
 
	mö_mesßge_muãx
;

189 
±hªad_muãx_t
 
	mout_mesßge_muãx
;

190 
±hªad_muãx_t
 
	mmid_muãx
;

191 
±hªad_t
 
	mthªad_id
;

193 
boﬁ
 
	m˛ón_£ssi⁄
;

194 #ifde‡
WITH_BROKER


195 
boﬁ
 
	mis_dr›pög
;

196 
boﬁ
 
	mis_bridge
;

197 
_mqâ3_bridge
 *
	mbridge
;

198 
mosquôto_˛õ¡_msg
 *
	mmsgs
;

199 
mosquôto_˛õ¡_msg
 *
	mœ°_msg
;

200 
	mmsg_cou¡
;

201 
	mmsg_cou¡12
;

202 
_mosquôto_a˛_u£r
 *
	ma˛_li°
;

203 
_mqâ3_li°íî
 *
	mli°íî
;

204 
time_t
 
	mdisc⁄√˘_t
;

205 
_mosquôto_∑ckë
 *
	mout_∑ckë_œ°
;

206 
_mosquôto_subhõr
 **
	msubs
;

207 
	msub_cou¡
;

208 
	mpﬁlfd_ödex
;

209 #ifde‡
WITH_WEBSOCKETS


210 
libwebsockë_c⁄ãxt
 *
	mws_c⁄ãxt
;

211 
libwebsockë
 *
	mwsi
;

214 #ifde‡
WITH_SOCKS


215 *
	msocks5_ho°
;

216 
	msocks5_p‹t
;

217 *
	msocks5_u£∫ame
;

218 *
	msocks5_∑ssw‹d
;

220 *
	mu£rd©a
;

221 
boﬁ
 
	mö_ˇŒback
;

222 
	mmesßge_ªåy
;

223 
time_t
 
	mœ°_ªåy_check
;

224 
mosquôto_mesßge_Æl
 *
	mö_mesßges
;

225 
mosquôto_mesßge_Æl
 *
	mö_mesßges_œ°
;

226 
mosquôto_mesßge_Æl
 *
	mout_mesßges
;

227 
mosquôto_mesßge_Æl
 *
	mout_mesßges_œ°
;

228 (*
	m⁄_c⁄√˘
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mrc
);

229 (*
	m⁄_disc⁄√˘
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mrc
);

230 (*
	m⁄_publish
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
);

231 (*
	m⁄_mesßge
)(
	mmosquôto
 *, *
	mu£rd©a
, c⁄° 
mosquôto_mesßge
 *
	mmesßge
);

232 (*
	m⁄_subs¸ibe
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
, 
	mqos_cou¡
, c⁄° *
	mgø¡ed_qos
);

233 (*
	m⁄_unsubs¸ibe
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mmid
);

234 (*
	m⁄_log
)(
	mmosquôto
 *, *
	mu£rd©a
, 
	mÀvñ
, c⁄° *
	m°r
);

236 *
	mho°
;

237 
	mp‹t
;

238 
	mö_queue_Àn
;

239 
	mout_queue_Àn
;

240 *
	mböd_addªss
;

241 
	mªc⁄√˘_dñay
;

242 
	mªc⁄√˘_dñay_max
;

243 
boﬁ
 
	mªc⁄√˘_exp⁄ítül_backoff
;

244 
boﬁ
 
	mthªaded
;

245 
_mosquôto_∑ckë
 *
	mout_∑ckë_œ°
;

246 
	möÊight_mesßges
;

247 
	mmax_öÊight_mesßges
;

248 #ifde‡
WITH_SRV


249 
¨es_ch™√l
 
	mach™
;

253 #ifde‡
WITH_BROKER


254 
UT_hash_h™dÀ
 
	mhh_id
;

255 
UT_hash_h™dÀ
 
	mhh_sock
;

256 
mosquôto
 *
	mf‹_‰ì_√xt
;

260 
	#STREMPTY
(
°r
Ë(°r[0] ='\0')

	)

	@mosquitto_plugin.h

17 #i‚de‡
MOSQUITTO_PLUGIN_H


18 
	#MOSQUITTO_PLUGIN_H


	)

20 
	#MOSQ_AUTH_PLUGIN_VERSION
 2

	)

22 
	#MOSQ_ACL_NONE
 0x00

	)

23 
	#MOSQ_ACL_READ
 0x01

	)

24 
	#MOSQ_ACL_WRITE
 0x02

	)

26 
	smosquôto_auth_›t
 {

27 *
	mkey
;

28 *
	mvÆue
;

69 
mosquôto_log_¥ötf
(
Àvñ
, c⁄° *
fmt
, ...);

88 
mosquôto_auth_∂ugö_vîsi⁄
();

109 
mosquôto_auth_∂ugö_öô
(**
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
);

129 
mosquôto_auth_∂ugö_˛ónup
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
);

153 
mosquôto_auth_£curôy_öô
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
);

177 
mosquôto_auth_£curôy_˛ónup
(*
u£r_d©a
, 
mosquôto_auth_›t
 *
auth_›ts
, 
auth_›t_cou¡
, 
boﬁ
 
ªlﬂd
);

187 
mosquôto_auth_a˛_check
(*
u£r_d©a
, c⁄° *
˛õ¡id
, c⁄° *
u£∫ame
, c⁄° *
t›ic
, 
ac˚ss
);

197 
mosquôto_auth_u≈wd_check
(*
u£r_d©a
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

221 
mosquôto_auth_psk_key_gë
(*
u£r_d©a
, c⁄° *
höt
, c⁄° *
idítôy
, *
key
, 
max_key_Àn
);

	@mqtt3_protocol.h

17 #i‚de‡
_MQTT3_PROTOCOL_H_


18 
	#_MQTT3_PROTOCOL_H_


	)

22 
	#PROTOCOL_NAME_v31
 "MQIsdp"

	)

23 
	#PROTOCOL_VERSION_v31
 3

	)

25 
	#PROTOCOL_NAME_v311
 "MQTT"

	)

26 
	#PROTOCOL_VERSION_v311
 4

	)

29 
	#CONNECT
 0x10

	)

30 
	#CONNACK
 0x20

	)

31 
	#PUBLISH
 0x30

	)

32 
	#PUBACK
 0x40

	)

33 
	#PUBREC
 0x50

	)

34 
	#PUBREL
 0x60

	)

35 
	#PUBCOMP
 0x70

	)

36 
	#SUBSCRIBE
 0x80

	)

37 
	#SUBACK
 0x90

	)

38 
	#UNSUBSCRIBE
 0xA0

	)

39 
	#UNSUBACK
 0xB0

	)

40 
	#PINGREQ
 0xC0

	)

41 
	#PINGRESP
 0xD0

	)

42 
	#DISCONNECT
 0xE0

	)

44 
	#CONNACK_ACCEPTED
 0

	)

45 
	#CONNACK_REFUSED_PROTOCOL_VERSION
 1

	)

46 
	#CONNACK_REFUSED_IDENTIFIER_REJECTED
 2

	)

47 
	#CONNACK_REFUSED_SERVER_UNAVAILABLE
 3

	)

48 
	#CONNACK_REFUSED_BAD_USERNAME_PASSWORD
 4

	)

49 
	#CONNACK_REFUSED_NOT_AUTHORIZED
 5

	)

51 
	#MQTT_MAX_PAYLOAD
 268435455

	)

	@tls_mosq.h

17 #i‚de‡
_TLS_MOSQ_H_


18 
	#_TLS_MOSQ_H_


	)

20 #ifde‡
WITH_TLS


21 
	#SSL_DATA_PENDING
(
A
Ë((A)->
s¶
 && 
	`SSL_≥ndög
((A)->s¶))

	)

23 
	#SSL_DATA_PENDING
(
A
Ë0

	)

26 #ifde‡
WITH_TLS


28 
	~<›ís¶/s¶.h
>

29 #ifde‡
WITH_TLS_PSK


30 #i‡
OPENSSL_VERSION_NUMBER
 >= 0x10000000

31 
	#REAL_WITH_TLS_PSK


	)

37 
_mosquôto_£rvî_˚πifiˇã_vîify
(
¥evîify_ok
, 
X509_STORE_CTX
 *
˘x
);

38 
_mosquôto_vîify_˚πifiˇã_ho°«me
(
X509
 *
˚π
, c⁄° *
ho°«me
);

	@uthash.h

24 #i‚de‡
UTHASH_H


25 
	#UTHASH_H


	)

27 
	~<°rög.h
>

28 
	~<°ddef.h
>

29 
	~<°dlib.h
>

35 #ifde‡
_MSC_VER


36 #i‡
_MSC_VER
 >1600 && 
deföed
(
__˝lu•lus
)

37 
	#DECLTYPE
(
x
Ë(
	`de˛ty≥
(x))

	)

39 
	#NO_DECLTYPE


	)

40 
	#DECLTYPE
(
x
)

	)

43 
	#DECLTYPE
(
x
Ë(
	`__ty≥of
(x))

	)

46 #ifde‡
NO_DECLTYPE


47 
	#DECLTYPE_ASSIGN
(
d°
,
§c
) \

49 **
_da_d°
 = (**)(&(
d°
)); \

50 *
_da_d°
 = (*)(
§c
); \

51 } 0)

	)

53 
	#DECLTYPE_ASSIGN
(
d°
,
§c
) \

55 (
d°
Ë
	`DECLTYPE
(d°)(
§c
); \

56 } 0)

	)

60 #ifde‡
_MSC_VER


61 
	tuöt32_t
;

62 
	tuöt8_t
;

64 
	~<öây≥s.h
>

67 
	#UTHASH_VERSION
 1.9.8

	)

69 #i‚de‡
uthash_Áèl


70 
	#uthash_Áèl
(
msg
Ë
	`exô
(-1Ë

	)

72 #i‚de‡
uthash_mÆloc


73 
	#uthash_mÆloc
(
sz
Ë
	`mÆloc
(szË

	)

75 #i‚de‡
uthash_‰ì


76 
	#uthash_‰ì
(
±r
,
sz
Ë
	`‰ì
’åË

	)

79 #i‚de‡
uthash_n€x∑nd_fyi


80 
	#uthash_n€x∑nd_fyi
(
tbl
Ë

	)

82 #i‚de‡
uthash_ex∑nd_fyi


83 
	#uthash_ex∑nd_fyi
(
tbl
Ë

	)

87 
	#HASH_INITIAL_NUM_BUCKETS
 32

	)

88 
	#HASH_INITIAL_NUM_BUCKETS_LOG2
 5

	)

89 
	#HASH_BKT_CAPACITY_THRESH
 10

	)

92 
	#ELMT_FROM_HH
(
tbl
,
hhp
Ë((*)(((*)(hhp)Ë- (—bl)->
hho
)))

	)

94 
	#HASH_FIND
(
hh
,
hód
,
key±r
,
keyÀn
,
out
) \

96 
_hf_bkt
,
_hf_hashv
; \

97 
out
=
NULL
; \

98 i‡(
hód
) { \

99 
	`HASH_FCN
(
key±r
,
keyÀn
, (
hód
)->
hh
.
tbl
->
num_buckës
, 
_hf_hashv
, 
_hf_bkt
); \

100 i‡(
	`HASH_BLOOM_TEST
((
hód
)->
hh
.
tbl
, 
_hf_hashv
)) { \

101 
	`HASH_FIND_IN_BKT
((
hód
)->
hh
.
tbl
, hh, (hód)->hh.tbl->
buckës
[ 
_hf_bkt
 ], \

102 
key±r
,
keyÀn
,
out
); \

105 } 0)

	)

107 #ifde‡
HASH_BLOOM


108 
	#HASH_BLOOM_BITLEN
 (1ULL << 
HASH_BLOOM
)

	)

109 
	#HASH_BLOOM_BYTELEN
 (
HASH_BLOOM_BITLEN
/8Ë+ ((HASH_BLOOM_BITLEN%8Ë? 1:0)

	)

110 
	#HASH_BLOOM_MAKE
(
tbl
) \

112 (
tbl
)->
bloom_nbôs
 = 
HASH_BLOOM
; \

113 (
tbl
)->
bloom_bv
 = (
uöt8_t
*)
	`uthash_mÆloc
(
HASH_BLOOM_BYTELEN
); \

114 i‡(!((
tbl
)->
bloom_bv
)Ë{ 
	`uthash_Áèl
( "out of memory"); } \

115 
	`mem£t
((
tbl
)->
bloom_bv
, 0, 
HASH_BLOOM_BYTELEN
); \

116 (
tbl
)->
bloom_sig
 = 
HASH_BLOOM_SIGNATURE
; \

117 } 0)

	)

119 
	#HASH_BLOOM_FREE
(
tbl
) \

121 
	`uthash_‰ì
((
tbl
)->
bloom_bv
, 
HASH_BLOOM_BYTELEN
); \

122 } 0)

	)

124 
	#HASH_BLOOM_BITSET
(
bv
,
idx
Ë(bv[(idx)/8] |(1U << ((idx)%8)))

	)

125 
	#HASH_BLOOM_BITTEST
(
bv
,
idx
Ë(bv[(idx)/8] & (1U << ((idx)%8)))

	)

127 
	#HASH_BLOOM_ADD
(
tbl
,
hashv
) \

128 
	`HASH_BLOOM_BITSET
((
tbl
)->
bloom_bv
, (
hashv
 & (
uöt32_t
)((1ULL << (tbl)->
bloom_nbôs
Ë- 1)))

	)

130 
	#HASH_BLOOM_TEST
(
tbl
,
hashv
) \

131 
	`HASH_BLOOM_BITTEST
((
tbl
)->
bloom_bv
, (
hashv
 & (
uöt32_t
)((1ULL << (tbl)->
bloom_nbôs
Ë- 1)))

	)

134 
	#HASH_BLOOM_MAKE
(
tbl
)

	)

135 
	#HASH_BLOOM_FREE
(
tbl
)

	)

136 
	#HASH_BLOOM_ADD
(
tbl
,
hashv
)

	)

137 
	#HASH_BLOOM_TEST
(
tbl
,
hashv
Ë(1)

	)

138 
	#HASH_BLOOM_BYTELEN
 0

	)

141 
	#HASH_MAKE_TABLE
(
hh
,
hód
) \

143 (
hód
)->
hh
.
tbl
 = (
UT_hash_èbÀ
*)
	`uthash_mÆloc
( \

144 (
UT_hash_èbÀ
)); \

145 i‡(!((
hód
)->
hh
.
tbl
)Ë{ 
	`uthash_Áèl
( "out of memory"); } \

146 
	`mem£t
((
hód
)->
hh
.
tbl
, 0, (
UT_hash_èbÀ
)); \

147 (
hód
)->
hh
.
tbl
->
èû
 = &((head)->hh); \

148 (
hód
)->
hh
.
tbl
->
num_buckës
 = 
HASH_INITIAL_NUM_BUCKETS
; \

149 (
hód
)->
hh
.
tbl
->
log2_num_buckës
 = 
HASH_INITIAL_NUM_BUCKETS_LOG2
; \

150 (
hód
)->
hh
.
tbl
->
hho
 = (*)(&(head)->hh) - (*)(head); \

151 (
hód
)->
hh
.
tbl
->
buckës
 = (
UT_hash_buckë
*)
	`uthash_mÆloc
( \

152 
HASH_INITIAL_NUM_BUCKETS
*(
UT_hash_buckë
)); \

153 i‡(! (
hód
)->
hh
.
tbl
->
buckës
Ë{ 
	`uthash_Áèl
( "out of memory"); } \

154 
	`mem£t
((
hód
)->
hh
.
tbl
->
buckës
, 0, \

155 
HASH_INITIAL_NUM_BUCKETS
*(
UT_hash_buckë
)); \

156 
	`HASH_BLOOM_MAKE
((
hód
)->
hh
.
tbl
); \

157 (
hód
)->
hh
.
tbl
->
sig«tuª
 = 
HASH_SIGNATURE
; \

158 } 0)

	)

160 
	#HASH_ADD
(
hh
,
hód
,
fõld«me
,
keyÀn_ö
,
add
) \

161 
	`HASH_ADD_KEYPTR
(
hh
,
hód
,&((
add
)->
fõld«me
),
keyÀn_ö
,add)

	)

163 
	#HASH_REPLACE
(
hh
,
hód
,
fõld«me
,
keyÀn_ö
,
add
,
ª∂a˚d
) \

165 
ª∂a˚d
=
NULL
; \

166 
	`HASH_FIND
(
hh
,
hód
,&((
add
)->
fõld«me
),
keyÀn_ö
,
ª∂a˚d
); \

167 i‡(
ª∂a˚d
!=
NULL
) { \

168 
	`HASH_DELETE
(
hh
,
hód
,
ª∂a˚d
); \

170 
	`HASH_ADD
(
hh
,
hód
,
fõld«me
,
keyÀn_ö
,
add
); \

171 } 0)

	)

173 
	#HASH_ADD_KEYPTR
(
hh
,
hód
,
key±r
,
keyÀn_ö
,
add
) \

175 
_ha_bkt
; \

176 (
add
)->
hh
.
√xt
 = 
NULL
; \

177 (
add
)->
hh
.
key
 = (*)
key±r
; \

178 (
add
)->
hh
.
keyÀn
 = ()
keyÀn_ö
; \

179 i‡(!(
hód
)) { \

180 
hód
 = (
add
); \

181 (
hód
)->
hh
.
¥ev
 = 
NULL
; \

182 
	`HASH_MAKE_TABLE
(
hh
,
hód
); \

184 (
hód
)->
hh
.
tbl
->
èû
->
√xt
 = (
add
); \

185 (
add
)->
hh
.
¥ev
 = 
	`ELMT_FROM_HH
((
hód
)->hh.
tbl
, (hód)->hh.tbl->
èû
); \

186 (
hód
)->
hh
.
tbl
->
èû
 = &((
add
)->hh); \

188 (
hód
)->
hh
.
tbl
->
num_ôems
++; \

189 (
add
)->
hh
.
tbl
 = (
hód
)->hh.tbl; \

190 
	`HASH_FCN
(
key±r
,
keyÀn_ö
, (
hód
)->
hh
.
tbl
->
num_buckës
, \

191 (
add
)->
hh
.
hashv
, 
_ha_bkt
); \

192 
	`HASH_ADD_TO_BKT
((
hód
)->
hh
.
tbl
->
buckës
[
_ha_bkt
],&(
add
)->hh); \

193 
	`HASH_BLOOM_ADD
((
hód
)->
hh
.
tbl
,(
add
)->hh.
hashv
); \

194 
	`HASH_EMIT_KEY
(
hh
,
hód
,
key±r
,
keyÀn_ö
); \

195 
	`HASH_FSCK
(
hh
,
hód
); \

196 } 0)

	)

198 
	#HASH_TO_BKT
–
hashv
, 
num_bkts
, 
bkt
 ) \

200 
bkt
 = ((
hashv
Ë& ((
num_bkts
) - 1)); \

201 } 0)

	)

215 
	#HASH_DELETE
(
hh
,
hód
,
dñ±r
) \

217 
_hd_bkt
; \

218 
UT_hash_h™dÀ
 *
_hd_hh_dñ
; \

219 i‡–((
dñ±r
)->
hh
.
¥ev
 =
NULL
Ë&& ((dñ±r)->hh.
√xt
 == NULL) ) { \

220 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
->
buckës
, \

221 (
hód
)->
hh
.
tbl
->
num_buckës
*(
UT_hash_buckë
) ); \

222 
	`HASH_BLOOM_FREE
((
hód
)->
hh
.
tbl
); \

223 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
, (
UT_hash_èbÀ
)); \

224 
hód
 = 
NULL
; \

226 
_hd_hh_dñ
 = &((
dñ±r
)->
hh
); \

227 i‡((
dñ±r
Ë=
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
,(hód)->hh.tbl->
èû
)) { \

228 (
hód
)->
hh
.
tbl
->
èû
 = \

229 (
UT_hash_h™dÀ
*)((
±rdiff_t
)((
dñ±r
)->
hh
.
¥ev
) + \

230 (
hód
)->
hh
.
tbl
->
hho
); \

232 i‡((
dñ±r
)->
hh
.
¥ev
) { \

233 ((
UT_hash_h™dÀ
*)((
±rdiff_t
)((
dñ±r
)->
hh
.
¥ev
) + \

234 (
hód
)->
hh
.
tbl
->
hho
))->
√xt
 = (
dñ±r
)->hh.next; \

236 
	`DECLTYPE_ASSIGN
(
hód
,(
dñ±r
)->
hh
.
√xt
); \

238 i‡(
_hd_hh_dñ
->
√xt
) { \

239 ((
UT_hash_h™dÀ
*)((
±rdiff_t
)
_hd_hh_dñ
->
√xt
 + \

240 (
hód
)->
hh
.
tbl
->
hho
))->
¥ev
 = \

241 
_hd_hh_dñ
->
¥ev
; \

243 
	`HASH_TO_BKT
–
_hd_hh_dñ
->
hashv
, (
hód
)->
hh
.
tbl
->
num_buckës
, 
_hd_bkt
); \

244 
	`HASH_DEL_IN_BKT
(
hh
,(
hód
)->hh.
tbl
->
buckës
[
_hd_bkt
], 
_hd_hh_dñ
); \

245 (
hód
)->
hh
.
tbl
->
num_ôems
--; \

247 
	`HASH_FSCK
(
hh
,
hód
); \

248 } 0)

	)

252 
	#HASH_FIND_STR
(
hód
,
föd°r
,
out
) \

253 
	`HASH_FIND
(
hh
,
hód
,
föd°r
,
	`°æí
(föd°r),
out
)

	)

254 
	#HASH_ADD_STR
(
hód
,
°rfõld
,
add
) \

255 
	`HASH_ADD
(
hh
,
hód
,
°rfõld
,
	`°æí
(
add
->°rfõld),add)

	)

256 
	#HASH_REPLACE_STR
(
hód
,
°rfõld
,
add
,
ª∂a˚d
) \

257 
	`HASH_REPLACE
(
hh
,
hód
,
°rfõld
,
	`°æí
(
add
->°rfõld),add,
ª∂a˚d
)

	)

258 
	#HASH_FIND_INT
(
hód
,
födöt
,
out
) \

259 
	`HASH_FIND
(
hh
,
hód
,
födöt
,(),
out
)

	)

260 
	#HASH_ADD_INT
(
hód
,
ötfõld
,
add
) \

261 
	`HASH_ADD
(
hh
,
hód
,
ötfõld
,(),
add
)

	)

262 
	#HASH_REPLACE_INT
(
hód
,
ötfõld
,
add
,
ª∂a˚d
) \

263 
	`HASH_REPLACE
(
hh
,
hód
,
ötfõld
,(),
add
,
ª∂a˚d
)

	)

264 
	#HASH_FIND_PTR
(
hód
,
föd±r
,
out
) \

265 
	`HASH_FIND
(
hh
,
hód
,
föd±r
,(*),
out
)

	)

266 
	#HASH_ADD_PTR
(
hód
,
±rfõld
,
add
) \

267 
	`HASH_ADD
(
hh
,
hód
,
±rfõld
,(*),
add
)

	)

268 
	#HASH_REPLACE_PTR
(
hód
,
±rfõld
,
add
) \

269 
	`HASH_REPLACE
(
hh
,
hód
,
±rfõld
,(*),
add
,
ª∂a˚d
)

	)

270 
	#HASH_DEL
(
hód
,
dñ±r
) \

271 
	`HASH_DELETE
(
hh
,
hód
,
dñ±r
)

	)

276 #ifde‡
HASH_DEBUG


277 
	#HASH_OOPS
(...Ëdÿ{ 
	`Ârötf
(
°dîr
,
__VA_ARGS__
); 
	`exô
(-1); } 0)

	)

278 
	#HASH_FSCK
(
hh
,
hód
) \

280 
_bkt_i
; \

281 
_cou¡
, 
_bkt_cou¡
; \

282 *
_¥ev
; \

283 
UT_hash_h™dÀ
 *
_thh
; \

284 i‡(
hód
) { \

285 
_cou¡
 = 0; \

286  
_bkt_i
 = 0; _bkt_ò< (
hód
)->
hh
.
tbl
->
num_buckës
; _bkt_i++) { \

287 
_bkt_cou¡
 = 0; \

288 
_thh
 = (
hód
)->
hh
.
tbl
->
buckës
[
_bkt_i
].
hh_hód
; \

289 
_¥ev
 = 
NULL
; \

290 
_thh
) { \

291 i‡(
_¥ev
 !(*)(
_thh
->
hh_¥ev
)) { \

292 
	`HASH_OOPS
("invalid hh_prev %p,áctual %p\n", \

293 
_thh
->
hh_¥ev
, 
_¥ev
 ); \

295 
_bkt_cou¡
++; \

296 
_¥ev
 = (*)(
_thh
); \

297 
_thh
 = _thh->
hh_√xt
; \

299 
_cou¡
 +
_bkt_cou¡
; \

300 i‡((
hód
)->
hh
.
tbl
->
buckës
[
_bkt_i
].
cou¡
 !
_bkt_cou¡
) { \

301 
	`HASH_OOPS
("invalid bucket count %d,áctual %d\n", \

302 (
hód
)->
hh
.
tbl
->
buckës
[
_bkt_i
].
cou¡
, 
_bkt_cou¡
); \

305 i‡(
_cou¡
 !(
hód
)->
hh
.
tbl
->
num_ôems
) { \

306 
	`HASH_OOPS
("invalid hh item count %d,áctual %d\n", \

307 (
hód
)->
hh
.
tbl
->
num_ôems
, 
_cou¡
 ); \

310 
_cou¡
 = 0; \

311 
_¥ev
 = 
NULL
; \

312 
_thh
 = &(
hód
)->
hh
; \

313 
_thh
) { \

314 
_cou¡
++; \

315 i‡(
_¥ev
 !=(*)(
_thh
->
¥ev
)) { \

316 
	`HASH_OOPS
("invalidÖrev %p,áctual %p\n", \

317 
_thh
->
¥ev
, 
_¥ev
 ); \

319 
_¥ev
 = (*)
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
, 
_thh
); \

320 
_thh
 = ( _thh->
√xt
 ? (
UT_hash_h™dÀ
*)((*)(_thh->next) + \

321 (
hód
)->
hh
.
tbl
->
hho
Ë: 
NULL
 ); \

323 i‡(
_cou¡
 !(
hód
)->
hh
.
tbl
->
num_ôems
) { \

324 
	`HASH_OOPS
("invalidápp item count %d,áctual %d\n", \

325 (
hód
)->
hh
.
tbl
->
num_ôems
, 
_cou¡
 ); \

328 } 0)

	)

330 
	#HASH_FSCK
(
hh
,
hód
)

	)

336 #ifde‡
HASH_EMIT_KEYS


337 
	#HASH_EMIT_KEY
(
hh
,
hód
,
key±r
,
fõldÀn
) \

339 
_kÀn
 = 
fõldÀn
; \

340 
	`wrôe
(
HASH_EMIT_KEYS
, &
_kÀn
, (_klen)); \

341 
	`wrôe
(
HASH_EMIT_KEYS
, 
key±r
, 
fõldÀn
); \

342 } 0)

	)

344 
	#HASH_EMIT_KEY
(
hh
,
hód
,
key±r
,
fõldÀn
)

	)

348 #ifde‡
HASH_FUNCTION


349 
	#HASH_FCN
 
HASH_FUNCTION


	)

351 
	#HASH_FCN
 
HASH_JEN


	)

355 
	#HASH_BER
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

357 
_hb_keyÀn
=
keyÀn
; \

358 *
_hb_key
=(*)(
key
); \

359 (
hashv
) = 0; \

360 
_hb_keyÀn
--Ë{ (
hashv
Ë((hashvË* 33Ë+ *
_hb_key
++; } \

361 
bkt
 = (
hashv
Ë& (
num_bkts
-1); \

362 } 0)

	)

367 
	#HASH_SAX
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

369 
_sx_i
; \

370 *
_hs_key
=(*)(
key
); \

371 
hashv
 = 0; \

372 
_sx_i
=0; _sx_ò< 
keyÀn
; _sx_i++) \

373 
hashv
 ^(hashv << 5Ë+ (hashv >> 2Ë+ 
_hs_key
[
_sx_i
]; \

374 
bkt
 = 
hashv
 & (
num_bkts
-1); \

375 } 0)

	)

377 
	#HASH_FNV
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

379 
_‚_i
; \

380 *
_hf_key
=(*)(
key
); \

381 
hashv
 = 2166136261UL; \

382 
_‚_i
=0; _‚_ò< 
keyÀn
; _fn_i++) \

383 
hashv
 = (hashv * 16777619Ë^ 
_hf_key
[
_‚_i
]; \

384 
bkt
 = 
hashv
 & (
num_bkts
-1); \

385 } 0)

	)

387 
	#HASH_OAT
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

389 
_ho_i
; \

390 *
_ho_key
=(*)(
key
); \

391 
hashv
 = 0; \

392 
_ho_i
=0; _ho_ò< 
keyÀn
; _ho_i++) { \

393 
hashv
 +
_ho_key
[
_ho_i
]; \

394 
hashv
 += (hashv << 10); \

395 
hashv
 ^= (hashv >> 6); \

397 
hashv
 += (hashv << 3); \

398 
hashv
 ^= (hashv >> 11); \

399 
hashv
 += (hashv << 15); \

400 
bkt
 = 
hashv
 & (
num_bkts
-1); \

401 } 0)

	)

403 
	#HASH_JEN_MIX
(
a
,
b
,
c
) \

405 
a
 -
b
;á -
c
;á ^= ( c >> 13 ); \

406 
b
 -
c
; b -
a
; b ^= (á << 8 ); \

407 
c
 -
a
; c -
b
; c ^= ( b >> 13 ); \

408 
a
 -
b
;á -
c
;á ^= ( c >> 12 ); \

409 
b
 -
c
; b -
a
; b ^= (á << 16 ); \

410 
c
 -
a
; c -
b
; c ^= ( b >> 5 ); \

411 
a
 -
b
;á -
c
;á ^= ( c >> 3 ); \

412 
b
 -
c
; b -
a
; b ^= (á << 10 ); \

413 
c
 -
a
; c -
b
; c ^= ( b >> 15 ); \

414 } 0)

	)

416 
	#HASH_JEN
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

418 
_hj_i
,
_hj_j
,
_hj_k
; \

419 *
_hj_key
=(*)(
key
); \

420 
hashv
 = 0xfeedbeef; \

421 
_hj_i
 = 
_hj_j
 = 0x9e3779b9; \

422 
_hj_k
 = ()
keyÀn
; \

423 
_hj_k
 >= 12) { \

424 
_hj_i
 +(
_hj_key
[0] + ( ()_hj_key[1] << 8 ) \

425 + ( ()
_hj_key
[2] << 16 ) \

426 + ( ()
_hj_key
[3] << 24 ) ); \

427 
_hj_j
 +(
_hj_key
[4] + ( ()_hj_key[5] << 8 ) \

428 + ( ()
_hj_key
[6] << 16 ) \

429 + ( ()
_hj_key
[7] << 24 ) ); \

430 
hashv
 +(
_hj_key
[8] + ( ()_hj_key[9] << 8 ) \

431 + ( ()
_hj_key
[10] << 16 ) \

432 + ( ()
_hj_key
[11] << 24 ) ); \

434 
	`HASH_JEN_MIX
(
_hj_i
, 
_hj_j
, 
hashv
); \

436 
_hj_key
 += 12; \

437 
_hj_k
 -= 12; \

439 
hashv
 +
keyÀn
; \

440  
_hj_k
 ) { \

441 11: 
hashv
 +–()
_hj_key
[10] << 24 ); \

442 10: 
hashv
 +–()
_hj_key
[9] << 16 ); \

443 9: 
hashv
 +–()
_hj_key
[8] << 8 ); \

444 8: 
_hj_j
 +–()
_hj_key
[7] << 24 ); \

445 7: 
_hj_j
 +–()
_hj_key
[6] << 16 ); \

446 6: 
_hj_j
 +–()
_hj_key
[5] << 8 ); \

447 5: 
_hj_j
 +
_hj_key
[4]; \

448 4: 
_hj_i
 +–()
_hj_key
[3] << 24 ); \

449 3: 
_hj_i
 +–()
_hj_key
[2] << 16 ); \

450 2: 
_hj_i
 +–()
_hj_key
[1] << 8 ); \

451 1: 
_hj_i
 +
_hj_key
[0]; \

453 
	`HASH_JEN_MIX
(
_hj_i
, 
_hj_j
, 
hashv
); \

454 
bkt
 = 
hashv
 & (
num_bkts
-1); \

455 } 0)

	)

458 #unde‡
gë16bôs


459 #i‡(
deföed
(
__GNUC__
Ë&& deföed(
__i386__
)Ë|| deföed(
__WATCOMC__
) \

460 || 
deföed
(
_MSC_VER
Ë|| deföed (
__BORLANDC__
Ë|| 
	$deföed
 (
__TURBOC__
)

461 
	#gë16bôs
(
d
Ë(*((c⁄° 
uöt16_t
 *Ë(d)))

	)

464 #i‡!
	`deföed
 (
gë16bôs
)

465 
	#gë16bôs
(
d
Ë((((
uöt32_t
)(((c⁄° 
uöt8_t
 *)(d))[1])) << 8) \

466 +(
uöt32_t
)(((c⁄° 
uöt8_t
 *)(
d
))[0]Ë)

	)

468 
	#HASH_SFH
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

470 *
_sfh_key
=(*)(
key
); \

471 
uöt32_t
 
_sfh_tmp
, 
_sfh_Àn
 = 
keyÀn
; \

473 
_sfh_ªm
 = 
_sfh_Àn
 & 3; \

474 
_sfh_Àn
 >>= 2; \

475 
hashv
 = 0xcafebabe; \

478 ;
_sfh_Àn
 > 0; _sfh_len--) { \

479 
hashv
 +
	`gë16bôs
 (
_sfh_key
); \

480 
_sfh_tmp
 = (
uöt32_t
)(
	`gë16bôs
 (
_sfh_key
+2)Ë<< 11 ^ 
hashv
; \

481 
hashv
 = (hashv << 16Ë^ 
_sfh_tmp
; \

482 
_sfh_key
 +2* (
uöt16_t
); \

483 
hashv
 += hashv >> 11; \

487 
_sfh_ªm
) { \

488 3: 
hashv
 +
	`gë16bôs
 (
_sfh_key
); \

489 
hashv
 ^= hashv << 16; \

490 
hashv
 ^(
uöt32_t
)(
_sfh_key
[ (
uöt16_t
)] << 18); \

491 
hashv
 += hashv >> 11; \

493 2: 
hashv
 +
	`gë16bôs
 (
_sfh_key
); \

494 
hashv
 ^= hashv << 11; \

495 
hashv
 += hashv >> 17; \

497 1: 
hashv
 +*
_sfh_key
; \

498 
hashv
 ^= hashv << 10; \

499 
hashv
 += hashv >> 1; \

503 
hashv
 ^= hashv << 3; \

504 
hashv
 += hashv >> 5; \

505 
hashv
 ^= hashv << 4; \

506 
hashv
 += hashv >> 17; \

507 
hashv
 ^= hashv << 25; \

508 
hashv
 += hashv >> 6; \

509 
bkt
 = 
hashv
 & (
num_bkts
-1); \

510 
	}
} 0)

	)

512 #ifde‡
HASH_USING_NO_STRICT_ALIASING


522 #i‡(
deföed
(
__i386__
Ë|| deföed(
__x86_64__
Ë|| deföed(
_M_IX86
))

523 
	#MUR_GETBLOCK
(
p
,
i
Ëp[i]

	)

525 
	#MUR_PLUS0_ALIGNED
(
p
Ë(((Ì & 0x3Ë=0)

	)

526 
	#MUR_PLUS1_ALIGNED
(
p
Ë(((Ì & 0x3Ë=1)

	)

527 
	#MUR_PLUS2_ALIGNED
(
p
Ë(((Ì & 0x3Ë=2)

	)

528 
	#MUR_PLUS3_ALIGNED
(
p
Ë(((Ì & 0x3Ë=3)

	)

529 
	#WP
(
p
Ë((
uöt32_t
*)(()’Ë& ~3UL))

	)

530 #i‡(
deföed
(
__BIG_ENDIAN__
Ë|| deföed(
SPARC
Ë|| deföed(
__µc__
Ë|| deföed(
__µc64__
))

531 
	#MUR_THREE_ONE
(
p
Ë((((*
	`WP
’))&0x00ffffffË<< 8Ë| (((*(WP’)+1))&0xff000000Ë>> 24))

	)

532 
	#MUR_TWO_TWO
(
p
Ë((((*
	`WP
’))&0x0000ffffË<<16Ë| (((*(WP’)+1))&0xffff0000Ë>> 16))

	)

533 
	#MUR_ONE_THREE
(
p
Ë((((*
	`WP
’))&0x000000ffË<<24Ë| (((*(WP’)+1))&0xffffff00Ë>> 8))

	)

535 
	#MUR_THREE_ONE
(
p
Ë((((*
	`WP
’))&0xffffff00Ë>> 8Ë| (((*(WP’)+1))&0x000000ffË<< 24))

	)

536 
	#MUR_TWO_TWO
(
p
Ë((((*
	`WP
’))&0xffff0000Ë>>16Ë| (((*(WP’)+1))&0x0000ffffË<< 16))

	)

537 
	#MUR_ONE_THREE
(
p
Ë((((*
	`WP
’))&0xff000000Ë>>24Ë| (((*(WP’)+1))&0x00ffffffË<< 8))

	)

539 
	#MUR_GETBLOCK
(
p
,
i
Ë(
	`MUR_PLUS0_ALIGNED
(p) ? ((p)[i]) : \

540 (
	`MUR_PLUS1_ALIGNED
(
p
Ë? 
	`MUR_THREE_ONE
(p) : \

541 (
	`MUR_PLUS2_ALIGNED
(
p
Ë? 
	`MUR_TWO_TWO
(p) : \

542 
	`MUR_ONE_THREE
(
p
))))

	)

544 
	#MUR_ROTL32
(
x
,
r
Ë(((xË<< (r)Ë| ((xË>> (32 - (r))))

	)

545 
	#MUR_FMIX
(
_h
) \

547 
_h
 ^= _h >> 16; \

548 
_h
 *= 0x85ebca6b; \

549 
_h
 ^= _h >> 13; \

550 
_h
 *= 0xc2b2ae35l; \

551 
_h
 ^= _h >> 16; \

552 } 0)

	)

554 
	#HASH_MUR
(
key
,
keyÀn
,
num_bkts
,
hashv
,
bkt
) \

556 c⁄° 
uöt8_t
 *
_mur_d©a
 = (c⁄° uöt8_t*)(
key
); \

557 c⁄° 
_mur_nblocks
 = (
keyÀn
) / 4; \

558 
uöt32_t
 
_mur_h1
 = 0xf88D5353; \

559 
uöt32_t
 
_mur_c1
 = 0xcc9e2d51; \

560 
uöt32_t
 
_mur_c2
 = 0x1b873593; \

561 
uöt32_t
 
_mur_k1
 = 0; \

562 c⁄° 
uöt8_t
 *
_mur_èû
; \

563 c⁄° 
uöt32_t
 *
_mur_blocks
 = (c⁄° uöt32_t*)(
_mur_d©a
+
_mur_nblocks
*4); \

564 
_mur_i
; \

565 
_mur_i
 = -
_mur_nblocks
; _mur_i; _mur_i++) { \

566 
_mur_k1
 = 
	`MUR_GETBLOCK
(
_mur_blocks
,
_mur_i
); \

567 
_mur_k1
 *
_mur_c1
; \

568 
_mur_k1
 = 
	`MUR_ROTL32
(_mur_k1,15); \

569 
_mur_k1
 *
_mur_c2
; \

571 
_mur_h1
 ^
_mur_k1
; \

572 
_mur_h1
 = 
	`MUR_ROTL32
(_mur_h1,13); \

573 
_mur_h1
 = _mur_h1*5+0xe6546b64; \

575 
_mur_èû
 = (c⁄° 
uöt8_t
*)(
_mur_d©a
 + 
_mur_nblocks
*4); \

576 
_mur_k1
=0; \

577 (
keyÀn
) & 3) { \

578 3: 
_mur_k1
 ^
_mur_èû
[2] << 16; \

579 2: 
_mur_k1
 ^
_mur_èû
[1] << 8; \

580 1: 
_mur_k1
 ^
_mur_èû
[0]; \

581 
_mur_k1
 *
_mur_c1
; \

582 
_mur_k1
 = 
	`MUR_ROTL32
(_mur_k1,15); \

583 
_mur_k1
 *
_mur_c2
; \

584 
_mur_h1
 ^
_mur_k1
; \

586 
_mur_h1
 ^(
keyÀn
); \

587 
	`MUR_FMIX
(
_mur_h1
); \

588 
hashv
 = 
_mur_h1
; \

589 
bkt
 = 
hashv
 & (
num_bkts
-1); \

590 } 0)

	)

594 
	#HASH_KEYCMP
(
a
,
b
,
Àn
Ë
	`memcmp
◊,b,Àn)

	)

597 
	#HASH_FIND_IN_BKT
(
tbl
,
hh
,
hód
,
key±r
,
keyÀn_ö
,
out
) \

599 i‡(
hód
.
hh_hód
Ë
	`DECLTYPE_ASSIGN
(
out
,
	`ELMT_FROM_HH
(
tbl
,head.hh_head)); \

600 
out
=
NULL
; \

601 
out
) { \

602 i‡((
out
)->
hh
.
keyÀn
 =
keyÀn_ö
) { \

603 i‡((
	`HASH_KEYCMP
((
out
)->
hh
.
key
,
key±r
,
keyÀn_ö
)) == 0) ; \

605 i‡((
out
)->
hh
.
hh_√xt
Ë
	`DECLTYPE_ASSIGN
(out,
	`ELMT_FROM_HH
(
tbl
,(out)->hh.hh_next)); \

606 
out
 = 
NULL
; \

608 } 0)

	)

611 
	#HASH_ADD_TO_BKT
(
hód
,
addhh
) \

613 
hód
.
cou¡
++; \

614 (
addhh
)->
hh_√xt
 = 
hód
.
hh_hód
; \

615 (
addhh
)->
hh_¥ev
 = 
NULL
; \

616 i‡(
hód
.
hh_hód
Ë{ (hód).hh_hód->
hh_¥ev
 = (
addhh
); } \

617 (
hód
).
hh_hód
=
addhh
; \

618 i‡(
hód
.
cou¡
 >((hód.
ex∑nd_mu…
+1Ë* 
HASH_BKT_CAPACITY_THRESH
) \

619 && (
addhh
)->
tbl
->
n€x∑nd
 != 1) { \

620 
	`HASH_EXPAND_BUCKETS
((
addhh
)->
tbl
); \

622 } 0)

	)

625 
	#HASH_DEL_IN_BKT
(
hh
,
hód
,
hh_dñ
) \

626 (
hód
).
cou¡
--; \

627 i‡((
hód
).
hh_hód
 =
hh_dñ
) { \

628 (
hód
).
hh_hód
 = 
hh_dñ
->
hh_√xt
; \

630 i‡(
hh_dñ
->
hh_¥ev
) { \

631 
hh_dñ
->
hh_¥ev
->
hh_√xt
 = hh_del->hh_next; \

633 i‡(
hh_dñ
->
hh_√xt
) { \

634 
hh_dñ
->
hh_√xt
->
hh_¥ev
 = hh_del->hh_prev; \

635 }

	)

666 
	#HASH_EXPAND_BUCKETS
(
tbl
) \

668 
_he_bkt
; \

669 
_he_bkt_i
; \

670 
UT_hash_h™dÀ
 *
_he_thh
, *
_he_hh_nxt
; \

671 
UT_hash_buckë
 *
_he_√w_buckës
, *
_he_√wbkt
; \

672 
_he_√w_buckës
 = (
UT_hash_buckë
*)
	`uthash_mÆloc
( \

673 2 * 
tbl
->
num_buckës
 * (
UT_hash_buckë
)); \

674 i‡(!
_he_√w_buckës
Ë{ 
	`uthash_Áèl
( "out of memory"); } \

675 
	`mem£t
(
_he_√w_buckës
, 0, \

676 2 * 
tbl
->
num_buckës
 * (
UT_hash_buckë
)); \

677 
tbl
->
idól_chaö_maxÀn
 = \

678 (
tbl
->
num_ôems
 >> (tbl->
log2_num_buckës
+1)) + \

679 ((
tbl
->
num_ôems
 & (—bl->
num_buckës
*2)-1)) ? 1 : 0); \

680 
tbl
->
n⁄idól_ôems
 = 0; \

681 
_he_bkt_i
 = 0; _he_bkt_ò< 
tbl
->
num_buckës
; _he_bkt_i++) \

683 
_he_thh
 = 
tbl
->
buckës
[ 
_he_bkt_i
 ].
hh_hód
; \

684 
_he_thh
) { \

685 
_he_hh_nxt
 = 
_he_thh
->
hh_√xt
; \

686 
	`HASH_TO_BKT
–
_he_thh
->
hashv
, 
tbl
->
num_buckës
*2, 
_he_bkt
); \

687 
_he_√wbkt
 = &(
_he_√w_buckës
[ 
_he_bkt
 ]); \

688 i‡(++(
_he_√wbkt
->
cou¡
Ë> 
tbl
->
idól_chaö_maxÀn
) { \

689 
tbl
->
n⁄idól_ôems
++; \

690 
_he_√wbkt
->
ex∑nd_mu…
 = _he_√wbkt->
cou¡
 / \

691 
tbl
->
idól_chaö_maxÀn
; \

693 
_he_thh
->
hh_¥ev
 = 
NULL
; \

694 
_he_thh
->
hh_√xt
 = 
_he_√wbkt
->
hh_hód
; \

695 i‡(
_he_√wbkt
->
hh_hód
Ë_he_√wbkt->hh_hód->
hh_¥ev
 = \

696 
_he_thh
; \

697 
_he_√wbkt
->
hh_hód
 = 
_he_thh
; \

698 
_he_thh
 = 
_he_hh_nxt
; \

701 
	`uthash_‰ì
–
tbl
->
buckës
,Åbl->
num_buckës
*(
UT_hash_buckë
) ); \

702 
tbl
->
num_buckës
 *= 2; \

703 
tbl
->
log2_num_buckës
++; \

704 
tbl
->
buckës
 = 
_he_√w_buckës
; \

705 
tbl
->
öeff_ex∑nds
 = (tbl->
n⁄idól_ôems
 > (tbl->
num_ôems
 >> 1)) ? \

706 (
tbl
->
öeff_ex∑nds
+1) : 0; \

707 i‡(
tbl
->
öeff_ex∑nds
 > 1) { \

708 
tbl
->
n€x∑nd
=1; \

709 
	`uthash_n€x∑nd_fyi
(
tbl
); \

711 
	`uthash_ex∑nd_fyi
(
tbl
); \

712 } 0)

	)

718 
	#HASH_SORT
(
hód
,
cmpf˙
Ë
	`HASH_SRT
(
hh
,hód,cmpf˙)

	)

719 
	#HASH_SRT
(
hh
,
hód
,
cmpf˙
) \

721 
_hs_i
; \

722 
_hs_lo›ög
,
_hs_nmîges
,
_hs_ösize
,
_hs_psize
,
_hs_qsize
; \

723 
UT_hash_h™dÀ
 *
_hs_p
, *
_hs_q
, *
_hs_e
, *
_hs_li°
, *
_hs_èû
; \

724 i‡(
hód
) { \

725 
_hs_ösize
 = 1; \

726 
_hs_lo›ög
 = 1; \

727 
_hs_li°
 = &((
hód
)->
hh
); \

728 
_hs_lo›ög
) { \

729 
_hs_p
 = 
_hs_li°
; \

730 
_hs_li°
 = 
NULL
; \

731 
_hs_èû
 = 
NULL
; \

732 
_hs_nmîges
 = 0; \

733 
_hs_p
) { \

734 
_hs_nmîges
++; \

735 
_hs_q
 = 
_hs_p
; \

736 
_hs_psize
 = 0; \

737  
_hs_i
 = 0; _hs_ò< 
_hs_ösize
; _hs_i++ ) { \

738 
_hs_psize
++; \

739 
_hs_q
 = (
UT_hash_h™dÀ
*)((_hs_q->
√xt
) ? \

740 ((*)((*)(
_hs_q
->
√xt
) + \

741 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

742 i‡(! (
_hs_q
) ) ; \

744 
_hs_qsize
 = 
_hs_ösize
; \

745 (
_hs_psize
 > 0Ë|| ((
_hs_qsize
 > 0Ë&& 
_hs_q
 )) { \

746 i‡(
_hs_psize
 == 0) { \

747 
_hs_e
 = 
_hs_q
; \

748 
_hs_q
 = (
UT_hash_h™dÀ
*)((_hs_q->
√xt
) ? \

749 ((*)((*)(
_hs_q
->
√xt
) + \

750 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

751 
_hs_qsize
--; \

752 } i‡–(
_hs_qsize
 =0Ë|| !(
_hs_q
) ) { \

753 
_hs_e
 = 
_hs_p
; \

754 i‡(
_hs_p
){ \

755 
_hs_p
 = (
UT_hash_h™dÀ
*)((_hs_p->
√xt
) ? \

756 ((*)((*)(
_hs_p
->
√xt
) + \

757 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

759 
_hs_psize
--; \

761 
	`cmpf˙
(
	`DECLTYPE
(
hód
)(
	`ELMT_FROM_HH
((hód)->
hh
.
tbl
,
_hs_p
)), \

762 
	`DECLTYPE
(
hód
)(
	`ELMT_FROM_HH
((hód)->
hh
.
tbl
,
_hs_q
))) \

764 
_hs_e
 = 
_hs_p
; \

765 i‡(
_hs_p
){ \

766 
_hs_p
 = (
UT_hash_h™dÀ
*)((_hs_p->
√xt
) ? \

767 ((*)((*)(
_hs_p
->
√xt
) + \

768 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

770 
_hs_psize
--; \

772 
_hs_e
 = 
_hs_q
; \

773 
_hs_q
 = (
UT_hash_h™dÀ
*)((_hs_q->
√xt
) ? \

774 ((*)((*)(
_hs_q
->
√xt
) + \

775 (
hód
)->
hh
.
tbl
->
hho
)Ë: 
NULL
); \

776 
_hs_qsize
--; \

778 i‡–
_hs_èû
 ) { \

779 
_hs_èû
->
√xt
 = ((
_hs_e
) ? \

780 
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
,
_hs_e
Ë: 
NULL
); \

782 
_hs_li°
 = 
_hs_e
; \

784 i‡(
_hs_e
) { \

785 
_hs_e
->
¥ev
 = ((
_hs_èû
) ? \

786 
	`ELMT_FROM_HH
((
hód
)->
hh
.
tbl
,
_hs_èû
Ë: 
NULL
); \

788 
_hs_èû
 = 
_hs_e
; \

790 
_hs_p
 = 
_hs_q
; \

792 i‡(
_hs_èû
){ \

793 
_hs_èû
->
√xt
 = 
NULL
; \

795 i‡–
_hs_nmîges
 <= 1 ) { \

796 
_hs_lo›ög
=0; \

797 (
hód
)->
hh
.
tbl
->
èû
 = 
_hs_èû
; \

798 
	`DECLTYPE_ASSIGN
(
hód
,
	`ELMT_FROM_HH
((hód)->
hh
.
tbl
, 
_hs_li°
)); \

800 
_hs_ösize
 *= 2; \

802 
	`HASH_FSCK
(
hh
,
hód
); \

804 } 0)

	)

811 
	#HASH_SELECT
(
hh_d°
, 
d°
, 
hh_§c
, 
§c
, 
c⁄d
) \

813 
_§c_bkt
, 
_d°_bkt
; \

814 *
_œ°_ñt
=
NULL
, *
_ñt
; \

815 
UT_hash_h™dÀ
 *
_§c_hh
, *
_d°_hh
, *
_œ°_ñt_hh
=
NULL
; \

816 
±rdiff_t
 
_d°_hho
 = ((*)(&(
d°
)->
hh_d°
) - (*)(dst)); \

817 i‡(
§c
) { \

818 
_§c_bkt
=0; _§c_bkà< (
§c
)->
hh_§c
.
tbl
->
num_buckës
; _src_bkt++) { \

819 
_§c_hh
 = (
§c
)->
hh_§c
.
tbl
->
buckës
[
_§c_bkt
].
hh_hód
; \

820 
_§c_hh
; \

821 
_§c_hh
 = _§c_hh->
hh_√xt
) { \

822 
_ñt
 = 
	`ELMT_FROM_HH
((
§c
)->
hh_§c
.
tbl
, 
_§c_hh
); \

823 i‡(
	`c⁄d
(
_ñt
)) { \

824 
_d°_hh
 = (
UT_hash_h™dÀ
*)(((*)
_ñt
Ë+ 
_d°_hho
); \

825 
_d°_hh
->
key
 = 
_§c_hh
->key; \

826 
_d°_hh
->
keyÀn
 = 
_§c_hh
->keylen; \

827 
_d°_hh
->
hashv
 = 
_§c_hh
->hashv; \

828 
_d°_hh
->
¥ev
 = 
_œ°_ñt
; \

829 
_d°_hh
->
√xt
 = 
NULL
; \

830 i‡(
_œ°_ñt_hh
Ë{ _œ°_ñt_hh->
√xt
 = 
_ñt
; } \

831 i‡(!
d°
) { \

832 
	`DECLTYPE_ASSIGN
(
d°
,
_ñt
); \

833 
	`HASH_MAKE_TABLE
(
hh_d°
,
d°
); \

835 
_d°_hh
->
tbl
 = (
d°
)->
hh_d°
.tbl; \

837 
	`HASH_TO_BKT
(
_d°_hh
->
hashv
, _d°_hh->
tbl
->
num_buckës
, 
_d°_bkt
); \

838 
	`HASH_ADD_TO_BKT
(
_d°_hh
->
tbl
->
buckës
[
_d°_bkt
],_dst_hh); \

839 (
d°
)->
hh_d°
.
tbl
->
num_ôems
++; \

840 
_œ°_ñt
 = 
_ñt
; \

841 
_œ°_ñt_hh
 = 
_d°_hh
; \

846 
	`HASH_FSCK
(
hh_d°
,
d°
); \

847 } 0)

	)

849 
	#HASH_CLEAR
(
hh
,
hód
) \

851 i‡(
hód
) { \

852 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
->
buckës
, \

853 (
hód
)->
hh
.
tbl
->
num_buckës
*(
UT_hash_buckë
)); \

854 
	`HASH_BLOOM_FREE
((
hód
)->
hh
.
tbl
); \

855 
	`uthash_‰ì
((
hód
)->
hh
.
tbl
, (
UT_hash_èbÀ
)); \

856 (
hód
)=
NULL
; \

858 } 0)

	)

860 
	#HASH_OVERHEAD
(
hh
,
hód
) \

861 (
size_t
)((((
hód
)->
hh
.
tbl
->
num_ôems
 * (
UT_hash_h™dÀ
)) + \

862 ((
hód
)->
hh
.
tbl
->
num_buckës
 * (
UT_hash_buckë
)) + \

863 ((
UT_hash_èbÀ
)) + \

864 (
HASH_BLOOM_BYTELEN
)))

	)

866 #ifde‡
NO_DECLTYPE


867 
	#HASH_ITER
(
hh
,
hód
,
ñ
,
tmp
) \

868 (
ñ
)=(
hód
), (*(**)(&(
tmp
)))=(*)((hód)?(hód)->
hh
.
√xt
:
NULL
); \

869 
ñ
; (ñ)=(
tmp
),(*(**)(&—mp)))=(*)(—mp)?—mp)->
hh
.
√xt
:
NULL
))

	)

871 
	#HASH_ITER
(
hh
,
hód
,
ñ
,
tmp
) \

872 (
ñ
)=(
hód
),(
tmp
)=
	`DECLTYPE
”l)((hód)?(hód)->
hh
.
√xt
:
NULL
); \

873 
ñ
; (ñ)=(
tmp
),—mp)=
	`DECLTYPE
”l)(—mp)?—mp)->
hh
.
√xt
:
NULL
))

	)

877 
	#HASH_COUNT
(
hód
Ë
	`HASH_CNT
(
hh
,hód)

	)

878 
	#HASH_CNT
(
hh
,
hód
Ë((hód)?((hód)->hh.
tbl
->
num_ôems
):0)

	)

880 
	sUT_hash_buckë
 {

881 
UT_hash_h™dÀ
 *
	mhh_hód
;

882 
	mcou¡
;

896 
	mex∑nd_mu…
;

898 } 
	tUT_hash_buckë
;

901 
	#HASH_SIGNATURE
 0xa0111„1

	)

902 
	#HASH_BLOOM_SIGNATURE
 0xb12220f2

	)

904 
	sUT_hash_èbÀ
 {

905 
UT_hash_buckë
 *
	mbuckës
;

906 
	mnum_buckës
, 
	mlog2_num_buckës
;

907 
	mnum_ôems
;

908 
UT_hash_h™dÀ
 *
	mèû
;

909 
±rdiff_t
 
	mhho
;

913 
	midól_chaö_maxÀn
;

918 
	mn⁄idól_ôems
;

926 
	möeff_ex∑nds
, 
	mn€x∑nd
;

928 
uöt32_t
 
	msig«tuª
;

929 #ifde‡
HASH_BLOOM


930 
uöt32_t
 
	mbloom_sig
;

931 
uöt8_t
 *
	mbloom_bv
;

932 
	mbloom_nbôs
;

935 } 
	tUT_hash_èbÀ
;

937 
	sUT_hash_h™dÀ
 {

938 
UT_hash_èbÀ
 *
	mtbl
;

939 *
	m¥ev
;

940 *
	m√xt
;

941 
UT_hash_h™dÀ
 *
	mhh_¥ev
;

942 
UT_hash_h™dÀ
 *
	mhh_√xt
;

943 *
	mkey
;

944 
	mkeyÀn
;

945 
	mhashv
;

946 } 
	tUT_hash_h™dÀ
;

	@util_mosq.h

16 #i‚de‡
_UTIL_MOSQ_H_


17 
	#_UTIL_MOSQ_H_


	)

19 
	~<°dio.h
>

21 
	~"és_mosq.h
"

22 
	~"mosquôto.h
"

23 
	~"mosquôto_öã∫Æ.h
"

24 #ifde‡
WITH_BROKER


25 
	~"mosquôto_brokî.h
"

28 
_mosquôto_∑ckë_Æloc
(
_mosquôto_∑ckë
 *
∑ckë
);

29 #ifde‡
WITH_BROKER


30 
_mosquôto_check_kì∑live
(
mosquôto_db
 *
db
, 
mosquôto
 *
mosq
);

32 
_mosquôto_check_kì∑live
(
mosquôto
 *
mosq
);

34 
uöt16_t
 
_mosquôto_mid_gíî©e
(
mosquôto
 *
mosq
);

35 
FILE
 *
_mosquôto_f›í
(c⁄° *
∑th
, c⁄° *
mode
);

37 #ifde‡
REAL_WITH_TLS_PSK


38 
_mosquôto_hex2bö
(c⁄° *
hex
, *
bö
, 
bö_max_Àn
);

	@mosquitto.h

17 #i‚de‡
_MOSQUITTO_H_


18 
	#_MOSQUITTO_H_


	)

20 #ifde‡
__˝lu•lus


24 #i‡
deföed
(
WIN32
Ë&& !deföed(
WITH_BROKER
)

25 #ifde‡
libmosquôto_EXPORTS


26 
	#libmosq_EXPORT
 
	`__de˛•ec
(
dŒexp‹t
)

	)

28 
	#libmosq_EXPORT
 
	`__de˛•ec
(
dŒimp‹t
)

	)

31 
	#libmosq_EXPORT


	)

34 #ifde‡
WIN32


35 #i‚de‡
__˝lu•lus


36 
	#boﬁ
 

	)

37 
	#åue
 1

	)

38 
	#Ál£
 0

	)

41 #i‚de‡
__˝lu•lus


42 
	~<°dboﬁ.h
>

46 
	#LIBMOSQUITTO_MAJOR
 1

	)

47 
	#LIBMOSQUITTO_MINOR
 4

	)

48 
	#LIBMOSQUITTO_REVISION
 3

	)

50 
	#LIBMOSQUITTO_VERSION_NUMBER
 (
LIBMOSQUITTO_MAJOR
*1000000+
LIBMOSQUITTO_MINOR
*1000+
LIBMOSQUITTO_REVISION
)

	)

53 
	#MOSQ_LOG_NONE
 0x00

	)

54 
	#MOSQ_LOG_INFO
 0x01

	)

55 
	#MOSQ_LOG_NOTICE
 0x02

	)

56 
	#MOSQ_LOG_WARNING
 0x04

	)

57 
	#MOSQ_LOG_ERR
 0x08

	)

58 
	#MOSQ_LOG_DEBUG
 0x10

	)

59 
	#MOSQ_LOG_SUBSCRIBE
 0x20

	)

60 
	#MOSQ_LOG_UNSUBSCRIBE
 0x40

	)

61 
	#MOSQ_LOG_WEBSOCKETS
 0x80

	)

62 
	#MOSQ_LOG_ALL
 0xFFFF

	)

65 
	emosq_îr_t
 {

66 
MOSQ_ERR_CONN_PENDING
 = -1,

67 
MOSQ_ERR_SUCCESS
 = 0,

68 
MOSQ_ERR_NOMEM
 = 1,

69 
MOSQ_ERR_PROTOCOL
 = 2,

70 
MOSQ_ERR_INVAL
 = 3,

71 
MOSQ_ERR_NO_CONN
 = 4,

72 
MOSQ_ERR_CONN_REFUSED
 = 5,

73 
MOSQ_ERR_NOT_FOUND
 = 6,

74 
MOSQ_ERR_CONN_LOST
 = 7,

75 
MOSQ_ERR_TLS
 = 8,

76 
MOSQ_ERR_PAYLOAD_SIZE
 = 9,

77 
MOSQ_ERR_NOT_SUPPORTED
 = 10,

78 
MOSQ_ERR_AUTH
 = 11,

79 
MOSQ_ERR_ACL_DENIED
 = 12,

80 
MOSQ_ERR_UNKNOWN
 = 13,

81 
MOSQ_ERR_ERRNO
 = 14,

82 
MOSQ_ERR_EAI
 = 15,

83 
MOSQ_ERR_PROXY
 = 16

87 
	emosq_›t_t
 {

88 
MOSQ_OPT_PROTOCOL_VERSION
 = 1,

92 
	#MOSQ_MQTT_ID_MAX_LENGTH
 23

	)

94 
	#MQTT_PROTOCOL_V31
 3

	)

95 
	#MQTT_PROTOCOL_V311
 4

	)

97 
	smosquôto_mesßge
{

98 
mid
;

99 *
t›ic
;

100 *
∑ylﬂd
;

101 
∑ylﬂdÀn
;

102 
qos
;

103 
boﬁ
 
ªèö
;

106 
mosquôto
;

160 
libmosq_EXPORT
 
mosquôto_lib_vîsi⁄
(*
maj‹
, *
mö‹
, *
ªvisi⁄
);

175 
libmosq_EXPORT
 
mosquôto_lib_öô
();

188 
libmosq_EXPORT
 
mosquôto_lib_˛ónup
();

219 
libmosq_EXPORT
 
mosquôto
 *
mosquôto_√w
(c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
, *
obj
);

232 
libmosq_EXPORT
 
mosquôto_de°roy
(
mosquôto
 *
mosq
);

261 
libmosq_EXPORT
 
mosquôto_ªöôüli£
(
mosquôto
 *
mosq
, c⁄° *
id
, 
boﬁ
 
˛ón_£ssi⁄
, *
obj
);

286 
libmosq_EXPORT
 
mosquôto_wûl_£t
(
mosquôto
 *
mosq
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
);

301 
libmosq_EXPORT
 
mosquôto_wûl_˛ór
(
mosquôto
 *
mosq
);

326 
libmosq_EXPORT
 
mosquôto_u£∫ame_pw_£t
(
mosquôto
 *
mosq
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

352 
libmosq_EXPORT
 
mosquôto_c⁄√˘
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
);

382 
libmosq_EXPORT
 
mosquôto_c⁄√˘_böd
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
);

413 
libmosq_EXPORT
 
mosquôto_c⁄√˘_async
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
);

450 
libmosq_EXPORT
 
mosquôto_c⁄√˘_böd_async
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, 
kì∑live
, c⁄° *
böd_addªss
);

486 
libmosq_EXPORT
 
mosquôto_c⁄√˘_§v
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
kì∑live
, c⁄° *
böd_addªss
);

517 
libmosq_EXPORT
 
mosquôto_ªc⁄√˘
(
mosquôto
 *
mosq
);

548 
libmosq_EXPORT
 
mosquôto_ªc⁄√˘_async
(
mosquôto
 *
mosq
);

563 
libmosq_EXPORT
 
mosquôto_disc⁄√˘
(
mosquôto
 *
mosq
);

599 
libmosq_EXPORT
 
mosquôto_publish
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
t›ic
, 
∑ylﬂdÀn
, c⁄° *
∑ylﬂd
, 
qos
, 
boﬁ
 
ªèö
);

621 
libmosq_EXPORT
 
mosquôto_subs¸ibe
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
, 
qos
);

642 
libmosq_EXPORT
 
mosquôto_unsubs¸ibe
(
mosquôto
 *
mosq
, *
mid
, c⁄° *
sub
);

662 
libmosq_EXPORT
 
mosquôto_mesßge_c›y
(
mosquôto_mesßge
 *
d°
, c⁄° mosquôto_mesßgê*
§c
);

675 
libmosq_EXPORT
 
mosquôto_mesßge_‰ì
(
mosquôto_mesßge
 **
mesßge
);

721 
libmosq_EXPORT
 
mosquôto_lo›
(
mosquôto
 *
mosq
, 
timeout
, 
max_∑ckës
);

757 
libmosq_EXPORT
 
mosquôto_lo›_f‹evî
(
mosquôto
 *
mosq
, 
timeout
, 
max_∑ckës
);

777 
libmosq_EXPORT
 
mosquôto_lo›_°¨t
(
mosquôto
 *
mosq
);

801 
libmosq_EXPORT
 
mosquôto_lo›_°›
(
mosquôto
 *
mosq
, 
boﬁ
 
f‹˚
);

815 
libmosq_EXPORT
 
mosquôto_sockë
(
mosquôto
 *
mosq
);

845 
libmosq_EXPORT
 
mosquôto_lo›_ªad
(
mosquôto
 *
mosq
, 
max_∑ckës
);

875 
libmosq_EXPORT
 
mosquôto_lo›_wrôe
(
mosquôto
 *
mosq
, 
max_∑ckës
);

898 
libmosq_EXPORT
 
mosquôto_lo›_misc
(
mosquôto
 *
mosq
);

911 
libmosq_EXPORT
 
boﬁ
 
mosquôto_w™t_wrôe
(
mosquôto
 *
mosq
);

928 
libmosq_EXPORT
 
mosquôto_thªaded_£t
(
mosquôto
 *
mosq
, 
boﬁ
 
thªaded
);

946 
libmosq_EXPORT
 
mosquôto_›ts_£t
(
mosquôto
 *
mosq
, 
mosq_›t_t
 
›ti⁄
, *
vÆue
);

995 
libmosq_EXPORT
 
mosquôto_és_£t
(
mosquôto
 *
mosq
,

996 c⁄° *
ˇfûe
, c⁄° *
ˇ∑th
,

997 c⁄° *
˚πfûe
, c⁄° *
keyfûe
,

998 (*
pw_ˇŒback
)(*
buf
, 
size
, 
rwÊag
, *
u£rd©a
));

1025 
libmosq_EXPORT
 
mosquôto_és_ö£cuª_£t
(
mosquôto
 *
mosq
, 
boﬁ
 
vÆue
);

1059 
libmosq_EXPORT
 
mosquôto_és_›ts_£t
(
mosquôto
 *
mosq
, 
˚π_ªqs
, c⁄° *
és_vîsi⁄
, c⁄° *
cùhîs
);

1086 
libmosq_EXPORT
 
mosquôto_és_psk_£t
(
mosquôto
 *
mosq
, c⁄° *
psk
, c⁄° *
idítôy
, c⁄° *
cùhîs
);

1110 
libmosq_EXPORT
 
mosquôto_c⁄√˘_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_c⁄√˘
)(mosquitto *, *, ));

1130 
libmosq_EXPORT
 
mosquôto_disc⁄√˘_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_disc⁄√˘
)(mosquitto *, *, ));

1148 
libmosq_EXPORT
 
mosquôto_publish_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_publish
)(mosquitto *, *, ));

1171 
libmosq_EXPORT
 
mosquôto_mesßge_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_mesßge
)(mosquôtÿ*, *, c⁄° 
mosquôto_mesßge
 *));

1192 
libmosq_EXPORT
 
mosquôto_subs¸ibe_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_subs¸ibe
)(mosquitto *, *, , , const *));

1210 
libmosq_EXPORT
 
mosquôto_unsubs¸ibe_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_unsubs¸ibe
)(mosquitto *, *, ));

1233 
libmosq_EXPORT
 
mosquôto_log_ˇŒback_£t
(
mosquôto
 *
mosq
, (*
⁄_log
)(mosquitto *, *, , const *));

1270 
libmosq_EXPORT
 
mosquôto_ªc⁄√˘_dñay_£t
(
mosquôto
 *
mosq
, 
ªc⁄√˘_dñay
, 
ªc⁄√˘_dñay_max
, 
boﬁ
 
ªc⁄√˘_exp⁄ítül_backoff
);

1295 
libmosq_EXPORT
 
mosquôto_max_öÊight_mesßges_£t
(
mosquôto
 *
mosq
, 
max_öÊight_mesßges
);

1308 
libmosq_EXPORT
 
mosquôto_mesßge_ªåy_£t
(
mosquôto
 *
mosq
, 
mesßge_ªåy
);

1324 
libmosq_EXPORT
 
mosquôto_u£r_d©a_£t
(
mosquôto
 *
mosq
, *
obj
);

1348 
libmosq_EXPORT
 
mosquôto_socks5_£t
(
mosquôto
 *
mosq
, c⁄° *
ho°
, 
p‹t
, c⁄° *
u£∫ame
, c⁄° *
∑ssw‹d
);

1368 
libmosq_EXPORT
 c⁄° *
mosquôto_°ªº‹
(
mosq_î∫o
);

1381 
libmosq_EXPORT
 c⁄° *
mosquôto_c⁄«ck_°rög
(
c⁄«ck_code
);

1436 
libmosq_EXPORT
 
mosquôto_sub_t›ic_tokíi£
(c⁄° *
subt›ic
, ***
t›ics
, *
cou¡
);

1454 
libmosq_EXPORT
 
mosquôto_sub_t›ic_tokís_‰ì
(***
t›ics
, 
cou¡
);

1477 
libmosq_EXPORT
 
mosquôto_t›ic_m©ches_sub
(c⁄° *
sub
, c⁄° *
t›ic
, 
boﬁ
 *
ªsu…
);

1501 
libmosq_EXPORT
 
mosquôto_pub_t›ic_check
(c⁄° *
t›ic
);

1528 
libmosq_EXPORT
 
mosquôto_sub_t›ic_check
(c⁄° *
t›ic
);

1530 #ifde‡
__˝lu•lus


	@time_mosq.h

17 #i‚de‡
_TIME_MOSQ_H_


18 
	#_TIME_MOSQ_H_


	)

20 
time_t
 
mosquôto_time
();

	@
1
.
0
33
1392
/Users/psaraf/Downloads/mosquitto-1.4.3/src/bridge.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/conf.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/context.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/database.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/db_dump/db_dump.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/logging.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/loop.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/main.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/mosquitto.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/mosquitto_passwd.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/net.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/persist.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/read_handle.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/read_handle_client.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/read_handle_server.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/security.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/security_default.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/send_server.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/service.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/subs.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/sys_tree.c
/Users/psaraf/Downloads/mosquitto-1.4.3/src/websockets.c
lib_load.h
memory_mosq.h
mosquitto_broker.h
mosquitto_internal.h
mosquitto_plugin.h
mqtt3_protocol.h
tls_mosq.h
uthash.h
util_mosq.h
mosquitto.h
time_mosq.h
